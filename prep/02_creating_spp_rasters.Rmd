---
title: "Exploring biodiversity files"
name: "Gage Clawson and Rich Cottrell"
date: "March 2, 2023"
output: html_document
---

## Summary 

This script takes the raw biodiversity shapefiles from IUCN and birds of the world stored on the rdsi storage and converts them to rasters. 

## Setup 

```{r setup, include=FALSE}

library(tidyverse)
library(here)
library(sf)
library(data.table)
library(dtplyr)
library(terra)
library(parallel)
library(strex)

source(here("src/directories.R"))

source(here("src/spatial.R"))

base_raster_ea <- rast(here("data/spatial/base_raster_gall_peters.tif"))


```

## Methods 

Create all rasters for each taxon.


This chunk processes only the IUCN taxa. Birds of the world have different fields so are generated in the chunk below and we do not include freshwater species

```{r}

taxon_list <- list.files(file.path(iucn_dir, "spp_shapefiles"))[-grep(pattern = "BOTW|hybas_table|FW_", list.files(file.path(iucn_dir, "spp_shapefiles")))] #excluding birds of the world and hybas tables and fw species. Botw has a different format which means iteration fails; hybas tables are needed to intersect the range maps; the range of some fw species is smaller than one pixel so rast() fails 

#create taxon directories
map(.x = taxon_list, \(this_taxon){
  dir.create(paste0("/mnt/rdsi/raw_data/iucn/spp_rasters/", this_taxon))
})


#This can take a long time to run and was killing memory trying to run all at once - so splitting it into groups of three to keep manageable. Sometimes have to rerun when results from some cores fail


#########################################################################################################################


#RUN 1
map(.x = taxon_list[1:5], .f = \(this_taxon){
  
  message("processing ", this_taxon) 
  
  #read in shp files - can be multiple per taxon
  this_taxons_shpfiles <- list.files(file.path(iucn_dir, sprintf("spp_shapefiles/%s/", this_taxon)), pattern = "\\.shp$")
  
  #read in each in the list of shp files
    
  this_taxon_shp_list <- mclapply(X=this_taxons_shpfiles, 
                       FUN = \(this_shp){
                         st_read(dsn = paste0("/mnt/rdsi/raw_data/iucn/spp_shapefiles/", this_taxon) , layer =  tools::file_path_sans_ext(this_shp))  
                       },
                       mc.cores=detectCores()-2)
  
  #filter for extant species and those we know to have ongoing (or past likely to reoccur threats that cause at least slow but substantial declines)
  this_taxon_shp <- bind_rows(this_taxon_shp_list) |> 
    filter(grepl("Extant", legend) & presence == 1) #|> 
    #filter(id_no %in% current_severe_threats_of_interest$id_no)
  
  #isolate the species
  these_spp <- unique(this_taxon_shp$id_no)
  
  
  #cycle through the species
  mclapply(X = these_spp, FUN = \(this_spp){
    
    spp_raster_filepath <- file.path(iucn_dir, sprintf("spp_rasters/%s/spp_%s.tif", this_taxon, this_spp))
    
    #does this file path exist? If not create the file
    if(!file.exists(spp_raster_filepath)){
      
      this_spp_shp <- this_taxon_shp |> filter(id_no == this_spp) |> st_transform(crs = equal_area_gp_proj)
      
      this_spp_raster <- rasterize(vect(this_spp_shp), base_raster_ea, touches = TRUE)
      
      writeRaster(x = this_spp_raster, filename = spp_raster_filepath, overwrite=TRUE)
      }
  },
  
  mc.cores = detectCores()-2)}
  )


#########################################################################################################################
#RUN 2

map(.x = taxon_list[6:10], .f = \(this_taxon){
  
  message("processing ", this_taxon) 
  
  #read in shp files - can be multiple per taxon
  this_taxons_shpfiles <- list.files(file.path(iucn_dir, sprintf("spp_shapefiles/%s/", this_taxon)), pattern = "\\.shp$")
  
  #read in each in the list of shp files
    
  this_taxon_shp_list <- mclapply(X=this_taxons_shpfiles, 
                       FUN = \(this_shp){
                         st_read(dsn = paste0("/mnt/rdsi/raw_data/iucn/spp_shapefiles/", this_taxon) , layer =  tools::file_path_sans_ext(this_shp))  
                       },
                       mc.cores=detectCores()-2)
  
  
  #filter for extant species and those we know to have ongoing (or past likely to reoccur threats that cause at least slow but substantial declines)
  this_taxon_shp <- bind_rows(this_taxon_shp_list) |> 
    filter(grepl("Extant", legend) & presence == 1) #|> 
    #filter(id_no %in% current_severe_threats_of_interest$id_no)
  
  #isolate the species
  these_spp <- unique(this_taxon_shp$id_no)
  
  
  #cycle through the species
  mclapply(X = these_spp, FUN = \(this_spp){
    
    spp_raster_filepath <- file.path(iucn_dir, sprintf("spp_rasters/%s/spp_%s.tif", this_taxon, this_spp))
    
    #does this file path exist? If not create the file
    if(!file.exists(spp_raster_filepath)){
      
      this_spp_shp <- this_taxon_shp |> filter(id_no == this_spp) |> st_transform(crs = equal_area_gp_proj)
      
      this_spp_raster <- rasterize(vect(this_spp_shp), base_raster_ea , touches = TRUE)
      
      writeRaster(x = this_spp_raster, filename = spp_raster_filepath, overwrite=TRUE)
      }
  },
  
  mc.cores = detectCores()-2)}
  )


#########################################################################################################################
#RUN 3

map(.x = taxon_list[11:15], .f = \(this_taxon){
  
  message("processing ", this_taxon) 
  
  #read in shp files - can be multiple per taxon
  this_taxons_shpfiles <- list.files(file.path(iucn_dir, sprintf("spp_shapefiles/%s/", this_taxon)), pattern = "\\.shp$")
  
  #read in each in the list of shp files
    
  this_taxon_shp_list <- mclapply(X=this_taxons_shpfiles, 
                       FUN = \(this_shp){
                         st_read(dsn = paste0("/mnt/rdsi/raw_data/iucn/spp_shapefiles/", this_taxon) , layer =  tools::file_path_sans_ext(this_shp))  
                       },
                       mc.cores=detectCores()-2)
  
  #filter for extant species and those we know to have ongoing (or past likely to reoccur threats that cause at least slow but substantial declines)
  this_taxon_shp <- bind_rows(this_taxon_shp_list) |> 
    filter(grepl("Extant", legend) & presence == 1) #|> 
    #filter(id_no %in% current_severe_threats_of_interest$id_no)
  
  #isolate the species
  these_spp <- unique(this_taxon_shp$id_no)
  
  
  #cycle through the species
  mclapply(X = these_spp, FUN = \(this_spp){
    
    spp_raster_filepath <- file.path(iucn_dir, sprintf("spp_rasters/%s/spp_%s.tif", this_taxon, this_spp))
    
    #does this file path exist? If not create the file
    if(!file.exists(spp_raster_filepath)){
      
      this_spp_shp <- this_taxon_shp |> filter(id_no == this_spp) |> st_transform(crs = equal_area_gp_proj)
      
      this_spp_raster <- rasterize(vect(this_spp_shp), base_raster_ea, touches = TRUE)
      
      writeRaster(x = this_spp_raster, filename = spp_raster_filepath, overwrite=TRUE)
      }
  },
  
  mc.cores = detectCores()-2)}
  )




#########################################################################################################################
#RUN 4

map(.x = taxon_list[16:20], .f = \(this_taxon){
  
  message("processing ", this_taxon) 
  
  #read in shp files - can be multiple per taxon
  this_taxons_shpfiles <- list.files(file.path(iucn_dir, sprintf("spp_shapefiles/%s/", this_taxon)), pattern = "\\.shp$")
  
  #read in each in the list of shp files
    
  this_taxon_shp_list <- mclapply(X=this_taxons_shpfiles, 
                       FUN = \(this_shp){
                         st_read(dsn = paste0("/mnt/rdsi/raw_data/iucn/spp_shapefiles/", this_taxon) , layer =  tools::file_path_sans_ext(this_shp))  
                       },
                       mc.cores=detectCores()-2)
  
  #filter for extant species and those we know to have ongoing (or past likely to reoccur threats that cause at least slow but substantial declines)
  this_taxon_shp <- bind_rows(this_taxon_shp_list) |> 
    filter(grepl("Extant", legend) & presence == 1) #|> 
    #filter(id_no %in% current_severe_threats_of_interest$id_no)
  
  #isolate the species
  these_spp <- unique(this_taxon_shp$id_no)
  
  
  #cycle through the species
  mclapply(X = these_spp, FUN = \(this_spp){
    
    spp_raster_filepath <- file.path(iucn_dir, sprintf("spp_rasters/%s/spp_%s.tif", this_taxon, this_spp))
    
    #does this file path exist? If not create the file
    if(!file.exists(spp_raster_filepath)){
      
      this_spp_shp <- this_taxon_shp |> filter(id_no == this_spp) |> st_transform(crs = equal_area_gp_proj)
      
      this_spp_raster <- rasterize(vect(this_spp_shp), base_raster_ea, touches = TRUE)
      
      writeRaster(x = this_spp_raster, filename = spp_raster_filepath, overwrite=TRUE)
      }
  },
  
  mc.cores = detectCores()-2)}
  )




#########################################################################################################################
#RUN 5

map(.x = taxon_list[21:25], .f = \(this_taxon){
  
  message("processing ", this_taxon) 
  
  #read in shp files - can be multiple per taxon
  this_taxons_shpfiles <- list.files(file.path(iucn_dir, sprintf("spp_shapefiles/%s/", this_taxon)), pattern = "\\.shp$")
  
  #read in each in the list of shp files
    
  this_taxon_shp_list <- mclapply(X=this_taxons_shpfiles, 
                       FUN = \(this_shp){
                         st_read(dsn = paste0("/mnt/rdsi/raw_data/iucn/spp_shapefiles/", this_taxon) , layer =  tools::file_path_sans_ext(this_shp))  
                       },
                       mc.cores=detectCores()-2)
  
  #filter for extant species and those we know to have ongoing (or past likely to reoccur threats that cause at least slow but substantial declines)
  this_taxon_shp <- bind_rows(this_taxon_shp_list) |> 
    filter(grepl("Extant", legend) & presence == 1) #|> 
    #filter(id_no %in% current_severe_threats_of_interest$id_no)
  
  #isolate the species
  these_spp <- unique(this_taxon_shp$id_no)
  
  
  #cycle through the species
  mclapply(X = these_spp, FUN = \(this_spp){
    
    spp_raster_filepath <- file.path(iucn_dir, sprintf("spp_rasters/%s/spp_%s.tif", this_taxon, this_spp))
    
    #does this file path exist? If not create the file
    if(!file.exists(spp_raster_filepath)){
      
      this_spp_shp <- this_taxon_shp |> filter(id_no == this_spp) |> st_transform(crs = equal_area_gp_proj)
      
      this_spp_raster <- rasterize(vect(this_spp_shp), base_raster_ea, touches = TRUE)
      
      writeRaster(x = this_spp_raster, filename = spp_raster_filepath, overwrite=TRUE)
      }
  },
  
  mc.cores = detectCores()-2)}
  )



#########################################################################################################################
#RUN 6

map(.x = taxon_list[26:length(taxon_list)], .f = \(this_taxon){
  
  message("processing ", this_taxon) 
  
  #read in shp files - can be multiple per taxon
  this_taxons_shpfiles <- list.files(file.path(iucn_dir, sprintf("spp_shapefiles/%s/", this_taxon)), pattern = "\\.shp$")
  
  #read in each in the list of shp files
    
  this_taxon_shp_list <- mclapply(X=this_taxons_shpfiles, 
                       FUN = \(this_shp){
                         st_read(dsn = paste0("/mnt/rdsi/raw_data/iucn/spp_shapefiles/", this_taxon) , layer =  tools::file_path_sans_ext(this_shp))  
                       },
                       mc.cores=detectCores()-2)
  
  #filter for extant species and those we know to have ongoing (or past likely to reoccur threats that cause at least slow but substantial declines)
  this_taxon_shp <- bind_rows(this_taxon_shp_list) |> 
    filter(grepl("Extant", legend) & presence == 1) #|> 
    #filter(id_no %in% current_severe_threats_of_interest$id_no)
  
  #isolate the species
  these_spp <- unique(this_taxon_shp$id_no)
  
  
  #cycle through the species
  mclapply(X = these_spp, FUN = \(this_spp){
    
    spp_raster_filepath <- file.path(iucn_dir, sprintf("spp_rasters/%s/spp_%s.tif", this_taxon, this_spp))
    
    #does this file path exist? If not create the file
    if(!file.exists(spp_raster_filepath)){
      
      this_spp_shp <- this_taxon_shp |> filter(id_no == this_spp) |> st_transform(crs = equal_area_gp_proj)
      
      this_spp_raster <- rasterize(vect(this_spp_shp), base_raster_ea, touches = TRUE)
      
      writeRaster(x = this_spp_raster, filename = spp_raster_filepath, overwrite=TRUE)
      }
  },
  
  mc.cores = detectCores()-2)}
  )










```


Create rasters of BOTW and freshwater species 

```{r}

taxon_list <- list.files(file.path(iucn_dir, "spp_shapefiles"))[grep(pattern = "BOTW|FW_", list.files(file.path(iucn_dir, "spp_shapefiles")))] #excluding birds of the world and hybas tables and fw species. Botw has a different format which means iteration fails; hybas tables are needed to intersect the range maps; the range of some fw species is smaller than one pixel so rast() fails 


# Run BOTW
  
this_taxon = taxon_list[1]
  
  message("processing ", this_taxon) 
  
  #read in shp files - can be multiple per taxon
  this_taxons_shpfiles <- list.files(file.path(iucn_dir, sprintf("spp_shapefiles/%s/", this_taxon)), pattern = "\\.shp$")
  
  #read in each in the list of shp files
  
 # this_taxon_shp <- st_read(dsn = paste0("/mnt/rdsi/raw_data/iucn/spp_shapefiles/BOTW/", this_taxon, "_PART_1.shp")) %>%
 #   st_drop_geometry()
  
    
  this_taxon_shp_list <- mclapply(X=this_taxons_shpfiles, 
                       FUN = \(this_shp){
                         st_read(dsn = paste0("/mnt/rdsi/raw_data/iucn/spp_shapefiles/", this_taxon) , layer =  tools::file_path_sans_ext(this_shp))  
                       },
                       mc.cores=detectCores()-2)
  
  #filter for extant species and those we know to have ongoing (or past likely to reoccur threats that cause at least slow but substantial declines)
  this_taxon_shp <- bind_rows(this_taxon_shp_list) |> 
    filter(presenc == 1) #|> 
    #filter(id_no %in% current_severe_threats_of_interest$id_no)
  
  #isolate the species
  these_spp <- unique(this_taxon_shp$id_no)
  
  done_spp <- str_before_first(str_after_last(list.files(file.path(iucn_dir, sprintf("spp_rasters/%s/", this_taxon))), "_"), ".tif")
  
  these_spp <- setdiff(these_spp, done_spp)
  
  
  #cycle through the species
  mclapply(X = these_spp, FUN = \(this_spp){
    
    spp_raster_filepath <- file.path(iucn_dir, sprintf("spp_rasters/%s/spp_%s.tif", this_taxon, this_spp))
    
    #does this file path exist? If not create the file
    if(!file.exists(spp_raster_filepath)){
      
      this_spp_shp <- this_taxon_shp |> filter(id_no == this_spp) |> st_transform(crs = equal_area_gp_proj)
      
      this_spp_raster <- rasterize(vect(this_spp_shp), base_raster_ea, touches = TRUE)
      
      writeRaster(x = this_spp_raster, filename = spp_raster_filepath, overwrite=TRUE)
      }
  },
  
  mc.cores = detectCores()-8)
  
  
  
map(.x = taxon_list[2:7], .f = \(this_taxon){

# Run FW spp 
  
# this_taxon = taxon_list[2]
  
  message("processing ", this_taxon) 
  
  #read in shp files - can be multiple per taxon
  this_taxons_shpfiles <- list.files(file.path(iucn_dir, sprintf("spp_shapefiles/%s/", this_taxon)), pattern = "\\.shp$")
  
  #read in each in the list of shp files
  
 # this_taxon_shp <- st_read(dsn = paste0("/mnt/rdsi/raw_data/iucn/spp_shapefiles/BOTW/", this_taxon, "_PART_1.shp")) %>%
 #   st_drop_geometry()
  
    
  this_taxon_shp_list <- mclapply(X=this_taxons_shpfiles, 
                       FUN = \(this_shp){
                         st_read(dsn = paste0("/mnt/rdsi/raw_data/iucn/spp_shapefiles/", this_taxon) , layer =  tools::file_path_sans_ext(this_shp))  
                       },
                       mc.cores=detectCores()-2)
  
  #filter for extant species and those we know to have ongoing (or past likely to reoccur threats that cause at least slow but substantial declines)
  this_taxon_shp <- bind_rows(this_taxon_shp_list) |> 
    filter(presence == 1 & grepl("Extant", legend)) # |> 
    # filter(id_no %in% current_severe_threats_of_interest$id_no)
  
  #isolate the species
  these_spp <- unique(this_taxon_shp$id_no)
  
  
  #cycle through the species
  mclapply(X = these_spp, FUN = \(this_spp){
    
    spp_raster_filepath <- file.path(iucn_dir, sprintf("spp_rasters/%s/spp_%s.tif", this_taxon, this_spp))
    
    #does this file path exist? If not create the file
    if(!file.exists(spp_raster_filepath)){
      
      this_spp_shp <- this_taxon_shp |> filter(id_no == this_spp) |> st_transform(crs = equal_area_gp_proj)
      
      this_spp_raster <- rasterize(vect(this_spp_shp), base_raster_ea, touches = TRUE)
      
      writeRaster(x = this_spp_raster, filename = spp_raster_filepath, overwrite=TRUE)
      }
  },
  
  mc.cores = detectCores()-8)}
)
  


```



```{r}
test <- rast(list.files("/mnt/rdsi/raw_data/iucn/spp_rasters/FW_CRAYFISH", full.names = TRUE)) %>%
  app(., fun = sum, na.rm = TRUE) %>%
  classify(., cbind(1, Inf, 1))
  
plot(test, col = "red")
test


```

