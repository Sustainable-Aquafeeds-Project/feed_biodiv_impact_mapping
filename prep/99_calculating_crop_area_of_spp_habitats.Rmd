---
title: "Overlapping species AOH with feed crops"
output: html_document
editor_options: 
  chunk_output_type: console
---

## Setup

Load libraries

```{r setup, include=FALSE}

library(tidyverse)
library(here)
library(sf)
library(data.table)
library(dtplyr)
library(terra)
library(raster)
library(parallel)
library(rnaturalearth)
library(strex)
library(gdalUtils)

source(here("src/directories.R"))

source(here("src/spatial.R"))

base_raster_ea <- rast(here("data/spatial/base_raster_gall_peters.tif"))

select <- dplyr::select


```

Check to make sure we downloaded all of the AOH species maps from https://datadryad.org/stash/dataset/doi:10.5061/dryad.02v6wwq48


You can download by ssh into the rdsi storage and then running wget url_to_download

ssh ubuntu@131.217.178.173
cd ../../mnt/rdsi/raw_data/AOH_lumbierres
wget https://datadryad.org/stash/downloads/file_stream/1931890

unzip 1931890.zip

Above example is how to download mammals_rodentia.zip file. Link taken from https://datadryad.org/stash/dataset/doi:10.5061/dryad.02v6wwq48.


Aselliscus_tricuspidatus.tif

```{r}

test <- data.frame(empty = "empty df")

write.csv(test, file.path(rdsi_raw_data_dir, "testing.csv"), row.names = FALSE)

write.csv(test, here("test.csv"))

## read in species lists from raw data dir 

mammals_list <-
  read.csv(file.path(rdsi_raw_data_dir, "AOH_lumbierres/Mammals_list_AOH.csv")) %>%
  clean_names() %>%
  dplyr::select(binomial, aoh_name, order) %>%
  mutate(type = "mammal")

birds_list <- read.csv(file.path(rdsi_raw_data_dir, "AOH_lumbierres/Birds_list_AOH.csv")) %>%
  clean_names() %>%
  dplyr::select(binomial, aoh_name, order) %>%
  mutate(type = "bird")


total_spp_list <- rbind(mammals_list, birds_list)

## now grab the names of the species from the raw data directory

files <- list.files(file.path(rdsi_raw_data_dir, "AOH_lumbierres"), pattern = ".tif")

spp_list_files <- str_before_last(files, ".tif") 

remove_suffix <- function(string) {
  modified_string <- sub("_[BNR]$", "", string)
  return(modified_string)
}

spp_list_files_fin <- remove_suffix(spp_list_files) %>%
  unique()


## now filter these spp out of the spp df 

missing_spp <- total_spp_list %>%
  filter(!(aoh_name %in% c(spp_list_files_fin)))

## ok I'm missing 4394 spp. 

sort(unique(missing_spp$order)) # still missing 933 Rodentia 

# [1] "CHIROPTERA"    "PASSERIFORMES"    


## I will redownload the zip files missing from here: https://datadryad.org/stash/dataset/doi:10.5061/dryad.02v6wwq48 and see if that helps the missing species...

unzip(file.path(rdsi_raw_data_dir, "AOH_lumbierres/1931870.zip"), exdir = here("test/"))

```

Don't think I need to download this one: non migratory passeriformes: https://datadryad.org/stash/downloads/file_stream/1931825

Need to download migratory passeriformes: https://datadryad.org/stash/downloads/file_stream/1931854
Need to download chiroptera: https://datadryad.org/stash/downloads/file_stream/1931870


## Summary

Trying an example using soy production for SPC and soy oil, overlapped with sloths and anteater habitats from the order Pilosa. 


Import area of soy production using plant-diet mass allocation

```{r}

allocation = "mass"
crop = "soyb"
diet = "plant-dominant"

rast_names <- list.files(sprintf(here("prep/02_feed/output/%s"), diet), pattern = sprintf("%s_.*_%s.tif", crop, allocation))

rasts <- rast(list.files(sprintf(here("prep/02_feed/output/%s"), diet), full.names = TRUE, pattern = sprintf("%s_.*_%s.tif", crop, allocation)))

names(rasts) <- rast_names

plot(log(rasts+1))


```

Import AOH maps for Pilosa species into a raster list

```{r}
aoh <- rast(list.files(file.path(rdsi_raw_data_dir, "AOH_lumbierres/Mammals_pilosa/"), full.names = TRUE)[[8]])

plot(aoh)

aoh_files <- list.files(file.path(rdsi_raw_data_dir, "AOH_lumbierres/Mammals_pilosa/"), full.names = TRUE)

raster_list <- list()

# Loop through each raster file
for (file_path in aoh_files) {
  # file_path <- aoh_files[[2]]
  
  # Read the raster with the common resolution, projection, and CRS
  raster <- rast(file_path) 
  #%>%
   # extend(rasts)
  # Add the raster to the list
  raster_list[[file_path]] <- raster
  
 #  plot(raster)
}

raster_list

plot(raster_list[[3]])

# this is how you plot then all together 
em <- ext(rasts)

plot(em, type = "n")
terra::plot(raster_list[[2]], add = TRUE, legend = F, col = "red")
terra::plot(raster_list[[8]], add = TRUE, legend = F, col = "blue")
plot(raster_list[[1]], add = TRUE, legend = F)
plot(raster_list[[3]], add = TRUE, legend = F)
plot(raster_list[[5]], add = TRUE, legend = F)






```


Try aggregating aoh rasters to crop raster res
 - this might be quicker... although there are a lot more rasters to resample this way... 

```{r}


resample_aoh <- terra::resample(raster_list[[3]], rasts, method = "near")
plot(resample_aoh)

test <- crop(resample_aoh, ext(raster_list[[3]]))

plot(test)
plot(raster_list[[3]])
## ok we definitely lose some info here... what is best practice though? Should we aggregate up to crop resolution? Or disaggregate crop resolution to the better res of the AOH maps? This is called the modifiable areal unit problem. If you disaggregate, you introducec possible randomness and uncerainty. If you aggregate, you lose some information. 


# Let's ask chatGPT...

# Given the scenario you described, where the soybean raster has a lower resolution and the habitat raster has a higher resolution, it is recommended to use the higher resolution for the analysis. This approach allows for a more precise assessment of the overlap between the crop production and habitat areas.
# 
# By using the higher resolution habitat raster, you can accurately determine the amount of habitat disturbed by crop production at a finer scale. This finer-scale analysis is particularly important when assessing the impacts of land-use changes on biodiversity.
# 
# While the soybean raster has a lower resolution, it can still be utilized in the analysis. You can resample the soybean raster to match the resolution of the higher resolution habitat raster. This will ensure consistency in the analysis and enable the accurate calculation of the amount of habitat disturbed by crop production at the higher resolution.
# 
# Resampling the soybean raster can be achieved using the terra::resample function. By resampling the soybean raster to the higher resolution, you retain the information on soybean production while aligning it with the habitat raster for the overlap analysis.

## when chatGPT says "lower resolution", it means the "worse" resolution, e.g., the resolution of the crop MAPSPAM data... so this indicates that I should resample to the aoh rasters... which is pretty computationally intensive. 
```


Try resampling crop rasters to same resolution as AOH rasters

 - just testing here. Will probably want to do this to the raw mapSPAM rasters, rather than repeating a bunch here. 
 - takes 2.446796 for one raster to run. We have ~60 gb of memory, each run takes ~5gb, so we could theoretically run 12 cores at a time. There are 42 raw MapSPAM rasters, so that would take 42 rasters/12 rasters per run = 3.5 runs*2.5 hours = ~9 hours? Probably more, because I will likely limit to 8 cores to be safe... but might also cut some crops out that we don't include in salmon feeds, so could be less rasters to resample. 

```{r}
# factor = 0.08333333/0.0009920722
# disagg_crop <- terra::disagg(rasts, factor)

## Define the properties of the template raster based on the given raster
resolution <- c(0.0009920722, 0.0009920722) # aoh res
extent <- c(-180, 180, -90, 90) # global extent
crs <- "+proj=longlat +datum=WGS84 +no_defs" # crs 

# Create the template raster with the desired properties
template_raster <- rast(resolution = resolution, extent = extent, crs = crs)

# save raster cell size area
template_raster_area <- terra::cellSize(template_raster, unit = "km")

writeRaster(template_raster_area, file.path("/mnt/rdsi/raw_data/AOH_lumbierres/highres_area_raster.tif"))

# template_raster_area <- rast(file.path("/mnt/rdsi/raw_data/AOH_lumbierres/highres_area_raster.tif"))

# divide by area to make it unitless
rasts_area_fix <- rasts/terra::cellSize(rasts, unit = "km")

start_time <- Sys.time()

# resample no area raster
terra::resample(rasts_area_fix[[1]], template_raster, method = "bilinear", filename = file.path("/mnt/rdsi/raw_data/AOH_lumbierres/soyb_soy oil_mass_terra_no_area.tif"), overwrite = TRUE)

# file.info("/mnt/rdsi/raw_data/AOH_lumbierres/highres_area_raster.tif")

# read in new raster
rasts_high_res_no_area <- rast("/mnt/rdsi/raw_data/AOH_lumbierres/soyb_soy oil_mass_terra_no_area.tif")

# now multiply by area again
rasts_high_res_area_fix <- rasts_high_res_no_area*template_raster_area

terra::app(rasts_high_res_no_area*template_raster_area, fun = "*", file.name = file.path("/mnt/rdsi/raw_data/AOH_lumbierres/soyb_soy oil_mass_terra_area_adjusted_resampled.tif"))


end_time <- Sys.time()
execution_time <- end_time - start_time
print(execution_time)

## these should be the same 
global(rasts[[1]], fun = "sum", na.rm = TRUE)

global(rasts_high_res_area_fix, fun = "sum", na.rm = TRUE)



# lol well that didn't work... reporting way more production. Do I need to divide by area or something? I'm not reprojecting though... I could rescale the raster by a scaling factor of 14954.95 (original tonnage) /105536365 (new tonnage). Doesn't matter if I use nearest neighbor or if I use bilinear. 



# input_raster <-  list.files(sprintf(here("prep/02_feed/output/%s"), diet), full.names = TRUE, pattern = sprintf("%s_.*_%s.tif", crop, allocation))[[1]]
# output_raster <- file.path("/mnt/rdsi/raw_data/AOH_lumbierres/soyb_soy oil_mass.tif")
# 
# target_resolution = c(0.0009920722, 0.0009920722)
# options(gdalUtils_gdalwarp_CHECK_DISK_FREE_SPACE = FALSE)
# 
# start_time <- Sys.time()
# gdalwarp(
#   srcfile = input_raster,
#   dstfile = output_raster,
#   tr = target_resolution,
#   r = "bilinear",
#   s_srs = "EPSG:4326",
#   t_sts = "EPSG:4326",
#   overwrite = TRUE
# )
# end_time <- Sys.time()
# execution_time <- end_time - start_time
# print(execution_time)


test <- raster(file.path("/mnt/rdsi/raw_data/AOH_lumbierres/soyb_soy oil_mass_terra.tif"))
plot(test)
```

Ok, so a couple of options here. Because the AOH files are different resolution and extent, we need to figure out a way to make the AOH files and the mapspam files match. 

 - Disaggregate the mapspam rasters from the very beginning
 - resample each feed ingredient mapspam raster to match every species AOH. Doing this would result in a ingredient raster (~10 ingredients) for every species (16000) for each allocation approach (2) = >300k rasters... probably don't want this. Even this is really computationally intensive, especially for species that have large AOH extents. 
 - Resample ingredient rasters to be global extent and same resolution as spp aoh, then overlap... very computationally intensive.
 - Aggregate species aoh to the higher resolution of mapspam... Problem with this, is it might take away from the advantages of using AOH maps, as the aggregation would probably make the AOH maps look more like species range maps... 
 
**Is there some sort of data frame option? There is, but no matter what, I will have to have the AOH rasters in the same resolution as the feed ingredient rasters. We just have to choose how to do that.**



ARCHIVE: 

Import threat data
```{r}

current_severe_threats_of_interest <- read_csv(here("data/tidy_data/iucn/current_severe_threats_of_interest.csv")) |> 
  rename(id_no = id)
  
#how many species fall in to te category of being affected by these threats? 12728 species
length(unique(current_severe_threats_of_interest$id_no))

#ongoing threats represent 93.9% of all threats
current_severe_threats_of_interest |> filter(result_timing == "Ongoing") |> nrow()/(current_severe_threats_of_interest |> nrow())



```

Import area of soy production using the balanced diet 1 as an example.

```{r}

base_raster_layer <- base_raster_ea |> raster()
base_df <- rasterToPoints(base_raster_layer) |> lazy_dt() |> select(x, y)

#seclect the mammals currently threatened by AG, Aquaculture or fisheries
terrestrial_mammals <- list.files(file.path(iucn_dir, "spp_rasters/MAMMALS_TERRESTRIAL_ONLY"), full.names = TRUE)
ag_threat_index <- which(as.double(gsub("spp_", "", basename(tools::file_path_sans_ext(terrestrial_mammals)))) %in% current_severe_threats_of_interest$id_no, TRUE)
vuln_terrestrial_mammals <- terrestrial_mammals[ag_threat_index]

#select amphibians currently threatened by AG, aquaculture or fisheries
amphibians <- list.files(file.path(iucn_dir, "spp_rasters/ANURA"), full.names = TRUE)
ag_threat_index <- which(as.double(gsub("spp_", "", basename(tools::file_path_sans_ext(amphibians)))) %in% current_severe_threats_of_interest$id_no, TRUE)
vuln_amphibians <- amphibians[ag_threat_index]


#soy protein concentrate raster spatial layers - select top 3 to start with
spc_files <- list.files(here("../feed_pressure_mapping/data/spatial/marine_diet/production/"), pattern = "soybean meal_AllTech_", full.names = TRUE)
spc_files_top_3 <- spc_files[grepl("USA|BRA|CHN", spc_files)]


mammals_aoh <- map(spc_files_top_3, \(this_country){
  
  # this_country = spc_files_top_3[2]
  
  this_countryname <- str_before_first(str_after_last(this_country, "_"), ".tif")
    
  this_allocation_type <- str_before_last(str_after_nth(str_after_last(this_country, "/"), "_",  2), "_")
  
  message("processing mammals impacts in ", this_countryname, " for ", this_allocation_type)
  
  
  this_country_spc_raster <- terra::rast(this_country) |> raster()
  
  this_country_spc_dt <- rasterToPoints(this_country_spc_raster) |> lazy_dt() %>% rename(crop_area = 3) |> mutate(cell_area = 100)
  
  overlap_list <- mclapply(X = vuln_terrestrial_mammals, FUN = \(this_mammal){
    
    #isolate species
    #this spp id
    # this_mammal <- vuln_terrestrial_mammals[[1]]
    
    this_species <- as.numeric(gsub("spp_", "", basename(tools::file_path_sans_ext(this_mammal))))
    
    #import raster
    this_spp_raster <- rast(this_mammal) |> raster() %>% projectRaster(., this_country_spc_raster)
    #convert raster layer to species id
    values(this_spp_raster)[!is.na(values(this_spp_raster))] <- this_species
    #get the xyz file
    this_spp_dt <- rasterToPoints(this_spp_raster) |> lazy_dt() |> rename(spp_id = layer)
    
    #inner join species and crop files so we know if they overlap and summarise the crop portion of spp habitat
    spp_crop_overlap <-  this_spp_dt |> 
      inner_join(this_country_spc_dt, by = c("x", "y")) |> 
      group_by(spp_id) |> 
      summarise(aoh = sum(crop_area)/sum(cell_area)) |> 
      mutate(allocation = this_allocation_type) %>%
      as.data.table() 
    
  },
  mc.cores = detectCores()-2)
  
  return(rbindlist(overlap_list) |> mutate(country = this_countryname) |> as_tibble())
  
})


test <- map_df(mammals_aoh, as_tibble) ## so this is range map km2 (?) of that overlaps with crops used for SBM?

write_csv(x = map_df(mammals_aoh, as_tibble), file = here("data/int/sbm_mammals_aoh_marine_diet.csv"))


#AMPHIBIANS
amphibs_aoh <- map(spc_files_top_3, \(this_country){
  
  this_countryname <- str_before_first(str_after_last(this_country, "_"), ".tif")
    
  this_allocation_type <- str_before_last(str_after_nth(str_after_last(this_country, "/"), "_",  2), "_")
  
  message("processing amphibian impacts in ", this_countryname, " for ", this_allocation_type)
  
  
  this_country_spc_raster <- terra::rast(this_country) |> raster()
  
  this_country_spc_dt<- rasterToPoints(this_country_spc_raster) |> lazy_dt() |> rename(crop_area = 3) |> mutate(cell_area = 100)
  
  overlap_list <- mclapply(X = vuln_amphibians, FUN = \(this_amphibian){
    
    this_amphibian = vuln_amphibians[[1]]
    #isolate species
    #this spp id
    this_species <- as.numeric(gsub("spp_", "", basename(tools::file_path_sans_ext(this_amphibian))))
    
    #import raster
    this_spp_raster <- rast(this_amphibian) |> raster() %>% projectRaster(., this_country_spc_raster)
    #convert raster layer to species id
    values(this_spp_raster)[!is.na(values(this_spp_raster))] <- this_species
    #get the xyz file
    this_spp_dt <- rasterToPoints(this_spp_raster) |> lazy_dt() |> rename(spp_id = layer)
    
    #inner join species and crop files so we know if they overlap and summarise the crop portion of spp habitat
    spp_crop_overlap <-  this_spp_dt |> 
      inner_join(this_country_spc_dt, by = c("x", "y")) |> 
      group_by(spp_id) |> 
      summarise(aoh = sum(crop_area)/sum(cell_area)) |> 
      mutate(allocation = this_allocation_type) %>%
      as.data.table()
    
  },
  mc.cores = detectCores()-2)
  
   return(rbindlist(overlap_list) |> mutate(country = this_countryname))
  
})


write_csv(x = map_df(amphibs_aoh, as_tibble), file = here("data/int/sbm_amphibs_aoh_marine_diet.csv"))


```

Illustrate the example of the method through the mammals in Brazil, China, USA

```{r}

amphib_impacts <- read_csv(file = here("data/int/sbm_amphibs_aoh_marine_diet.csv"))
mammals_impacts <- read_csv(file = here("data/int/sbm_mammals_aoh_marine_diet.csv"))

sbm_rasters <- list.files("../../feed_pressure_mapping/data/spatial/marine_diet/production/", pattern = "soybean meal_AllTech_", full.names = TRUE)

brazil_sbm_raster <- rast(sbm_rasters[grepl("BRA", sbm_rasters)]) |> raster() %>% projectRaster(crs = equal_area_gp_proj) %>% crop(brazil_shp)

sbm_df <- brazil_sbm_raster |> as("SpatialPointsDataFrame") |> as.data.frame() |> filter(spam2010V2r0_global_P_SOYB_A>0)

#using species 6228 as an example as the proportion is large

mammals_shp <- st_read(dsn = file.path("/mnt/rdsi/raw_data/iucn/spp_shapefiles/MAMMALS_TERRESTRIAL_ONLY/MAMMALS_TERRESTRIAL_ONLY.shp"), layer = "MAMMALS_TERRESTRIAL_ONLY" ) 

shp_29404 <- mammals_shp |> filter(id_no == 29404)|> st_transform(crs = equal_area_gp_proj)
shp_6288 <- mammals_shp |> filter(id_no == 6288) |> st_transform(crs = equal_area_gp_proj)
shp_29404 <- mammals_shp |> filter(id_no == 29404) |> st_transform(crs = equal_area_gp_proj)
shp_14224 <- mammals_shp |> filter(id_no == 14224) |> st_transform(crs = equal_area_gp_proj)


countries_shp <- ne_countries(scale = 110, returnclass = "sf") |> st_transform(equal_area_gp_proj) 

brazil_shp <- countries_shp |> filter(geounit %in% c("Brazil", "Peru", "Ecuador", "Chile", "Colombia", "Argentina", "Paraguay", "Uruguay", "Bolivia", "Venezuela", "Guyana", "French Guiana", "Panama", "Costa Rica", "Suriname"))

(p <- ggplot()+
  geom_sf(data = brazil_shp, fill="grey", colour="white")+
  geom_sf(data = shp_14224, fill = "darkgreen", colour=NA, alpha=0.7)+
  geom_sf(data = shp_6288, fill = "blue", colour=NA, alpha=0.5)+
  geom_tile(data = sbm_df, aes(x = x, y = y, fill = spam2010V2r0_global_P_SOYB_A))+
 scale_fill_gradientn(colors = RColorBrewer::brewer.pal(n=9, name = "BuPu"))+
  theme_bw()+
    theme(title = element_text(size=7))+
    labs(fill = "Soy production\n(km2)", title = "Myrmecophaga tridactyla (Giant anteater) - green\nDasypus hybridus (Southern long-nosed armadillo) - blue")) ## soy production  not showing for some reason...

ggsave(filename = here("data/int/explore/explore_brazil_species_impacts.jpg"), device = "jpg", dpi=300, height = 20, width = 15, units =  "cm")



#try an example from china

```

Compare countries for mammal impacts example for SBM

```{r}
my_pal <- rcartocolor::carto_pal(n = , name = "Bold")[c(1, 7, 2)]

mammals_impacts2 <- mammals_impacts |> group_by(country) |>add_tally()

ggplot(mammals_impacts2, 
       aes(x = country, y = aoh*100, fill = country))+
    ggdist::stat_gradientinterval(
    width = .3, 
    color = "black", 
    fill_type = "gradient")+
  geom_jitter(alpha = 0.5, width = 0.1, colour = "grey50")+
  theme_bw()+
  facet_wrap(~allocation) +
  scale_fill_manual(values = my_pal, guide = "none")+
  #scale_color_manual(values = my_pal, guide = "none")+
  geom_text(data = mammals_impacts2 |> select(c(4,5)) |> distinct() |> mutate(y = 12),
            aes(x = country, y = y, label = n), colour = "black")+
  labs(y = "Area of habitat (%)", x= "", title = "SPC - Area of mammal habitat") 

ggsave(filename = here("data/int/explore/comparison of mammal impacts for countries - spc .jpg"), device = "jpg", dpi = 300, width = 15, height = 12, units = "cm")

```

Create plot for method example

```{r}

#country shapefile for brazil versus china example
countries_shp <- ne_countries(scale = 110, returnclass = "sf") %>% st_transform(crs = equal_area_gp_proj)

brazil_shp <- countries_shp |> filter(geounit %in% c("Brazil"))
china_shp <- countries_shp |> filter(geounit %in% c("China"))



#plot brazil soy demand  marine diet 1 for sbm

sbm_rasters_marine <- list.files("../../feed_pressure_mapping/data/spatial/marine_diet/production/", pattern = "soybean meal_AllTech_", full.names = TRUE)
brazil_sbm_raster_marine <- rast(sbm_rasters_marine[grepl("BRA", sbm_rasters_marine)]) |> raster() %>%
  projectRaster(crs = equal_area_gp_proj)

brazil_sbm_raster_marine_df <- brazil_sbm_raster_marine %>% as("SpatialPointsDataFrame") %>% as.data.frame() %>% 
  filter(spam2010V2r0_global_P_SOYB_A>0)

ggplot()+
  geom_sf(data = brazil_shp) +
  geom_tile(data = brazil_sbm_raster_marine_df, aes(x=x, y=y, fill = spam2010V2r0_global_P_SOYB_A))+
  theme_bw()+
  scale_fill_gradientn(colours = RColorBrewer::brewer.pal(n=9, "BuPu"))

ggsave(filename = here("explore/sbm_brazil_marinediet.jpg"), device = "jpg", dpi = 300, width = 12, height = 18, units = "cm")

#plot china soy demand  marine diet 1 for sbm
china_sbm_raster_marine <- rast(sbm_rasters_marine[grepl("CHN", sbm_rasters_marine)]) |> raster() %>% projectRaster(crs = equal_area_gp_proj)

china_sbm_raster_marine_df <- china_sbm_raster_marine %>% as("SpatialPointsDataFrame") %>% as.data.frame() %>% filter(spam2010V2r0_global_P_SOYB_A >0)

ggplot()+
  geom_sf(data = china_shp)+
  geom_tile(data = china_sbm_raster_marine_df, aes(x=x, y=y, fill = spam2010V2r0_global_P_SOYB_A))+
  theme_bw()+
  scale_fill_gradientn(colours = RColorBrewer::brewer.pal(n=9, "BuPu"))


ggsave(filename = here("data/int/explore/sbm_china_marinediet.jpg"), device = "jpg", dpi = 300, width = 12, height = 18, units = "cm")


#plot brazil soy demand  balanced diet 1 for spc
spc_rasters_bal <- list.files("../../feed_pressure_mapping/data/spatial/plant_diet/production", pattern = "soy protein concentrate_AllTech_ge", full.names = TRUE)
brazil_spc_raster_bal <- rast(spc_rasters_bal[grepl("BRA", spc_rasters_bal)]) |> raster() %>% projectRaster(crs = equal_area_gp_proj)

brazil_spc_raster_bal_df <- brazil_spc_raster_bal %>% as("SpatialPointsDataFrame") %>% as.data.frame() 


ggplot()+
  geom_sf(data = brazil_shp)+
  geom_tile(data = brazil_spc_raster_bal_df, aes(x=x, y=y, fill = spam2010V2r0_global_P_SOYB_A))+
  theme_bw()+
  guides(fill = "none")

ggsave(filename = here("data/int/explore/spc_brazil_plant_diet_ge.jpg"), device = "jpg", dpi = 300, width = 12, height = 18, units = "cm")


```


