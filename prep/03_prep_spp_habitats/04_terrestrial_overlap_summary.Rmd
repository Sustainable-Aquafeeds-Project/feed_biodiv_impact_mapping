---
title: "Summarizing global terrestrial AOH impact per species"
output: html_document
editor_options: 
  chunk_output_type: console
---

## Summary

In this script we prep dataframes of total global amount of impacted habitat per terrestrial species.


## Setup

Load libraries

```{r setup, include=FALSE}

library(tidyverse)
library(here)
library(terra)
library(parallel)
library(strex)
library(janitor)
library(sf)
library(tools)
library(glue)

source(here("src/directories.R"))

source(here("src/spatial.R"))

select <- dplyr::select


aoh_dir <- file.path(rdsi_raw_data_dir, "AOH_lumbierres/reprojected/")

setwd(dirname(rstudioapi::getSourceEditorContext()$path)) # set working directory to where this script is located
this_dir <- getwd()
```

Bind all chunked data together, tidy, and save

```{r}

impact_df <-  purrr::map_df(list.files(here("prep/03_prep_spp_habitats/int/aoh_impacts_terrestrial/"), full.names = TRUE), readRDS) %>%
  separate_wider_delim(species_full, delim = "_", names = c("genus", "species", "bird_type"), too_few = "align_start") %>%
  unite(sciname, c(genus, species))


length(unique(impact_df$sciname)) # 15507 hmmm.. missing ~600 species

# now lets clean up the data a bit 

mammals_list <- read.csv(here("prep/data/Mammals_list_AOH.csv")) %>%
  dplyr::select(sciname = BINOMIAL, order = ORDER, iucn_rl_cat = Red_List_Category_2019)

birds_list <- read.csv(here("prep/data/Birds_list_AOH.csv")) %>%
    dplyr::select(sciname = BINOMIAL, order = Order_, iucn_rl_cat = F2019_Iucn_Red_List_Category)

all_spp_list <- rbind(mammals_list, birds_list)


impact_df_tidy <- impact_df %>%
    group_by(sciname, diet, fcr_type, allocation, crop_ingredient) %>%
  summarise(impact_total = sum(impact_total, na.rm = TRUE)) %>%
  mutate(aoh_filepath = paste0(aoh_dir, sciname), 
         feed_filepath = sprintf(here("prep/02_feed/output/resampled/%s/%s_%s_A.tif"), diet, crop_ingredient, allocation)) %>%
  rename("ingredient" = "crop_ingredient") %>%
  mutate(sciname = str_replace_all(sciname, "_", " ")) %>%
  left_join(all_spp_list, by = c("sciname")) %>%
  mutate(impact_total = ifelse(is.na(impact_total), 0, impact_total))

species_list <- c(unique(impact_df_tidy$sciname))

writeLines(species_list, here("prep/03_prep_spp_habitats/int/species_list.txt"))


```




Pull total amount of cropland (km2) for each allocation, diet, and aquafeed ingredient

```{r}
# file_list <- list.files(here("prep/02_feed/output/resampled"), full.names = TRUE, recursive = TRUE, pattern = "_A") # 36 - good
# 
# rast_list <- rast(file_list)
# 
# names_list <- basename(file_list)
# 
# 
# crops_km2 <- data.frame(feed_filepath = file_list, filename = names_list, total_cropland = global(rast_list, "sum", na.rm = TRUE)) %>%
#   mutate(allocation = str_after_last(str_before_last(filename, "_"), "_"),
#          ingredient = str_before_nth(filename, "_", 2),
#          diet = str_after_last(str_before_last(feed_filepath, "\\/"), "\\/")) %>%
#   dplyr::select(-filename) %>%
#   rename(total_ingredient_km2 = sum)


```


Bind species' tolerances to the full aoh impacted dataframe. 

```{r}
ag_suitability <- readRDS(here("prep/03_prep_spp_habitats/int/terrestrial_spp_habitat_suitability.rds"))

aoh_df <- impact_df_tidy %>%
  left_join(., ag_suitability, by = c("sciname" = "species")) %>%
  # left_join(crops_km2) %>%
  mutate(order = ifelse(is.na(order), "CHIROPTERA", order), # fix the spp with missing order
         spp_type = ifelse(order %in% c(mammals_list$order), "Terrestrial mammal", "Bird")) %>% # identifier for class type
  dplyr::select(-order) %>%
  rename(suitability = cropland_suitability)

saveRDS(aoh_df, here("prep/03_prep_spp_habitats/output/aoh_terrestrial_mammals_birds_impact.rds")) # save rds to save space

test <- aoh_df %>%
  ungroup() %>%
  dplyr::select(spp_type, sciname) %>%
  group_by(spp_type) %>%
  summarise(n_distinct(sciname)) ## ok missing a lot of species... is this because they aren't vulnerable? 

test_ag <- ag_suitability %>% 
  group_by(spp_type, cropland_suitability) %>%
  summarise(n_distinct(species))

2962 + 613 # 3575 species not vulnerable

7328+4548 # 11876

11876 + 3575 # 15451 total species 

## paper reports: 
10651 + 5481 # 16132.. ok so missing ~600 species.. not as bad as I thought 

length(unique(ag_suitability$species)) # 16133


```

  
Do some checks: 

```{r}
check_bird <- aoh_df %>%
  filter(sciname == "Accipiter brevipes")

check_aoh_1 <- rast("/mnt/rdsi/raw_data/AOH_lumbierres/reprojected/Accipiter_badius_B.tif") %>%
  filter(ex_Accipiter_badius_B != 0)
plot(check_aoh_1)
check_aoh_2 <- rast("/mnt/rdsi/raw_data/AOH_lumbierres/reprojected/Accipiter_badius_R.tif") %>%
    filter(ex_Accipiter_badius_R != 0)
plot(check_aoh_2)
check_aoh_3  <- rast("/mnt/rdsi/raw_data/AOH_lumbierres/reprojected/Accipiter_badius_N.tif") %>%
    filter(ex_Accipiter_badius_N != 0)
plot(check_aoh_3)

check_intersect <- intersect(check_aoh_1, check_aoh_2)
plot(check_intersect)
check_intersect <- intersect(check_aoh_1, check_aoh_3)
plot(check_intersect)
check_intersect <- intersect(check_aoh_2, check_aoh_3)
plot(check_intersect) # ok so looks like there is no/minimal intersection... additionally, the paper indicates that they can be combined and are separate, non-overlapping habitats. So probably no double counting occurring thankfully. 

  
check <- aoh_df %>%
  filter(aoh_affected >= total_cropland) # 0, makes sense! 
```

  