---
title: "Overlapping species AOH with feed crops"
output: html_document
editor_options: 
  chunk_output_type: console
---

## Setup

Load libraries

```{r setup, include=FALSE}

library(tidyverse)
library(here)
library(data.table)
library(dtplyr)
library(terra)
library(raster)
library(parallel)
library(rnaturalearth)
library(strex)
library(janitor)

source(here("src/directories.R"))

source(here("src/spatial.R"))

base_raster_ea <- rast(here("data/spatial/base_raster_gall_peters.tif")) ## ok so this is the 10km by 10km raster. We want to upscale all AOH rasters to this. 

select <- dplyr::select


```

Check to make sure we downloaded all of the AOH species maps from https://datadryad.org/stash/dataset/doi:10.5061/dryad.02v6wwq48


You can download by ssh into the rdsi storage and then running wget url_to_download

ssh ubuntu@131.217.178.173
cd ../../mnt/rdsi/raw_data/AOH_lumbierres
wget https://datadryad.org/stash/downloads/file_stream/1931890

unzip 1931890.zip

Above example is how to download mammals_rodentia.zip file. Link taken from https://datadryad.org/stash/dataset/doi:10.5061/dryad.02v6wwq48.


```{r}

## read in species lists from raw data dir 

mammals_list <-
  read.csv(file.path(rdsi_raw_data_dir, "AOH_lumbierres/Mammals_list_AOH.csv")) %>%
  clean_names() %>%
  dplyr::select(binomial, aoh_name, order) %>%
  mutate(type = "mammal")

birds_list <- read.csv(file.path(rdsi_raw_data_dir, "AOH_lumbierres/Birds_list_AOH.csv")) %>%
  clean_names() %>%
  dplyr::select(binomial, aoh_name, order) %>%
  mutate(type = "bird")


total_spp_list <- rbind(mammals_list, birds_list)

## now grab the names of the species from the raw data directory

files <- list.files(file.path(rdsi_raw_data_dir, "AOH_lumbierres"), pattern = ".tif")

spp_list_files <- str_before_last(files, ".tif") 

remove_suffix <- function(string) {
  modified_string <- sub("_[BNR]$", "", string)
  return(modified_string)
}

spp_list_files_fin <- remove_suffix(spp_list_files) %>%
  unique()


## now filter these spp out of the spp df 

missing_spp <- total_spp_list %>%
  filter(!(aoh_name %in% c(spp_list_files_fin)))

## ok I'm missing 1984 spp. 

sort(unique(missing_spp$order)) 

# [1] "CHIROPTERA"    "PASSERIFORMES"    


## I will redownload the zip files missing from here: https://datadryad.org/stash/dataset/doi:10.5061/dryad.02v6wwq48 and see if that helps the missing species...

unzip(file.path(rdsi_raw_data_dir, "AOH_lumbierres/1931870.zip"), exdir = here("test/"))


test <- rast(file.path(rdsi_raw_data_dir, "AOH_lumbierres/Aselliscus_tricuspidatus.tif"))

test_size <- cellSize(test, unit = "km")
plot(test_size)


```

Don't think I need to download this one: non migratory passeriformes: https://datadryad.org/stash/downloads/file_stream/1931825

Need to download migratory passeriformes: https://datadryad.org/stash/downloads/file_stream/1931854
Need to download chiroptera: https://datadryad.org/stash/downloads/file_stream/1931870



## Write up code to overlap the AOH maps with our crop maps 

Import threat data

```{r}

current_severe_threats_of_interest <- read_csv(here("data/tidy_data/iucn/current_severe_threats_of_interest.csv")) |> 
  rename(id_no = id)
  
#how many species fall in to te category of being affected by these threats? 12728 species
length(unique(current_severe_threats_of_interest$id_no))

#ongoing threats represent 93.9% of all threats
current_severe_threats_of_interest |> filter(result_timing == "Ongoing") |> nrow()/(current_severe_threats_of_interest |> nrow())



```

Overlap all species AOH with crop feed ingredient rasters!

```{r}

aoh_files <- list.files(file.path(rdsi_raw_data_dir, "AOH_lumbierres"), full.names = TRUE)
  
ingredient_files <- list.files(here("prep/02_feed/output/resampled"), full.names = TRUE, recursive = TRUE, pattern = "_A")

# chunk 1569, 7841 not working 
chunk_size = 112

for(i in seq(10529, length(aoh_files), chunk_size)) {
  # i = 1569

  chunk_aoh_files <- aoh_files[i:min(i + chunk_size -1, length(aoh_files))]

# Start timing
start_time <- proc.time()
  
chunk_terrestrial_aoh <- mclapply(X = chunk_aoh_files, FUN = \(this_spp){
  
    #isolate species
    #this spp id
    # this_spp <- aoh_files

    this_spp_name <- basename(tools::file_path_sans_ext(this_spp))
    
    this_spp_dt <- rast(this_spp) %>%
      project(moll_template, method = "near") %>%
      terra::as.data.frame(this_spp_raster, xy = TRUE) %>%  #get the xyz 
      mutate(sci_name = this_spp_name) %>% 
      rename(prescence = 3) %>% 
      filter(prescence == 1) %>% 
      lazy_dt()
    
    if(nrow(this_spp_dt) == 0){
      
      this_spp_dt <- rast(this_spp) %>%
      aggregate(fact = 10, fun = "mean", na.rm = TRUE) %>%  
      project(moll_template, method = "near") %>%
      terra::as.data.frame(this_spp_raster, xy = TRUE) %>%  #get the xyz 
      mutate(sci_name = this_spp_name) %>% 
      rename(prescence = 3) %>% 
      filter(prescence == 1) %>% 
      lazy_dt()
      
    }

  
  overlap_list <- map(ingredient_files, \(this_crop_ingredient){

      # this_crop_ingredient = ingredient_files[30]
  
  this_crop_ingredient_name <- str_before_nth(str_before_first(str_after_last(this_crop_ingredient, "/"), ".tif"), "_", 2)
    
  this_allocation_type <- str_before_last(str_after_nth(str_after_last(this_crop_ingredient, "/"), "_",  2), "_")
  
  this_diet_type <- str_before_last(str_after_nth(this_crop_ingredient, "/", 9), "/")
  
  message("processing terrestrial spp impacts in ", this_crop_ingredient_name, " for ", this_allocation_type, " for ", this_diet_type)
  
  this_crop_ingredient_raster <- terra::rast(this_crop_ingredient)
  
  this_crop_ingredient_dt <- terra::as.data.frame(this_crop_ingredient_raster, xy=TRUE) |> 
    rename(crop_area = 3) |> 
    mutate(cell_area = 102.6423) %>% 
   # filter(crop_area > 0) %>% # keeping in areas without any overlap for now... Time difference is minimal ~1 second
    lazy_dt() 
  
    #inner join species and crop files so we know if they overlap and summarise the crop portion of spp habitat
    spp_crop_overlap <-  this_spp_dt |> 
      inner_join(this_crop_ingredient_dt, by = c("x", "y")) %>% 
      group_by(sci_name) |> 
      summarise(prop_aoh_affected = sum(crop_area)/sum(cell_area),
                crop_area_overlap_total = sum(crop_area),
                aoh_total = sum(cell_area)) |> 
      mutate(allocation = this_allocation_type,
             crop_ingredient = this_crop_ingredient_name, 
             diet = this_diet_type) 
    
    as.data.frame(spp_crop_overlap)
    
  
  })
  
  return(bind_rows(overlap_list))
  
},  mc.cores = detectCores()-2)
  

full_df <- bind_rows(chunk_terrestrial_aoh) %>% as_tibble()

saveRDS(full_df, here(sprintf("prep/03_prep_spp_habitats/int/aoh_overlay_chunks/full_df_chunk_%s.rds", i)))

# End timing
end_time <- proc.time()

# Calculate the elapsed time
elapsed_time <- end_time - start_time

# Print the elapsed time
print(elapsed_time)

print(paste("chunk ", i, " out of 15233 finished"))

}


```

```{r}
test_chunk <- readRDS(here("prep/03_prep_spp_habitats/int/aoh_overlay_chunks/full_df_chunk_1592.rds"))
```





Match AOH names to spp ids from IUCN 

```{r}



```



Make a plot! 

```{r}
countries_shp <- ne_countries(scale = 110, returnclass = "sf") |> st_transform(crs(moll_template)) 

brazil_shp <- countries_shp |> filter(geounit %in% c("Brazil", "Peru", "Ecuador", "Chile", "Colombia", "Argentina", "Paraguay", "Uruguay", "Bolivia", "Venezuela", "Guyana", "French Guiana", "Panama", "Costa Rica", "Suriname"))

us_can_shp <- countries_shp %>% filter(geounit %in% c("United States of America", "Canada", "Mexico"))

test <- crop(this_crop_ingredient_raster, us_can_shp)
test[test == 0] <- NA
test2 <- crop(this_spp_raster, us_can_shp)
 
spp_crop_overlap_plot <-  this_spp_dt |> 
      inner_join(this_crop_ingredient_dt, by = c("x", "y")) %>%
  as.data.frame() %>%
  filter(crop_area >0)

ingredient_df <- this_crop_ingredient_dt %>% filter(crop_area >0)

(p <- ggplot()+
geom_sf(data = us_can_shp, fill="grey", colour="white")+
 # geom_tile(data = this_spp_dt %>% as.data.frame(), aes(x=x, y=y, fill = ex_Myrmecophaga_tridactyla), color = "darkgreen") +
  geom_tile(data = spp_crop_overlap_plot, aes(x = x, y = y, fill = crop_area))+
 scale_fill_gradientn(colors = RColorBrewer::brewer.pal(n=9, name = "BuPu"))+
  theme_bw() +
    theme(title = element_text(size=7))+
    labs(fill = paste(this_crop_ingredient_name, "km2"), title = this_spp_name)) ## soy production  not showing for some reason...

# ggsave(filename = here("data/int/explore/explore_brazil_species_impacts.jpg"), device = "jpg", dpi=300, height = 20, width = 15, units =  "cm")

 
ggplot() +
  geom_sf(data = us_can_shp, fill="grey", colour="white")+
   # geom_tile(data = this_spp_dt %>% as.data.frame(), aes(x=x, y=y, fill = prescence), color = "darkgreen") +
  geom_tile(data = as.data.frame(test, xy=TRUE) %>% as.data.frame(), aes(x=x, y=y, fill = layer)) +  scale_fill_gradientn(colors = RColorBrewer::brewer.pal(n=9, name = "BuPu"))+
  theme_bw() +
    theme(title = element_text(size=7))+
    labs(fill = paste(this_crop_ingredient_name, "km2"))


```



ARCHIVE: 





```{r}

# test <- as.points(cellSize(moll_template, unit = "km")) %>% as.data.frame() %>% filter(area > 0) # mean area is 102.6423 km2 

moll_df <- as.points(moll_template) |> lazy_dt() 

aoh_files <- list.files(file.path(rdsi_raw_data_dir, "AOH_lumbierres"), full.names = TRUE)
  
ingredient_files <- list.files(here("prep/02_feed/output/resampled"), full.names = TRUE, recursive = TRUE, pattern = "_A")

# Start timing
start_time <- proc.time()
  
terrestrial_aoh <- mclapply(X = aoh_files, FUN = \(this_spp){
  
    #isolate species
    #this spp id
    # this_spp <- aoh_files[[7]]
    # this_spp <- str_subset(this_spp, "Ursus_americanus.tif")
    this_spp_name <- basename(tools::file_path_sans_ext(this_spp))
    
    #import raster

    # this_spp_raster <- rast(this_spp) 
    
    # crs(this_spp_raster) <- crs(moll_template)
    
    this_spp_raster <- rast(this_spp) %>%
      project(moll_template, method = "near") 

    #get the xyz file
    this_spp_dt <- terra::as.data.frame(this_spp_raster, xy = TRUE) %>% 
      mutate(sci_name = this_spp_name) %>% 
      rename(prescence = 3) %>% 
      filter(prescence == 1) %>% 
      lazy_dt()

  
  overlap_list <- map(ingredient_files, \(this_crop_ingredient){

      # this_crop_ingredient = ingredient_files[30]
  
  this_crop_ingredient_name <- str_before_nth(str_before_first(str_after_last(this_crop_ingredient, "/"), ".tif"), "_", 2)
    
  this_allocation_type <- str_before_last(str_after_nth(str_after_last(this_crop_ingredient, "/"), "_",  2), "_")
  
  this_diet_type <- str_before_last(str_after_nth(this_crop_ingredient, "/", 9), "/")
  
  message("processing terrestrial spp impacts in ", this_crop_ingredient_name, " for ", this_allocation_type, " for ", this_diet_type)
  
  this_crop_ingredient_raster <- terra::rast(this_crop_ingredient)
  
  this_crop_ingredient_dt <- terra::as.data.frame(this_crop_ingredient_raster, xy=TRUE) |> 
    rename(crop_area = 3) |> 
    mutate(cell_area = 102.6423) %>% 
   # filter(crop_area > 0) %>% # keeping in areas without any overlap for now... Time difference is minimal ~1 second
    lazy_dt() 
  
    #inner join species and crop files so we know if they overlap and summarise the crop portion of spp habitat
    spp_crop_overlap <-  this_spp_dt |> 
      inner_join(this_crop_ingredient_dt, by = c("x", "y")) %>% 
      group_by(sci_name) |> 
      summarise(prop_aoh_affected = sum(crop_area)/sum(cell_area),
                crop_area_overlap_total = sum(crop_area),
                aoh_total = sum(cell_area)) |> 
      mutate(allocation = this_allocation_type,
             crop_ingredient = this_crop_ingredient_name, 
             diet = this_diet_type) 
    
    as.data.frame(spp_crop_overlap)
    
  
  })
  
  return(bind_rows(overlap_list))
  
},  mc.cores = detectCores()-2)
  

full_df <- bind_rows(terrestrial_aoh) %>% 
  as_tibble()


# End timing
end_time <- proc.time()

# Calculate the elapsed time
elapsed_time <- end_time - start_time

# Print the elapsed time
print(elapsed_time)

```



