---
title: "Save maps a multitude of ways"
output: html_document
editor_options: 
  chunk_output_type: console
---

## Setup

Load libraries

```{r setup, include=FALSE}

library(tidyverse)
library(here)
library(data.table)
library(terra)
library(rnaturalearth)
library(strex)
library(janitor)
library(sf)
library(tools)
library(patchwork)
library(cowplot)
library(glue)
library(RColorBrewer)
library(ggpubr)
library(smoothr)
library(ggtext)
library(ggnewscale)

source(here("src/directories.R"))

source(here("src/spatial.R"))

setwd(dirname(rstudioapi::getSourceEditorContext()$path)) # set working directory to where this script is located
this_dir <- getwd()

biodiv_dir <- file.path(rdsi_dir, "biodiversity_impacts")

impact_maps_dir <- file.path(biodiv_dir, "output")

globe_bbox <- rbind(c(-180, -90), c(-180, 90), 
                      c(180, 90), c(180, -90), c(-180, -90)) 

globe_border <- st_polygon(list(globe_bbox)) %>%
  st_sfc(crs = 4326) %>%
  st_sf(data.frame(rgn = 'globe', geom = .)) %>%
  smoothr::densify(max_distance = 0.5) %>%
  st_transform(crs = crs(moll_template))


```

```{r establish color palettes and themes}

## establish color palette from food footprint project
d_brown <- "#515256"
m_brown <- "#B27B54"
l_brown <- "#BC995F"
green <- "#A8B072"
yellow<- "#EFCE71"
l_yellow <- "#F7F6C1"

jv_pal <- c(l_yellow, yellow, green, l_brown, m_brown, d_brown)

continuous_pal <-  colorRampPalette(jv_pal, space="Lab", bias = 3.5)(10000)
image(volcano, asp=1, col=continuous_pal)

light_gray <- "#F8F9FA"
final_palette <- c(light_gray, continuous_pal)
image(volcano, asp=1, col=final_palette)

palette_red <- c(final_palette, "#B90000")
image(volcano, asp=1, col=palette_red)


countries_shp <- ne_countries(scale = 110, returnclass = "sf") |> 
  st_transform(crs(moll_template)) # read in countries shapefile

theme_ohara <- function(base_size = 9) {
  theme(axis.ticks = element_blank(),
        text             = element_text(family = 'Helvetica',
                                        color = 'gray30', size = base_size),
        plot.title       = element_text(size = rel(1.25), hjust = 0, face = 'bold'),
        panel.background = element_blank(),
        legend.position  = 'right',
        panel.border     = element_blank(),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_line(colour = 'grey90', size = .25),
        legend.key       = element_rect(colour = NA, fill = NA),
        axis.line        = element_blank())
}


```

Read in marine and terrestrial dfs and combine

```{r}
marine_overlap <- readRDS(here("prep/03_prep_spp_habitats/output/aoh_marine_impact.rds")) %>%
    dplyr::select(sciname, spp_type, diet, fcr_type, allocation, ingredient, vulnerability, impact_total, total_hab_area)


terrestrial_overlap <- readRDS(here("prep/03_prep_spp_habitats/output/aoh_terrestrial_impact.rds")) %>% 
    dplyr::select(sciname, spp_type, diet, fcr_type, allocation, ingredient, vulnerability, impact_total, total_hab_area)

all_overlap <- rbind(marine_overlap, terrestrial_overlap)

hab_areas <- all_overlap %>% 
  distinct(sciname, spp_type, total_hab_area)

saveRDS(hab_areas, here("prep/03_prep_spp_habitats/output/all_spp_hab_areas.rds")) 

all_overlap <- all_overlap %>%
  dplyr::select(-total_hab_area)

# write_rds(all_overlap, here("prep/03_prep_spp_habitats/output/aoh_spp_impacts.rds")) # was saving this, but it is too big for github i believe

spp_impacted <- all_overlap %>%
  group_by(spp_type, diet, allocation, fcr_type) %>%
  summarise(spp_count_impacted = n_distinct(sciname)) %>%
  ungroup()


aquamaps_spp <- readRDS(file.path(rdsi_dir, "biodiversity_impacts/int/spp_vuln_depth_info.rds")) %>%
  distinct(spp_type = taxon, sciname = species)
  
eyres_spp <- readRDS(here("prep/03_prep_spp_habitats/data/iucn/eyres_iucn_spp.rds")) %>%
  dplyr::select(spp_type, sciname = scientific_name) %>%
  mutate(sciname = tolower(sciname)) %>%
  mutate(spp_type = case_when(
    spp_type == "mammals" ~ "Terrestrial mammal",
    spp_type == "amphibians" ~ "Amphibians", 
    spp_type == "reptiles" ~ "Reptiles", 
    spp_type == "birds" ~ "Bird"
  ))

spp_assessed <- rbind(aquamaps_spp, eyres_spp) %>%
  group_by(spp_type) %>%
  summarise(spp_count_assessed = n_distinct(sciname)) %>%
  ungroup()
```

Maps!

Global maps across ingredients and taxon; Delta datasets as well

```{r}
## only need to save RDS when impact maps info has changed
allocations <- c("ge", "mass", "economic")

for(allocation_type in allocations){

 # allocation_type = "economic"

global_maps_list <- list.files(file.path(impact_maps_dir, "impact_maps_across_taxon_ingredient"), pattern = allocation_type, recursive = TRUE, full.names = TRUE)

global_maps_mean <- rast(global_maps_list)
names(global_maps_mean) <- file_path_sans_ext(str_after_nth(global_maps_list, "\\/", 6))


all_df <- as.data.frame(global_maps_mean, xy = TRUE) %>%
  pivot_longer(cols = c(3:ncol(.)), values_to = "value", names_to = "type") %>%
  separate_wider_delim(type, delim = "/", names = c("diet", "fcr_type", "calc_type")) %>%
  rename(long = x, lat = y)

# %>%
#   filter(str_detect(calc_type, "mean_prop"))

for(i in unique(all_df$calc_type)){
  # i = "economic_mean_prop"

  loop_df <- all_df %>%
    filter(calc_type == i) 

data.table::fwrite(loop_df, glue(file.path(impact_maps_dir, "csvs/impact_maps_across_taxon_ingredient/{i}.rds.gz")))


  delta_df <- loop_df %>%
      pivot_wider(names_from = c(diet), values_from = value) %>%
    mutate(`fish-dominant` = ifelse(is.na(`fish-dominant`), 0, `fish-dominant`),
           `plant-dominant` = ifelse(is.na(`plant-dominant`), 0, `plant-dominant`)) %>%
  mutate(delta = (`fish-dominant` - `plant-dominant`)) %>%
    mutate(delta_cat = case_when(
      delta > 0 ~ "Fish-dominant",
      delta < 0 ~ "Plant-dominant",
      delta == 0 ~ "No difference"
    ))


data.table::fwrite(delta_df, glue(file.path(impact_maps_dir, "csvs/impact_maps_across_taxon_ingredient/delta/{i}.rds.gz")))

}
}



## make plots showing impacts for each scenario 

allocation_types <- c("mass", "economic", "ge")  
calc_types <- c("mean", "nspp", "sd")
calc_types_2 <- c("_prop", "")
types_df <- expand.grid(allocation_types, calc_types, calc_types_2) %>%
  unite(new_var, Var1:Var2, sep = "_") %>%
    unite(new_var, new_var:Var3, sep = "") %>%
  pull(new_var) %>%
  unique()

types_df <- types_df[!grepl("nspp_prop", types_df)]

diets <- c("fish-dominant", "plant-dominant")
fcrs <- c("regular", "efficient")

# types_df <- grep(pattern = "mean_prop", types_df, value = TRUE)

for(type in types_df){
  
  # type = "economic_mean_prop"
  
 filepath <- glue(file.path(impact_maps_dir, "csvs/impact_maps_across_taxon_ingredient/{type}.rds.gz"))

loop_df <-  fread(filepath) 

if(str_detect(type, "mean")){
  
  if(str_detect(type, "_prop")){
  fill_name = "Proportion\nhabitat\nimpacted"
  }else{
    fill_name = "Extinction\nRisk"
  }
  
  plot_list <- list()
  
  for(diet_type in diets){
    for(fcr in fcrs){

      # diet_type = "plant-dominant"
      # fcr = "efficient"
      
  loop_loop_df <- loop_df %>%
    filter(diet == diet_type, 
           fcr_type == fcr)
  
quantile_value <- quantile(loop_loop_df$value, probs = 0.999, na.rm = TRUE)
  
  loop_loop_df <- loop_loop_df %>% 
    mutate(value_new = ifelse(value > quantile_value, quantile_value, value))
  
  loop_plot <-  ggplot() + 
      geom_tile(data = loop_loop_df, aes(x = long, y = lat, fill = value_new, color = value_new)) +
     geom_tile(fill = ifelse(loop_loop_df$value_new < quantile_value, "#B90000", NA)) + 
            geom_sf(data = countries_shp, fill = NA, colour = "grey") + 
       scale_fill_gradientn(colors = palette_red, na.value = "white") +
            scale_color_gradientn(colors = palette_red, na.value = "white") +
            geom_sf(data = globe_border,
            fill = NA, color = 'grey70', 
            size = .1) +
    scale_x_continuous(expand = c(0, 0)) +
    scale_y_continuous(expand = c(0, 0)) +
    theme_void() +
      theme(plot.title = element_text(hjust = 0.5), 
          axis.title = element_blank(),
          axis.text = element_blank(),
          axis.ticks = element_blank(),
          legend.margin = margin(r = 10)) + # add a margin to legend text so it isn't cut off when saving 
  labs(fill = fill_name,
      # color = "≥99th quantile",
       title = glue("{diet_type}, {fcr}")) + 
     guides(color = "none")
   # + 
    #   guides(color = guide_legend(override.aes = list(fill = "#B90000")))
        
      plot_list[[length(plot_list) + 1]] <- loop_plot

    }
  } 

ggsave(glue(here(this_dir, "output/plots/{type}_plot.png")), plot = plot_grid(plotlist = plot_list, nrow = 2), width = 10, height = 8, bg = "white")

}else{
  
 # type = "ge_sd_prop"
  
 if(str_detect(type, "nspp")){
    fill_name = "Number of\nspecies\nimpacted"
  }else{
    fill_name = "sdev"
  }
  
    plot_list <- list()
  
    for(diet_type in diets){
    for(fcr in fcrs){
  
loop_loop_df <- loop_df %>%
    filter(diet == diet_type, 
           fcr_type == fcr)

  
  loop_plot <-  ggplot() + 
      geom_tile(data = loop_loop_df, aes(x = long, y = lat, fill = value, color = value)) +
            geom_sf(data = countries_shp, fill = NA, colour = "grey") + 
       scale_fill_gradientn(colors = final_palette, na.value = "white") +
            scale_color_gradientn(colors = palette_red, na.value = "white") +
            geom_sf(data = globe_border,
            fill = NA, color = 'grey70', 
            size = .1) +
    scale_x_continuous(expand = c(0, 0)) +
    scale_y_continuous(expand = c(0, 0)) +
    theme_void() +
      theme(plot.title = element_text(hjust = 0.5), 
          axis.title = element_blank(),
          axis.text = element_blank(),
          axis.ticks = element_blank(),
          legend.margin = margin(r = 10)) + 
  labs(fill = fill_name,
       title = glue("{diet_type}, {fcr}")) + 
     guides(color = "none")
        
      plot_list[[length(plot_list) + 1]] <- loop_plot
    }
    }
  
ggsave(glue(here(this_dir, "output/plots/{type}_plot.png")), plot = plot_grid(plotlist = plot_list, nrow = 2), width = 10, height = 8, bg = "white")

}

}

```

Global maps across ingredients per taxon - there is an if statement within each loop that will skip if the files exists. If you want to rerun all of the files you will need to comment that out.

```{r}

allocations <- c("economic", "ge", "mass")
calc_types <- c("mean", "sd", "nspp", "mean_prop", "sd_prop")
taxon <- all_overlap %>% 
  filter(spp_type != "polychaetes") %>% 
  pull(spp_type) %>% unique()

## this part only needs to be run if the source maps changed! 
for(allocation_type in allocations){
    for(taxa_type in taxon){

# allocation_type = "mass"
#  taxa_type = "cnidaria"
      
  #      if(all(c(file.exists(glue(file.path(impact_maps_dir, "csvs/impact_maps_by_taxon_across_ingredient/{allocation_type}_{taxa_type}_mean.rds.gz"))), 
  #         file.exists(glue(file.path(impact_maps_dir, "csvs/impact_maps_by_taxon_across_ingredient/{allocation_type}_{taxa_type}_mean_prop.rds.gz"))),
  #         file.exists(glue(file.path(impact_maps_dir, "csvs/impact_maps_by_taxon_across_ingredient/{allocation_type}_{taxa_type}_sd_prop.rds.gz"))),
  #         file.exists(glue(file.path(impact_maps_dir, "csvs/impact_maps_by_taxon_across_ingredient/{allocation_type}_{taxa_type}_nspp.rds.gz"))),
  #         file.exists(glue(file.path(impact_maps_dir, "csvs/impact_maps_by_taxon_across_ingredient/{allocation_type}_{taxa_type}_sd.rds.gz"))))
  #         )){
  # 
  #   cat("file exists")
  #   next()
  # }else{
  #   cat(glue("running {allocation_type} {taxa_type}"))
  # }

global_maps_list <- list.files(file.path(impact_maps_dir, "impact_maps_by_taxon_across_ingredient"), pattern = glue("{allocation_type}_{taxa_type}"), recursive = TRUE, full.names = TRUE)

stack_rast <- rast()

for(file in global_maps_list){
  # file <- global_maps_list[[1]]

  rast_1 <- rast(file) %>%
    project(., moll_template, method = "near")

  stack_rast <- c(stack_rast, rast_1)
}

names(stack_rast) <- file_path_sans_ext(str_after_nth(global_maps_list, "\\/", 6))


all_df <- terra::as.data.frame(stack_rast, xy = TRUE) %>%
  pivot_longer(cols = c(3:ncol(.)), values_to = "value", names_to = "type") %>%
  filter(!is.na(value)) %>%
  separate_wider_delim(type, delim = "/", names = c("diet", "fcr_type", "taxa_calc_type")) %>%
  separate_wider_delim(taxa_calc_type, delim = "_", names = c("allocation", "taxa", "calc_type"), too_many = "merge") %>%
  rename(long = x, lat = y) 
# %>%
#   filter(str_detect(calc_type, "mean_prop")) # comment this out if you want to run a specific calc_type only

for(i in unique(all_df$calc_type)){

  # i = "nspp"

  # if(file.exists(glue(file.path(impact_maps_dir, "csvs/impact_maps_by_taxon_across_ingredient/{allocation_type}_{taxa_type}_{i}.rds.gz")))){
  # 
  #   cat("file exists")
  #   next()
  # }else{
  #   cat(glue("running {i} {allocation_type} {taxa_type}"))
  # }

  loop_df <- all_df %>%
    filter(calc_type == i) %>%
    filter(!is.na(value))

  data.table::fwrite(loop_df, glue(file.path(impact_maps_dir, "csvs/impact_maps_by_taxon_across_ingredient/{allocation_type}_{taxa_type}_{i}.rds.gz")))

  
    delta_df <- loop_df %>%
      pivot_wider(names_from = c(diet, taxa), values_from = value) %>%
    rename_with(
      ~ case_when(
        str_detect(., "fish-dominant") ~ "fish-dominant",
        str_detect(., "plant-dominant") ~ "plant-dominant",
        TRUE ~ .)
      ) %>%
    mutate(`fish-dominant` = ifelse(is.na(`fish-dominant`), 0, `fish-dominant`),
           `plant-dominant` = ifelse(is.na(`plant-dominant`), 0, `plant-dominant`)) %>%
  mutate(delta = (`fish-dominant` - `plant-dominant`))
  
data.table::fwrite(delta_df, glue(file.path(impact_maps_dir, "csvs/impact_maps_by_taxon_across_ingredient/delta/{allocation_type}_{taxa_type}_{i}.rds.gz")))
  
      }
    }
  }

diets <- c("fish-dominant", "plant-dominant")
fcrs <- c("regular", "efficient")
     
  
# make and save plots across ingredients per taxon  

for(allocation_type in allocations){
    for(taxa_type in taxon){
      for(type in calc_types){
# 
# allocation_type = "economic"
# taxa_type = "Bird"
# type = "sd_prop"

        loop_df <- fread(glue(file.path(impact_maps_dir, "csvs/impact_maps_by_taxon_across_ingredient/{allocation_type}_{taxa_type}_{type}.rds.gz"))) %>%
          filter(!is.na(value))

if(str_detect(type, "mean")){
  
  if(str_detect(type, "_prop")){
  fill_name = "Proportion\nhabitat\nimpacted"
  }else{
    fill_name = "Extinction\nRisk"
  }
  
  plot_list <- list()
  
  for(diet_type in diets){
    for(fcr in fcrs){

      # diet_type = "plant-dominant"
      # fcr = "efficient"
      
  loop_loop_df <- loop_df %>%
    filter(diet == diet_type, 
           fcr_type == fcr)
  
quantile_value <- quantile(loop_loop_df$value, probs = 0.999, na.rm = TRUE)
  
  loop_loop_df <- loop_loop_df %>% 
    mutate(value_new = ifelse(value > quantile_value, quantile_value, value))
  
  loop_plot <-  ggplot() + 
      geom_tile(data = loop_loop_df, aes(x = long, y = lat, fill = value_new, color = value_new)) +
     geom_tile(fill = ifelse(loop_loop_df$value_new < quantile_value, "#B90000", NA)) + 
            geom_sf(data = countries_shp, fill = NA, colour = "grey") + 
       scale_fill_gradientn(colors = palette_red, na.value = "white") +
            scale_color_gradientn(colors = palette_red, na.value = "white") +
            geom_sf(data = globe_border,
            fill = NA, color = 'grey70', 
            size = .1) +
    scale_x_continuous(expand = c(0, 0)) +
    scale_y_continuous(expand = c(0, 0)) +
    theme_void() +
      theme(plot.title = element_text(hjust = 0.5), 
          axis.title = element_blank(),
          axis.text = element_blank(),
          axis.ticks = element_blank(),
          legend.margin = margin(r = 10)) + # add a margin to legend text so it isn't cut off when saving 
  labs(fill = fill_name,
      # color = "≥99th quantile",
       title = glue("{diet_type}, {fcr}")) + 
     guides(color = "none")
   # + 
    #   guides(color = guide_legend(override.aes = list(fill = "#B90000")))
        
      plot_list[[length(plot_list) + 1]] <- loop_plot

    }
  } 

ggsave(glue(here(this_dir, "output/plots/by_taxa/{allocation_type}_{taxa_type}_{type}_plot.png")), plot = plot_grid(plotlist = plot_list, nrow = 2), width = 10, height = 8, bg = "white")

}else{
  
 # type = "ge_sd_prop"
  
 if(str_detect(type, "nspp")){
    fill_name = "Number of\nspecies\nimpacted"
  }else{
    fill_name = "sdev"
  }
  
    plot_list <- list()
  
    for(diet_type in diets){
    for(fcr in fcrs){
  
loop_loop_df <- loop_df %>%
    filter(diet == diet_type, 
           fcr_type == fcr)

  
  loop_plot <-  ggplot() + 
      geom_tile(data = loop_loop_df, aes(x = long, y = lat, fill = value, color = value)) +
            geom_sf(data = countries_shp, fill = NA, colour = "grey") + 
       scale_fill_gradientn(colors = final_palette, na.value = "white") +
            scale_color_gradientn(colors = palette_red, na.value = "white") +
            geom_sf(data = globe_border,
            fill = NA, color = 'grey70', 
            size = .1) +
    scale_x_continuous(expand = c(0, 0)) +
    scale_y_continuous(expand = c(0, 0)) +
    theme_void() +
      theme(plot.title = element_text(hjust = 0.5), 
          axis.title = element_blank(),
          axis.text = element_blank(),
          axis.ticks = element_blank(),
          legend.margin = margin(r = 10)) + 
  labs(fill = fill_name,
       title = glue("{diet_type}, {fcr}")) + 
     guides(color = "none")
        
      plot_list[[length(plot_list) + 1]] <- loop_plot
    }
    }
    
    ggsave(glue(here(this_dir, "output/plots/by_taxa/{allocation_type}_{taxa_type}_{type}_plot.png")), plot = plot_grid(plotlist = plot_list, nrow = 2), width = 10, height = 8, bg = "white")

    }
  }
    }
}


```

Global maps by ingredients across taxon

```{r}

allocations <- c("economic", "ge", "mass")
calc_types <- c("mean", "sd", "nspp", "sd_prop", "mean_prop")
ingredients <- all_overlap %>% 
  pull(ingredient) %>% unique()

## this loop only needs to be run if the source impact maps are updated! 
for(allocation_type in allocations){
  for(ingredient_type in ingredients){

      # ingredient_type = "Soybean_soybean meal"
      # allocation_type = "economic"
      # type = "mean"

global_maps_list <- list.files(file.path(impact_maps_dir, "impact_maps_across_taxon_by_ingredient"), pattern = glue("{allocation_type}_{ingredient_type}"), recursive = TRUE, full.names = TRUE)

stack_rast <- rast()

for(file in global_maps_list){
  # file <- global_maps_list[[1]]

  rast_1 <- rast(file) %>%
    project(., moll_template, method = "near")

  stack_rast <- c(stack_rast, rast_1)
}

names(stack_rast) <- file_path_sans_ext(str_after_nth(global_maps_list, "\\/", 6))


all_df <- as.data.frame(stack_rast, xy = TRUE) %>%
  pivot_longer(cols = c(3:ncol(.)), values_to = "value", names_to = "type") %>%
  separate_wider_delim(type, delim = "/", names = c("diet", "fcr_type", "ingredient_calc_type")) %>%
    separate_wider_delim(ingredient_calc_type, delim = "_", names = c("allocation", "raw_material", "ingredient", "calc_type"), too_many = "merge") %>%
  rename(long = x, lat = y) %>%
  filter(!is.na(value)) %>%
  unite("crop_ingredient", c(raw_material:ingredient), sep = "_", remove = FALSE) 


for(i in unique(all_df$calc_type)){
  # i = "mean"

  loop_df <- all_df %>%
    filter(calc_type == i) %>%
    filter(!is.na(value))

  data.table::fwrite(loop_df, glue(file.path(impact_maps_dir, "csvs/impact_maps_across_taxon_by_ingredient/{allocation_type}_{ingredient_type}_{i}.rds.gz")))
  
  
          delta_df <- loop_df %>%
          filter(!is.na(value)) %>%
          dplyr::select(long, lat, fcr_type, allocation, crop_ingredient, calc_type, diet, value) %>%
          filter(crop_ingredient == ingredient_type)

  
  delta_df <- delta_df %>%
      pivot_wider(names_from = c(diet, crop_ingredient), values_from = value) %>%
    rename_with(
      ~ case_when(
        str_detect(., "fish-dominant") ~ "fish-dominant",
        str_detect(., "plant-dominant") ~ "plant-dominant",
        TRUE ~ .)
      ) 
  
  if(!("fish-dominant" %in% c(colnames(delta_df)))){
    
    delta_df <- delta_df %>%
      mutate(`fish-dominant` = 0)
  }else if(!("plant-dominant" %in% c(colnames(delta_df)))){
        delta_df <- delta_df %>%
      mutate(`plant-dominant` = 0)
  }
  
  delta_df <- delta_df %>% 
  mutate(`fish-dominant` = coalesce(`fish-dominant`, 0),
         `plant-dominant` = coalesce(`plant-dominant`, 0)) %>%
  mutate(delta = (`fish-dominant` - `plant-dominant`)) 
  

  
  data.table::fwrite(loop_df, glue(file.path(impact_maps_dir, "csvs/impact_maps_across_taxon_by_ingredient/delta/{allocation_type}_{ingredient_type}_{i}.rds.gz")))


   }
  }
}



for(allocation_type in allocations){
    for(ingredient_type in ingredients){
      for(type in calc_types){
        
      # ingredient_type = "Soybean_soybean meal"
      # allocation_type = "economic"
      # type = "sd_prop"
        
                loop_df <- fread(glue(file.path(impact_maps_dir, "csvs/impact_maps_across_taxon_by_ingredient/{allocation_type}_{ingredient_type}_{type}.rds.gz"))) 
 
diets <- unique(loop_df$diet)
  

if(str_detect(type, "mean")){
  
  if(str_detect(type, "_prop")){
  fill_name = "Proportion\nhabitat\nimpacted"
  }else{
    fill_name = "Extinction\nRisk"
  }
  
  plot_list <- list()
  
  for(diet_type in diets){
    for(fcr in fcrs){

      # diet_type = "plant-dominant"
      # fcr = "efficient"
      
  loop_loop_df <- loop_df %>%
    filter(diet == diet_type, 
           fcr_type == fcr)
  
quantile_value <- quantile(loop_loop_df$value, probs = 0.999, na.rm = TRUE)
  
  loop_loop_df <- loop_loop_df %>% 
    mutate(value_new = ifelse(value > quantile_value, quantile_value, value))
  
  loop_plot <-  ggplot() + 
      geom_tile(data = loop_loop_df, aes(x = long, y = lat, fill = value_new, color = value_new)) +
     geom_tile(fill = ifelse(loop_loop_df$value_new < quantile_value, "#B90000", NA)) + 
            geom_sf(data = countries_shp, fill = NA, colour = "grey") + 
       scale_fill_gradientn(colors = palette_red, na.value = "white") +
            scale_color_gradientn(colors = palette_red, na.value = "white") +
            geom_sf(data = globe_border,
            fill = NA, color = 'grey70', 
            size = .1) +
    scale_x_continuous(expand = c(0, 0)) +
    scale_y_continuous(expand = c(0, 0)) +
    theme_void() +
      theme(plot.title = element_text(hjust = 0.5), 
          axis.title = element_blank(),
          axis.text = element_blank(),
          axis.ticks = element_blank(),
          legend.margin = margin(r = 10)) + # add a margin to legend text so it isn't cut off when saving 
  labs(fill = fill_name,
      # color = "≥99th quantile",
       title = glue("{diet_type}, {fcr}")) + 
     guides(color = "none")
   # + 
    #   guides(color = guide_legend(override.aes = list(fill = "#B90000")))
        
      plot_list[[length(plot_list) + 1]] <- loop_plot

    }
  } 

ggsave(glue(here(this_dir, "output/plots/by_ingredient/{allocation_type}_{ingredient_type}_{type}_plot.png")), plot = plot_grid(plotlist = plot_list, nrow = 2), width = 10, height = 8, bg = "white")

}else{
  
 # type = "ge_sd_prop"
  
 if(str_detect(type, "nspp")){
    fill_name = "Number of\nspecies\nimpacted"
  }else{
    fill_name = "sdev"
  }
  
    plot_list <- list()
  
    for(diet_type in diets){
    for(fcr in fcrs){
  
loop_loop_df <- loop_df %>%
    filter(diet == diet_type, 
           fcr_type == fcr)

  
  loop_plot <-  ggplot() + 
      geom_tile(data = loop_loop_df, aes(x = long, y = lat, fill = value, color = value)) +
            geom_sf(data = countries_shp, fill = NA, colour = "grey") + 
       scale_fill_gradientn(colors = final_palette, na.value = "white") +
            scale_color_gradientn(colors = palette_red, na.value = "white") +
            geom_sf(data = globe_border,
            fill = NA, color = 'grey70', 
            size = .1) +
    scale_x_continuous(expand = c(0, 0)) +
    scale_y_continuous(expand = c(0, 0)) +
    theme_void() +
      theme(plot.title = element_text(hjust = 0.5), 
          axis.title = element_blank(),
          axis.text = element_blank(),
          axis.ticks = element_blank(),
          legend.margin = margin(r = 10)) + 
  labs(fill = fill_name,
       title = glue("{diet_type}, {fcr}")) + 
     guides(color = "none")
        
      plot_list[[length(plot_list) + 1]] <- loop_plot
    }
    }
    
    ggsave(glue(here(this_dir, "output/plots/by_ingredient/{allocation_type}_{ingredient_type}_{type}_plot.png")), plot = plot_grid(plotlist = plot_list, nrow = 2), width = 10, height = 8, bg = "white")

    }
  }
    }
}

```

Global maps by raw material across taxon

```{r}

allocations <- c("economic", "ge", "mass")
calc_types <- c("mean", "sd", "nspp", "sd_prop", "mean_prop")
ingredients <- all_overlap %>% pull(ingredient) %>% unique()
raw_mats <- all_overlap %>% mutate(raw_material = str_before_first(ingredient, "_")) %>% 
  # filter(!(raw_material %in% c("forage fish", "trimmings fish"))) %>% 
  pull(raw_material) %>% unique()

## for some reason didn't run all... need to split mean and mean_prop? 

## commented out code only needs to be run if the source impact maps are updated! 
for(allocation_type in allocations){
  for(raw_mat in raw_mats){
    for(type in calc_types){

# allocation_type = "economic"
# type = "mean_prop"
#  raw_mat = "Soybean"

    all_files <- list.files(file.path(impact_maps_dir, "csvs/impact_maps_across_taxon_by_ingredient"), pattern = glue("{allocation_type}_{raw_mat}_.*._{type}"), full.names = TRUE)


all_df <- map_dfr(all_files, ~fread(.x), header = TRUE)

all_df_fin <- all_df %>% 
  group_by(long, lat, diet, fcr_type, allocation, raw_material, calc_type) %>% 
  summarise(value = sum(value, na.rm = TRUE)) %>%
  ungroup() 

# test <- all_df_fin %>% group_by(diet, fcr_type, allocation) %>% summarise(sum = sum(value, na.rm = TRUE))


data.table::fwrite(all_df_fin, glue(file.path(impact_maps_dir, "csvs/impact_maps_across_taxon_by_raw_material/{allocation_type}_{raw_mat}_{type}.rds.gz")))


delta_df <- all_df_fin %>%
        pivot_wider(names_from = c(diet), values_from = value) 


  if(!("fish-dominant" %in% c(colnames(delta_df)))){
    
    delta_df <- delta_df %>%
      mutate(`fish-dominant` = 0)
  }else if(!("plant-dominant" %in% c(colnames(delta_df)))){
        delta_df <- delta_df %>%
      mutate(`plant-dominant` = 0)
  }

delta_df <- delta_df %>% 
  mutate(delta = (`fish-dominant` - `plant-dominant`)) 

data.table::fwrite(delta_df, glue(file.path(impact_maps_dir, "csvs/impact_maps_across_taxon_by_raw_material/delta/{allocation_type}_{raw_mat}_{type}.rds.gz")))

    }
  }
}



for(allocation_type in allocations){
    for(raw_mat in raw_mats){
      for(type in calc_types){
        
      # raw_mat = "forage fish"
      # allocation_type = "economic"
      # type = "mean_prop"
      
                loop_df <- fread(glue(file.path(impact_maps_dir, "csvs/impact_maps_across_taxon_by_raw_material/{allocation_type}_{raw_mat}_{type}.rds.gz"))) %>%
                  filter(calc_type == type)
 
diets <- unique(loop_df$diet)
  fcrs <- unique(loop_df$fcr_type)

if(str_detect(type, "mean")){
  
  if(str_detect(type, "_prop")){
  fill_name = "Proportion\nhabitat\nimpacted"
  }else{
    fill_name = "Extinction\nRisk"
  }
  
  plot_list <- list()
  
  for(diet_type in diets){
    for(fcr in fcrs){

      # diet_type = "plant-dominant"
      # fcr = "efficient"
      
  loop_loop_df <- loop_df %>%
    filter(diet == diet_type, 
           fcr_type == fcr)
  
quantile_value <- quantile(loop_loop_df$value, probs = 0.999, na.rm = TRUE)
  
  loop_loop_df <- loop_loop_df %>% 
    mutate(value_new = ifelse(value > quantile_value, quantile_value, value))
  
  loop_plot <-  ggplot() + 
      geom_tile(data = loop_loop_df, aes(x = long, y = lat, fill = value_new, color = value_new)) +
     geom_tile(fill = ifelse(loop_loop_df$value_new < quantile_value, "#B90000", NA)) + 
            geom_sf(data = countries_shp, fill = NA, colour = "grey") + 
       scale_fill_gradientn(colors = palette_red, na.value = "white") +
            scale_color_gradientn(colors = palette_red, na.value = "white") +
            geom_sf(data = globe_border,
            fill = NA, color = 'grey70', 
            size = .1) +
    scale_x_continuous(expand = c(0, 0)) +
    scale_y_continuous(expand = c(0, 0)) +
    theme_void() +
      theme(plot.title = element_text(hjust = 0.5), 
          axis.title = element_blank(),
          axis.text = element_blank(),
          axis.ticks = element_blank(),
          legend.margin = margin(r = 10)) + # add a margin to legend text so it isn't cut off when saving 
  labs(fill = fill_name,
      # color = "≥99th quantile",
       title = glue("{diet_type}, {fcr}")) + 
     guides(color = "none")
   # + 
    #   guides(color = guide_legend(override.aes = list(fill = "#B90000")))
        
      plot_list[[length(plot_list) + 1]] <- loop_plot

    }
  } 

ggsave(glue(here(this_dir, "output/plots/by_material/{allocation_type}_{raw_mat}_{type}_plot.png")), plot = plot_grid(plotlist = plot_list, nrow = 2), width = 10, height = 8, bg = "white")

}else{
  
 # type = "ge_sd_prop"
  
 if(str_detect(type, "nspp")){
    fill_name = "Number of\nspecies\nimpacted"
  }else{
    fill_name = "sdev"
  }
  
    plot_list <- list()
  
    for(diet_type in diets){
    for(fcr in fcrs){
  
loop_loop_df <- loop_df %>%
    filter(diet == diet_type, 
           fcr_type == fcr)

  
  loop_plot <-  ggplot() + 
      geom_tile(data = loop_loop_df, aes(x = long, y = lat, fill = value, color = value)) +
            geom_sf(data = countries_shp, fill = NA, colour = "grey") + 
       scale_fill_gradientn(colors = final_palette, na.value = "white") +
            scale_color_gradientn(colors = palette_red, na.value = "white") +
            geom_sf(data = globe_border,
            fill = NA, color = 'grey70', 
            size = .1) +
    scale_x_continuous(expand = c(0, 0)) +
    scale_y_continuous(expand = c(0, 0)) +
    theme_void() +
      theme(plot.title = element_text(hjust = 0.5), 
          axis.title = element_blank(),
          axis.text = element_blank(),
          axis.ticks = element_blank(),
          legend.margin = margin(r = 10)) + 
  labs(fill = fill_name,
       title = glue("{diet_type}, {fcr}")) + 
     guides(color = "none")
        
      plot_list[[length(plot_list) + 1]] <- loop_plot
    }
    }
    
    ggsave(glue(here(this_dir, "output/plots/by_material/{allocation_type}_{raw_mat}_{type}_plot.png")), plot = plot_grid(plotlist = plot_list, nrow = 2), width = 10, height = 8, bg = "white")

    }
  }
    }
}


```

Data check soybeans

```{r}

list.files(file.path(impact_maps_dir, "csvs/impact_maps_across_taxon_by_raw_material/delta/"))


soy_deltas <- data.table::fread(file.path(impact_maps_dir, "csvs/impact_maps_across_taxon_by_raw_material/delta/economic_Soybean_mean_prop.rds.gz")) %>%
  filter(fcr_type == "regular") %>%
  mutate(delta_cat = case_when(
    delta > 0 ~ "Fish-dominant", 
    delta < 0 ~ "Plant-dominant",
    delta == 0 ~ "No difference"
  )) %>%
  filter(delta != "No difference")



quantiles_delta_fish <- soy_deltas %>%
  filter(delta_cat == "Fish-dominant") %>%
  group_by(delta_cat) %>%
  summarise(q25 = quantile(delta, 0.25),
            q50 = quantile(delta, 0.50),
            q75 = quantile(delta, 0.75),
            q95 = quantile(delta, 0.95),
            q999 = quantile(delta, 0.999)) %>%
  ungroup()

quantiles_delta_plant <- soy_deltas %>%
  filter(delta_cat == "Plant-dominant") %>%
  group_by(delta_cat) %>%
  summarise(q25 = quantile(-1*delta, 0.25),
            q50 = quantile(-1*delta, 0.50),
            q75 = quantile(-1*delta, 0.75),
            q95 = quantile(-1*delta, 0.95),
            q999 = quantile(-1*delta, 0.999)) %>%
  ungroup() %>%
  mutate(across(2:6, ~.x*-1))

quantiles_delta <- rbind(quantiles_delta_plant, quantiles_delta_fish) # bind back together

delta_df_quant <- soy_deltas %>%
  left_join(quantiles_delta, by = "delta_cat") %>%
    mutate(category = case_when(
    abs(delta) < abs(q25) ~ "0-24",
    abs(delta) >= abs(q25) & abs(delta) < abs(q50) ~ "25-49",
    abs(delta) >= abs(q50) & abs(delta) < abs(q75) ~ "50-74",
    abs(delta) >= abs(q75) & abs(delta) < abs(q95) ~ "75-94",
    abs(delta) >= abs(q95) & abs(delta) < abs(q999) ~ "95-99.9",
    abs(delta) >= abs(q999) ~ "≥99.9"
  ))

# establish palettes for delta map 
plant_pal <- c(
      "0-24" = "#DBF1D5", 
    "25-49" = "#ADDEA7", 
    "50-74" = "#74C476", 
    "75-94" = "#37A055", 
    "95-99.9" = "#0B7734", 
    "≥99.9" = "#00441B"
)

fish_pal <- c(
      "0-24" = "#D6E5F4", 
    "25-49" = "#ABCFE5", 
    "50-74" = "#6BAED6", 
    "75-94" = "#3787C0", 
    "95-99.9" = "#105BA4", 
    "≥99.9" = "#08306B"
)

delta_df_quant_fis <- delta_df_quant %>% filter(delta_cat == "Fish-dominant")
delta_df_quant_fis$category <- factor(delta_df_quant_fis$category, levels = c("0-24", "25-49", "50-74", "75-94", "95-99.9", "≥99.9"))


delta_df_quant_plant <- delta_df_quant %>% filter(delta_cat == "Plant-dominant")
delta_df_quant_plant$category <- factor(delta_df_quant_plant$category, levels = c("0-24", "25-49", "50-74", "75-94", "95-99.9", "≥99.9"))


   delta_plot <-  ggplot() + 
      geom_tile(data = delta_df_quant_plant, aes(x = long, y = lat, fill = category, color = category)) +
        scale_fill_manual(values = plant_pal) +
    scale_colour_manual(values = plant_pal) +
    scale_x_continuous(expand = c(0, 0)) +
    scale_y_continuous(expand = c(0, 0)) +
     theme_ohara() + 
  labs() +
  guides(color = "none") +
          theme(legend.position = "none", 
                text = element_text(family = "Arial")) + 
     new_scale_color() +
     new_scale_fill() + 
           geom_tile(data = delta_df_quant_fis, aes(x = long, y = lat, fill = category, color = category)) +
             scale_fill_manual(values = fish_pal) +
                 geom_sf(data = countries_shp, fill = NA, colour = "grey", alpha = 0.2)  +
                 geom_sf(data = globe_border, fill = NA, colour = "grey") + 
    scale_colour_manual(values = fish_pal) +
       labs(fill = "Fish-dominant", x = "Difference of Impact by Quantile", y = "", title = "Soybean impacts") +
  guides(color = "none") + 
     theme(legend.position = "none", 
           axis.text.y = element_blank(), 
           axis.text.x = element_blank(),
           axis.title.x = element_text(size = 8, family = "Arial"),
           plot.margin = margin(t = 10, r = 10, b = 50, l = 10, unit = "pt"),
           text = element_text(family = "Arial", colour = "black"))
   
   fish_legend <- get_legend(ggplot() + 
      geom_tile(data = delta_df_quant_fis, aes(x = long, y = lat, fill = category, color = category)) +
             scale_fill_manual(values = fish_pal) +
              scale_colour_manual(values = fish_pal) +
                  labs(fill = "Fish-dominant") +
          guides(color = "none",
            fill = guide_legend(title.position = "bottom", title.hjust = 0.5, nrow = 1)) +
          theme(legend.position = "bottom", 
                  legend.title = element_text(size = 8),
                legend.text = element_text(size = 8), 
      text = element_text(family = "Arial", colour = "black"),
      legend.margin = margin(r = 10),
      legend.key.size = unit(4, "mm")))
   
   plant_legend <- get_legend(ggplot() + 
      geom_tile(data = delta_df_quant_plant, aes(x = long, y = lat, fill = category, color = category)) +
             scale_fill_manual(values = plant_pal) +
              scale_colour_manual(values = plant_pal) +
                  labs(fill = "Plant-dominant") +
          guides(color = "none",
            fill = guide_legend(title.position = "bottom", title.hjust = 0.5, nrow = 1)) +
          theme(legend.position = "bottom",
                legend.title = element_text(size = 8),
                legend.text = element_text(size = 8), 
                text = element_text(family = "Arial", colour = "black"), 
      legend.margin = margin(r = 10),
      legend.key.size = unit(4, "mm")))
     
   full_plot <- ggdraw() +
                draw_plot(delta_plot) +
                draw_plot(fish_legend, height = 0.25, width = 0.52) +
                draw_plot(plant_legend, height = 0.25, width = 1.54)
   
            ggsave(glue(here(this_dir, "output/plots/publication/SI/soybean_test.png")),
                plot = full_plot, 
                width = 180, height = 180, bg = "white", units = "mm")

            
            
## ok this isn't making sense to me...
            
## lets look at the soybean pressure rasters just to be sure...
            
            sbm_fd <- rast(here("prep/02_feed/output/fish-dominant/regular/Soybean_soybean meal_economic_A.tif"))
            plot(sbm_fd)
            
                        spc_pd <- rast(here("prep/02_feed/output/plant-dominant/regular/Soybean_soy protein concentrate_economic_A.tif"))
            plot(spc_pd)
```

