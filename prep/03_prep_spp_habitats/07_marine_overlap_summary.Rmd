---
title: "Summarize global marine AOH impacts per species"
name: "Gage Clawson"
date: "September 8, 2023"
output: html_document
editor_options: 
  chunk_output_type: console
---

## Summary 

In this script we prep a dataset of total global impacted habitat per marine species, ingredient, and allocation approach.

## Setup 

```{r setup, include=FALSE}

library(tidyverse)
library(here)
library(terra)
library(parallel)
library(strex)
library(janitor)
library(readxl)

source(here("src/directories.R"))

source(here("src/spatial.R"))


aquamaps_dir <- file.path(rdsi_raw_data_dir, "aquamaps")

```


Read in vulnerability data from [Butt et al. 2022](https://esajournals.onlinelibrary.wiley.com/doi/10.1002/ecs2.3919) and match to Aquamaps species. 
 - ~57% of the Aquamaps species do not have vulnerability scores. We will need to gapfill these. We will gapfill using the same method that the source data used (by genus and then family.)

```{r}
vuln_taxa <- readRDS(file.path(rdsi_dir, "biodiversity_impacts/int/spp_vuln_depth_info.rds")) %>%
  unite("ingredient", c(fish_type, ingredient), sep = "_") %>%
  mutate(ingredient = case_when(
    ingredient == "trimmings fish_fish meal" ~ "trimmings fish_fish meal, cut offs",
    ingredient == "trimmings fish_fish oil" ~ "trimmings fish_fish oil, cut offs",
    TRUE ~ ingredient
  ))


```

Pull total amount of ocean area fished (km2) for each allocation, diet, and aquafeed ingredient

```{r}
# file_list <- list.files(here("prep/02_feed/output/resampled"), full.names = TRUE, recursive = TRUE, pattern = "fish_.*_A") # 36 - good
# 
# rast_list <- rast(file_list)
# 
# names_list <- basename(file_list)
# 
# 
# fishing_km2 <- data.frame(feed_filepath = file_list, filename = names_list, total_km2 = global(rast_list, "sum", na.rm = TRUE)) %>%
#   mutate(allocation = str_after_last(str_before_last(filename, "_"), "_"),
#          ingredient = str_before_nth(filename, "_", 2),
#          diet = str_after_last(str_before_last(feed_filepath, "\\/"), "\\/")) %>%
#   dplyr::select(-filename) %>%
#   rename(total_ingredient_km2 = sum)


```

Now lets read in the intermediate overlay data, and apply our vulnerability metrics to this. Some rules:
 - If the raster is a forage fish FMFO raster, and a targeted forage fish species, then vulnerability is 1. 
 - If the raster is a trimmings fish FMFO raster, and a targeted trimmings fish species, then the vulnerability is 1. 
 - Otherwise the vulnerability is that of the Butt et al. 2022 data. 

```{r}

aquamaps_spp <- read.csv(file.path(rdsi_raw_data_dir, "aquamaps/GTE10_SPECIESOCCURSUM/speciesoccursum_gte10.csv"))


impact_df <- purrr::map_df(list.files(here("prep/03_prep_spp_habitats/int/aoh_impacts_marine"), full.names = TRUE, recursive = TRUE), readRDS) %>%
  left_join(aquamaps_spp %>% 
              unite(Genus, Species, sep = " ", col = "species") %>%
              mutate(species = tolower(species))
              ) 

length(unique(impact_df$SpeciesID)) # 19949 missing some spp.. however, we filtered out the species that aren't vulnerable, so this makes sense (see check that I did in the terrestrial overlap summary RMD)

setdiff(unique(aquamaps_spp$SpeciesID), unique(impact_df$SpeciesID))

spp_to_run <- setdiff(unique(aquamaps_spp$SpeciesID), unique(impact_df$SpeciesID)) 

test <- vuln_taxa %>% filter(SpeciesID %in% spp_to_run) # ok, all species that aren't vulnerable or there is no overlap/impact


impact_vuln <- impact_df %>%
  dplyr::group_by(species, diet, fcr_type, allocation, ingredient) %>%
  summarise(impact_total = sum(impact_total, na.rm = TRUE)) %>%
  ungroup() %>% 
  left_join(vuln_taxa) %>%
  dplyr::select(sciname= species, diet, fcr_type, allocation, ingredient, impact_total, vulnerability = vuln_quartile, spp_type = taxon, impact_total)
  
summary(impact_vuln) # no Nas in vulnerability

saveRDS(impact_vuln, here("prep/03_prep_spp_habitats/output/aoh_marine_impact.rds"))


## take al look at some stuff
terrestrial_overlap <- readRDS(here("prep/03_prep_spp_habitats/output/aoh_terrestrial_mammals_birds_impact.rds"))
colnames(terrestrial_overlap)


test_terr <- terrestrial_overlap %>%
  filter(diet == "plant-dominant",
         allocation == "mass")

sum(test_terr$impact_total, na.rm = TRUE) # 847173.8
mean(test_terr$impact_total, na.rm = TRUE) # 4.202438

test_marine <- impact_vuln %>%
    filter(diet == "plant-dominant",
         allocation == "mass")

sum(test_marine$impact_total, na.rm = TRUE) # 145315.6
mean(test_marine$impact_total, na.rm = TRUE) # 1.536951


```




