---
title: "Summary plots"
output: html_document
editor_options: 
  chunk_output_type: console
---

## Setup

Load libraries

```{r setup, include=FALSE}

library(tidyverse)
library(here)
library(data.table)
library(terra)
library(raster)
library(rnaturalearth)
library(strex)
library(janitor)
library(sf)
library(tools)
library(khroma)
library(scales)
library(fields)
library(patchwork)
library(cowplot)
library(glue)
library(viridis)

source(here("src/directories.R"))

source(here("src/spatial.R"))

select <- dplyr::select
setwd(dirname(rstudioapi::getSourceEditorContext()$path)) # set working directory to where this script is located
this_dir <- getwd()

aoh_dir <- file.path(rdsi_raw_data_dir, "AOH_lumbierres/reprojected_csvs/")

base_rast <- rast(res=0.5)
ext(base_rast) <- c(-180, 180, -90, 90)

# read in xy cell_id lookup table for land and ocean
ocean_xy_moll <- readRDS(file.path(this_dir, "data/spatial/moll_template_ocean_xy.rds"))
land_xy_moll <- readRDS(here(this_dir, "data/spatial/moll_template_land_xy.rds"))

impact_maps_dir <- file.path(rdsi_dir, "biodiversity_impacts/output")

```


Read in marine and terrestrial dfs and combine

```{r}
marine_overlap <- readRDS(here("prep/03_prep_spp_habitats/output/aoh_marine_impact.rds")) %>%
  group_by(sciname, spp_type, diet, allocation, ingredient) %>%
  summarise(vulnerability = mean(vulnerability, na.rm = TRUE), 
            impact_total = sum(impact_total, na.rm = TRUE)) %>%
  ungroup() %>%
    dplyr::select(sciname, spp_type, diet, allocation, ingredient, vulnerability, impact_total)


terrestrial_overlap <- readRDS(here("prep/03_prep_spp_habitats/output/aoh_terrestrial_mammals_birds_impact.rds")) %>% 
  group_by(sciname, diet, allocation, ingredient, spp_type) %>%
  summarise(vulnerability = 1 - mean(suitability, na.rm = TRUE),
            impact_total = sum(impact_total, na.rm = TRUE)) %>%
  ungroup() %>%
    dplyr::select(sciname, spp_type, diet, allocation, ingredient, vulnerability, impact_total)

all_overlap <- rbind(marine_overlap, terrestrial_overlap)

```

Lets make plots, just using economic allocation. 

```{r}
all_overlap <- all_overlap %>%
  filter(allocation == "economic")


## total AOH affected   
summary_df <- all_overlap %>%
  group_by(diet, allocation, ingredient) %>%
  summarise(impact_total = sum(impact_total, na.rm = TRUE)) %>%
  ungroup()

summary_df$ordered_ingredient <- with(summary_df, reorder(ingredient, impact_total, FUN = function(x) sum(x)))


ggplot(summary_df, aes(x = ordered_ingredient, y = impact_total)) + 
  geom_bar(stat = "identity") +
  theme_minimal() +
  facet_grid(diet~allocation, scales = "free_y") +
    coord_flip() +
  labs(title = "Global AOH Affected (39822 species)", x = "Raw material and Ingredient", y = expression(paste("Total AOH Affected (", km^{2}, ")"))) + 
      theme(axis.text.x = element_text(angle = -90, hjust = 1)) # Adjust the 'angle' value as needed


## Split by class total AOH
summary_df <- all_overlap %>%
  group_by(diet, allocation, ingredient, spp_type) %>%
  summarise(impact_total = sum(impact_total, na.rm = TRUE)) %>%
  ungroup() 

summary_df$ordered_ingredient <- with(summary_df, reorder(ingredient, impact_total, FUN = function(x) sum(x)))


muted <- color("muted")
light <- color("light")
light <- unname(c(light(9)))[c(2,3,4,6,9)]
muted <- unname(c(muted(9)))

muted_palette <- c(muted, light)


ggplot(summary_df, aes(x = ordered_ingredient, y = impact_total, fill = spp_type)) +
    geom_bar(stat = "identity", position = "dodge") +
  facet_grid(diet ~ allocation, scales = "free_y") +
  labs(title = "Global AOH Affected (39822 species)", x = "Raw material and Ingredient", y = expression(paste("Total AOH Affected (", km^{2}, ")")), fill = NULL) +
  # scale_fill_manual(values = category_colors) +
  scale_fill_manual(values = muted_palette) + 
  theme_minimal() + 
  coord_flip()  + 
    theme(axis.text.x = element_text(angle = -90, hjust = 1)) # Adjust the 'angle' value as needed



## Split by class average AOH
summary_df <- all_overlap %>%
  group_by(diet, allocation, ingredient, spp_type) %>%
  summarise(impact_total = mean(impact_total, na.rm = TRUE)) %>%
  ungroup() 

summary_df$ordered_ingredient <- with(summary_df, reorder(ingredient, impact_total, FUN = function(x) sum(x)))

ggplot(summary_df, aes(x = ordered_ingredient, y = impact_total, fill = spp_type)) +
    geom_bar(stat = "identity", position = "dodge") +
  facet_grid(diet ~ allocation, scales = "free_y") +
  labs(title = "Average AOH Affected (39822 species)", x = "Raw material and Ingredient", y = expression(paste("Average AOH Affected (", km^{2}, ")")), fill = NULL) +
    scale_fill_manual(values = muted_palette) +
  theme_minimal() + 
  coord_flip() 



## Split by class average AOH .. 
summary_df <- all_overlap %>%
  group_by(diet, allocation, spp_type) %>%
  mutate(species_count = n_distinct(sciname)) %>%
  summarise(nspp =  n_distinct(sciname), 
            impact_mean = mean(impact_total, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(impact_nspp_mean = impact_mean*nspp)

summary_df$spp_type <- with(summary_df, reorder(spp_type, impact_mean, FUN = function(x) sum(x)))


ggplot(summary_df, aes(x = spp_type, y = impact_mean, fill = spp_type)) +
    geom_bar(stat = "identity", position = "dodge") +
  facet_grid(diet ~ allocation, scales = "free") +
  theme_minimal() + 
  scale_fill_manual(values = muted_palette) + 
    labs(title = "Average AOH Affected (39822 species)", x = "Species Class", y = expression(paste("Average AOH Affected (", km^{2}, ")")), fill = NULL) +
  coord_flip()

```


Maps!

Global maps across ingredients and taxon 

```{r}
d_brown <- "#515256"
m_brown <- "#B27B54"
l_brown <- "#BC995F"
green <- "#A8B072"
yellow<- "#EFCE71"
l_yellow <- "#F7F6C1"

jv_pal <- c(l_yellow, yellow, green, l_brown, m_brown, d_brown)

continuous_pal <-  colorRampPalette(jv_pal, space="Lab", bias = 3.5)(10000)
image(volcano, asp=1, col=continuous_pal)

light_gray <- "#F8F9FA"
final_palette <- c(light_gray, continuous_pal)
image(volcano, asp=1, col=final_palette)

palette_red <- c(final_palette, "#B90000")
image(volcano, asp=1, col=palette_red)

# jv_pal_new <- jv_pal[7000:length(continuous_pal)]
# image(volcano, asp=1, col=jv_pal_new)

light_gray <- "#F8F9FA"
final_palette <- c(light_gray, continuous_pal)
scales::show_col(final_palette)

countries_shp <- ne_countries(scale = 110, returnclass = "sf") |> st_transform(crs(moll_template))

YlOrBr <- color("YlOrBr")
# plot_scheme(YlOrBr(9), colours = TRUE, size = 0.9)

## only need to save RDS when impact maps info has changed
allocations <- c("economic", "ge", "mass")

# for(allocation_type in allocations){
# 
#  # allocation_type = "mass"
# 
# global_maps_list <- list.files(file.path(impact_maps_dir, "impact_maps_across_taxon_ingredient"), pattern = allocation_type, recursive = TRUE, full.names = TRUE)
# 
# global_maps_mean <- rast(global_maps_list)
# names(global_maps_mean) <- file_path_sans_ext(str_after_nth(global_maps_list, "\\/", 6))
# 
# 
# all_df <- as.data.frame(global_maps_mean, xy = TRUE) %>%
#   pivot_longer(cols = c(3:8), values_to = "value", names_to = "type") %>%
#   separate_wider_delim(type, delim = "/", names = c("diet", "calc_type")) %>%
#   mutate(value =  ifelse(str_detect(calc_type, "mean"), log(value*1000000 + 1), value)) %>%
#   rename(long = x, lat = y)
# 
# for(i in unique(all_df$calc_type)){
# 
#   # i = "economic_mean"
# 
#   loop_df <- all_df %>%
#     filter(calc_type == i) %>%
#     filter(!is.na(value))
# 
# # write_rds(all_df, glue(file.path(impact_maps_dir, "csvs/impact_maps_across_taxon_ingredient/{allocation_type}.rds.gz")))
# 
# data.table::fwrite(loop_df, glue(file.path(impact_maps_dir, "csvs/impact_maps_across_taxon_ingredient/{i}.rds.gz")))
# 
# }
# }



allocation_types <- c("mass", "economic", "ge")  
calc_types <- c("mean", "nspp", "sd")
types_df <- expand.grid(allocation_types, calc_types) %>%
  unite(new_var, Var1:Var2, sep = "_") %>%
  pull(new_var) %>%
  unique()

diets <- c("fish-dominant", "plant-dominant")

for(type in types_df){
  
  # type = "economic_mean"
  
 filepath <- glue(file.path(impact_maps_dir, "csvs/impact_maps_across_taxon_ingredient/{type}.rds.gz"))

loop_df <-  fread(filepath) 
  
## create maps in separate plots, force common scale between them
maps <- map(.x = diets, 
            .f = function(x, y) 
  ggplot() + 
  geom_tile(data = loop_df  %>% filter(diet == x), aes(x= long, y = lat, fill = value)) +  # (exp(value) - 1) / 1000000)
      # scale_fill_gradientn(colors = YlOrBr(9), na.value = "white") +  # Set the color for missing values (NA) to white
   scale_fill_gradientn(colors = final_palette, na.value = "white") +
   #  scale_fill_viridis(direction = -1) + 
              geom_sf(data = countries_shp, fill = NA, colour = "grey") + 
  theme_minimal() +
      theme(
          axis.title = element_blank(),
          axis.text = element_blank(),
          axis.ticks = element_blank())
            )

ggsave(glue(here(this_dir, "output/plots/{type}_plot.png")), plot = plot_grid(plotlist = maps, labels = glue("{diets}:{type}"), label_size = 10, nrow = 2), width = 10, height = 8, bg = "white")

}

# test <- rast("/mnt/rdsi/biodiversity_impacts/output/impact_maps_across_taxon_ingredient/plant-dominant/economic_mean.tif")
# test[test <= 0.00001] <- NA
# plot(test, col = "red")
```

Global maps across ingredients per taxon 

```{r}

allocations <- c("economic", "ge", "mass")
calc_types <- c("mean", "sd", "nspp")
taxon <- all_overlap %>% filter(spp_type != "polychaetes") %>% pull(spp_type) %>% unique()

## this part only needs to be run if the source maps changed! 
# for(allocation_type in allocations){
#     for(taxa_type in taxon){
#       for(type in calc_types){
# 
#  # allocation_type = "economic"
#  #  taxa_type = "sponges"
# 
#       out_fstem <- glue(file.path(impact_maps_dir, "csvs/impact_maps_by_taxon_across_ingredient/{allocation_type}_{taxa_type}_{type}.rds.gz"))
# 
#       # if(file.exists(out_fstem)){
#       # 
#       #   message(glue("skipping {allocation_type}_{taxa_type}_{type}"))
#       #   next()
#       # 
#       # }
# 
# global_maps_list <- list.files(file.path(impact_maps_dir, "impact_maps_by_taxon_across_ingredient"), pattern = glue("{allocation_type}_{taxa_type}"), recursive = TRUE, full.names = TRUE)
# 
# stack_rast <- rast()
# 
# for(file in global_maps_list){
#   # file <- global_maps_list[[1]]
# 
#   rast_1 <- rast(file) %>%
#     project(., moll_template, method = "near")
# 
#   stack_rast <- c(stack_rast, rast_1)
# }
# 
# names(stack_rast) <- file_path_sans_ext(str_after_nth(global_maps_list, "\\/", 6))
# 
# 
# all_df <- as.data.frame(stack_rast, xy = TRUE) %>%
#   pivot_longer(cols = c(3:ncol(.)), values_to = "value", names_to = "type") %>%
#   filter(!is.na(value)) %>%
#   separate_wider_delim(type, delim = "/", names = c("diet", "taxa_calc_type")) %>%
#   separate_wider_delim(taxa_calc_type, delim = "_", names = c("allocation", "taxa", "calc_type")) %>%
#   mutate(value =  ifelse(str_detect(calc_type, "mean"), log(value*1000000 + 1), value)) %>%
#   rename(long = x, lat = y)
# 
# for(i in unique(all_df$calc_type)){
# 
#   loop_df <- all_df %>%
#     filter(calc_type == i) %>%
#     filter(!is.na(value))
# 
#   data.table::fwrite(loop_df, glue(file.path(impact_maps_dir, "csvs/impact_maps_by_taxon_across_ingredient/{allocation_type}_{taxa_type}_{i}.rds.gz")))
# 
#       }
#     }
#   }
# }
     
  
  
for(allocation_type in allocations){
    for(taxa_type in taxon){
      for(type in calc_types){

        # allocation_type = "economic"
        # taxa_type = "Bird"
        # type = "mean"
        
        all_df <- fread(glue(file.path(impact_maps_dir, "csvs/impact_maps_by_taxon_across_ingredient/{allocation_type}_{taxa_type}_{type}.rds.gz"))) %>%
          filter(!is.na(value))
        
diets <- unique(all_df$diet)
  
## create maps in separate plots, force common scale between them
maps <- map(.x = diets, 
            .f = function(x, y) 
  ggplot() + 
  geom_tile(data = all_df  %>% filter(diet == x), aes(x= long, y = lat, fill = value)) + 
      # scale_fill_gradientn(colors = YlOrBr(9), na.value = "white") +  # Set the color for missing values (NA) to white
   scale_fill_gradientn(colors = final_palette, na.value = "white") +
   #  scale_fill_viridis(direction = -1) + 
              geom_sf(data = countries_shp, fill = NA, colour = "grey") + 
  theme_minimal() +
      theme(
          axis.title = element_blank(),
          axis.text = element_blank(),
          axis.ticks = element_blank())
            )


ggsave(glue(here(this_dir, "output/plots/by_taxa/{allocation_type}_{taxa_type}_{type}_plot.png")), plot = plot_grid(plotlist = maps, labels = glue("{diets}:{allocation_type}:{taxa_type}:{type}"), label_size = 10, nrow = 2), width = 10, height = 8, bg = "white")

    }
  }
}

```

Global maps by ingredients across taxon 

```{r}

allocations <- c("economic", "ge", "mass")
calc_types <- c("mean", "sd", "nspp")
ingredients <- all_overlap %>% pull(ingredient) %>% unique()

## commented out code only needs to be run if the source impact maps are updated! 
# for(allocation_type in allocations){
#   for(ingredient_type in ingredients){
# 
#       # ingredient_type = "Soybean_soybean meal"
#       # allocation_type = "economic"
#       # type = "mean"
# 
# global_maps_list <- list.files(file.path(impact_maps_dir, "impact_maps_across_taxon_by_ingredient"), pattern = glue("{allocation_type}_{ingredient_type}"), recursive = TRUE, full.names = TRUE)

# stack_rast <- rast()
# 
# for(file in global_maps_list){
#   # file <- global_maps_list[[1]]
# 
#   rast_1 <- rast(file) %>%
#     project(., moll_template, method = "near")
# 
#   stack_rast <- c(stack_rast, rast_1)
# }
# 
# names(stack_rast) <- file_path_sans_ext(str_after_nth(global_maps_list, "\\/", 6))
# 
# 
# all_df <- as.data.frame(stack_rast, xy = TRUE) %>%
#   pivot_longer(cols = c(3:ncol(.)), values_to = "value", names_to = "type") %>%
#   separate_wider_delim(type, delim = "/", names = c("diet", "ingredient_calc_type")) %>%
#     separate_wider_delim(ingredient_calc_type, delim = "_", names = c("allocation", "raw_material", "ingredient", "calc_type")) %>%
#   mutate(value =  ifelse(str_detect(calc_type, "mean"), log(value*1000000 + 1), value)) %>%
#   rename(long = x, lat = y) %>%
#   filter(!is.na(value)) %>%
#   unite("crop_ingredient", c(raw_material:ingredient), sep = "_", remove = FALSE)
# 
# for(i in unique(all_df$calc_type)){
#   # i = "mean"
# 
#   loop_df <- all_df %>%
#     filter(calc_type == i) %>%
#     filter(!is.na(value))
# 
#   data.table::fwrite(loop_df, glue(file.path(impact_maps_dir, "csvs/impact_maps_across_taxon_by_ingredient/{allocation_type}_{ingredient_type}_{i}.rds.gz")))
# 
#    }
#   }
# }


for(allocation_type in allocations){
    for(ingredient_type in ingredients){
      for(type in calc_types){
        
      # ingredient_type = "Soybean_soybean meal"
      # allocation_type = "economic"
      # type = "mean"
        
                all_df <- fread(glue(file.path(impact_maps_dir, "csvs/impact_maps_across_taxon_by_ingredient/{allocation_type}_{ingredient_type}_{type}.rds.gz"))) 
 
diets <- unique(all_df$diet)
  
## create maps in separate plots, force common scale between them
maps <- map(.x = diets, 
            .f = function(x, y) 
  ggplot() + 
  geom_tile(data = all_df  %>% filter(diet == x), aes(x= long, y = lat, fill = value)) + 
      # scale_fill_gradientn(colors = YlOrBr(9), na.value = "white") +  # Set the color for missing values (NA) to white
   scale_fill_gradientn(colors = final_palette, na.value = "white") +
   #  scale_fill_viridis(direction = -1) + 
              geom_sf(data = countries_shp, fill = NA, colour = "grey") + 
  theme_minimal() +
      theme(
          axis.title = element_blank(),
          axis.text = element_blank(),
          axis.ticks = element_blank())
            )

ggsave(glue(here(this_dir, "output/plots/by_ingredient/{allocation_type}_{ingredient_type}_{type}_plot.png")), plot = plot_grid(plotlist = maps, labels = glue("{diets}:{allocation_type}:{ingredient_type}:{type}"), label_size = 10, nrow = 2), width = 10, height = 8, bg = "white")

    
    }
  }
}

```

