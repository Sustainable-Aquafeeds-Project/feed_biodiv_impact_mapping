---
title: "Download terrestrial Area of Habitat (AOH) data"
output: html_document
editor_options: 
  chunk_output_type: console
---

## Data sources 

* Lumbierres et al. 2022: https://www.nature.com/articles/s41597-022-01838-w
* Eyres et al. 2023(4?): In prep. Files shared through email communication with Alison Eyres (ae491@cam.ac.uk) and Michael Winston Dales (mwd24@cam.ac.uk) at Cambridge University: https://www.cl.cam.ac.uk/research/eeg/4c/data/aoh/


## Setup

Load libraries

```{r setup, include=FALSE}

library(tidyverse)
library(here)
library(terra)
library(strex)
library(janitor)
library(rredlist)

source(here("src/directories.R"))
source(here("src/spatial.R"))
source(here("src/fxns.R"))

select <- dplyr::select
setwd(dirname(rstudioapi::getSourceEditorContext()$path)) # set working directory to where this script is located
this_dir <- getwd()

```


## Download the Lumbierres data 

Check to make sure we downloaded all of the AOH species maps from https://datadryad.org/stash/dataset/doi:10.5061/dryad.02v6wwq48


You can download by ssh into the rdsi storage and then running wget url_to_download

ssh ubuntu@131.217.178.173
cd ../../mnt/rdsi/raw_data/AOH_lumbierres
wget https://datadryad.org/stash/downloads/file_stream/1931890

unzip 1931890.zip

Above example is how to download mammals_rodentia.zip file. Link taken from https://datadryad.org/stash/dataset/doi:10.5061/dryad.02v6wwq48.


```{r}

## read in species lists from raw data dir 

mammals_list <-
  read.csv(file.path(rdsi_raw_data_dir, "AOH_lumbierres/Mammals_list_AOH.csv")) %>%
  clean_names() %>%
  dplyr::select(binomial, aoh_name, order) %>%
  mutate(type = "mammal")

birds_list <- read.csv(file.path(rdsi_raw_data_dir, "AOH_lumbierres/Birds_list_AOH.csv")) %>%
  clean_names() %>%
  dplyr::select(binomial, aoh_name, order) %>%
  mutate(type = "bird")


total_spp_list <- rbind(mammals_list, birds_list)

## save species list 
write_rds(total_spp_list, file.path(this_dir, "int/terrestrial_species_list.rds"))


## now grab the names of the species from the raw data directory

files <- list.files(file.path(rdsi_raw_data_dir, "AOH_lumbierres"), pattern = ".tif")

spp_list_files <- str_before_last(files, ".tif") 

remove_suffix <- function(string) {
  modified_string <- sub("_[BNR]$", "", string)
  return(modified_string)
}

spp_list_files_fin <- remove_suffix(spp_list_files) %>%
  unique()


## now filter these spp out of the spp df 

missing_spp <- total_spp_list %>%
  filter(!(aoh_name %in% c(spp_list_files_fin)))

## ok I'm missing 1984 spp. 

sort(unique(missing_spp$order)) 

# [1] "CHIROPTERA"    "PASSERIFORMES"    


## I will redownload the zip files missing from here: https://datadryad.org/stash/dataset/doi:10.5061/dryad.02v6wwq48 and see if that helps the missing species...

unzip(file.path(rdsi_raw_data_dir, "AOH_lumbierres/1931870.zip"), exdir = here("test/"))


test <- rast(file.path(rdsi_raw_data_dir, "AOH_lumbierres/Aselliscus_tricuspidatus.tif"))

test_size <- cellSize(test, unit = "km")
plot(test_size)


```


## Download the Eyres data

run these bash in the terminal and you will be able to recursively download all species AOH files from https://www.cl.cam.ac.uk/research/eeg/4c/data/aoh/ to your specific folder (mine is "AOH_eyres")

IUCN ids are the numbers which are attached

This takes a really long time... run it overnight.

```{bash eval = false}

cd ../../raw_data/AOH_eyres
wget -r -nH --cut-dirs=5 --no-parent --reject="index.html*" -N https://www.cl.cam.ac.uk/research/eeg/4c/data/aoh/

```

Get IUCN ids and spp names for the Eyres species (need to download them all first)

```{r}

out <- rl_sp(all=TRUE, key = api_key)
vapply(out,"[[",1,"count") 
all_df<-do.call(rbind,lapply(out,"[[","result"))

write_rds(all_df, here("prep/03_prep_spp_habitats/data/iucn/all_iucn_spp.rds"))


spp_ids <- data.frame(fn = grep(list.files(file.path("/mnt/rdsi/raw_data/AOH_eyres/"), recursive = TRUE), pattern = "reprojected", invert = TRUE, value = TRUE)) %>% # delete amphibians and add recursive for all species names
  mutate(iucn_id = as.numeric(str_after_last(fn, "-") %>%
  str_before_first(., ".tif")),
  spp_type = str_before_first(fn, "\\/")) %>%
  distinct(spp_type, iucn_id)

all_df <- readRDS(here("prep/03_prep_spp_habitats/data/iucn/all_iucn_spp.rds"))

eyres_ids <- spp_ids %>% 
  left_join(all_df, by = c("iucn_id" = "taxonid")) # ok cool 

spp_groups <- eyres_ids %>%
  group_by(spp_type) %>%
  summarise(n_group = n_distinct(iucn_id)) %>%
  ungroup()

test_nas <- eyres_ids %>%
  filter(is.na(scientific_name)) ## missing names for 235 species

# lets see if we can find some of these names using iucn redlist api 

loop_list <- c()

for(loop_id in unique(test_nas$iucn_id)){
  
  search_id <- rl_search(id = loop_id, key = api_key)
  
  loop_list <- c(loop_list, search_id)
} # ok that didn't work.. maybe these just don't exist? Hopefully Michael will send me a species list. 

write_rds(eyres_ids, here("prep/03_prep_spp_habitats/data/iucn/eyres_iucn_spp.rds"))




```




```{r}
test <- read.csv("/mnt/rdsi/raw_data/AOH_eyres/reprojected_mol_csv/Seasonality.BREEDING-103702625.csv")


test1 <- rast(list.files(file.path("/mnt/rdsi/raw_data/AOH_eyres"), recursive = TRUE, pattern = "Seasonality.RESIDENT-130481421.tif", full.names = TRUE))
test1
plot(test1)

test_rast <- left_join(test, moll_template_xy) %>% 
  dplyr::select(x,y,presence)
# %>%
#  mutate(presence = ifelse(is.na(presence), 0, presence)) %>%
#   rast(., type = "xyz", crs = moll_template)
  
plot(test_rast)

test_rast[test_rast == 1] <- 10000
plot(test_rast)
global(test_rast, "max")

moll_template_xy_new <- moll_template %>% mutate(new_col = 1) %>%
  as.data.frame(., xy = TRUE) %>% 
  mutate(cell_id = 1:ncell(moll_template)) %>% 
  filter(across(everything(), ~grepl("\\.", as.character(.))))

moll_template_xy_land <- readRDS(here("prep/03_prep_spp_habitats/data/spatial/moll_template_land_xy.rds"))
moll_template_xy_ocean <- readRDS(here("prep/03_prep_spp_habitats/data/spatial/moll_template_ocean_xy.rds"))

ocean <- rast(here("prep/03_prep_spp_habitats/data/spatial/ocean_area_mol.tif"))
ocean[is.na(ocean)] <- 0

ocean_df <- ocean %>%
  as.data.frame(., xy = TRUE) %>%
   mutate(cell_id = 1:ncell(ocean)) %>% 
  filter(grepl("\\.", as.character(x)))

test2 <- rast(list.files(file.path("/mnt/rdsi/raw_data/AOH_eyres"), recursive = TRUE, pattern = "Seasonality.BREEDING-103702625.tif", full.names = TRUE))
# test2[test2 == 0] <- NA
plot(test2, col = "red")


spp_csv <- test2 %>% 
    project(moll_template, method = "near") %>%
      as.data.frame(., xy = TRUE) %>%
     rename(presence = 3) %>%
    filter(presence > 0) %>%
    mutate(presence = 1) %>%
     inner_join(moll_template_xy_ocean) %>%
     dplyr::select(x, y, presence) %>%
  rast(., type = "xyz")
  
spp_csv <-  test2 %>%
        aggregate(fact = 10, fun = "mean", na.rm = TRUE) %>%  
        project(moll_template, method = "near") %>% 
        as.data.frame(., xy = TRUE) %>%
        rename(presence = 3) %>%
        filter(presence >0) %>%
        mutate(presence = 1) %>%
        inner_join(moll_template_xy) %>%
        dplyr::select(x,y,presence) %>%
        rast(., type = "xyz", crs = moll_template)
      
      
      
      test3 <- rbind(test_rast, spp_csv) %>%
                rast(., type = "xyz", crs = moll_template)
        
      plot(test3)
      
      
      
  
```


