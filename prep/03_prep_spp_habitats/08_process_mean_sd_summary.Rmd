---
title: "Process rasters across taxa or ingredients or both"
output: html_document
editor_options: 
  chunk_output_type: console
---

## Summary

In this script we summarize the impact rasters created in 03b, 06a and 06b by finding the impact mean, standard deviation (pooled variance), and number of species:

 - Across all taxon and ingredients
 - Across all taxon per each ingredient
 - Across all ingredients per each taxon
 
## Datasources

 - O'hara et al. 2023 in prep
    - Code largely adapted from Casey. 

## Setup

Load libraries

```{r setup, include=FALSE}

library(tidyverse)
library(here)
library(terra)
library(strex)
library(janitor)
library(tools)
library(glue)
library(tidyterra)

source(here("src/directories.R"))

source(here("src/spatial.R"))
source(here("src/fxns.R"))

select <- dplyr::select
setwd(dirname(rstudioapi::getSourceEditorContext()$path)) # set working directory to where this script is located
this_dir <- getwd()

aoh_dir <- file.path(rdsi_raw_data_dir, "AOH_lumbierres/reprojected_csvs/")

base_rast <- rast(res=0.5)
ext(base_rast) <- c(-180, 180, -90, 90)

# read in xy cell_id lookup table for land and ocean
ocean_xy_moll <- readRDS(file.path(this_dir, "data/spatial/moll_template_ocean_xy.rds"))
land_xy_moll <- readRDS(here(this_dir, "data/spatial/moll_template_land_xy.rds"))
all_xy_moll <- rbind(ocean_xy_moll, land_xy_moll)

biodiv_dir <- file.path(rdsi_dir, "biodiversity_impacts")

impact_maps_dir <- file.path(biodiv_dir, "output")

```

Define functions for processing raster maps of taxon or ingredient aggregated mean impacts 

```{r}
r_to_df <- function(f) {
 # f = "/mnt/rdsi/biodiversity_impacts/output/impact_maps_by_taxon_ingredient/fish-dominant/imp_unwt_forage fish_fish meal_economic_arthropods_sd.tif"
  
  r <- terra::rast(f) 
  crs(r) <- crs(moll_template)
  r <- r %>%
    project(., moll_template, method = "near") # have to project it for some reason first...  
  
  if(str_detect(f, "_sd.tif")){
      df <- data.frame(val = as.vector(values(r)),
                   cell_id = 1:ncell(r)) %>%
    filter(!is.na(val)) 
    
  }else{
  
  df <- data.frame(val = as.vector(values(r)),
                   cell_id = 1:ncell(r)) %>%
    filter(!is.na(val)) %>% 
    filter(val > 0)
}
  
  return(df)
}


combine_taxa_maps <- function(tx_impact_map_df) {

  mean_fs <- tx_impact_map_df %>% filter(p == 'mean') %>% .$f
  sdev_fs <- tx_impact_map_df %>% filter(p == 'sd') %>% .$f
  nspp_fs <- tx_impact_map_df %>% filter(p == 'nspp') %>% .$f

  taxa <- tx_impact_map_df %>% filter(p == "mean") %>% pull(t)
  diet <- tx_impact_map_df %>% filter(p == "mean") %>% pull(d)
  allocation <- tx_impact_map_df %>% filter(p == "mean") %>% pull(a)
  ingredient <- tx_impact_map_df %>% filter(p == "mean") %>% pull(i)

  message(glue('... loading mean maps across taxa and ingredients for {allocation_type} and {diet_type} impacts'))

  mean_df <- parallel::mclapply(mean_fs, mc.cores = 12, FUN = r_to_df) %>%
    setNames(glue("{taxa}_{diet}_{allocation}_{ingredient}")) %>%
    data.table::rbindlist(idcol = 'taxon') %>%
    rename(imp_mean = val) %>%
    dplyr::select(cell_id, taxon, imp_mean)

 message(glue('... loading stdev maps across taxa and ingredients for {allocation_type} and {diet_type} impacts'))

  taxa <- tx_impact_map_df %>% filter(p == "sd") %>% pull(t)
  diet <- tx_impact_map_df %>% filter(p == "sd") %>% pull(d)
  allocation <- tx_impact_map_df %>% filter(p == "sd") %>% pull(a)
  ingredient <- tx_impact_map_df %>% filter(p == "sd") %>% pull(i)
 
 sdev_df <- parallel::mclapply(sdev_fs, mc.cores = 12, FUN = r_to_df) %>%
 setNames(glue("{taxa}_{diet}_{allocation}_{ingredient}")) %>%
    data.table::rbindlist(idcol = 'taxon') %>%
    rename(imp_sd = val) %>%
    dplyr::select(cell_id, taxon, imp_sd)

 message(glue('... loading nspp maps across taxa and ingredients for {allocation_type} and {diet_type} impacts'))

  taxa <- tx_impact_map_df %>% filter(p == "nspp") %>% pull(t)
  diet <- tx_impact_map_df %>% filter(p == "nspp") %>% pull(d)
  allocation <- tx_impact_map_df %>% filter(p == "nspp") %>% pull(a)
  ingredient <- tx_impact_map_df %>% filter(p == "nspp") %>% pull(i)
 
  nspp_df <- parallel::mclapply(nspp_fs, mc.cores = 12, FUN = r_to_df) %>%
 setNames(glue("{taxa}_{diet}_{allocation}_{ingredient}")) %>%
    data.table::rbindlist(idcol = 'taxon') %>%
    rename(imp_nspp = val) %>%
    dplyr::select(cell_id, taxon, imp_nspp)
 
  message('... joining mean, sd, nspp into big-ass dataframe for impacts')
  big_df <- mean_df %>%
    full_join(sdev_df, by = c('taxon', 'cell_id')) %>%
    full_join(nspp_df, by = c('taxon', 'cell_id')) %>%
    filter(!is.na(imp_mean) & !is.na(imp_nspp)) # filter out any NAs here so they don't get caught in the mean calculations
  
  return(big_df)
}

process_mean_rasts <- function(big_df) {
  
  ### Set up for parallel processing
  cell_id_vec <- big_df$cell_id %>% unique()
  n_gps <- 25
  gp_vec <- rep(1:n_gps, length.out = length(cell_id_vec))
  
  ### perform parallel processing
  spp_mean_list <- parallel::mclapply(
    X = 1:n_gps, mc.cores = 8, 
    FUN = function(gp) { ### gp <- 2
      gp_cells <- cell_id_vec[gp_vec == gp]
      message('...processing ', length(gp_cells), ' cells in group ', gp, '...')
      gp_out <- big_df %>%
        filter(cell_id %in% gp_cells) %>%
        group_by(cell_id) %>%
        summarize(imp_mean = (sum(imp_mean * imp_nspp) / sum(imp_nspp))) %>%
        ungroup()
    })
  
  ### gather results
  spp_mean_df <- data.table::rbindlist(spp_mean_list)
  return(spp_mean_df)
}

process_nspp_rasts <- function(big_df){
  
   ### Set up for parallel processing
  cell_id_vec <- big_df$cell_id %>% unique()
  n_gps <- 25
  gp_vec <- rep(1:n_gps, length.out = length(cell_id_vec))
  
  ### perform parallel processing
  spp_nspp_list <- parallel::mclapply(
    X = 1:n_gps, mc.cores = 8, 
    FUN = function(gp) { ### gp <- 2
      gp_cells <- cell_id_vec[gp_vec == gp]
      message('...processing ', length(gp_cells), ' cells in group ', gp, '...')
      gp_out <- big_df %>%
        filter(cell_id %in% gp_cells) %>%
        group_by(cell_id) %>%
        summarize(imp_nspp = sum(imp_nspp, na.rm = TRUE)) %>%
        ungroup()
    })
  
  ### gather results
  spp_nspp_df <- data.table::rbindlist(spp_nspp_list)
  return(spp_nspp_df)
  

}




process_sdev_rasts <- function(big_df) {
  ### Set up for parallel processing
  cell_id_vec <- big_df$cell_id %>% unique()
  n_gps <- 100
  gp_vec <- rep(1:n_gps, length.out = length(cell_id_vec))
  
  ### perform parallel processing
  all_spp_sdev_list <- parallel::mclapply(
    X = 1:n_gps, mc.cores = 8, 
    FUN = function(gp) { ### gp <- round(n_gps / 2)
      gp_cells <- cell_id_vec[gp_vec == gp]
      message('...processing ', length(gp_cells), ' cells in group ', gp, ' of ', n_gps, '...')
      # system.time({
        gp_sdev_out <- big_df %>%
          filter(cell_id %in% gp_cells) %>%
          group_by(cell_id) %>%
          summarize(imp_var = iterated_pooled_var(imp_mean, imp_sd, imp_nspp),
                    imp_sd = sqrt(imp_var)) %>%
          ungroup()
      # })
      return(gp_sdev_out)
    })
  
  ### gather results
  all_spp_sdev <- data.table::rbindlist(all_spp_sdev_list)
  return(all_spp_sdev)
}
```

## Calculate mean and nspp impact maps
  - Across all taxa and ingredients: 1 raster per diet/allocation
  - Across all taxa per ingredient: 1 raster per diet/allocation/ingredient
  - Across all ingredients per taxa: 1 raster per taxon/allocation/diet

```{r assemble taxon impact maps to total mean and nspp maps}
tx_impact_map_df <- data.frame(f = list.files(file.path(impact_maps_dir, "impact_maps_by_taxon_ingredient"), 
                                               pattern = 'imp_unwt_',
                                               full.names = TRUE, recursive = TRUE)) %>%
  filter(str_detect(f, "regular|efficient")) %>%
  mutate(d = str_before_first(str_after_nth(f, "\\/", 6), "\\/"),
         t = str_after_last(str_before_last(file_path_sans_ext(f), "_"), "_"), 
         p = str_after_last(file_path_sans_ext(f), "_"), 
         i = str_before_nth(str_after_nth(file_path_sans_ext(basename(f)), "_", 2), "_", 2), 
         a = str_before_first(str_after_nth(file_path_sans_ext(basename(f)), "_", 4), "_"),
         e = str_before_first(str_after_nth(f, "\\/", 7), "\\/"))

## calculate means across taxa and ingredients; will end up with 1 raster per diet type and allocation type 

allocations <- c("mass", "ge", "economic")
diets <- c("fish-dominant", "plant-dominant")
fcrs <- c("efficient", "regular") 
 
for(allocation_type in allocations){
  for(diet_type in diets){
    for(fcr_type in fcrs){

# allocation_type = "mass"
# diet_type = "plant-dominant"
#       fcr_type = "regular"
    
    out_fstem_mean <- glue(file.path(impact_maps_dir, "impact_maps_across_taxon_ingredient/{diet_type}/{fcr_type}/{allocation_type}_mean.tif"))
    out_fstem_nspp <- glue(file.path(impact_maps_dir, "impact_maps_across_taxon_ingredient/{diet_type}/{fcr_type}/{allocation_type}_nspp.tif"))
    
    # if(all(file.exists(out_fstem_mean, out_fstem_nspp))){
    #   message(glue("skipping global mean and nspp calculations for {diet_type}; {allocation_type} because rasters exist"))
    #   next()
    # 
    # }

    tx_impact_map_df_loop <- tx_impact_map_df %>%
      filter(a == allocation_type, 
             d == diet_type,
             e == fcr_type)
    
    
  big_df <- combine_taxa_maps(tx_impact_map_df_loop)
    
 process_mean_rasts(big_df) %>%
    inner_join(all_xy_moll, by = "cell_id") %>%
      dplyr::select(x, y, imp_mean) %>%
      rast(., type = "xyz", crs = moll_template) %>%
   writeRaster(., out_fstem_mean, overwrite = TRUE)
   
  #plot(log(spp_mean_rast+1))
 
 
  process_nspp_rasts(big_df) %>%       
    inner_join(all_xy_moll, by = "cell_id") %>%
      dplyr::select(x, y, imp_nspp) %>%
      rast(., type = "xyz", crs = moll_template) %>%
   writeRaster(., out_fstem_nspp, overwrite = TRUE)

    }
  }
}


## calculate means by taxa across ingredients

allocations <- c("mass", "ge", "economic")
diets <- c("fish-dominant", "plant-dominant")
taxa <- tx_impact_map_df %>% filter(t != "polychaetes") %>% 
  pull(t) %>% unique()
fcrs <- c("efficient", "regular")

for(allocation_type in allocations){
  for(diet_type in diets){
    for(fcr_type in fcrs){
    for(taxa_type in taxa){

      # allocation_type = "mass"
      # diet_type = "fish-dominant"
      # taxa_type = "cnidaria"
      # fcr_type = "regular"
    
    out_fstem_mean <- glue(file.path(impact_maps_dir, "impact_maps_by_taxon_across_ingredient/{diet_type}/{fcr_type}/{allocation_type}_{taxa_type}_mean.tif"))
    out_fstem_nspp <- glue(file.path(impact_maps_dir, "impact_maps_by_taxon_across_ingredient/{diet_type}/{fcr_type}/{allocation_type}_{taxa_type}_nspp.tif"))

    
    # if(all(file.exists(out_fstem_mean, out_fstem_nspp))){
    #   message(glue("skipping global mean calculations for {diet_type} diet; {allocation_type} allocation; {taxa_type} taxon because rasters exist"))
    #   next()
    # }

    tx_impact_map_df_loop <- tx_impact_map_df %>%
      filter(a == allocation_type, 
             d == diet_type, 
             t == taxa_type,
             e == fcr_type)
    
    message(glue("processing mean calculations for {diet_type} diet; {fcr_type} efficiency; {allocation_type} allocation; {taxa_type} taxon"))
    
    big_df <- combine_taxa_maps(tx_impact_map_df_loop)
    
    if(nrow(big_df) == 0){
      
      setValues(moll_template, NA) %>%
        writeRaster(., out_fstem_mean, overwrite = TRUE)
      
            setValues(moll_template, NA) %>%
        writeRaster(., out_fstem_nspp, overwrite = TRUE)
      
    }else{
      
 process_mean_rasts(big_df) %>%
    inner_join(all_xy_moll, by = "cell_id") %>%
      dplyr::select(x, y, imp_mean) %>%
      rast(., type = "xyz", crs = moll_template) %>%
   writeRaster(., out_fstem_mean, overwrite = TRUE)
 
 
  process_nspp_rasts(big_df) %>%       
    inner_join(all_xy_moll, by = "cell_id") %>%
      dplyr::select(x, y, imp_nspp) %>%
      rast(., type = "xyz", crs = moll_template) %>%
   writeRaster(., out_fstem_nspp, overwrite = TRUE)
  
    }
   
# test <- rast(out_fstem)
  # plot(log(test*100000+1))

     }
   }
  }
}


## calculate means by ingredient across taxa

allocations <- c("mass", "ge", "economic")
diets <- c("fish-dominant", "plant-dominant")
ingredients <- unique(tx_impact_map_df$i)
# ingredients <- tx_impact_map_df %>% filter(str_detect(i, "fish")) %>% pull(i) %>% unique()
fcrs <- c("efficient", "regular")

for(allocation_type in allocations){
  for(diet_type in diets){
    for(fcr_type in fcrs){
    for(ingredient_type in ingredients){

      # allocation_type = "mass"
      # diet_type = "fish-dominant"
      # ingredient_type = "Wheat_wheat"
      # fcr_type = "regular"

    out_fstem_mean <- glue(file.path(impact_maps_dir, "impact_maps_across_taxon_by_ingredient/{diet_type}/{fcr_type}/{allocation_type}_{ingredient_type}_mean.tif"))
    out_fstem_nspp <- glue(file.path(impact_maps_dir, "impact_maps_across_taxon_by_ingredient/{diet_type}/{fcr_type}/{allocation_type}_{ingredient_type}_nspp.tif"))
    
    # if(all(file.exists(out_fstem_mean, out_fstem_nspp))){
    #   message(glue("skipping global mean and nspp calculations for {diet_type} diet; {allocation_type} allocation; {ingredient_type} ingredients because rasters exist"))
    #   next()
    # 
    # }

    tx_impact_map_df_loop <- tx_impact_map_df %>%
      filter(a == allocation_type, 
             d == diet_type, 
             i == ingredient_type,
             e == fcr_type)
    
    if(nrow(tx_impact_map_df_loop) == 0){
      
      message("skipping, not a category")
      next()
    }
    
message(glue("processing mean and nspp calculations for {diet_type} diet; {fcr_type} efficiency; {allocation_type} allocation; {ingredient_type} ingredient"))

big_df <- combine_taxa_maps(tx_impact_map_df_loop)

 process_mean_rasts(big_df) %>%       
    inner_join(all_xy_moll, by = "cell_id") %>%
      dplyr::select(x, y, imp_mean) %>%
      rast(., type = "xyz", crs = moll_template) %>%
   writeRaster(., out_fstem_mean, overwrite = TRUE)
 
  process_nspp_rasts(big_df) %>%       
    inner_join(all_xy_moll, by = "cell_id") %>%
      dplyr::select(x, y, imp_nspp) %>%
      rast(., type = "xyz", crs = moll_template) %>%
   writeRaster(., out_fstem_nspp, overwrite = TRUE)
   
 # test <- rast(out_fstem)
  # plot(log(test*100000+1))

     }
   }
  }
}

```

## Calculate sd and pooled variance impact maps
  - Across all taxa and ingredients: 1 raster per diet/allocation
  - Across all taxa per ingredient: 1 raster per diet/allocation/ingredient
  - Across all ingredients per taxa: 1 raster per taxon/allocation/diet


```{r assemble taxon impact maps to total sdev maps}


tx_impact_map_df <- data.frame(f = list.files(file.path(impact_maps_dir, "impact_maps_by_taxon_ingredient"), 
                                               pattern = 'imp_unwt_',
                                               full.names = TRUE, recursive = TRUE)) %>%
  filter(str_detect(f, "regular|efficient")) %>%
  mutate(d = str_before_first(str_after_nth(f, "\\/", 6), "\\/"),
         t = str_after_last(str_before_last(file_path_sans_ext(f), "_"), "_"), 
         p = str_after_last(file_path_sans_ext(f), "_"), 
         i = str_before_nth(str_after_nth(file_path_sans_ext(basename(f)), "_", 2), "_", 2), 
         a = str_before_first(str_after_nth(file_path_sans_ext(basename(f)), "_", 4), "_"),
         e = str_before_first(str_after_nth(f, "\\/", 7), "\\/"))


## calculate means across taxa and ingredients; will end up with 1 raster per diet type and allocation type 

allocations <- c("mass", "economic", "ge")
diets <- c("plant-dominant", "fish-dominant")
fcrs <- c("efficient", "regular") 

for(allocation_type in allocations){
  for(diet_type in diets){
    for(fcr_type in fcrs){

# allocation_type = "economic"
# diet_type = "plant-dominant"
# fcr_type = "efficient"
      
    
        out_fstem_sdev <- glue(file.path(impact_maps_dir, "impact_maps_across_taxon_ingredient/{diet_type}/{fcr_type}/{allocation_type}_sd.tif"))

    # if(all(file.exists(out_fstem_sdev))){
    #   message(glue("skipping global sdev calculations for {diet_type}; {fcr_type} efficiency; {allocation_type} because rasters exist"))
    #   next()
    # }

    tx_impact_map_df_loop <- tx_impact_map_df %>%
      filter(a == allocation_type, 
             d == diet_type,
             e == fcr_type)
    
    
  big_df <- combine_taxa_maps(tx_impact_map_df_loop)
    
  process_sdev_rasts(big_df) %>%
    inner_join(all_xy_moll, by = "cell_id") %>%
      dplyr::select(x, y, imp_sd) %>%
      rast(., type = "xyz", crs = moll_template) %>%
   writeRaster(., out_fstem_sdev, overwrite = TRUE)
   
#  rast(out_fstem_sdev) %>% plot()

   }
  }
}


## calculate means by taxa across ingredients

allocations <- c("mass", "ge", "economic")
diets <- c("fish-dominant", "plant-dominant")
taxa <- tx_impact_map_df %>% filter(t != "polychaetes") %>% pull(t) %>% unique()
fcrs <- c("efficient", "regular") 

for(allocation_type in allocations){
  for(diet_type in diets){
    for(fcr_type in fcrs){
    for(taxa_type in taxa){

      # allocation_type = "economic"
      # diet_type = "plant-dominant"
      # taxa_type = "arthropods"
      # fcr_type = "regular"
    
    out_fstem_sdev <- glue(file.path(impact_maps_dir, "impact_maps_by_taxon_across_ingredient/{diet_type}/{fcr_type}/{allocation_type}_{taxa_type}_sd.tif"))

    
    # if(all(file.exists(out_fstem_sdev))){
    #   message(glue("skipping global sd calculations for {diet_type} diet; {fcr_type} efficiency; {allocation_type} allocation; {taxa_type} taxon because rasters exist"))
    #   next()
    #   
    # }

    tx_impact_map_df_loop <- tx_impact_map_df %>%
      filter(a == allocation_type, 
             d == diet_type, 
             t == taxa_type,
             e == fcr_type)
    
    message(glue("processing sd calculations for {diet_type} diet; {fcr_type} efficiency; {allocation_type} allocation; {taxa_type} taxon"))
    
    big_df <- combine_taxa_maps(tx_impact_map_df_loop)
    
    
        if(nrow(big_df) == 0){
      
      setValues(moll_template, NA) %>%
        writeRaster(., out_fstem_sdev, overwrite = TRUE)

    }else{
    
 process_sdev_rasts(big_df) %>%
    inner_join(all_xy_moll, by = "cell_id") %>%
      dplyr::select(x, y, imp_sd) %>%
      rast(., type = "xyz", crs = moll_template) %>%
   writeRaster(., out_fstem_sdev, overwrite = TRUE)
 
 
# test <- rast(out_fstem_sdev)
  # plot(log(test*100000+1))

       }
     }
   }
  }
}


## calculate means by ingredient across taxa

allocations <- c("mass", "ge", "economic")
diets <- c("fish-dominant", "plant-dominant")
ingredients <- unique(tx_impact_map_df$i)
ingredients <- tx_impact_map_df %>% pull(i) %>% unique()
fcrs <- c("efficient", "regular") 

for(allocation_type in allocations){
  for(diet_type in diets){
    for(fcr_type in fcrs){
    for(ingredient_type in ingredients){

      # allocation_type = "mass"
      # diet_type = "fish-dominant"
      # ingredient_type = "Wheat_wheat"
      # fcr_type = "regular"

    out_fstem_sdev <- glue(file.path(impact_maps_dir, "impact_maps_across_taxon_by_ingredient/{diet_type}/{fcr_type}/{allocation_type}_{ingredient_type}_sd.tif"))
    
    # if(all(file.exists(out_fstem_sdev))){
    #   message(glue("skipping global sd calculations for {diet_type} diet; {fcr_type} efficiency; {allocation_type} allocation; {ingredient_type} ingredients because rasters exist"))
    #   next()
    #   
    # }

    tx_impact_map_df_loop <- tx_impact_map_df %>%
      filter(a == allocation_type, 
             d == diet_type, 
             i == ingredient_type,
             e == fcr_type)
    
    if(nrow(tx_impact_map_df_loop) == 0){
      
      message("skipping, not a category")
      next()
    }
    
message(glue("processing sd calculations for {diet_type} diet; {fcr_type} efficiency; {allocation_type} allocation; {ingredient_type} ingredient"))

big_df <- combine_taxa_maps(tx_impact_map_df_loop)

 process_sdev_rasts(big_df) %>%       
    inner_join(all_xy_moll, by = "cell_id") %>%
      dplyr::select(x, y, imp_sd) %>%
      rast(., type = "xyz", crs = moll_template) %>%
   writeRaster(., out_fstem_sdev, overwrite = TRUE)

   
 # test <- rast(out_fstem_sdev)
  # plot(log(test*100000+1))

     }
    }
  }
}

```

## Calculate mean proportion of habitat impacted maps
  - Across all taxa and ingredients: 1 raster per diet/allocation
  - Across all taxa per ingredient: 1 raster per diet/allocation/ingredient
  - Across all ingredients per taxa: 1 raster per taxon/allocation/diet

```{r assemble taxon impact maps to total mean and nspp maps}
tx_impact_map_df <- data.frame(f = list.files(file.path(impact_maps_dir, "impact_maps_by_taxon_ingredient"), 
                                               pattern = 'prop_unwt_',
                                               full.names = TRUE, recursive = TRUE)) %>%
  filter(str_detect(f, "regular|efficient")) %>%
  mutate(d = str_before_first(str_after_nth(f, "\\/", 6), "\\/"),
         t = str_after_last(str_before_last(file_path_sans_ext(f), "_"), "_"), 
         p = str_after_last(file_path_sans_ext(f), "_"), 
         i = str_before_nth(str_after_nth(file_path_sans_ext(basename(f)), "_", 2), "_", 2), 
         a = str_before_first(str_after_nth(file_path_sans_ext(basename(f)), "_", 4), "_"),
         e = str_before_first(str_after_nth(f, "\\/", 7), "\\/"))

## calculate means across taxa and ingredients; will end up with 1 raster per diet type and allocation type 

allocations <- c("mass", "ge", "economic")
diets <- c("fish-dominant", "plant-dominant")
fcrs <- c("efficient", "regular") 
 
for(allocation_type in allocations){
  for(diet_type in diets){
    for(fcr_type in fcrs){

# allocation_type = "mass"
# diet_type = "plant-dominant"
#       fcr_type = "regular"
    
    out_fstem_mean <- glue(file.path(impact_maps_dir, "impact_maps_across_taxon_ingredient/{diet_type}/{fcr_type}/{allocation_type}_mean_prop.tif"))
    
    # if(all(file.exists(out_fstem_mean))){
    #   message(glue("skipping global mean and nspp calculations for {diet_type}; {allocation_type} because rasters exist"))
    #   next()
    # 
    # }

    tx_impact_map_df_loop <- tx_impact_map_df %>%
      filter(a == allocation_type, 
             d == diet_type,
             e == fcr_type)
    
    
  big_df <- combine_taxa_maps(tx_impact_map_df_loop)
    
  process_mean_rasts(big_df) %>%
    inner_join(all_xy_moll, by = "cell_id") %>%
      dplyr::select(x, y, imp_mean) %>%
      rast(., type = "xyz", crs = moll_template) %>%
   writeRaster(., out_fstem_mean, overwrite = TRUE)
   
# plot(1-spp_mean_rast)

    }
  }
}


## calculate means by taxa across ingredients

allocations <- c("mass", "ge", "economic")
diets <- c("fish-dominant", "plant-dominant")
taxa <- tx_impact_map_df %>% filter(t != "polychaetes") %>% 
  pull(t) %>% unique()
fcrs <- c("efficient", "regular")

for(allocation_type in allocations){
  for(diet_type in diets){
    for(fcr_type in fcrs){
    for(taxa_type in taxa){

      # allocation_type = "mass"
      # diet_type = "fish-dominant"
      # taxa_type = "cnidaria"
      # fcr_type = "regular"
    
    out_fstem_mean <- glue(file.path(impact_maps_dir, "impact_maps_by_taxon_across_ingredient/{diet_type}/{fcr_type}/{allocation_type}_{taxa_type}_mean_prop.tif"))

    
    # if(all(file.exists(out_fstem_mean))){
    #   message(glue("skipping global mean calculations for {diet_type} diet; {allocation_type} allocation; {taxa_type} taxon because rasters exist"))
    #   next()
    # }

    tx_impact_map_df_loop <- tx_impact_map_df %>%
      filter(a == allocation_type, 
             d == diet_type, 
             t == taxa_type,
             e == fcr_type)
    
    message(glue("processing mean calculations for {diet_type} diet; {fcr_type} efficiency; {allocation_type} allocation; {taxa_type} taxon"))
    
    big_df <- combine_taxa_maps(tx_impact_map_df_loop)
    
    if(nrow(big_df) == 0){
      
      setValues(moll_template, NA) %>%
        writeRaster(., out_fstem_mean, overwrite = TRUE)
      
    }else{
      
 process_mean_rasts(big_df) %>%
    inner_join(all_xy_moll, by = "cell_id") %>%
      dplyr::select(x, y, imp_mean) %>%
      rast(., type = "xyz", crs = moll_template) %>%
   writeRaster(., out_fstem_mean, overwrite = TRUE)
  
    }
   
# test <- rast(out_fstem_mean)
  # plot(1-test)

     }
   }
  }
}

## calculate means by ingredient across taxa

allocations <- c("mass", "ge", "economic")
diets <- c("fish-dominant", "plant-dominant")
ingredients <- unique(tx_impact_map_df$i)
# ingredients <- tx_impact_map_df %>% filter(str_detect(i, "fish")) %>% pull(i) %>% unique()
fcrs <- c("efficient", "regular")

for(allocation_type in allocations){
  for(diet_type in diets){
    for(fcr_type in fcrs){
    for(ingredient_type in ingredients){

      # allocation_type = "mass"
      # diet_type = "fish-dominant"
      # ingredient_type = "Wheat_wheat"
      # fcr_type = "regular"

    out_fstem_mean <- glue(file.path(impact_maps_dir, "impact_maps_across_taxon_by_ingredient/{diet_type}/{fcr_type}/{allocation_type}_{ingredient_type}_mean_prop.tif"))

    # if(all(file.exists(out_fstem_mean))){
    #   message(glue("skipping global mean and nspp calculations for {diet_type} diet; {allocation_type} allocation; {ingredient_type} ingredients because rasters exist"))
    #   next()
    # 
    # }

    tx_impact_map_df_loop <- tx_impact_map_df %>%
      filter(a == allocation_type, 
             d == diet_type, 
             i == ingredient_type,
             e == fcr_type)
    
    if(nrow(tx_impact_map_df_loop) == 0){
      
      message("skipping, not a category")
      next()
    }
    
message(glue("processing mean and nspp calculations for {diet_type} diet; {fcr_type} efficiency; {allocation_type} allocation; {ingredient_type} ingredient"))

big_df <- combine_taxa_maps(tx_impact_map_df_loop)

 process_mean_rasts(big_df) %>%       
    inner_join(all_xy_moll, by = "cell_id") %>%
      dplyr::select(x, y, imp_mean) %>%
      rast(., type = "xyz", crs = moll_template) %>%
   writeRaster(., out_fstem_mean, overwrite = TRUE)
   
 # test <- rast(out_fstem_mean)
  # plot(1-test)

     }
   }
  }
}

```

## Calculate sd and pooled variance proportion of habitat impacted maps
  - Across all taxa and ingredients: 1 raster per diet/allocation
  - Across all taxa per ingredient: 1 raster per diet/allocation/ingredient
  - Across all ingredients per taxa: 1 raster per taxon/allocation/diet


```{r assemble taxon impact maps to total sdev maps}


tx_impact_map_df <- data.frame(f = list.files(file.path(impact_maps_dir, "impact_maps_by_taxon_ingredient"), 
                                               pattern = 'prop_unwt_',
                                               full.names = TRUE, recursive = TRUE)) %>%
  filter(str_detect(f, "regular|efficient")) %>%
  mutate(d = str_before_first(str_after_nth(f, "\\/", 6), "\\/"),
         t = str_after_last(str_before_last(file_path_sans_ext(f), "_"), "_"), 
         p = str_after_last(file_path_sans_ext(f), "_"), 
         i = str_before_nth(str_after_nth(file_path_sans_ext(basename(f)), "_", 2), "_", 2), 
         a = str_before_first(str_after_nth(file_path_sans_ext(basename(f)), "_", 4), "_"),
         e = str_before_first(str_after_nth(f, "\\/", 7), "\\/"))


## calculate means across taxa and ingredients; will end up with 1 raster per diet type and allocation type 

allocations <- c("mass", "economic", "ge")
diets <- c("plant-dominant", "fish-dominant")
fcrs <- c("efficient", "regular") 

for(allocation_type in allocations){
  for(diet_type in diets){
    for(fcr_type in fcrs){

# allocation_type = "economic"
# diet_type = "plant-dominant"
# fcr_type = "efficient"
      
    
        out_fstem_sdev <- glue(file.path(impact_maps_dir, "impact_maps_across_taxon_ingredient/{diet_type}/{fcr_type}/{allocation_type}_sd_prop.tif"))

    # if(all(file.exists(out_fstem_sdev))){
    #   message(glue("skipping global sdev calculations for {diet_type}; {fcr_type} efficiency; {allocation_type} because rasters exist"))
    #   next()
    # }

    tx_impact_map_df_loop <- tx_impact_map_df %>%
      filter(a == allocation_type, 
             d == diet_type,
             e == fcr_type)
    
    
  big_df <- combine_taxa_maps(tx_impact_map_df_loop)
    
  process_sdev_rasts(big_df) %>%
    inner_join(all_xy_moll, by = "cell_id") %>%
      dplyr::select(x, y, imp_sd) %>%
      rast(., type = "xyz", crs = moll_template) %>%
   writeRaster(., out_fstem_sdev, overwrite = TRUE)
   
#  rast(out_fstem_sdev) %>% plot()

   }
  }
}


## calculate means by taxa across ingredients

allocations <- c("mass", "ge", "economic")
diets <- c("fish-dominant", "plant-dominant")
taxa <- tx_impact_map_df %>% filter(t != "polychaetes") %>% pull(t) %>% unique()
fcrs <- c("efficient", "regular") 

for(allocation_type in allocations){
  for(diet_type in diets){
    for(fcr_type in fcrs){
    for(taxa_type in taxa){

      # allocation_type = "economic"
      # diet_type = "plant-dominant"
      # taxa_type = "arthropods"
      # fcr_type = "regular"
    
    out_fstem_sdev <- glue(file.path(impact_maps_dir, "impact_maps_by_taxon_across_ingredient/{diet_type}/{fcr_type}/{allocation_type}_{taxa_type}_sd_prop.tif"))

    
    # if(all(file.exists(out_fstem_sdev))){
    #   message(glue("skipping global sd calculations for {diet_type} diet; {fcr_type} efficiency; {allocation_type} allocation; {taxa_type} taxon because rasters exist"))
    #   next()
    #   
    # }

    tx_impact_map_df_loop <- tx_impact_map_df %>%
      filter(a == allocation_type, 
             d == diet_type, 
             t == taxa_type,
             e == fcr_type)
    
    message(glue("processing sd calculations for {diet_type} diet; {fcr_type} efficiency; {allocation_type} allocation; {taxa_type} taxon"))
    
    big_df <- combine_taxa_maps(tx_impact_map_df_loop)
    
    
        if(nrow(big_df) == 0){
      
      setValues(moll_template, NA) %>%
        writeRaster(., out_fstem_sdev, overwrite = TRUE)

    }else{
    
 process_sdev_rasts(big_df) %>%
    inner_join(all_xy_moll, by = "cell_id") %>%
      dplyr::select(x, y, imp_sd) %>%
      rast(., type = "xyz", crs = moll_template) %>%
   writeRaster(., out_fstem_sdev, overwrite = TRUE)
 
 
# test <- rast(out_fstem_sdev)
  # plot(log(test*100000+1))

       }
     }
   }
  }
}


## calculate means by ingredient across taxa

allocations <- c("mass", "ge", "economic")
diets <- c("fish-dominant", "plant-dominant")
ingredients <- unique(tx_impact_map_df$i)
ingredients <- tx_impact_map_df %>% pull(i) %>% unique()
fcrs <- c("efficient", "regular") 

for(allocation_type in allocations){
  for(diet_type in diets){
    for(fcr_type in fcrs){
    for(ingredient_type in ingredients){

      # allocation_type = "mass"
      # diet_type = "fish-dominant"
      # ingredient_type = "Wheat_wheat"
      # fcr_type = "regular"

    out_fstem_sdev <- glue(file.path(impact_maps_dir, "impact_maps_across_taxon_by_ingredient/{diet_type}/{fcr_type}/{allocation_type}_{ingredient_type}_sd_prop.tif"))
    
    # if(all(file.exists(out_fstem_sdev))){
    #   message(glue("skipping global sd calculations for {diet_type} diet; {fcr_type} efficiency; {allocation_type} allocation; {ingredient_type} ingredients because rasters exist"))
    #   next()
    #   
    # }

    tx_impact_map_df_loop <- tx_impact_map_df %>%
      filter(a == allocation_type, 
             d == diet_type, 
             i == ingredient_type,
             e == fcr_type)
    
    if(nrow(tx_impact_map_df_loop) == 0){
      
      message("skipping, not a category")
      next()
    }
    
message(glue("processing sd calculations for {diet_type} diet; {fcr_type} efficiency; {allocation_type} allocation; {ingredient_type} ingredient"))

big_df <- combine_taxa_maps(tx_impact_map_df_loop)

 process_sdev_rasts(big_df) %>%       
    inner_join(all_xy_moll, by = "cell_id") %>%
      dplyr::select(x, y, imp_sd) %>%
      rast(., type = "xyz", crs = moll_template) %>%
   writeRaster(., out_fstem_sdev, overwrite = TRUE)

   
 # test <- rast(out_fstem_sdev)
  # plot(log(test*100000+1))

     }
    }
  }
}

```




