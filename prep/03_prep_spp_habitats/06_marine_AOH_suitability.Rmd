---
title: "Calculate vulnerabilities to stressor and AOH affected"
name: "Gage Clawson"
date: "September 8, 2023"
output: html_document
editor_options: 
  chunk_output_type: console
---

## Summary 


## Setup 

```{r setup, include=FALSE}

library(tidyverse)
library(here)
library(sf)
library(data.table)
library(dtplyr)
library(terra)
library(parallel)
library(strex)
library(janitor)
library(readxl)
library(rfishbase)

source(here("src/directories.R"))

source(here("src/spatial.R"))


aquamaps_dir <- file.path(rdsi_raw_data_dir, "aquamaps")

```

NOTE: For benthopelagic the pelagic part will be multiplied by the pelagic % and the benthic multiplied by the benthic % (same for reef fish)

```{r}

foragefish_catch <- readRDS(file.path(watson_dir, "v5.0/int/all_catch_foragefish.rds"))

foragefish_gears <- foragefish_catch %>%
  filter(forage_id == 1) %>%
  filter(FOFM_catch > 0) %>%
  distinct(Gear, FGearCode, FleetGearName, VBDesc)

forage_spp <- foragefish_catch %>%
  filter(forage_id == 1) %>%
  pull(TaxonName) %>%
  unique()

forage_catch_bycatch <- foragefish_catch %>%
  filter(TaxonName %in% c(forage_spp)) %>%
  group_by(water_col_position) %>%
  dplyr::summarise(total_discards = DiscardsIND + DiscardsNIND, 
                   total_catch = IUUIND + IUUNIND + ReportedIND + ReportedNIND + DiscardsIND + DiscardsNIND) %>%
  summarise(total_discards = sum(total_discards), 
            total_catch = sum(total_catch)) %>%
  ungroup() %>%
  mutate(prop_discards = total_discards/total_catch) %>%
  mutate(prop_all_fofm_catch = total_catch/sum(total_catch))

test_high_bycatch <- forage_catch_bycatch %>%
  filter(prop_discards >= 0.1) %>%
  pull(prop_all_fofm_catch) %>%
  sum()

# ok so ~19% of forage catch has a relatively high bycatch proportions (range from 0.1 to 0.34), the rest have values <0.03 of catch within the targeted forage fish species are bycatch.

## lets look at trimmings fish now 

trimmingsfish_catch <- readRDS(file.path(watson_dir, "v5.0/int/all_catch_trimmingsfish.rds"))

trimmingsfish_gears <- trimmingsfish_catch %>%
  filter(trimmingsfish == 1) %>%
  filter(trimmings_catch > 0) %>%
  distinct(Gear, FGearCode, FleetGearName, VBDesc)

trimmings_spp <- trimmingsfish_catch %>%
  filter(trimmingsfish == 1) %>%
  pull(TaxonName) %>%
  unique()

trimmings_catch_bycatch <- trimmingsfish_catch %>%
  filter(TaxonName %in% c(trimmings_spp)) %>%
  group_by(water_col_position) %>%
  dplyr::summarise(total_discards = DiscardsIND + DiscardsNIND, 
                   total_catch = IUUIND + IUUNIND + ReportedIND + ReportedNIND + DiscardsIND + DiscardsNIND) %>%
  summarise(total_discards = sum(total_discards), 
            total_catch = sum(total_catch)) %>%
  ungroup() %>%
  mutate(prop_discards = total_discards/total_catch) %>%
  mutate(prop_all_fofm_catch = total_catch/sum(total_catch))

test_high_bycatch <- trimmings_catch_bycatch %>%
  filter(prop_discards >= 0.1) %>%
  pull(prop_all_fofm_catch) %>%
  sum()

## only 11% have high bycatch! even better than forage...


  
```



Read in vulnerability data from [Butt et al. 2022](https://esajournals.onlinelibrary.wiley.com/doi/10.1002/ecs2.3919) and match to Aquamaps species. 
 - ~57% of the Aquamaps species do not have vulnerability scores. We will need to gapfill these. We will gapfill using the same method that the source data used (by genus and then family.)

```{r}
vuln_taxa <- read.csv(here("prep/03_prep_spp_habitats/data/spp_vuln_butt/vuln_gapfilled_tx.csv"))

unique(vuln_taxa$gapfill) # ok so they only had to gapfill by genus and then family
# [1] "none"   "family" "genus" 


aquamaps_spp <- read.csv(file.path(aquamaps_dir, "GTE10_SPECIESOCCURSUM/speciesoccursum_gte10.csv"))


aquamaps_spp_clean <- aquamaps_spp %>%
  mutate(species = paste0(tolower(Genus), " ", Species)) %>%
  mutate(spp_type = case_when(
    Kingdom == "Plantae" | Phylum %in% c("Ochrophyta") ~ "Marine plant",
    str_detect(SpeciesID, "Fis-") ~ "Fish",
    Class == "Mammalia" ~ "Marine mammal",
    Class == "Aves" ~ "Bird",
    Class %in% c("Reptilia", "Amphibia") ~ "Reptiles and amphibians", 
    Phylum %in% c("Mollusca", "Arthropoda", "Cnidaria", "Echinodermata", "Annelida", "Bryozoa", "Brachiopoda", "Porifera", "Phoronida", "Nemertea", "Chaetognatha", "Platyhelminthes", "Priapulida", "Acanthocephala", "Ctenophora", "Echiura", "Kamptozoa", "Gastrotricha", "Gnathostomulida", "Hemichordata", "Nematoda", "Rotifera", "Sipuncula", "Kamptozoa") | Class %in% c("Appendicularia", "Ascidiacea", "Thaliacea", "Cephalochordata", "Thaliacea") ~ "Invertebrates", 
    Kingdom %in% c("Protozoa", "Bacteria") | Phylum == "Sagenista" ~ "Microorganisms"
  ))

test <- aquamaps_spp_clean %>% filter(is.na(spp_type)) # 0... good

aquamaps_spp_vuln_taxa <- aquamaps_spp_clean %>%
  left_join(vuln_taxa) %>%
  mutate(class = ifelse(is.na(class), Class, class),
         order = ifelse(is.na(order), Order, order),
         family = ifelse(is.na(family), Family, family),
         genus = ifelse(is.na(genus), Genus, genus)) %>%
  dplyr::select(species, class, order, family, genus, gapfill, vuln_gf_id, SpeciesID, SpecCode, FBname, spp_type)

summary(aquamaps_spp_vuln_taxa)

# 13687/23699 = 0.5775349 don't have vulnerability scores... we could gapfill the same way they did by genus and then family. We'll try that and see if it fills everything in. If not, we will gapfill by order and then class as a last resort.  

vuln_scores <- read.csv(here("prep/03_prep_spp_habitats/data/spp_vuln_butt/vuln_gapfilled_score.csv")) %>%
  dplyr::select(vuln_gf_id, bycatch)

aquamaps_vuln_scores <- aquamaps_spp_vuln_taxa %>%
  left_join(vuln_scores) %>%
 mutate(across(class:genus, tolower)) %>%
  group_by(genus) %>%
  mutate(genus_mean_gf = mean(bycatch, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(family) %>%
  mutate(family_mean_gf = mean(bycatch, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(order) %>%
  mutate(order_mean_gf = mean(bycatch, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(class) %>%
  mutate(class_mean_gf = mean(bycatch, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(spp_type) %>%
  mutate(large_taxa_mean_gf = mean(bycatch, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(bycatch_gf = 
           case_when(is.na(bycatch) & !is.na(genus_mean_gf) ~ genus_mean_gf,
                     is.na(bycatch) & is.na(genus_mean_gf) & !is.na(family_mean_gf) ~ family_mean_gf, 
                     is.na(bycatch) & is.na(genus_mean_gf) & is.na(family_mean_gf) & !is.na(order_mean_gf) ~ order_mean_gf,
                     is.na(bycatch) & is.na(genus_mean_gf) & is.na(family_mean_gf) & is.na(order_mean_gf) & !is.na(class_mean_gf) ~ class_mean_gf,
                     is.na(bycatch) & is.na(genus_mean_gf) & is.na(family_mean_gf) & is.na(order_mean_gf) & is.na(class_mean_gf) & !is.na(large_taxa_mean_gf) ~ large_taxa_mean_gf,
                     spp_type == "Microorganisms" ~ 0,
                     TRUE ~ bycatch
                     ))  %>%
    mutate(gapfill_flag = 
           case_when(is.na(bycatch) & !is.na(genus_mean_gf) ~ "genus",
                     is.na(bycatch) & is.na(genus_mean_gf) & !is.na(family_mean_gf) ~ "family", 
                     is.na(bycatch) & is.na(genus_mean_gf) & is.na(family_mean_gf) & !is.na(order_mean_gf) ~ "order",
                     is.na(bycatch) & is.na(genus_mean_gf) & is.na(family_mean_gf) & is.na(order_mean_gf) & !is.na(class_mean_gf) ~ "class",
                     is.na(bycatch) & is.na(genus_mean_gf) & is.na(family_mean_gf) & is.na(order_mean_gf) & is.na(class_mean_gf) & !is.na(large_taxa_mean_gf) ~ "Larger taxonomic group",
                     spp_type == "Microorganisms" ~ "Microorganism not affected",
                     TRUE ~ "none"
                     )) 

summary(aquamaps_vuln_scores)
hist(aquamaps_vuln_scores$bycatch_gf) # really concentrated around 0.3... I bet adding this will reduce affected area by quite a bit.
  
```

Pull total amount of ocean area fished (km2) for each allocation, diet, and aquafeed ingredient

```{r}
file_list <- list.files(here("prep/02_feed/output/resampled"), full.names = TRUE, recursive = TRUE, pattern = "fish_.*_A") # 36 - good

rast_list <- rast(file_list)

names_list <- basename(file_list)


fishing_km2 <- data.frame(feed_filepath = file_list, filename = names_list, total_km2 = global(rast_list, "sum", na.rm = TRUE)) %>%
  mutate(allocation = str_after_last(str_before_last(filename, "_"), "_"),
         ingredient = str_before_nth(filename, "_", 2),
         diet = str_after_last(str_before_last(feed_filepath, "\\/"), "\\/")) %>%
  dplyr::select(-filename) %>%
  rename(total_ingredient_km2 = sum)


```

Now lets read in the intermediate overlay data, and apply our vulnerability metrics to this. Some rules:
 - If the raster is a forage fish FMFO raster, and a targeted forage fish species, then vulnerability is 1. 
 - If the raster is a trimmings fish FMFO raster, and a targeted trimmings fish species, then the vulnerability is 1. 
 - Otherwise the vulnerability is that of the Butt et al. 2022 data. 

```{r}

overlay_df <- purrr::map_df(list.files(here("prep/03_prep_spp_habitats/int/aoh_overlay_chunks_marine"), full.names = TRUE, recursive = TRUE), readRDS) %>%
  rename(SpeciesID = sciname) %>%
  left_join(aquamaps_spp)

length(unique(overlay_df$SpeciesID)) # 23696
spp_to_run <- setdiff(unique(aquamaps_spp$SpeciesID), unique(overlay_df$SpeciesID)) # there are 5 missing. Will fix this later.
setdiff(unique(overlay_df$SpeciesID), unique(aquamaps_spp$SpeciesID)) # 0 good

forage_spp <- read.csv(here("data/raw_data/fisheries/forage_fish_list_final.csv")) %>%
    mutate(species = tolower(sci_name)) # ok so some of these are family level... will need to fix that eventually...
  
trimmings_spp <- read_csv(here("data/raw_data/biomar/trimmings_spp_list.csv")) %>% 
  mutate(species = tolower(scientific_name)) 


overlay_vuln <- overlay_df %>%
  left_join(aquamaps_vuln_scores) %>%
  mutate(trim_spp = ifelse(species %in% c(trimmings_spp$species), 1, NA),
         for_spp = ifelse(species %in% c(forage_spp$species), 1, NA)) %>%
  mutate(bycatch = case_when(
    ingredient %in% c("forage fish_fish meal", "forage fish_fish oil") & for_spp == 1 ~ 1,
    ingredient %in% c("trimmings fish_fish meal, cut offs", "trimmings fish_fish oil, cut offs") & trim_spp == 1 ~ 1,
    TRUE ~ bycatch_gf
  )) %>%
  mutate(aoh_overlap_vuln = aoh_overlap*bycatch_gf) %>%
  mutate(bycatch_quartile = case_when(
    bycatch_gf <0.25 ~ 0,
    bycatch_gf <= 0.75 & bycatch >= 0.25 ~ 0.5, 
    bycatch_gf > 0.75 ~ 1
  )) %>% 
   mutate(bycatch_new_test = case_when(
    bycatch_gf <0.25 ~ 0,
    bycatch_gf <= 0.75 & bycatch >= 0.25 ~ 0.25, 
    bycatch_gf > 0.75 ~ 0.5
  )) %>%
  mutate(aoh_overlap_vuln_quartile = aoh_overlap*bycatch_quartile) %>%
  mutate(aoh_overlap_vuln_test = aoh_overlap*bycatch_new_test) %>%
  dplyr::select(Genus, Species, spp_type, diet, allocation, ingredient, aoh_overlap, aoh_area_orig, suitability = bycatch_quartile, aoh_affected = aoh_overlap_vuln_quartile, aoh_affected_test = aoh_overlap_vuln_test, gapfill_flag) %>%
  mutate(sciname = paste(Genus, Species)) %>%
  dplyr::select(-Genus, -Species) %>%
  left_join(fishing_km2)

saveRDS(overlay_vuln, here("prep/03_prep_spp_habitats/output/aoh_marine_overlap.rds"))

terrestrial_overlap <- read.csv(here("prep/03_prep_spp_habitats/output/aoh_terrestrial_mammals_birds_overlap.csv"))
colnames(terrestrial_overlap)
# [1] "aoh_filename"         "sciname"              "bird_type"            "diet"                 "allocation"          
#  [6] "crop_ingredient"      "aoh_crop_overlap"     "aoh_area_orig"        "feed_filepath"        "aoh_filepath"        
# [11] "order"                "iucn_rl_cat"          "cropland_suitability" "aoh_affected"         "aoh_unaffected"      
# [16] "total_cropland"       "class"    

```

Do some testing 

```{r}

test <- overlay_vuln %>%
  filter(diet == "plant-dominant",
         allocation == "mass", 
         ingredient == "forage fish_fish meal")

sum(test$aoh_overlap, na.rm = TRUE) # 3342859 km2... that's a lot compared to crops! But there are more species, with larger AOH ranges, and more dispersed harvesting area

sum(test$aoh_affected, na.rm = TRUE) # 1432985 way better.. still pretty high tho 
sum(test$aoh_affected_test, na.rm = TRUE) # 716492.5 better but still pretty high 

mean(test$aoh_overlap, na.rm = TRUE) # 141.359 km2 mean
mean(test$aoh_affected, na.rm = TRUE) # 60.60158 km2 mean 
mean(test$aoh_affected_test, na.rm = TRUE) # 30.30079 km2 mean 


``` 



