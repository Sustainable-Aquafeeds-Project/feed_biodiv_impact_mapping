---
title: "Make maps"
output: html_document
editor_options: 
  chunk_output_type: console
---

## Setup

Load libraries

```{r setup, include=FALSE}

library(tidyverse)
library(here)
library(data.table)
library(terra)
library(raster)
library(rnaturalearth)
library(strex)
library(janitor)
library(sf)
library(tools)
library(khroma)
library(scales)
library(fields)
library(patchwork)
library(cowplot)
library(glue)
library(viridis)
library(RColorBrewer)
library(ggpubr)
library(smoothr)
library(egg)
library(ggh4x)

source(here("src/directories.R"))

source(here("src/spatial.R"))

select <- dplyr::select
setwd(dirname(rstudioapi::getSourceEditorContext()$path)) # set working directory to where this script is located
this_dir <- getwd()

biodiv_dir <- file.path(rdsi_dir, "biodiversity_impacts")

impact_maps_dir <- file.path(biodiv_dir, "output")

globe_bbox <- rbind(c(-180, -90), c(-180, 90), 
                      c(180, 90), c(180, -90), c(-180, -90)) 

globe_border <- st_polygon(list(globe_bbox)) %>%
  st_sfc(crs = 4326) %>%
  st_sf(data.frame(rgn = 'globe', geom = .)) %>%
  smoothr::densify(max_distance = 0.5) %>%
  st_transform(crs = crs(moll_template))


```

```{r establish color palettes}

## establish color palette from food footprint project
d_brown <- "#515256"
m_brown <- "#B27B54"
l_brown <- "#BC995F"
green <- "#A8B072"
yellow<- "#EFCE71"
l_yellow <- "#F7F6C1"

jv_pal <- c(l_yellow, yellow, green, l_brown, m_brown, d_brown)

continuous_pal <-  colorRampPalette(jv_pal, space="Lab", bias = 3.5)(10000)
image(volcano, asp=1, col=continuous_pal)

light_gray <- "#F8F9FA"
final_palette <- c(light_gray, continuous_pal)
image(volcano, asp=1, col=final_palette)

palette_red <- c(final_palette, "#B90000")
image(volcano, asp=1, col=palette_red)


countries_shp <- ne_countries(scale = 110, returnclass = "sf") |> 
  st_transform(crs(moll_template)) # read in countries shapefile

theme_ohara <- function(base_size = 9) {
  theme(axis.ticks = element_blank(),
        text             = element_text(family = 'Helvetica',
                                        color = 'gray30', size = base_size),
        plot.title       = element_text(size = rel(1.25), hjust = 0, face = 'bold'),
        panel.background = element_blank(),
        legend.position  = 'right',
        panel.border     = element_blank(),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_line(colour = 'grey90', size = .25),
        legend.key       = element_rect(colour = NA, fill = NA),
        axis.line        = element_blank())
}


```

Read in marine and terrestrial dfs and combine

```{r}
marine_overlap <- readRDS(here("prep/03_prep_spp_habitats/output/aoh_marine_impact.rds")) %>%
  group_by(sciname, spp_type, diet, fcr_type, allocation, ingredient) %>%
  summarise(vulnerability = mean(vulnerability, na.rm = TRUE), 
            impact_total = sum(impact_total, na.rm = TRUE)) %>%
  ungroup() %>%
    dplyr::select(sciname, spp_type, diet, fcr_type, allocation, ingredient, vulnerability, impact_total)


terrestrial_overlap <- readRDS(here("prep/03_prep_spp_habitats/output/aoh_terrestrial_mammals_birds_impact.rds")) %>% 
  group_by(sciname, diet, fcr_type, allocation, ingredient, spp_type) %>%
  summarise(vulnerability = 1 - mean(suitability, na.rm = TRUE),
            impact_total = sum(impact_total, na.rm = TRUE)) %>%
  ungroup() %>%
    dplyr::select(sciname, spp_type, diet, fcr_type, allocation, ingredient, vulnerability, impact_total)

all_overlap <- rbind(marine_overlap, terrestrial_overlap)

spp_impacted <- all_overlap %>%
  group_by(spp_type, diet, allocation, fcr_type) %>%
  summarise(spp_count_impacted = n_distinct(sciname)) %>%
  ungroup()


aquamaps_spp <- readRDS(file.path(rdsi_dir, "biodiversity_impacts/int/spp_vuln_depth_info.rds")) %>%
  distinct(spp_type = taxon, sciname = species)
  
eyres_spp <- readRDS(here("prep/03_prep_spp_habitats/data/iucn/eyres_iucn_spp.rds")) %>%
  dplyr::select(spp_type, sciname = scientific_name) %>%
  mutate(sciname = tolower(sciname)) %>%
  mutate(spp_type = case_when(
    spp_type == "mammals" ~ "Terrestrial mammal",
    spp_type == "amphibians" ~ "Amphibians", 
    spp_type == "reptiles" ~ "Reptiles", 
    spp_type == "birds" ~ "Bird"
  ))

spp_assessed <- rbind(aquamaps_spp, eyres_spp) %>%
  group_by(spp_type) %>%
  summarise(spp_count_assessed = n_distinct(sciname)) %>%
  ungroup()
```

Maps!

Global maps across ingredients and taxon; Delta plots as well

```{r}

## only need to save RDS when impact maps info has changed
allocations <- c("ge", "mass", "economic")

for(allocation_type in allocations){

 # allocation_type = "economic"

global_maps_list <- list.files(file.path(impact_maps_dir, "impact_maps_across_taxon_ingredient"), pattern = allocation_type, recursive = TRUE, full.names = TRUE)

global_maps_mean <- rast(global_maps_list)
names(global_maps_mean) <- file_path_sans_ext(str_after_nth(global_maps_list, "\\/", 6))


all_df <- as.data.frame(global_maps_mean, xy = TRUE) %>%
  pivot_longer(cols = c(3:ncol(.)), values_to = "value", names_to = "type") %>%
  separate_wider_delim(type, delim = "/", names = c("diet", "fcr_type", "calc_type")) %>%
  mutate(value_log =  ifelse(str_detect(calc_type, "mean"), log(value*1000000 + 1), value)) %>%
  rename(long = x, lat = y)
# %>%
  # filter(str_detect(calc_type, "mean_prop")) # comment this out if you want to run a specific calc_type only

for(i in unique(all_df$calc_type)){

  # i = "economic_mean"

  loop_df <- all_df %>%
    filter(calc_type == i) 

data.table::fwrite(loop_df, glue(file.path(impact_maps_dir, "csvs/impact_maps_across_taxon_ingredient/{i}.rds.gz")))


delta_df <-  loop_df %>%
        dplyr::select(-value_log)

  delta_df <- delta_df %>%
      pivot_wider(names_from = c(diet), values_from = value) %>%
    mutate(`fish-dominant` = ifelse(is.na(`fish-dominant`), 0, `fish-dominant`),
           `plant-dominant` = ifelse(is.na(`plant-dominant`), 0, `plant-dominant`)) %>%
  mutate(delta = (`fish-dominant` - `plant-dominant`)) %>%
    mutate(delta_log = log(delta + 1)) %>%
    mutate(delta_rescale = delta*1000000) %>%
    mutate(delta_cat = case_when(
      delta > 0 ~ "Fish-dominant",
      delta < 0 ~ "Plant-dominant",
      delta == 0 ~ "No difference"
    ))


data.table::fwrite(delta_df, glue(file.path(impact_maps_dir, "csvs/impact_maps_across_taxon_ingredient/delta/{i}.rds.gz")))

}
}



## make plots showing impacts for each scenario 

allocation_types <- c("mass", "economic", "ge")  
calc_types <- c("mean", "nspp", "sd")
calc_types_2 <- c("_prop", "")
types_df <- expand.grid(allocation_types, calc_types, calc_types_2) %>%
  unite(new_var, Var1:Var2, sep = "_") %>%
    unite(new_var, new_var:Var3, sep = "") %>%
  pull(new_var) %>%
  unique()

types_df <- types_df[!grepl("nspp_prop", types_df)]

diets <- c("fish-dominant", "plant-dominant")
fcrs <- c("regular", "efficienct")

types_df <- grep(pattern = "mean_prop", types_df, value = TRUE)

for(type in types_df){
  
  # type = "economic_mean_prop"
  
 filepath <- glue(file.path(impact_maps_dir, "csvs/impact_maps_across_taxon_ingredient/{type}.rds.gz"))

loop_df <-  fread(filepath) 

if(str_detect(type, "_prop|nspp|sd")){
  
  if(str_detect(type, "_prop")){
  fill_name = "Proportion\nhabitat\nimpacted"
    
  }else if(str_detect(type, "nspp")){
    fill_name = "Number of\nspecies\nimpacted"
  }else{
    fill_name = "sdev"
  }
    
  
## create maps in separate plots, force common scale between them
maps <- map(.x = diets, 
            .f = function(x, y) 
  ggplot() + 
      geom_tile(data = loop_df  %>%
              filter(diet == x), aes(x = long, y = lat, fill = value)) +
    scale_fill_gradientn(colors = palette_red, na.value = "white") +
            geom_sf(data = countries_shp, fill = NA, colour = "grey") + 
            geom_sf(data = globe_border,
            fill = NA, color = 'grey70', 
            size = .1) +
    scale_x_continuous(expand = c(0, 0)) +
    scale_y_continuous(expand = c(0, 0)) +
    theme_void() +
    facet_wrap(~fcr_type) + 
      theme(
          axis.title = element_blank(),
          axis.text = element_blank(),
          axis.ticks = element_blank(),
          legend.margin = margin(r = 10)) + # add a margin to legend text so it isn't cut off when saving 
  labs(fill = fill_name)
        ) 

ggsave(glue(here(this_dir, "output/plots/{type}_plot.png")), plot = plot_grid(plotlist = maps, labels = glue("{diets}:{type}"), label_size = 10, nrow = 2), width = 10, height = 8, bg = "white")



}else{
  
  maps <- map(.x = diets, 
            .f = function(x, y) 
  ggplot() + 
  geom_tile(data = loop_df  %>% 
              filter(diet == x), aes(x= long, y = lat, fill = value_log)) +  # change to regular value if you don't want log transformed...
      # scale_fill_gradientn(colors = YlOrBr(9), na.value = "white") +  # Set the color for missing values (NA) to white
   scale_fill_gradientn(colors = final_palette, na.value = "white") +
              geom_sf(data = countries_shp, fill = NA, colour = "grey") + 
            geom_sf(data = globe_border,
            fill = NA, color = 'grey70', 
            size = .1) +
    scale_x_continuous(expand = c(0, 0)) +
    scale_y_continuous(expand = c(0, 0)) +
    theme_void() +
    facet_wrap(~fcr_type) + 
      theme(
          axis.title = element_blank(),
          axis.text = element_blank(),
          axis.ticks = element_blank(), 
          legend.margin = margin(r = 10)) +
    labs(fill = "Logged\nExtinction\nRisk")
            )

ggsave(glue(here(this_dir, "output/plots/{type}_plot.png")), plot = plot_grid(plotlist = maps, labels = glue("{diets}:{type}"), label_size = 10, nrow = 2), width = 10, height = 8, bg = "white")
}

}


# create delta (change) plots between each diet scenario

for(type in types_df){
  
  # type = "economic_mean"
 
  # if(file.exists(glue(here(this_dir, "output/plots/delta/{type}_plot.png")))){
  #   cat("exists")
  #   next()
  # }

 filepath <- glue(file.path(impact_maps_dir, "csvs/impact_maps_across_taxon_ingredient/delta/{type}.rds.gz"))

delta_df <-  fread(filepath) %>%
  filter(calc_type == type)
  
if(str_detect(type, "nspp|_prop")){
  limit <- c(min(delta_df$delta), max(delta_df$delta))

}else{
limit <- c(quantile(delta_df$delta, 0.05), quantile(delta_df$delta, 0.9))

}


if(str_detect(type, "nspp")){
  fill_name = 'Δ Nspp\nimpacted'

}else if(str_detect(type, "sd")){
 fill_name = 'Δ sdev'
 
}else if(type %in% c("mass_mean", "economic_mean", "ge_mean")){
    fill_name = 'Δ\nExtinction\nRisk'
}else{
   
      fill_name = 'Δ\nProportion\nRemaining'

 }
## create maps in separate plots, force common scale between them
# p <- ggplot() +
#   geom_tile(data = delta_df %>% filter(delta != 0) , aes(x= long, y = lat, fill = delta)) +
#     scale_fill_gradient2(low = "blue", mid = "white", high = "red", midpoint = 0, limit = limit, na.value = "white", oob=scales::squish) + # this will make sure anything above the scales limit will be a solid color
#   geom_sf(data = countries_shp, fill = NA, colour = "grey") +
#     facet_wrap(~fcr_type) +
#   theme_minimal() +
#       theme(
#           axis.title = element_blank(),
#           axis.text = element_blank(),
#           axis.ticks = element_blank()) +
#     labs(caption = str_replace(glue("{type}"), "_", "; "))

p <- ggplot() +
  geom_raster(data = delta_df , aes(x= long, y = lat, fill = delta)) +
  geom_sf(data = countries_shp, fill = NA, colour = "grey") +
        geom_sf(data = globe_border,
            fill = NA, color = 'grey70', 
            size = .1) +
    scale_x_continuous(expand = c(0, 0)) +
    scale_y_continuous(expand = c(0, 0)) +
    theme_void() +
    facet_wrap(~fcr_type) +
    labs(caption = str_replace(glue("{type}"), "_", "; "), 
         fill = fill_name) + 
        scale_fill_gradient2(high = '#d01c8b', mid = '#ffffdf', low = '#4dac26', limit = limit, oob=scales::squish) +
  theme(legend.margin = margin(r = 10))


  ggsave(plot = p, glue(here(this_dir, "output/plots/delta/{type}_plot.png")), width = 6.5, height = 3, dpi = 300)

}

```

Global maps across ingredients per taxon - there is an if statement within each loop that will skip if the files exists. If you want to rerun all of the files you will need to comment that out.

```{r}

allocations <- c("economic", "ge", "mass")
calc_types <- c("mean", "sd", "nspp", "mean_prop", "sd_prop")
taxon <- all_overlap %>% 
  filter(spp_type != "polychaetes") %>% 
  pull(spp_type) %>% unique()

## this part only needs to be run if the source maps changed! 
for(allocation_type in allocations){
    for(taxa_type in taxon){

# allocation_type = "mass"
#  taxa_type = "cnidaria"
      
       if(all(c(file.exists(glue(file.path(impact_maps_dir, "csvs/impact_maps_by_taxon_across_ingredient/{allocation_type}_{taxa_type}_mean.rds.gz"))), 
          file.exists(glue(file.path(impact_maps_dir, "csvs/impact_maps_by_taxon_across_ingredient/{allocation_type}_{taxa_type}_mean_prop.rds.gz"))),
          file.exists(glue(file.path(impact_maps_dir, "csvs/impact_maps_by_taxon_across_ingredient/{allocation_type}_{taxa_type}_sd_prop.rds.gz"))),
          file.exists(glue(file.path(impact_maps_dir, "csvs/impact_maps_by_taxon_across_ingredient/{allocation_type}_{taxa_type}_nspp.rds.gz"))),
          file.exists(glue(file.path(impact_maps_dir, "csvs/impact_maps_by_taxon_across_ingredient/{allocation_type}_{taxa_type}_sd.rds.gz"))))
          )){

    cat("file exists")
    next()
  }else{
    cat(glue("running {allocation_type} {taxa_type}"))
  }

global_maps_list <- list.files(file.path(impact_maps_dir, "impact_maps_by_taxon_across_ingredient"), pattern = glue("{allocation_type}_{taxa_type}"), recursive = TRUE, full.names = TRUE)

stack_rast <- rast()

for(file in global_maps_list){
  # file <- global_maps_list[[1]]

  rast_1 <- rast(file) %>%
    project(., moll_template, method = "near")

  stack_rast <- c(stack_rast, rast_1)
}

names(stack_rast) <- file_path_sans_ext(str_after_nth(global_maps_list, "\\/", 6))


all_df <- terra::as.data.frame(stack_rast, xy = TRUE) %>%
  pivot_longer(cols = c(3:ncol(.)), values_to = "value", names_to = "type") %>%
  filter(!is.na(value)) %>%
  separate_wider_delim(type, delim = "/", names = c("diet", "fcr_type", "taxa_calc_type")) %>%
  separate_wider_delim(taxa_calc_type, delim = "_", names = c("allocation", "taxa", "calc_type"), too_many = "merge") %>%
  mutate(value_log =  log(value*1000000 + 1)) %>%
  rename(long = x, lat = y)

for(i in unique(all_df$calc_type)){

  # i = "nspp"

  if(file.exists(glue(file.path(impact_maps_dir, "csvs/impact_maps_by_taxon_across_ingredient/{allocation_type}_{taxa_type}_{i}.rds.gz")))){

    cat("file exists")
    next()
  }else{
    cat(glue("running {i} {allocation_type} {taxa_type}"))
  }

  loop_df <- all_df %>%
    filter(calc_type == i) %>%
    filter(!is.na(value))

  data.table::fwrite(loop_df, glue(file.path(impact_maps_dir, "csvs/impact_maps_by_taxon_across_ingredient/{allocation_type}_{taxa_type}_{i}.rds.gz")))

  
    delta_df <- loop_df %>%
      pivot_wider(names_from = c(diet, taxa), values_from = value) %>%
    rename_with(
      ~ case_when(
        str_detect(., "fish-dominant") ~ "fish-dominant",
        str_detect(., "plant-dominant") ~ "plant-dominant",
        TRUE ~ .)
      ) %>%
    mutate(`fish-dominant` = ifelse(is.na(`fish-dominant`), 0, `fish-dominant`),
           `plant-dominant` = ifelse(is.na(`plant-dominant`), 0, `plant-dominant`)) %>%
  mutate(delta = (`fish-dominant` - `plant-dominant`))
  
data.table::fwrite(delta_df, glue(file.path(impact_maps_dir, "csvs/impact_maps_by_taxon_across_ingredient/delta/{allocation_type}_{taxa_type}_{i}.rds.gz")))
  
      }
    }
  }

     
  
# make and save plots across ingredients per taxon  

for(allocation_type in allocations){
    for(taxa_type in taxon){
      for(type in calc_types){

        # allocation_type = "economic"
        # taxa_type = "Bird"
        # type = "mean"
        
        all_df <- fread(glue(file.path(impact_maps_dir, "csvs/impact_maps_by_taxon_across_ingredient/{allocation_type}_{taxa_type}_{type}.rds.gz"))) %>%
          filter(!is.na(value))
        
diets <- unique(all_df$diet)
  
if(str_detect(type, "_prop|nspp|sd")){
  
    if(str_detect(type, "_prop")){
  fill_name = "Proportion\nhabitat\nremaining"
    
  }else if(str_detect(type, "nspp")){
    fill_name = "Number of\nspecies\nremaining"
  }else{
    fill_name = "sdev"
  }
  

## create maps in separate plots, force common scale between them
maps <- map(.x = diets, 
            .f = function(x, y) 
  ggplot() + 
  geom_tile(data = all_df  %>% filter(diet == x), aes(x= long, y = lat, fill = value)) + 
   scale_fill_gradientn(colors = final_palette, na.value = "white") +
              geom_sf(data = countries_shp, fill = NA, colour = "grey") + 
            geom_sf(data = globe_border,
            fill = NA, color = 'grey70', 
            size = .1) +
    scale_x_continuous(expand = c(0, 0)) +
    scale_y_continuous(expand = c(0, 0)) +
    theme_void() +
    facet_wrap(~fcr_type) +
      theme(
          axis.title = element_blank(),
          axis.text = element_blank(),
          axis.ticks = element_blank(), 
          legend.margin = margin(r = 10)) +
    labs(fill = fill_name)
            ) 


ggsave(glue(here(this_dir, "output/plots/by_taxa/{allocation_type}_{taxa_type}_{type}_plot.png")), plot = plot_grid(plotlist = maps, labels = glue("{diets}:{allocation_type}:{taxa_type}:{type}"), label_size = 10, nrow = 2), width = 10, height = 8, bg = "white")

}else{
 
   maps <- map(.x = diets, 
            .f = function(x, y) 
  ggplot() + 
  geom_tile(data = all_df  %>% filter(diet == x), aes(x= long, y = lat, fill = value_log)) + 
      # scale_fill_gradientn(colors = YlOrBr(9), na.value = "white") +  # Set the color for missing values (NA) to white
   scale_fill_gradientn(colors = final_palette, na.value = "white") +
   #  scale_fill_viridis(direction = -1) + 
              geom_sf(data = countries_shp, fill = NA, colour = "grey") + 
            geom_sf(data = globe_border,
            fill = NA, color = 'grey70', 
            size = .1) +
    scale_x_continuous(expand = c(0, 0)) +
    scale_y_continuous(expand = c(0, 0)) +
    theme_void() +
    facet_wrap(~fcr_type) +
      theme(
          axis.title = element_blank(),
          axis.text = element_blank(),
          axis.ticks = element_blank(),
          legend.margin = margin(r = 10)) +
    labs(fill = "Logged\nExtinction\nRisk")
            ) 
  
  ggsave(glue(here(this_dir, "output/plots/by_taxa/{allocation_type}_{taxa_type}_{type}_plot.png")), plot = plot_grid(plotlist = maps, labels = glue("{diets}:{allocation_type}:{taxa_type}:{type}"), label_size = 10, nrow = 2), width = 10, height = 8, bg = "white")
}

    }
  }
}



# save delta plots across ingredients per taxon 
taxon <- taxon[-5]

for(allocation_type in allocations){
    for(taxa_type in taxon){
      for(type in calc_types){
  
        # type = "mean"
        # allocation_type = "economic"
        # taxa_type = "arthropods"
  
  if(file.exists(glue(here(this_dir, "output/plots/delta/by_taxa/{allocation_type}_{taxa_type}_{type}_plot.png")))){
    cat("exists")
    next()
  }

delta_df <- fread(glue(file.path(impact_maps_dir, "csvs/impact_maps_by_taxon_across_ingredient/delta/{allocation_type}_{taxa_type}_{type}.rds.gz")))
  


if(str_detect(type, "nspp|_prop")){
  limit <- c(min(delta_df$delta), max(delta_df$delta))

}else{
limit <- c(quantile(delta_df$delta, 0.05), quantile(delta_df$delta, 0.9))
}

if(str_detect(type, "nspp")){
  fill_name = 'Δ Nspp\nimpacted'

}else if(str_detect(type, "sd")){
 fill_name = 'Δ sdev'
 
}else if(type %in% c("mass_mean", "economic_mean", "ge_mean")){
    fill_name = 'Δ Extinction\nRisk'
}else{
   
      fill_name = 'Δ Proportion\nRemaining'

 }

## create maps in separate plots, force common scale between them
  # ggplot() +
  # geom_tile(data = delta_df %>% filter(delta != 0) , aes(x= long, y = lat, fill = delta)) +
  #   scale_fill_gradient2(low = "blue", mid = "white", high = "red", midpoint = 0,  limit = limit, na.value = "white", oob=scales::squish) + # squish makes sure anything above the scales limit will be a solid red or blue... better to visualize this way since the numbers are so small
  #             geom_sf(data = countries_shp, fill = NA, colour = "grey") +
  #   facet_wrap(~fcr_type) +
  # theme_minimal() +
  #     theme(
  #         axis.title = element_blank(),
  #         axis.text = element_blank(),
  #         axis.ticks = element_blank()) +
  #   labs(caption = glue("{allocation_type}; {taxa_type}; {type}"))
  
  
  p <- ggplot() +
  geom_raster(data = delta_df , aes(x= long, y = lat, fill = delta)) +
  geom_sf(data = countries_shp, fill = NA, colour = "grey") +
        geom_sf(data = globe_border,
            fill = NA, color = 'grey70', 
            size = .1) +
    scale_x_continuous(expand = c(0, 0)) +
    scale_y_continuous(expand = c(0, 0)) +
    theme_void() +
    facet_wrap(~fcr_type) +
    labs(caption = glue("{allocation_type}; {taxa_type}; {type}"), 
         fill = fill_name) + 
        scale_fill_gradient2(high = '#d01c8b', mid = '#ffffdf', low = '#4dac26', limit = limit, oob=scales::squish) +
    theme(
          legend.margin = margin(r = 10))
       

    ggsave(plot = p, glue(here(this_dir, "output/plots/delta/by_taxa/{allocation_type}_{taxa_type}_{type}_plot.png")), width = 6.5, height = 3, dpi = 300, bg = "white")


# ggsave(glue(here(this_dir, "output/plots/delta/by_taxa/{allocation_type}_{taxa_type}_{type}_plot.png")), width = 10, height = 8, bg = "white")

    }
  }
}

```

Global maps by ingredients across taxon

```{r}

allocations <- c("economic", "ge", "mass")
calc_types <- c("mean", "sd", "nspp", "sd_prop", "mean_prop")
ingredients <- all_overlap %>% 
  pull(ingredient) %>% unique()

## commented out code only needs to be run if the source impact maps are updated! 
for(allocation_type in allocations){
  for(ingredient_type in ingredients){

      # ingredient_type = "Soybean_soybean meal"
      # allocation_type = "economic"
      # type = "mean"

global_maps_list <- list.files(file.path(impact_maps_dir, "impact_maps_across_taxon_by_ingredient"), pattern = glue("{allocation_type}_{ingredient_type}"), recursive = TRUE, full.names = TRUE)

stack_rast <- rast()

for(file in global_maps_list){
  # file <- global_maps_list[[1]]

  rast_1 <- rast(file) %>%
    project(., moll_template, method = "near")

  stack_rast <- c(stack_rast, rast_1)
}

names(stack_rast) <- file_path_sans_ext(str_after_nth(global_maps_list, "\\/", 6))


all_df <- as.data.frame(stack_rast, xy = TRUE) %>%
  pivot_longer(cols = c(3:ncol(.)), values_to = "value", names_to = "type") %>%
  separate_wider_delim(type, delim = "/", names = c("diet", "fcr_type", "ingredient_calc_type")) %>%
    separate_wider_delim(ingredient_calc_type, delim = "_", names = c("allocation", "raw_material", "ingredient", "calc_type"), too_many = "merge") %>%
  mutate(value_log =  ifelse(str_detect(calc_type, "mean"), log(value*1000000 + 1), value)) %>%
  rename(long = x, lat = y) %>%
  filter(!is.na(value)) %>%
  unite("crop_ingredient", c(raw_material:ingredient), sep = "_", remove = FALSE)

for(i in unique(all_df$calc_type)){
  # i = "mean"

  loop_df <- all_df %>%
    filter(calc_type == i) %>%
    filter(!is.na(value))

  data.table::fwrite(loop_df, glue(file.path(impact_maps_dir, "csvs/impact_maps_across_taxon_by_ingredient/{allocation_type}_{ingredient_type}_{i}.rds.gz")))
  
  
          delta_df <- loop_df %>%
          filter(!is.na(value)) %>%
          dplyr::select(long, lat, fcr_type, allocation, crop_ingredient, calc_type, diet, value) %>%
          filter(crop_ingredient == ingredient_type)

  
  delta_df <- delta_df %>%
      pivot_wider(names_from = c(diet, crop_ingredient), values_from = value) %>%
    rename_with(
      ~ case_when(
        str_detect(., "fish-dominant") ~ "fish-dominant",
        str_detect(., "plant-dominant") ~ "plant-dominant",
        TRUE ~ .)
      ) 
  
  if(!("fish-dominant" %in% c(colnames(delta_df)))){
    
    delta_df <- delta_df %>%
      mutate(`fish-dominant` = 0)
  }else if(!("plant-dominant" %in% c(colnames(delta_df)))){
        delta_df <- delta_df %>%
      mutate(`plant-dominant` = 0)
  }
  
  delta_df <- delta_df %>% 
  mutate(`fish-dominant` = coalesce(`fish-dominant`, 0),
         `plant-dominant` = coalesce(`plant-dominant`, 0)) %>%
  mutate(delta = (`fish-dominant` - `plant-dominant`)) 
  

  
  data.table::fwrite(loop_df, glue(file.path(impact_maps_dir, "csvs/impact_maps_across_taxon_by_ingredient/delta/{allocation_type}_{ingredient_type}_{type}.rds.gz")))


   }
  }
}



for(allocation_type in allocations){
    for(ingredient_type in ingredients){
      for(type in calc_types){
        
      # ingredient_type = "Soybean_soybean meal"
      # allocation_type = "economic"
      # type = "mean"
        
                all_df <- fread(glue(file.path(impact_maps_dir, "csvs/impact_maps_across_taxon_by_ingredient/{allocation_type}_{ingredient_type}_{type}.rds.gz"))) 
 
diets <- unique(all_df$diet)
  

if(str_detect(type, "_prop|nspp|sd")){
  
    if(str_detect(type, "_prop")){
  fill_name = "Proportion\nhabitat\nremaining"
    
  }else if(str_detect(type, "nspp")){
    fill_name = "Number of\nspecies\nremaining"
  }else{
    fill_name = "sdev"
  }
  
## create maps in separate plots, force common scale between them
maps <- map(.x = diets, 
            .f = function(x, y) 
  ggplot() + 
  geom_tile(data = all_df  %>% filter(diet == x), aes(x= long, y = lat, fill = value)) + 
   scale_fill_gradientn(colors = final_palette, na.value = "white") +
              geom_sf(data = countries_shp, fill = NA, colour = "grey") + 
            geom_sf(data = globe_border,
            fill = NA, color = 'grey70', 
            size = .1) +
    scale_x_continuous(expand = c(0, 0)) +
    scale_y_continuous(expand = c(0, 0)) +
    theme_void() +
        theme(
          legend.margin = margin(r = 10)) +
    labs(fill = fill_name) + 
    facet_wrap(~fcr_type) 
            )

ggsave(glue(here(this_dir, "output/plots/by_ingredient/{allocation_type}_{ingredient_type}_{type}_plot.png")), plot = plot_grid(plotlist = maps, labels = glue("{diets}:{allocation_type}:{ingredient_type}:{type}"), label_size = 10, nrow = 2), width = 10, height = 8, bg = "white")


}else{
  ## create maps in separate plots, force common scale between them
maps <- map(.x = diets, 
            .f = function(x, y) 
  ggplot() + 
  geom_tile(data = all_df  %>% filter(diet == x), aes(x= long, y = lat, fill = value_log)) + 
   scale_fill_gradientn(colors = final_palette, na.value = "white") +
              geom_sf(data = countries_shp, fill = NA, colour = "grey") + 
            geom_sf(data = globe_border,
            fill = NA, color = 'grey70', 
            size = .1) +
    scale_x_continuous(expand = c(0, 0)) +
    scale_y_continuous(expand = c(0, 0)) +
    theme_void() +
        theme(
          legend.margin = margin(r = 10)) +
    labs(fill = "Logged\nExtinction\nRisk") + 
    facet_wrap(~fcr_type) 
            )

ggsave(glue(here(this_dir, "output/plots/by_ingredient/{allocation_type}_{ingredient_type}_{type}_plot.png")), plot = plot_grid(plotlist = maps, labels = glue("{diets}:{allocation_type}:{ingredient_type}:{type}"), label_size = 10, nrow = 2), width = 10, height = 8, bg = "white")
  
}
    
    }
  }
}


# make delta plots! 
## jan 20 - sd_prop mean_prop delta doesn't exist; need to fix

calc_types <- calc_types[-5]
calc_types <- calc_types[-4]

for(allocation_type in allocations){
    for(ingredient_type in ingredients){
      for(type in calc_types){
  
        # type = "mean_prop"
        # allocation_type = "economic"
        # ingredient_type = "forage fish_fish oil"
  
  # if(file.exists(glue(here(this_dir, "output/plots/delta/by_ingredient/{allocation_type}_{ingredient_type}_{type}_plot.png")))){
  #   cat("exists")
  #   next()
  # }
        
        
        delta_df <- fread(glue(file.path(impact_maps_dir, "csvs/impact_maps_across_taxon_by_ingredient/delta/{allocation_type}_{ingredient_type}_{type}.rds.gz")))
  
  
        
if(str_detect(type, "nspp|_prop")){
  limit <- c(min(delta_df$delta), max(delta_df$delta))

}else{
limit <- c(quantile(delta_df$delta, 0.05), quantile(delta_df$delta, 0.9))
}

## create maps in separate plots, force common scale between them
  ggplot() +
  geom_tile(data = delta_df %>% filter(delta != 0) , aes(x= long, y = lat, fill = delta)) +
    scale_fill_gradient2(low = "blue", mid = "white", high = "red", midpoint = 0,  limit = limit, na.value = "white", oob=scales::squish) +
              geom_sf(data = countries_shp, fill = NA, colour = "grey") +
                geom_sf(data = globe_border,
            fill = NA, color = 'grey70', 
            size = .1) +
    scale_x_continuous(expand = c(0, 0)) +
    scale_y_continuous(expand = c(0, 0)) +
    theme_void() +
        theme(
          legend.margin = margin(r = 10)) +
    labs(fill = "Logged\nExtinction\nRisk") + 
    facet_wrap(~fcr_type) +
    labs(caption = glue("{allocation_type}; {ingredient_type}; {type}"))


ggsave(glue(here(this_dir, "output/plots/delta/by_ingredient/{allocation_type}_{ingredient_type}_{type}_plot.png")), width = 10, height = 8, bg = "white")

    }
  }
}

```

Global maps by raw material across taxon

```{r}

allocations <- c("economic", "ge", "mass")
calc_types <- c("mean", "sd", "nspp", "sd_prop", "mean_prop")
ingredients <- all_overlap %>% pull(ingredient) %>% unique()
raw_mats <- all_overlap %>% mutate(raw_material = str_before_first(ingredient, "_")) %>% 
  # filter(!(raw_material %in% c("forage fish", "trimmings fish"))) %>% 
  pull(raw_material) %>% unique()

## for some reason didn't run all... need to split mean and mean_prop? 

## commented out code only needs to be run if the source impact maps are updated! 
for(allocation_type in allocations){
  for(raw_mat in raw_mats){
    for(type in calc_types){

    # ingredient_type = "Sunflower_sunflower meal"
    # allocation_type = "economic"
    # type = "mean"
    #  raw_mat = "Sunflower"

    all_files <- list.files(file.path(impact_maps_dir, "csvs/impact_maps_across_taxon_by_ingredient"), pattern = glue("{allocation_type}_{raw_mat}_.*._{type}"), full.names = TRUE)


all_df <- map_dfr(all_files, ~fread(.x), header = TRUE)

all_df_fin <- all_df %>% 
  mutate(value_log = log(value + 1)*1000000) %>%
  group_by(long, lat, diet, fcr_type, allocation, raw_material, calc_type) %>% 
  summarise(value = sum(value, na.rm = TRUE),
            value_log = sum(value_log, na.rm = TRUE)) %>%
  ungroup()

# test <- all_df_fin %>% group_by(diet, fcr_type, allocation) %>% summarise(sum = sum(value, na.rm = TRUE))


data.table::fwrite(all_df_fin, glue(file.path(impact_maps_dir, "csvs/impact_maps_across_taxon_by_raw_material/{allocation_type}_{raw_mat}_{type}.rds.gz")))


delta_df <- all_df_fin %>%
        pivot_wider(names_from = c(diet), values_from = value) 


  if(!("fish-dominant" %in% c(colnames(delta_df)))){
    
    delta_df <- delta_df %>%
      mutate(`fish-dominant` = 0)
  }else if(!("plant-dominant" %in% c(colnames(delta_df)))){
        delta_df <- delta_df %>%
      mutate(`plant-dominant` = 0)
  }

delta_df <- delta_df %>% 
  mutate(delta = (`fish-dominant` - `plant-dominant`)) 

data.table::fwrite(delta_df, glue(file.path(impact_maps_dir, "csvs/impact_maps_across_taxon_by_raw_material/delta/{allocation_type}_{raw_mat}_{type}.rds.gz")))

    }
  }
}



for(allocation_type in allocations){
    for(raw_mat in raw_mats){
      for(type in calc_types){
        
      # raw_mat = "forage fish"
      # allocation_type = "economic"
      # type = "nspp"
      
                all_df <- fread(glue(file.path(impact_maps_dir, "csvs/impact_maps_across_taxon_by_raw_material/{allocation_type}_{raw_mat}_{type}.rds.gz"))) 
 
diets <- unique(all_df$diet)


if(str_detect(type, "_prop|nspp|sd")){
  
    if(str_detect(type, "_prop")){
  fill_name = "Proportion\nhabitat\nremaining"
    
  }else if(str_detect(type, "nspp")){
    fill_name = "Number of\nspecies\nremaining"
  }else{
    fill_name = "sdev"
  }
  
  
## create maps in separate plots, force common scale between them
maps <- map(.x = diets, 
            .f = function(x, y) 
  ggplot() + 
  geom_tile(data = all_df  %>% filter(diet == x), aes(x= long, y = lat, fill = value)) + 
   scale_fill_gradientn(colors = final_palette, na.value = "white") +
              geom_sf(data = countries_shp, fill = NA, colour = "grey") + 
                geom_sf(data = globe_border,
            fill = NA, color = 'grey70', 
            size = .1) +
    scale_x_continuous(expand = c(0, 0)) +
    scale_y_continuous(expand = c(0, 0)) +
    theme_void() +
        theme(
          legend.margin = margin(r = 10)) +
    labs(fill = "Logged\nExtinction\nRisk") + 
    facet_wrap(~fcr_type) + 
    labs(fill = fill_name)
            )

ggsave(glue(here(this_dir, "output/plots/by_material/{allocation_type}_{raw_mat}_{type}_plot.png")), plot = plot_grid(plotlist = maps, labels = glue("{diets}:{allocation_type}:{raw_mat}:{type}"), label_size = 10, nrow = 2), width = 10, height = 8, bg = "white")

}else{
  
  
  maps <- map(.x = diets, 
            .f = function(x, y) 
  ggplot() + 
  geom_tile(data = all_df  %>% filter(diet == x), aes(x= long, y = lat, fill = value_log)) + 
   scale_fill_gradientn(colors = final_palette, na.value = "white") +
              geom_sf(data = countries_shp, fill = NA, colour = "grey") + 
                geom_sf(data = globe_border,
            fill = NA, color = 'grey70', 
            size = .1) +
    scale_x_continuous(expand = c(0, 0)) +
    scale_y_continuous(expand = c(0, 0)) +
    theme_void() +
        theme(
          legend.margin = margin(r = 10)) +
    labs(fill = "Logged\nExtinction\nRisk") + 
    facet_wrap(~fcr_type) + 
    labs(fill = "Logged\nExtinction\nRisk")
            )

ggsave(glue(here(this_dir, "output/plots/by_material/{allocation_type}_{raw_mat}_{type}_plot.png")), plot = plot_grid(plotlist = maps, labels = glue("{diets}:{allocation_type}:{raw_mat}:{type}"), label_size = 10, nrow = 2), width = 10, height = 8, bg = "white")
  
  
}
    
    }
  }
}


# make delta plots! 

for(allocation_type in allocations){
    for(raw_mat in raw_mats){
      for(type in calc_types){
  
        # type = "mean"
        # allocation_type = "economic"
        # raw_mat = "Soybean"
  
  # if(file.exists(glue(here(this_dir, "output/plots/delta/by_ingredient/{allocation_type}_{ingredient_type}_{type}_plot.png")))){
  #   cat("exists")
  #   next()
  # }
  
        delta_df <- fread(glue(file.path(impact_maps_dir, "csvs/impact_maps_across_taxon_by_raw_material/delta/{allocation_type}_{raw_mat}_{type}.rds.gz"))) %>%
          filter(!is.na(delta)) %>%
          dplyr::select(long, lat, fcr_type, allocation, raw_material, calc_type, delta)
  
if(str_detect(type, "nspp|_prop")){
  limit <- c(min(delta_df$delta), max(delta_df$delta))
  
}else{
limit <- c(quantile(delta_df$delta, 0.05), quantile(delta_df$delta, 0.9))
}

## create maps in separate plots, force common scale between them
  ggplot() + 
  geom_tile(data = delta_df %>% filter(delta != 0) , aes(x= long, y = lat, fill = delta)) +
    scale_fill_gradient2(low = "blue", mid = "white", high = "red", midpoint = 0,  limit = limit, na.value = "white", oob=scales::squish) +
              geom_sf(data = countries_shp, fill = NA, colour = "grey") +
                geom_sf(data = globe_border,
            fill = NA, color = 'grey70', 
            size = .1) +
    scale_x_continuous(expand = c(0, 0)) +
    scale_y_continuous(expand = c(0, 0)) +
    theme_void() +
        theme(
          legend.margin = margin(r = 10)) +
    labs(fill = "Logged\nExtinction\nRisk") + 
    facet_wrap(~fcr_type) + 
    labs(caption = glue("{allocation_type}; {raw_mat}; {type}"))
            

ggsave(glue(here(this_dir, "output/plots/delta/by_material/{allocation_type}_{raw_mat}_{type}_plot.png")), width = 10, height = 8, bg = "white")

    }
  }
}

```


```{r}
# make publication ready mean extinction risk plots with all feed scenarios, economic allocation
 filepath <- glue(file.path(impact_maps_dir, "csvs/impact_maps_across_taxon_ingredient/economic_mean.rds.gz"))

all_df <-  fread(filepath) 

p <-  ggplot() + 
  geom_tile(data = all_df, aes(x= long, y = lat, fill = value_log)) +  # change to regular value if you don't want log transformed...
      # scale_fill_gradientn(colors = YlOrBr(9), na.value = "white") +  # Set the color for missing values (NA) to white
   scale_fill_gradientn(colors = final_palette, na.value = "white") +
              geom_sf(data = countries_shp, fill = NA, colour = "grey") + 
            geom_sf(data = globe_border,
            fill = NA, color = 'grey70', 
            size = .1) +
    scale_x_continuous(expand = c(0, 0)) +
    scale_y_continuous(expand = c(0, 0)) +
    theme_void() +
    facet_grid(diet~fcr_type, switch = "y") + 
      theme(
            legend.title = element_text(size = 9),
          legend.margin = margin(r = 10), 
          strip.text.y = element_text(angle = 90, vjust = 1, hjust = 0.5)) +
    labs(fill = "Logged\nExtinction\nRisk") 

p <- tag_facet(p, x = -Inf, y = Inf, tag_pool = LETTERS, open = "", close = "") + 
  theme(strip.text = element_text())
        
ggsave(glue(here(this_dir, "output/plots/publication/economic_mean_extinction.png")), plot = p, width = 10, height = 8, bg = "white")


filepath <- glue(file.path(impact_maps_dir, "csvs/impact_maps_across_taxon_ingredient/delta/economic_mean.rds.gz"))

delta_df <-  fread(filepath) 
  
limit <- c(quantile(delta_df$delta, 0.05), quantile(delta_df$delta, 0.9))

p <- ggplot() +
  geom_raster(data = delta_df , aes(x= long, y = lat, fill = delta)) +
  geom_sf(data = countries_shp, fill = NA, colour = "grey") +
        geom_sf(data = globe_border,
            fill = NA, color = 'grey70', 
            size = .1) +
    scale_x_continuous(expand = c(0, 0)) +
    scale_y_continuous(expand = c(0, 0)) +
    theme_void() +
    facet_wrap(~fcr_type) +
    labs(
         fill = "Δ Extinction\nRisk") + 
        scale_fill_gradient2(high = '#d01c8b', mid = '#ffffdf', low = '#4dac26', limit = limit, oob=scales::squish) +
  theme(legend.margin = margin(r = 10),
        legend.title = element_text(size = 9))

p <- tag_facet(p, x = -Inf, y = Inf, tag_pool = LETTERS, open = "", close = "") + 
  theme(strip.text = element_text())


ggsave(plot = p, glue(here(this_dir, "output/plots/publication/economic_mean_extinction_delta.png")), width = 10, height = 8, bg = "white")

```


Map stats!

```{r}

## read in plant-dominant, economic, regulat
 filepath <- glue(file.path(impact_maps_dir, "csvs/impact_maps_across_taxon_ingredient/economic_mean.rds.gz"))

all_df <-  fread(filepath)  %>%
  filter(value > 0) %>%
  filter(!is.na(value))

max(all_df$value)

test <- all_df %>%
  group_by(diet, fcr_type) %>%
  summarise(mean_ext = mean(value, na.rm = TRUE))

scenario_summary <- all_df %>% 
  group_by(diet, fcr_type) %>%
  summarise(cells_impacted = n()) %>%
  ungroup()

moll_land <- readRDS(here("prep/03_prep_spp_habitats/data/spatial/moll_template_land_xy.rds"))

all_df_land <- all_df %>%
  left_join(moll_land, by = c("long" = "x", "lat" = "y")) %>%
  filter(!is.na(cell_id)) %>%
    group_by(diet, fcr_type) %>%
  summarise(cells_impacted = n()) %>%
  ungroup() %>%
   mutate(land_cells_total = 2876998) %>%
  mutate(prop = cells_impacted/land_cells_total)

moll_ocean <- readRDS(here("prep/03_prep_spp_habitats/data/spatial/moll_template_ocean_xy.rds"))

all_df_ocean <- all_df %>%
  left_join(moll_ocean, by = c("long" = "x", "lat" = "y")) %>%
  filter(!is.na(cell_id)) %>%
    group_by(diet, fcr_type) %>%
  summarise(cells_impacted = n()) %>%
  ungroup() %>%
  mutate(ocean_cells_total = 3684240) %>%
  mutate(prop = cells_impacted/ocean_cells_total)

# Comparing the fish-dominant and plant-dominant feed scenarios, under the regular FCR scenario, we see that the plant-dominant diet has 82,162 more pixels impacted (there are ~6.5 million pixels on a 10km by 10 km Mollweide grid). This difference is almost exclusively due to the difference in terrestrial crop impacts, with the plant-dominant diet having 81,990 more terrestrial pixels impacted than that of the fish-dominant diet. Overall, ocean pixels are impacted over a larger area: ~42% of ocean pixels are impacted, regardless of feed scenario. In comparison, 22%-25% of land pixels are impacted, depending on the scenario. 

```

