---
title: "Trimmings for feed"
author: "Gage Clawson (NCEAS, IMAS)"
date: "May 25, 2023"
output: html_document
editor_options: 
  chunk_output_type: console
---


```{r}
# load relevant packages, etc.

library(here)
library(raster)
library(tidyverse)
library(countrycode)
library(readxl)


source(here("src/fxns.R"))
source(here("src/directories.R"))

```


## Methods 

 1. Start with demand per country 
    - EX: NOR requires X tonnes of FO
 2. Get trade data for FO trimmings and FM from trimmings and match to demand data. Figure out how much countries import FO or FM from other countries. 
    - EX: NOR imports Y% of FO trimmings from USA, Z% from Peru, etc.
 3. Multiply the import %s by the demand tonnes to get ingredient tonnes imported per country
    - EX: NOR requires 100 tonnes of FO from trimmings, they import 60% from the USA, then 60 tonnes of FO ingredients in NOR comes from the USA for salmon. 
 4. Group by exporter country to get total amount of FO or FM ingredients from trimmings they export under each diet demand scenario
    - EX: USA exports 60 tonnes to NOR, 40 tonnes to CHL, then they export 100 tonnes of FO from trimmings total for salmon feed. 
 5. Determine each countries' breakdown of trimmings species catch by flag country (e.g., where the catch is actually landed, rather than caught). Filter for all trimmings species (from biomar report), group by country and species, and determine the within-country proportions of catch from each species. For example, 55% of the trimmings species weight that USA lands is from XX spp, 24% from YY spp, etc...
 6. Apply these within country percentages to total country exported fish oil and fish meal (calculated in step 4). Now we will have X tonnes of fish oil and Y tonnes of fish meal exported from or kept within country Z per trimmings fish species per diet scenario. 
     - For example, if 55% of the trimmings catch in USA is from XX spp, then 55% of the fish meal (and 55% of the fish oil) exported from or kept in USA will be attributed to XX spp. 
 7. Next, we can use species specific allocation rates to convert the fish oil and fish meal from trimmings to raw material live weight equivalents. Now we have total tonnes of fish oil and fish meal live weight equivalents per landing country per species. 
    - for adjustments: 
       - If possible use species and region specific rates 
       - If a species exists outside of a region, use global species specific rates 
       - Otherwise, use a global average of all species and regions 

 8. Divide the tonnes of fish oil and fish meal live weight equivalents by the total amount of trimmings catch in each country. This gives us a proportion of trimmings fish catch in each country that goes to FMFO. 
 9. Join with Watson data, group by cell, and rasterize? Now we will have rasters describing the amount of trimmings fish catch that goes to fish oil or fish meal for salmon feed under each diet scenario under each allocation approach (mass or energetic). 
 
 
### step 1 
 
 Start with demand per country 
    - EX: NOR requires X tonnes of FO from trimmings
    
```{r}
## step 1
country_demand <- read_csv(here("prep/02_feed/data/demand/total_aquaculture_ingredient_demand.csv")) %>%
  filter(ingredient %in% c("fish meal, cut offs", "fish oil, cut offs")) 


forage_demand <- read_csv(here("prep/02_feed/data/demand/total_aquaculture_ingredient_demand.csv")) %>%
  filter(ingredient %in% c("fish meal, forage fish", "fish oil, forage fish")) %>%
  filter(diet == "plant-dominant")




sum(country_demand$ingredient_demand) # 191040.8


sum(forage_demand$ingredient_demand, na.rm = TRUE) # 2598876

191040.8/616377 # 0.3099415 trimmings demand represent ~30% of all FMFO in diet

5.3/(8.3+8.8) # 0.3099415 good, matches the Aas paper. So nothing wrong there... 
```



### step 2

 2. Get trade data for FO trimmings and FM from trimmings and match to demand data. Figure out how much countries import FO or FM from other countries. 
    - EX: NOR imports Y% of FO trimmings from USA, Z% from Peru, etc.
    
```{r}
oils_meals_all <- read.csv(file.path(rdsi_raw_data_dir, "BACI_data/BACI_FMFO_codes.csv"))

oils_meals_import_props <- oils_meals_all %>% 
  mutate(type = ifelse(hs_code == 230120, "fish meal", "fish oil")) %>%
  dplyr::select(importer_iso3c, partner_iso3c, type, qty) %>% 
  group_by(importer_iso3c, type) %>%
  mutate(total_import = sum(qty, na.rm = TRUE)) %>% 
  ungroup() %>%
  mutate(prop_import = qty/total_import) %>% 
  mutate(type = ifelse(type == "fish meal", "fish meal, cut offs", "fish oil, cut offs"))
  
length(unique(oils_meals_import_props$partner_iso3c)) # 164 countries...


```

### step 3

Multiply the import %s by the demand tonnes to get ingredient tonnes imported per country
    - EX: NOR requires 100 tonnes of FO from trimmings, they import 60% from the USA, then 60 tonnes of FO ingredients in NOR comes from the USA for salmon. 

```{r}
## step 3

demand_trade <- country_demand %>%
  left_join(oils_meals_import_props, by = c("iso3c" = "importer_iso3c", "ingredient" = "type")) %>% 
  mutate(tonnes_ingredient_demand_traded = prop_import*ingredient_demand)

sum(demand_trade$tonnes_ingredient_demand_traded, na.rm = TRUE)
# 184912.2
sum(country_demand$ingredient_demand)
# 191040.8

# interesting.. lost ~6k tonnes? 
```

Group by exporter country to get total amount of FO or FM ingredients from trimmings they export under each diet demand scenario
    - EX: USA exports 60 tonnes to NOR, 40 tonnes to CHL, then they export 100 tonnes of FO from trimmings total for salmon feed. 
    
```{r}

## step 4
demand_trade_origin <- demand_trade %>%
  group_by(partner_iso3c, ingredient, diet) %>%
  summarise(total_ingredient_tonnes_traded = sum(tonnes_ingredient_demand_traded, na.rm = TRUE)) %>% # missing about 1 million tonnes due to missing countries in trade data 
  ungroup()

sum(demand_trade_origin$total_ingredient_tonnes_traded, na.rm = TRUE) # 184912.2... good the same as above. 
 
```

### Step 5 

Determine each countries' breakdown of trimmings species catch by flag country (e.g., where the catch is actually landed, rather than caught). Filter for all trimmings species (from biomar report), group by country and species, and determine the within-country proportions of catch from each species. For example, 55% of the trimmings species weight that USA lands is from XX spp, 24% from YY spp, etc...
 
```{r}
## step 5 

trimmings_spp <- read_csv(here("data/raw_data/biomar/trimmings_spp_list.csv"))

watson_cells <- read.csv(file.path(watson_dir, "v5.0/Codes_cells.csv"))

watson_raw <- read_csv(file.path(watson_dir, "v5.0/watson_2017_fisheries_catch_w_cat.csv"))

watson_rgn <- watson_raw %>%
  distinct(CNumber, country = CountryName) %>%
  mutate(iso3c = countrycode(sourcevar = country, origin = "country.name", destination = "iso3c")) %>%
  mutate(iso3c = 
           case_when(
             country == "Amer Samoa" ~ "ASM", 
             country == "Br Ind Oc Tr" ~ "IOT", 
             country == "Br Virgin Is" ~ "VGB", 
             country == "Dominican Rp" ~ "DOM",
             country == "Fr Polynesia" ~ "PYF", 
             country == "Fr Guiana" ~ "GUF", 
             country == "Micronesia" ~ "FSM", 
             country == "St Pier Mq" ~ "SPM", 
             country == "Untd Arab Em" ~ "UAE", 
             country == "US Virgin Is" ~ "VIR", 
             TRUE ~ iso3c
           ))


codes_country <- read.csv(file.path(watson_dir, "v5.0/Codes_country.csv")) # read in country codes 


# calculate forage catch and add iso3c codes
trimmingscatch <- 
  watson_raw |> 
  mutate(trimmingsfish = ifelse(CommonName %in% c(trimmings_spp$common_name), 1, NA)) %>%
  left_join(watson_rgn, by = c("CountryName" = "country", "CNumber")) %>%
  mutate(catch = ReportedIND + IUUIND + ReportedNIND + IUUNIND) %>%
  mutate(trimmings_catch = catch*trimmingsfish) %>%
  filter(!is.na(trimmings_catch)) 

trimmingsfish <- 
  watson_raw |> 
  mutate(trimmingsfish = ifelse(CommonName %in% c(trimmings_spp$common_name), 1, NA)) %>%
  left_join(watson_rgn, by = c("CountryName" = "country", "CNumber")) %>%
  mutate(catch = ReportedIND + IUUIND + ReportedNIND + IUUNIND) %>%
  mutate(trimmings_catch = catch*trimmingsfish) %>%
  mutate(trimmings_catch = ifelse(is.na(trimmings_catch), 0, trimmings_catch))


write_rds(trimmingsfish, file.path(watson_dir, "v5.0/int/all_catch_trimmingsfish.rds"))


## get an estimate of proportion of forage fish catch coming from different species in different landing countries.
trimmings_catch_iso <- trimmingsfish %>%
  filter(trimmings_catch > 0) %>%
  group_by(iso3c, CommonName, TaxonName) %>%
  summarise(catch = sum(trimmings_catch, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(iso3c) %>%
  mutate(total_fofm_trim_catch = sum(catch, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(prop_of_iso_total = catch/total_fofm_trim_catch)

unique(trimmings_catch_iso$CommonName) # only 7 here...?

trimmings_spp

```


### step 6 

Apply these within country percentages to total country exported fish oil and fish meal (calculated in step 4). Now we will have X tonnes of fish oil and Y tonnes of fish meal exported from or kept within country Z per trimmings fish species per diet scenario. 
     - For example, if 55% of the trimmings catch in USA is from XX spp, then 55% of the fish meal (and 55% of the fish oil) exported from or kept in USA will be attributed to XX spp. 
     
```{r}
## step 6 

trimmings_fofm_origins <- trimmings_catch_iso %>%
  dplyr::select(iso3c, CommonName, TaxonName, prop_of_iso_total) %>%
  left_join(demand_trade_origin, by = c("iso3c" = "partner_iso3c")) %>%
  mutate(tonnes_fofm_trimmings_spp = total_ingredient_tonnes_traded*prop_of_iso_total) %>%
  dplyr::select(iso3c, CommonName, TaxonName, ingredient, diet, tonnes_fofm_trimmings_spp) %>%
  filter(!is.na(tonnes_fofm_trimmings_spp))

sum(trimmings_fofm_origins$tonnes_fofm_trimmings_spp) # 175979.5 lost a couple thousand more tonnes but nothing really concerning here...


```


### step 7 

Next, we can use species specific allocation rates to convert the fish oil and fish meal from trimmings to raw material live weight equivalents. Now we have total tonnes of fish oil and fish meal live weight equivalents per landing country per species. 
    - for adjustments: 
       - If possible use species rates
       - Otherwise, use a global average of all species 

```{r}

## step 7

## read in allocation data 
trimmings_allocation_raw <- read_xlsx(here("data/tidy_data/allocation/trimmings_allocation_factors.xlsx"), n_max = 30) %>%
  dplyr::select(species, ingredient, mass_byproduct_cf, ge_byproduct_cf)

## missing tuna... take means of tuna spp: Skipjack tuna, Yellowfin tuna

trimmings_allocation_tidy <- trimmings_allocation_raw %>% 
    separate(species, into = c("CommonName", "TaxonName"), sep = "\\s+\\(|\\)\\s+", remove = FALSE) %>%
  mutate(TaxonName = gsub("\\)", "", TaxonName)) %>%
  mutate(ingredient = ifelse(ingredient == "Fishmeal", "fish meal, cut offs", "fish oil, cut offs")) %>%
  dplyr::select(CommonName, TaxonName, ingredient, ge_value = ge_byproduct_cf, mass_value = mass_byproduct_cf) 

tuna_mean <- trimmings_allocation_tidy %>%
  filter(CommonName %in% c("Skipjack tuna", "Yellowfin tuna")) %>%
  mutate(CommonName = "Tuna",
         TaxonName = "Thunnus") %>%
  group_by(CommonName, TaxonName, ingredient) %>%
  summarise(ge_value = mean(ge_value, na.rm = TRUE),
            mass_value = mean(mass_value, na.rm = TRUE)) %>%
  ungroup()

trimmings_allocation_tidy <- rbind(trimmings_allocation_tidy, tuna_mean)

global_averages <- trimmings_allocation_tidy %>%
  group_by(ingredient) %>%
  summarise(average_ge = mean(ge_value, na.rm = TRUE),
            average_mass = mean(mass_value, na.rm = TRUE)) %>%
  ungroup()

ga_mass_FO <- global_averages %>%
  filter(ingredient == "fish oil, cut offs") %>%
  dplyr::pull(average_mass)

ga_mass_FM <- global_averages %>%
  filter(ingredient == "fish meal, cut offs") %>%
    dplyr::pull(average_mass)

  
ga_ge_FO <- global_averages %>%
  filter(ingredient == "fish oil, cut offs") %>%
    dplyr::pull(average_ge)


ga_ge_FM <- global_averages %>%
  filter(ingredient == "fish meal, cut offs") %>%
  dplyr::pull(average_ge)


trimmings_allocations_df <- trimmings_allocation_tidy %>%
  group_by(CommonName, TaxonName, ingredient) %>% # lets just do global averages per species for now
  summarise(ge_value = mean(ge_value, na.rm = TRUE),
            mass_value = mean(mass_value, na.rm = TRUE)) %>%
  ungroup() %>%
  filter(!is.na(ge_value))

## Match allocation data to the fish oil and fish meal per species from comtrade

trimmings_fofm_allocation <- trimmings_fofm_origins %>%
  left_join(trimmings_allocations_df, by = c("ingredient", "CommonName", "TaxonName")) %>%
  mutate(ge_value = case_when(
    is.na(ge_value) & ingredient == "fish meal, cut offs" ~ ga_ge_FM,
    is.na(ge_value) & ingredient == "fish oil, cut offs" ~ ga_ge_FO, 
    TRUE ~ ge_value),
    mass_value = case_when(
      is.na(mass_value) & ingredient == "fish meal, cut offs" ~ ga_mass_FM,
      is.na(mass_value) & ingredient == "fish oil, cut offs" ~ ga_mass_FO, 
      TRUE ~ mass_value
    )
  ) %>%
  pivot_longer(cols = c("ge_value", "mass_value"), 
               names_to = "allocation_type", 
               values_to = "allocation_value"
               ) %>%
  mutate(allocation_type = ifelse(allocation_type == "ge_value", "ge", "mass")) %>%
  mutate(tonnes_fofm_trimmings_spp_live_weight = tonnes_fofm_trimmings_spp*allocation_value) %>%
  dplyr::select(iso3c, CommonName, TaxonName, ingredient, diet, tonnes_fofm_trimmings_spp, allocation_type, allocation_value, tonnes_fofm_trimmings_spp_live_weight)

sum(trimmings_fofm_allocation$tonnes_fofm_trimmings_spp_live_weight) # 622087.8/2 = 311043.9. Ok this makes sense. 

```


### step 8

Divide the tonnes of fish oil and fish meal live weight equivalents by the total amount of trimmings catch in each country. This gives us a proportion of trimmings fish catch in each country that goes to FMFO. 

```{r}

## step 8

# Divide the tonnes of fish oil and fish meal live weight equivalents by the total amount of trimmings catch in each country. This gives us a proportion of trimmings fish catch in each country that goes to FMFO. 

trimmings_rgn_totals <- trimmings_catch_iso %>%
  group_by(iso3c, TaxonName) %>%
  summarise(trim_fofm_catch = sum(catch)) %>%
  ungroup()



trimmings_fofm_allocation_totals <- trimmings_fofm_allocation %>%
  group_by(iso3c, ingredient, TaxonName, diet, allocation_type) %>%
  summarise(total_tonnes_fofm_lw = sum(tonnes_fofm_trimmings_spp_live_weight, na.rm = TRUE)) %>%
              ungroup()

trim_props <- left_join(trimmings_rgn_totals, trimmings_fofm_allocation_totals) %>%
  filter(!is.na(diet)) %>% # filter out NAs since these countries dont produce any trimmings catch for salmon feeds
  mutate(prop = ifelse(trim_fofm_catch == 0, 0, total_tonnes_fofm_lw/trim_fofm_catch)) %>%
  dplyr::select(iso3c, ingredient, TaxonName, diet, allocation_type, prop) %>%
  filter(!is.na(iso3c)) # weird iso3c with all 0s 

write_rds(trim_props, here("prep/02_feed/data/embodied_FMFO_trimmings_rgns.rds"))


diets <- unique(trim_props$diet)
allocations <- unique(trim_props$allocation_type)
ingredients <- unique(trim_props$ingredient)

for(diet_type in diets){
  for(allocation in allocations){
    for(ingredient_type in ingredients){

    # diet_type = "plant-dominant"
    # allocation = "mass"
    # ingredient_type = "fish meal, cut offs"
    
  watson_raster_template <- terra::rast(ncol=720, nrow=360, vals=c(1:259200))
  
  system_prop <- trim_props %>%
    dplyr::filter(diet == diet_type,
                  allocation_type == allocation,
                  ingredient == ingredient_type) %>%
    dplyr::select(iso3c, diet, TaxonName, ingredient, prop)
  
  trimmingsfish_system <- left_join(trimmingsfish, system_prop) %>%
    filter(!is.na(ingredient)) %>%
    mutate(prop = ifelse(is.na(prop), 0, prop)) %>%
    mutate(trimmings_catch_foodsystem = prop*trimmings_catch) %>%
    group_by(Cell) %>%
    summarise(tonnes = sum(trimmings_catch_foodsystem, na.rm = TRUE)) %>%
    ungroup() %>%
    left_join(watson_cells) %>%
    dplyr::select(LonCentre, LatCentre, tonnes)
  
  trimmings_fish_system <- rast(trimmingsfish_system, type = "xyz", crs = crs(watson_raster_template)) %>%
    project(watson_raster_template)

# plot(log(trimmings_fish_system + 1))

# the following should be about equal
print(sprintf("the following should be about equal"))
print(sprintf("raster calc: %s", global(trimmings_fish_system, "sum", na.rm=TRUE))) 
print(sprintf("observed: %s", trimmings_fofm_allocation_totals %>% filter(diet == diet_type, allocation_type == allocation, ingredient == ingredient_type) %>% group_by(ingredient) %>% summarise(total = sum(total_tonnes_fofm_lw, na.rm = TRUE)) %>% ungroup() %>% pull(total)))


    writeRaster(trimmings_fish_system, sprintf(here("prep/02_feed/output/%s/trimmings fish_%s_%s_P.tif"), diet_type, ingredient_type, allocation), overwrite = TRUE)
  
   }
  }
}


trim_files <- list.files(here("prep/02_feed/output/plant-dominant/"), pattern = "fish oil, cut offs|fish meal, cut offs", full.names = TRUE)

test <- rast(trim_files)

test_names <- basename(trim_files)

names(test) <- test_names


plot(log(test+1))

plot(test)

global(test, "sum", na.rm = TRUE)
# trimmings fish_fish meal, cut offs_ge_P.tif   153196.2
# trimmings fish_fish meal, cut offs_mass_P.tif 184281.0
# trimmings fish_fish oil, cut offs_ge_P.tif    176360.8
# trimmings fish_fish oil, cut offs_mass_P.tif  108249.7


test <- trimmings_fofm_allocation %>%
  group_by(diet,
         allocation_type,
         ingredient) %>%
  summarise(sum = sum(tonnes_fofm_trimmings_spp_live_weight)) %>%
  ungroup()
test

# 5 plant-dominant ge              fish meal, cut offs 153196.
# 6 plant-dominant ge              fish oil, cut offs  176361.
# 7 plant-dominant mass            fish meal, cut offs 184281.
# 8 plant-dominant mass            fish oil, cut offs  108250.


```
 
 