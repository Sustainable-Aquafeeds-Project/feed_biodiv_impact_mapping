---
title: "Resample all crop and fish based feed rasters to 100km2 cells"
output: html_document
editor_options: 
  chunk_output_type: console
---

Goal: Resample all crop and fish based feed rasters to 100km2 cells

```{r}

library(here)
library(tidyverse)
library(countrycode)
library(tidytext)
library(knitr)
library(strex)
library(sjmisc)

focus_year = 2021

source(here("src/fxns.R"))
source(here("src/directories.R"))
source(here("src/spatial.R"))

moll_crs <- crs(moll_template)

```

We will present data at at ~10km resolution in the WGS84 Mollweide coordinate reference system, an equal area projection that retains considerable accuracy in area at polar latitudes.

Reproject and aggregate the ingredient crop rasters. It runs quick since they are already ~9km by 9km.

```{r}

for(diet in c("fish-dominant", "plant-dominant")){
  for(fcr in c("regular", "efficient")){
  
  # diet = "fish-dominant"
  #   fcr = "regular"
directory <- sprintf("prep/02_feed/output/%s/%s", diet, fcr)

files <- list.files(here(directory), full.names = TRUE)

filtered_files <- files[!grepl("fish oil|fish meal|archive", files)]

for(i in 1:length(filtered_files)){
  # i = 17
  file <- filtered_files[i]
  file_name <- basename(file)
  
  crop_rast <- rast(file)
  
  area_rast <- cellSize(crop_rast, unit = "km")
  
  crop_rast_fix <- crop_rast/area_rast
  
  crop_reproject <- project(crop_rast_fix, moll_template, method = "bilinear")
  
  crop_reproject_area <- cellSize(crop_reproject, unit = "km")
  
  crop_reproject_fix <- crop_reproject*crop_reproject_area
  
  print(global(crop_reproject_fix, "sum", na.rm = TRUE)) # layer 20374.35
  print(global(crop_rast, "sum", na.rm = TRUE)) # layer 20373.72
  
  ## perfect... 
  writeRaster(crop_reproject_fix, sprintf(here("prep/02_feed/output/resampled/%s/%s/%s"), diet,fcr, file_name), overwrite = TRUE)
  }

  }
}

```


Reproject and disaggregate the ingredient fish rasters to 10km res.

```{r}

for(diet in c("plant-dominant")){
  for(fcr in c("regular", "efficient")){
  
  # diet = "plant-dominant"
  #  fcr = "efficient"
directory <- sprintf("prep/02_feed/output/%s/%s", diet, fcr)

files <- list.files(directory, full.names = TRUE)

filtered_files <- files[grepl("fish oil|fish meal", files)]
filtered_files <- filtered_files[grep("_A", filtered_files)]

# 2*2*3*2*2 = 48 files.. makes sense

for(i in 1:24){
  # i = 6
  file <- filtered_files[i]
  file_name <- basename(file)
  
  fish_rast <- rast(file)
  
  area_rast <- cellSize(fish_rast, unit = "km")
  
  fish_rast_fix <- fish_rast/area_rast
  
  fish_reproject <- project(fish_rast_fix, moll_template, method = "bilinear")
  
  fish_reproject_area <- cellSize(fish_reproject, unit = "km")
  
  fish_reproject_fix <- fish_reproject*fish_reproject_area
  
  print(global(fish_reproject_fix, "sum", na.rm = TRUE)) # layer 3375102
  print(global(fish_rast, "sum", na.rm = TRUE)) # layer 3381631
  
  ## perfect... 
  writeRaster(fish_reproject_fix, sprintf(here("prep/02_feed/output/resampled/%s/%s/%s"), diet, fcr, file_name), overwrite = TRUE)
  
    }
  }
}

test <- rast(here("prep/02_feed/output/plant-dominant/regular/forage fish_fish oil_economic_benthic_catch_A.tif"))
plot(test)
global(test, "sum", na.rm = TRUE)

test_fis <- list.files(here("prep/02_feed/output/fish-dominant"), full.names = TRUE, recursive = TRUE)
test_fis_res <-  list.files(here("prep/02_feed/output/resampled/fish-dominant"), full.names = TRUE, recursive = TRUE)

## check 

test_plant <- list.files(here("prep/02_feed/output/plant-dominant/regular"), full.names = TRUE, recursive = TRUE)
test_plant <- test_plant[grep("_A.tif", test_plant)]
test_plant_res <-  list.files(here("prep/02_feed/output/resampled/plant-dominant/regular"), full.names = TRUE, recursive = TRUE) # ok missing some here...
test_plant_res <- test_plant_res[grep("_A.tif", test_plant_res)]

```


Data check 

```{r}
spc_mass_plant <- rast(here("prep/02_feed/output/resampled/plant-dominant/Soybean_soy protein concentrate_mass_A.tif"))

global(spc_mass_plant, "sum", na.rm = TRUE) # 3315.874 km2 of soybean for SPC globally


all_crop_rast_mass <- rast(list.files(here("prep/02_feed/output/resampled/plant-dominant/"), pattern = "mass_A.tif", full.names = TRUE))

names(all_crop_rast_mass) <- list.files(here("prep/02_feed/output/resampled/plant-dominant/"), pattern = "mass_A.tif")

```

