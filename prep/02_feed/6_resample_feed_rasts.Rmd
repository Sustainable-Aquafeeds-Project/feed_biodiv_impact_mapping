---
title: "Resample all crop and fish based feed rasters to 100km2 cells"
output: html_document
editor_options: 
  chunk_output_type: console
---

Goal: Resample all crop and fish based feed rasters to 100km2 cells

```{r}

library(here)
library(tidyverse)
library(countrycode)
library(tidytext)
library(knitr)
library(strex)
library(sjmisc)

focus_year = 2021

source(here("src/fxns.R"))
source(here("src/directories.R"))
source(here("src/spatial.R"))

moll_crs <- crs(moll_template)

```

We will present data at at ~10km resolution in the WGS84 Mollweide coordinate reference system, an equal area projection that retains considerable accuracy in area at polar latitudes.

Reproject and aggregate the ingredient crop rasters. It runs quick since they are already ~9km by 9km.

```{r}

for(diet in c("fish-dominant", "plant-dominant")){
  
  # diet = "fish-dominant"
directory <- sprintf("prep/02_feed/output/%s/", diet)

files <- list.files(directory, full.names = TRUE)

filtered_files <- files[!grepl("fish oil|fish meal|archive", files)]

for(i in 1:length(filtered_files)){
  
  file <- filtered_files[i]
  file_name <- basename(file)
  
  crop_rast <- rast(file)
  
  area_rast <- cellSize(crop_rast, unit = "ha")
  
  crop_rast_fix <- crop_rast/area_rast
  
  crop_reproject <- project(crop_rast_fix, moll_template, method = "bilinear")
  
  crop_reproject_area <- cellSize(crop_reproject, unit = "ha")
  
  crop_reproject_fix <- crop_reproject*crop_reproject_area
  
  print(global(crop_reproject_fix, "sum", na.rm = TRUE)) # layer 20374.35
  print(global(crop_rast, "sum", na.rm = TRUE)) # layer 20373.72
  
  ## perfect... 
  writeRaster(crop_reproject_fix, sprintf(here("prep/02_feed/output/resampled/%s/%s"), diet, file_name), overwrite = TRUE)
  }

}
```


Reproject and disaggregate the ingredient fish rasters to 10km res.

```{r}

for(diet in c("fish-dominant", "plant-dominant")){
  
  # diet = "fish-dominant"
directory <- sprintf("prep/02_feed/output/%s/", diet)

files <- list.files(directory, full.names = TRUE)

filtered_files <- files[grepl("fish oil|fish meal", files)]

for(i in 1:length(filtered_files)){
  
  file <- filtered_files[i]
  file_name <- basename(file)
  
  fish_rast <- rast(file)
  
  area_rast <- cellSize(fish_rast, unit = "ha")
  
  fish_rast_fix <- fish_rast/area_rast
  
  fish_reproject <- project(fish_rast_fix, moll_template, method = "bilinear")
  
  fish_reproject_area <- cellSize(fish_reproject, unit = "ha")
  
  fish_reproject_fix <- fish_reproject*fish_reproject_area
  
  print(global(fish_reproject_fix, "sum", na.rm = TRUE)) # layer 3375102
  print(global(fish_rast, "sum", na.rm = TRUE)) # layer 3381631
  
  ## perfect... 
  writeRaster(fish_reproject_fix, sprintf(here("prep/02_feed/output/resampled/%s/%s"), diet, file_name), overwrite = TRUE)
  }

}

```


Data check 

```{r}
spc_mass_plant <- rast(here("prep/02_feed/output/resampled/plant-dominant/Soybean_soy protein concentrate_mass_A.tif"))

global(spc_mass_plant, "sum", na.rm = TRUE) # 3315.874 km2 of soybean for SPC globally


all_crop_rast_mass <- rast(list.files(here("prep/02_feed/output/resampled/plant-dominant/"), pattern = "mass_A.tif", full.names = TRUE))

names(all_crop_rast_mass) <- list.files(here("prep/02_feed/output/resampled/plant-dominant/"), pattern = "mass_A.tif")

test <- as.data.frame(global(all_crop_rast_mass, "sum", na.rm = TRUE)) %>%
  rename(km2 = sum)
sum(test$km2) # 10435.71 km2 of cropland globally for salmon aquaculture feeds...

# EU chicken paper estimates 67000 km2 of cropland for chicken feed and 5.59 m2 per kg
file_list <- list.files(here("prep/02_feed/output/resampled/plant-dominant/"), pattern = "mass_P.tif", full.names = TRUE)

file_list <- file_list[!grepl("fish", file_list)]

all_crop_rast_mass_P <- rast(file_list)

test <- as.data.frame(global(all_crop_rast_mass_P, "sum", na.rm = TRUE))
sum(test$sum) # 2927252 tonnes of cropland globally for salmon aquaculture feeds...


2927252/10435.71 # = 280.5034 tonnes/km2

10435.71/2927252 # = 0.003565019 km2/tonne

(10874.02*1000000)/(2925089*1000) # = 3.717501 m2 per kg


test_soy <- rast(file.path(mapspam_dir, "spam2010V2r0_global_A_SOYB_A.tif"))

plot(test_soy/100)

global(test_soy, "sum", na.rm = TRUE)/100 # 979068.3


3436/979068.3

```


Compare to Kuempel et al. and halpern et al

```{r}

chicken_salmon <- read.csv(here("prep/02_feed/data/sum_pressures_country.csv"))

salmon_feed_disturbance <- chicken_salmon %>%
  filter(stressor == "disturbance", 
         animal_system == "salmon", 
         source == "feedcrop")


halpern <- read.csv(file.path(rdsi_raw_data_dir, "food-systems-project/rgn_raw_summary.csv")) %>%
  filter(pressure == "disturbance", 
         organism == "salmon", 
         category == "feedcrop") 

sum(halpern$sum) # 7525.14

```

