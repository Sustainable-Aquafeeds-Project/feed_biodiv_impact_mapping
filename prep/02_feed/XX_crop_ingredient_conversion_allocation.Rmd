---
title: "Account for crop trade, extraction rates, and rasterize!"
output: html_document
editor_options: 
  chunk_output_type: console
---

Get proportion of each MAPSPAM crop that is consumed by salmon aquaculture in each country.

Outputs: a raster for each crop describing the proportion of each crop consumed in each country by salmon aquaculture systems. This is a final output.

Be sure to run previous scripts if changes to data.

```{r}

library(here)
library(tidyverse)
library(countrycode)
library(tidytext)
library(knitr)
library(strex)
library(sjmisc)

focus_year = 2021

source(here("src/fxns.R"))
source(here("src/directories.R"))

```


# STEP 1: determine amount of crop produced in each country for each food system.

Trade proportion data:
```{r}

trade_data <- read_csv(here("prep/02_feed/data/FAO_MAPSPAMcrop_trade_data.csv")) 

```


Total consumption by animals per country in MAPSPAM crops
```{r}

consumption <- read_csv(here("prep/02_feed/data/demand/total_aquaculture_ingredient_demand.csv")) %>%
  mutate(animal_system = paste(animal, system, product, sep="_")) %>%
  rename(source_ingredient = ingredient) %>%
  select(iso3c_consuming = iso3c, animal_system, diet, source_ingredient, consuming_ingredient_consumed_tonnes = ingredient_demand) 

## need to match `consumption` ingredients to equivalent crop.. need lookup table 

feed_cats <- read_csv(here("prep/02_feed/data/ingredient_spam_fao_codes.csv")) %>% ## this table was created manually. It matches our ingredient names from Aas et al. 2022 to mapspam names. Must also update product_to_fao_spam.csv. 
  select(-notes)  %>%
  filter(included_source == "mapspam")


consumption_spam <- consumption %>%
  left_join(feed_cats) %>%
  filter(included_source == "mapspam") 

setdiff(unique(consumption$source_ingredient), unique(feed_cats$source_ingredient)) ## this is only fish ingredients and microingredients, which we don't care about for crops (because they aren't crops!)


setdiff(unique(feed_cats$source_ingredient), unique(consumption$source_ingredient)) # [1] "rapeseed and camelina oil"; replaced by canola oil.. so OK

```


Join consumption by country and crop to trade data to get likely country of origin regardless of country of consumption.

```{r}
# check that all feed products match up: should be nothing showing up here.. if it is then add it to lookup table
setdiff(consumption_spam$SPAM_super, trade_data$SPAM_super)


ingredient_production_location <- left_join(trade_data, consumption_spam, by=c("iso3c_consuming", "SPAM_super")) %>%
  filter(!is.na(animal_system)) %>%  #crops not fed to animal system in given country
  mutate(consuming_ingredient_consumed_tonnes = ifelse(is.na(consuming_ingredient_consumed_tonnes), 0, consuming_ingredient_consumed_tonnes)) %>%
  mutate(producing_ingredient_consumed_tonnes = consuming_ingredient_consumed_tonnes * prop_of_supply)


write.csv(ingredient_production_location, here("prep/02_feed/data/demand/ingredient_demand_production_locations.csv"), row.names = FALSE)
```


Take a look at the data 

```{r}

feed_source <- production_location %>%
  group_by(iso3c_producing, diet, animal_system, SPAM_super, source_ingredient) %>%
  summarize(consumed_ingredient_tonnes = sum(producing_ingredient_consumed_tonnes)) %>% 
  ungroup()



tmp <- filter(feed_source, animal_system == "salmon_aquaculture_meat") %>%
    group_by(source_ingredient, diet) %>%
  slice_max(order_by = consumed_ingredient_tonnes, n = 15) %>%
  ungroup() %>%
  filter(consumed_ingredient_tonnes > 0)


ggplot(data = tmp %>%
         filter(diet == "plant-dominant"), aes(x = consumed_ingredient_tonnes, y = reorder_within(iso3c_producing, consumed_ingredient_tonnes, SPAM_super))) + 
  geom_bar(stat = "identity") + 
  facet_wrap(~source_ingredient, scales = "free") + 
  labs(x = "Tonnes of raw ingredient produced", y = "Country") + 
  theme_bw() + 
  theme(axis.text.x = element_text(angle = 30, vjust = 0.5)) 

ggsave(here("prep/02_feed/plots/total_ingredient_feed_origins_plant.png"), units = "in", height = 11, width = 11)
```
 

## STEP 2: Use allocation methods to account for crop loss and coproducts to get a better idea of the amount of crops actually going to aquaculture feeds (instead of ingredients)

Ok now we need to convert the ingredient to crop raw material using the conversion factors that Rich has put together.. we will start with mass allocation first


```{r}
## read in raw material extraction rates (yields) that Rich compiled 

#get yield data from main ingredients
cf_data <- read_csv(file.path("/mnt/rdsi/raw_data/allocation/top_crop_producers_conversions.csv")) |> 
  mutate(ingredient = if_else(ingredient == "canola/camelina oil", true = "canola oil", false = ingredient)) %>% 
  dplyr::select(1:6)
# get coproduct yield data

cf_coproduct_data <- read_csv(file.path("/mnt/rdsi/raw_data/allocation/coproduct_conversions.csv")) %>%
  dplyr::select(1:4)

setdiff(unique(cf_data$ingredient), unique(ingredient_production_location$source_ingredient))

# [1] "tapioca starch" "lupins"         "corn starch" 
### this is fine.. these are unique to Rich's paper

setdiff(unique(ingredient_production_location$source_ingredient), unique(cf_data$ingredient))

# coconut oil
## yep makes sense, unique to Aas et al. We will need to add this into conversion factor data...


setdiff(unique(cf_data$item), unique(ingredient_production_location$fao_item))

# [1] [1] "Cassava" "Lupins" 
### this is fine.. these are unique to Rich's paper

setdiff(unique(ingredient_production_location$fao_item), unique(cf_data$item))

# 1] "Coconuts, in shell"; OK 

## Join cf data to the ingredient production data and gapfill missing cfs with mean cfs

ingredient_production_cf <- ingredient_production_location %>%
  group_by(iso3c_producing, SPAM_super, diet, source_ingredient, `raw material`, fao_item) %>%
  summarise(producing_ingredient_consumed_tonnes = sum(producing_ingredient_consumed_tonnes, na.rm = TRUE)) %>%
  ungroup() %>%
  left_join(cf_data, by = c("iso3c_producing" = "iso3c", "source_ingredient" = "ingredient", "fao_item" = "item")) %>%
  dplyr::select(iso3c_producing, SPAM_super, diet, source_ingredient, `raw material`, fao_item, producing_ingredient_consumed_tonnes, area, mean_value, cf) %>%
  group_by(source_ingredient, fao_item) %>%
  mutate(mean_cf = mean(cf, na.rm = TRUE)) %>%
  ungroup() %>% # only NAs are coconut oil bc we don't have cfs for those yet
  mutate(cf_gf = ifelse(is.na(cf), mean_cf, cf)) %>% # this if gapfilling step
  dplyr::select(-area)


## now join this with the coproduct data, and gapfill the missing coproduct cfs in the same way 

coproduct_lookup_gf <- cf_coproduct_data %>%
  group_by(ingredient, coproduct) %>%
  summarise(coproduct_cf_mean = mean(coproduct_cf, na.rm = TRUE)) %>%
  ungroup()

ingredient_production_cf_coproducts <- ingredient_production_cf %>%
  left_join(cf_coproduct_data, by = c("source_ingredient" = "ingredient", "iso3c_producing" = "country"))


production_cf_coproducts_non_na <- ingredient_production_cf_coproducts %>%
  filter(!is.na(coproduct)) %>%
    dplyr::select(iso3c_producing, SPAM_super, diet, source_ingredient, `raw material`, fao_item, producing_ingredient_consumed_tonnes, cf_gf, coproduct, coproduct_cf_gf = coproduct_cf)

    
production_cf_coproducts_na <- ingredient_production_cf_coproducts %>% 
  filter(is.na(coproduct)) %>%
  full_join(coproduct_lookup_gf, by = c("source_ingredient" = "ingredient")) %>%
  filter(!is.na(coproduct.y)) %>% # filter out soy oil and coconut oil for now...
  mutate(coproduct = ifelse(is.na(coproduct.x), coproduct.y, coproduct.x),
         coproduct_cf_gf = ifelse(is.na(coproduct.x), coproduct_cf_mean, coproduct_cf)) %>%
  dplyr::select(iso3c_producing, SPAM_super, diet, source_ingredient, `raw material`, fao_item, producing_ingredient_consumed_tonnes, cf_gf, coproduct, coproduct_cf_gf)



production_cf_coproducts_gf <- rbind(production_cf_coproducts_na, production_cf_coproducts_non_na) %>%
  dplyr::select(iso3c_producing, ingredient = source_ingredient, diet, item = fao_item, cf = cf_gf, coproduct, coproduct_cf = coproduct_cf_gf, ingredient_demand_produced = producing_ingredient_consumed_tonnes) %>%
  filter(!is.na(cf)) %>%
  dplyr::select(-ingredient_demand_produced)


ingredient_demand_produced <- ingredient_production_cf %>%
  dplyr::select(iso3c_producing, diet, SPAM_super, ingredient = source_ingredient, item = fao_item, prod_ingredient = producing_ingredient_consumed_tonnes) %>%
  dplyr::filter(!(ingredient %in% c("soy oil", "coconut oil")))



## Ok so now it is gapfilled, we need to calculate the mass allocation factor for each ingredient
allocation_raw <- 
  production_cf_coproducts_gf |> 
  group_by(ingredient, iso3c_producing, diet) |> 
  nest() |> 
  mutate(
         mass_allocation_factor = map(data, ~((.$cf/ (sum(unique(.$cf), sum(.$coproduct_cf))))/.$cf)) #need to divide by yield again here otherwise it is just the partitioning factor (for mass allocation only)
         ) |> 
  unnest(c(data, mass_allocation_factor))

# test2 <- allocation_raw %>%
#   dplyr::select(ingredient, item, iso3c_producing, mass_allocation_factor) %>%
#   filter(iso3c_producing %in% c(unique(cf_data$iso3c)))


## Now we calculate the actual crop raw material demand! 


crop_raw_material_demand <- allocation_raw %>%
  group_by(iso3c_producing, ingredient, diet, item) %>%
  summarise(mass_allocation_factor = mean(mass_allocation_factor)) %>%
  left_join(ingredient_demand_produced) %>%
  mutate(
         total_crop_demand_ms = prod_ingredient*mass_allocation_factor) %>%
  group_by(iso3c_producing, diet, ingredient, item) %>%
  summarise(total_crop_demand_ms = sum(total_crop_demand_ms, na.rm = TRUE)) %>%
  ungroup()
  # group_by(diet, ingredient) %>%
  # summarise(total = sum(total_crop_demand_ms))


write.csv(crop_raw_material_demand, here("prep/02_feed/data/demand/ingredient_crop_demand_production_conversions.csv"), row.names = FALSE)

## check against old method... Seems ok to me!! 
test <- read.csv(here("prep/02_feed/data/demand/archive/crop_demand_extraction_corrected.csv")) %>%
  dplyr::select(iso3c, diet, source_ingredient, crop, tonnes_product) %>%
  group_by(diet, source_ingredient) %>%
  summarise(total = sum(tonnes_product))
```


# STEP 3 Calculate proportion of production for animal system for each country

Crop production according to MAPSPAM data adjusted to 2021 production. These data include all growing systems (intensive, irrigated, etc.) and are in units of metric tonnes.

```{r}

crop_production_df <- read_csv(here("prep/02_feed/data/MAPSPAMcrop_production.csv"))
  
crop_production_global <- crop_production_df %>%
  group_by(SPAM_super) %>%
  summarize(tonnes_global = sum(tonnes_producing_crop, na.rm=TRUE))

```

Divide tonnes of consumption for each country/food system by total production to get the proportion of production produced for each food system:

```{r}
feed_source <- read.csv(here("prep/02_feed/data/demand/ingredient_crop_demand_production_conversions.csv")) %>%
  left_join(feed_cats, by = c("ingredient" = "source_ingredient", "item" = "fao_item")) %>%
  dplyr::select(-source, -`raw material`, -included_source)

# if the data were perfect, we could leave it at this...but there are some corrections to make
# when consumption overshoots production
proportion <- left_join(feed_source, crop_production_df, by=c("iso3c_producing", "SPAM_super")) %>%
  mutate(tonnes_producing_crop = ifelse(is.na(tonnes_producing_crop), 0, tonnes_producing_crop)) %>%
  mutate(prop_produced_for_system = ifelse(total_crop_demand_ms == 0, 0, total_crop_demand_ms/tonnes_producing_crop))

```

# STEP 3: Distribute excess, and adjust proportion produced for system values

NOTE: if ourproduction data were perfect these complicated steps would be unnecessary and the above calculation for prop_produced_for_system would be good enough. But due to mismatches, we spread excess production based on relative global production.

Identify the countries/crops with total production rates (across all systems) that exceed total production

```{r}
## step 1 ID regions where consumption exceeds production

production_exceed <- proportion %>%
  group_by(iso3c_producing, diet, SPAM_super, ingredient) %>%
  mutate(tonnes_produced_country = sum(total_crop_demand_ms)) %>%
  ungroup() %>%
  rowwise() %>%
  mutate(extra_crop_tonnes = tonnes_producing_crop - tonnes_produced_country) %>%
  mutate(percent_exceed = ifelse(tonnes_producing_crop == 0, 0, tonnes_produced_country/tonnes_producing_crop)) %>%
    data.frame()

```


Adjust proportion of consumption to not exceed production by more than 5%

```{r}

corrected_prop <- production_exceed %>%
  mutate(prop_of_production_within_iso = ifelse(tonnes_produced_country == 0, 0, total_crop_demand_ms/tonnes_produced_country)) %>%  # calculate proportion of crop each system eats within a country
  mutate(prop_produced_for_system_adjust = ifelse(percent_exceed >1 , 
                                        ifelse(percent_exceed > 1.05, prop_of_production_within_iso*1.05, prop_of_production_within_iso*percent_exceed),
                                        prop_produced_for_system))

summary(corrected_prop)
filter(corrected_prop, iso3c_producing=="BEL", SPAM_super=="soyb")

corrected_prop %>%
  group_by(iso3c_producing, diet, SPAM_super, ingredient) %>%
  summarize(total_adj_prop = sum(prop_produced_for_system_adjust),
            total_prop = sum(prop_produced_for_system))




```

For each animal system determine tonnes that was included and excluded.  The excluded will  be disbursed.

```{r}

tonnes_included_system <- corrected_prop %>%
  mutate(included_tonnes = prop_produced_for_system_adjust * tonnes_producing_crop) %>%
  mutate(lost_crop_tonnes = total_crop_demand_ms - included_tonnes) %>%
  mutate(included_prop = ifelse(tonnes_producing_crop == 0 , 0, included_tonnes/tonnes_producing_crop))
summary(tonnes_included_system)

# check, sum of included and excluded should equal sum of all consumption
tmp <- tonnes_included_system %>%
  group_by(SPAM_super, diet) %>%
  summarize(included_crop = sum(included_tonnes, na.rm=TRUE),
            excluded_crop = sum(lost_crop_tonnes, na.rm=TRUE)) %>% 
  mutate(prop_redistributed = excluded_crop/(excluded_crop + included_crop)) %>%
           data.frame() 

sum(tmp$included_crop)/(sum(tmp$included_crop) + sum(tmp$excluded_crop)) # 94% included and does not need to be distributed

tonnes_lost_system <- tonnes_included_system %>%
  group_by(SPAM_super, diet, ingredient) %>%
  summarize(lost_crop_tonnes = sum(lost_crop_tonnes, na.rm=TRUE))


#calculate extra crop tonnes in each country, and determine what proportion of extra each country accounts for
tonnes_extra_crop <- corrected_prop %>%
  dplyr::select(iso3c_producing, diet, SPAM_super, extra_crop_tonnes, tonnes_producing_crop, ingredient) %>%
  unique() %>%
  mutate(extra_crop_tonnes = ifelse(extra_crop_tonnes<0, 0, extra_crop_tonnes)) %>%
  group_by(SPAM_super) %>%
  mutate(excess_crop_global = sum(extra_crop_tonnes)) %>%
  rowwise() %>%
  mutate(prop_excess_crop = ifelse(excess_crop_global == 0, 0, extra_crop_tonnes/excess_crop_global))

# distribute the tonnes lost for each crop/system based on each countries extra production
excess_prop <- merge(tonnes_extra_crop, tonnes_lost_system) %>%
  mutate(tonnes_dispersed = prop_excess_crop * lost_crop_tonnes) %>%
  mutate(prop_dispersed = ifelse(tonnes_producing_crop == 0, 0, tonnes_dispersed/tonnes_producing_crop))


### NOTE: you can get higher total props for countries with very small proportions. This happens only for soybeans and for small production areas.
## this explores this:

excess_excess_prop <- excess_prop %>%
  mutate(extra_dispersed_tonnes = tonnes_dispersed - extra_crop_tonnes) %>%
  mutate(extra_dispersed_tonnes = ifelse(prop_dispersed > 1, extra_dispersed_tonnes, 0)) %>%
  left_join(crop_production_global, by = "SPAM_super") %>%
  mutate(prop_global_crop_production = tonnes_producing_crop/tonnes_global) %>%
  group_by(SPAM_super, diet, ingredient) %>%
  mutate(extra_dispersed_tonnes_by_system_crop = sum(extra_dispersed_tonnes))
  

filter(excess_excess_prop, prop_dispersed>1) %>% data.frame()

```


Combine the included and lost proportions for each system and country for plotting below

```{r}

assigned_prop <- tonnes_included_system  %>%
  dplyr::select(iso3c_producing, diet, ingredient, SPAM_super, prop_produced_for_system = included_prop)
excess_prop <- excess_prop %>%
  dplyr::select(iso3c_producing, diet, ingredient, SPAM_super, prop_extra_for_system = prop_dispersed)

total_prop <- left_join(assigned_prop, excess_prop, by=c("iso3c_producing", "diet", "SPAM_super", "ingredient")) %>%
  rowwise() %>%
  mutate(total_prop = prop_produced_for_system + prop_extra_for_system)
summary(total_prop)
filter(total_prop, iso3c_producing=="AFG" & SPAM_super=="soyb") %>% data.frame()

```

Checking
```{r}

summary(total_prop) # ok for total prop to be a bit above 1

filter(total_prop, prop_produced_for_system>1)

## check: should match original consumption:
production_global <- feed_source %>%
  group_by(diet, ingredient, SPAM_super) %>%
  summarize(obs_tonnes = sum(total_crop_demand_ms, na.rm=TRUE))

check <- left_join(total_prop, crop_production_df) %>%
  mutate(total_tonnes = total_prop*tonnes_producing_crop) %>%
  group_by(diet, ingredient, SPAM_super) %>%
  summarize(est_tonnes = sum(total_tonnes, na.rm=TRUE)) %>%
  left_join(production_global) %>%
  rowwise() %>%
  mutate(difference = obs_tonnes - est_tonnes )

# these should be the same
check %>%
  group_by(SPAM_super) %>%
  summarize(est_tonnes =sum(est_tonnes),
            obs_tonnes = sum(obs_tonnes)) %>% data.frame()

plot(log(check$est_tonnes+1), log(check$obs_tonnes+1))
abline(0,1, col="red") # these should look about the same!


plot(check$est_tonnes, check$obs_tonnes+1)
abline(0,1, col="red") # these should look about the same!

```


```{r}

write_csv(total_prop, here("prep/02_feed/output/proportion_feed_per_country_system_diet.csv"))

```





Now multiply rasterize this information to get rasters describing the amount of tonnages for each crop in each cell global that goes to salmon aquaculture feed ingredients! 


```{r}

total_prop <- read.csv(here("prep/02_feed/output/proportion_feed_per_country_system_diet.csv"))

library(terra)
library(raster)

## organize region data
rgns <- read_csv(file.path(food_systems_data_dir, "food_rgns_xy.csv"))

####################
## start loop here
#################3

todo <- unique(dplyr::select(total_prop, diet, SPAM_super, ingredient))


todo <- total_prop %>%
  group_by(diet, SPAM_super, ingredient) %>%
  summarise(sum_prop = sum(total_prop, na.rm = TRUE)) %>%
  ungroup() %>%
  filter(sum_prop >0)

for(i in 1:dim(todo)[1]){
#i=7
crop_spam <- todo$SPAM_super[i]
product_type <- todo$ingredient[i]
diet_type = todo$diet[i]


# crop_spam <- str_replace(crop, "x", "o")


# total country feed production
feed_crop <- filter(total_prop, SPAM_super==crop_spam, diet == diet_type, ingredient == product_type ) %>%
  dplyr::select(iso3c = iso3c_producing, prop_feed = total_prop)

# proportion crop grown for feed per country
prop_feed_crop <- left_join(rgns, feed_crop, by="iso3c") %>%
  dplyr::select(x, y, prop_feed)

prop_feed_crop_raster <- rasterFromXYZ(prop_feed_crop)

# plot(prop_feed_crop_raster)

crs(prop_feed_crop_raster) <- "+proj=longlat +datum=WGS84"


tonnes_crop_raster <- raster(sprintf(file.path(mapspam_dir, "scaled_maps_2021/crop_%s_A_scaled.tif"), crop_spam))

tonnes_crop_feed_raster <- tonnes_crop_raster*prop_feed_crop_raster

# plot(log(tonnes_crop_feed_raster+1))

writeRaster(tonnes_crop_feed_raster, filename= sprintf(here("prep/02_feed/output/%s/%s_%s.tif"), diet_type, crop_spam, product_type), overwrite=TRUE)

}


test <- rast(here("prep/02_feed/output/plant_diet/salmon_aquaculture_meat_soyb_soy protein concentrate.tif"))
plot(log(test+1))


test_names <- str_replace_all(str_before_last(list.files(here("prep/02_feed/output/plant-dominant/")), ".tif"), "_", ":")

test <- rast(list.files(here("prep/02_feed/output/plant-dominant/"), full.names = TRUE))

names(test) <- test_names
plot(log(test+1))

```
 
Make some plots

```{r}

feed_source <- read.csv(here("prep/02_feed/data/demand/ingredient_crop_demand_production_conversions.csv")) %>%
  left_join(feed_cats, by = c("ingredient" = "source_ingredient", "item" = "fao_item")) %>%
  dplyr::select(-source, -`raw material`, -included_source) %>%
  group_by(iso3c_producing, diet, SPAM_super, ingredient) %>%
  summarize(produced_ingredient_tonnes = sum(total_crop_demand_ms)) %>% 
  ungroup()



tmp <- filter(feed_source) %>%
    group_by(ingredient, diet) %>%
  slice_max(order_by = produced_ingredient_tonnes, n = 15) %>%
  ungroup() %>%
  filter(produced_ingredient_tonnes > 0)


ggplot(data = tmp %>%
         filter(diet == "fish-dominant"), aes(x = produced_ingredient_tonnes, y = reorder_within(iso3c_producing, produced_ingredient_tonnes, SPAM_super))) + 
  geom_bar(stat = "identity") + 
  facet_wrap(~ingredient, scales = "free") + 
  labs(x = "Tonnes of crop produced for ingredient", y = "Country") + 
  theme_bw() + 
  theme(axis.text.x = element_text(angle = 30, vjust = 0.5)) 

ggsave(here("prep/02_feed/plots/total_crop_feed_origins_plant.png"), units = "in", height = 11, width = 11)
```


