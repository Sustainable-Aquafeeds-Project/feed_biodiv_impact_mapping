---
title: "Forage fish for feed"
author: "Melanie Frazier (UCSB, NCEAS, OHI)"
date: "May 21, 2019"
output: html_document
editor_options: 
  chunk_output_type: console
---

GOAL: Create a raster describing the proportion of each country's catch going to animal feed in the location of capture.

```{r}
#load relevant packages, etc.

library(here)
library(raster)
library(tidyverse)
library(countrycode)

# function to project raster
## Use correct CRS


watson_raster_template <- raster::raster(ncol=720, nrow=360, vals=c(1:259200))
food_raster <- raster(nrows=2160, ncols=4320, xmn=-180, xmx=180, ymn=-90, ymx=90)

source(here("src/fxns.R"))
source(here("src/directories.R"))

```


The likely country source of fish meal/oil for each animal system. These data were generated by Jessica Gephart based on country level consumption and trade data. 

```{r}

feed_rgn <- read_csv(here("prep/02_feed/data/FMFO_bySource_2021Apr.csv")) %>%
  filter(!is.na(tonnes))

```


```{r}
# exploring what is lost

watson_rgn <- read_csv(here("fisheries/marine/ghg/data/Watson_rgns_with_iso3c.csv"))

watson_rgn <- read_csv(file.path(watson_dir, "v5.0/watson_2017_fisheries_catch_w_cat.csv")) %>%
  distinct(CNumber, country = CountryName) %>%
  mutate(iso3c = countrycode(sourcevar = country, origin = "country.name", destination = "iso3c")) %>%
  mutate(iso3c = 
           case_when(
             country == "Amer Samoa" ~ "ASM", 
             country == "Br Ind Oc Tr" ~ "IOT", 
             country == "Br Virgin Is" ~ "VGB", 
             country == "Dominican Rp" ~ "DOM",
             country == "Fr Polynesia" ~ "PYF", 
             country == "Fr Guiana" ~ "GUF", 
             country == "Micronesia" ~ "FSM", 
             country == "St Pier Mq" ~ "SPM", 
             country == "Untd Arab Em" ~ "UAE", 
             country == "US Virgin Is" ~ "VIR", 
             TRUE ~ iso3c
           ))

test <- watson_rgn %>%
  filter(is.na(iso3c))

excluded <- setdiff(feed_rgn$iso3c, watson_rgn$iso3c)

# catch for regions being lost
filter(feed_rgn, iso3c %in% excluded) %>%
  group_by(system) %>%
  summarize(total = sum(tonnes))

# total catch
feed_rgn %>%
  group_by(system) %>%
  summarize(total = sum(tonnes, na.rm=TRUE))

## only 311 tonnes missing from salmon.. I'm ok with that! 
```


Determine total forage fish captured by each country (Watson catch data):
```{r}

foragefish <- read_csv(file.path(watson_dir, "v5.0/watson_2017_fisheries_catch_w_cat.csv")) %>% 
  left_join(watson_rgn, by = c("CountryName" = "country", "CNumber")) %>%
  mutate(catch = ReportedIND + IUUIND + ReportedNIND + IUUNIND) %>%
  mutate(FOFM_catch = catch*foragefish) %>%
  mutate(FOFM_catch = ifelse(is.na(FOFM_catch), 0, FOFM_catch)) 

# foragefish <- read_csv("/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/ghg/watson_v5_emissions/full_watson_catch_data_2017.csv")

foragefish_rgn_totals <- foragefish %>%
  group_by(iso3c) %>%
  summarize(FOFM_catch = sum(FOFM_catch, na.rm = TRUE)) %>%
  ungroup()

```

Divide each country's total pelagic feed fish catch by the total going to each animal feed system.

```{r}

FOFM_props <- left_join(foragefish_rgn_totals, feed_rgn, by="iso3c") %>%
  filter(!is.na(system)) %>% # these regions have catch, but none recorded going to a system
  mutate(prop = ifelse(FOFM_catch == 0, 0, tonnes/FOFM_catch)) %>%
  filter(system == "salmon_aquaculture_meat")

summary(FOFM_props)  

```

ISSUE 2: in some cases, we overshoot and say there are more fish caught in the country for feed than what is reported in the fisheries catch data.  

In these cases: we constrain the consumed catch to not overshoot the reported catch for a country and distribute this extra globally later on.

```{r}

# list of overshooting countries
FOFM_props %>%
  group_by(iso3c) %>%
  summarize(total_prop = sum(prop)) %>% 
  filter(total_prop>1)

# code to limit feed to available catch:
FOFM_props_limit <- FOFM_props %>%
  group_by(iso3c) %>%
  mutate(total_prop = sum(prop, na.rm=TRUE),
            total_tonnes = sum(tonnes)) %>%
  rowwise() %>%
  mutate(prop_consumption = tonnes/total_tonnes) %>%
  mutate(prop_correct = ifelse(total_prop>1, prop_consumption, prop)) %>%
  select(iso3c, country, FOFM_catch, system, tonnes, prop=prop_correct)
  
## peak and see that all looks fine
filter(FOFM_props_limit, iso3c=="SYC") %>% data.frame()
filter(FOFM_props_limit, iso3c=="USA") %>% data.frame()
  
```

All sources of loss result in about 15% loss of fofm catch.  This will be assigned to global catch proportional to total forage fish catch. We will need to calculate the amount of fofm catch lost, and add that to our total. 

```{r}

# total fofm catch:
forage_tonnes <- sum(foragefish_rgn_totals$FOFM_catch) # 39054068 

# total system consumption:
system_consumption <- read_csv(here("prep/02_feed/data/demand/FMFO_country_data.csv")) %>%
  group_by(system) %>%
  summarize(total_feed = sum(tonnes, na.rm=TRUE)) %>%
  filter(!is.na(system))

loss <- FOFM_props_limit %>%
  rowwise() %>%
  mutate(est_tonnes = FOFM_catch*prop) %>%
  group_by(system) %>%
  summarize(est_feed = sum(est_tonnes)) %>%
  left_join(system_consumption, by="system") %>%
  mutate(prop_accounted_for = est_feed/total_feed) %>% # 92% accounted for 
  mutate(loss = total_feed - est_feed) %>%
  mutate(forage_tonnes = forage_tonnes) %>%
  mutate(prop_of_global_distribute = loss/forage_tonnes)

# about 8% is being lost from salmon aquaculture
sum(loss$est_feed, na.rm=TRUE)/sum(loss$total_feed, na.rm=TRUE) #0.92

```

Create rasters describing amount of each countries fofm catch going to feed for salmon aquaculture for each diet scenario.

```{r}

## eventually retrofit code to add extra diet scenarios

systems <- loss$system

system_item = systems
diet_type = "plant_diet"

  watson_raster_template <- raster::raster(ncol=720, nrow=360, vals=c(1:259200))

  
  system_prop <- FOFM_props_limit %>%
  dplyr::filter(system == system_item) %>%
  dplyr::select(iso3c, prop)

system_extra_prop <- filter(loss, system == system_item) %>%
  pull(prop_of_global_distribute)

foragefish_system <- left_join(foragefish, system_prop, by="iso3c") %>%
  mutate(prop = ifelse(is.na(prop), 0, prop)) %>% ## fix NAs
  mutate(system_extra_prop = system_extra_prop) %>%
  mutate(FOFM_catch_foodsystem_ID = FOFM_catch * prop) %>% ## fofm catch to feed
  mutate(FOFM_catch_foodsystem_xtra = FOFM_catch * system_extra_prop) %>% ## fofm catch to feed that is missing
  mutate(FOFM_catch_foodsystem = FOFM_catch_foodsystem_ID + FOFM_catch_foodsystem_xtra) %>% ## add that together
  group_by(Cell) %>%
  summarize(tonnes = sum(FOFM_catch_foodsystem, na.rm=TRUE))
  
forage_fish_system <- raster::subs(watson_raster_template, foragefish_system, by = "Cell", which = "tonnes", subsWithNA=TRUE)

# plot(log(forage_fish_system + 1))

# the following should be about equal
print(sprintf("the following should be about equal for: %s", system_item))
print(sprintf("raster calc: %s", cellStats(forage_fish_system, "sum", na.rm=TRUE))) 
print(sprintf("observed: %s", filter(loss, system==system_item) %>% pull(total_feed)))


writeRaster(forage_fish_system, sprintf(here("prep/02_feed/output/%s/forage_fish_tonnes_feed_%s.tif"), diet_type, diet_type) , overwrite=TRUE)


test <- rast(here("prep/02_feed/output/plant_diet/forage_fish_tonnes_feed_plant_diet.tif"))

plot(log(test+1))
```
