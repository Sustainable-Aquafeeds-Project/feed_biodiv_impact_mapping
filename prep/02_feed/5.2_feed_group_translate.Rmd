---
title: "Calculating feed components"
output: html_document
editor_options: 
  chunk_output_type: console
---


STOPPED HERE MARCH 20

This script divides consumption into fofm and crop categories.

```{r setup, include=FALSE}

library(here)
library(stringi)

source(here("src/fxns.R"))

demand <- read_csv(here("prep/02_feed/data/demand/total_aquaculture_ingredient_demand_corrected.csv")) %>%
  mutate(animal_system = paste(animal, system, product, sep="_")) %>%
  rename(source_ingredient = ingredient) %>%
  select(iso3c, animal_system, source_ingredient, ingredient_demand)

```

## Calculate tonnes consumption from MAPSPAM categories of feed

```{r}

feed_cats <- read_csv(here("prep/02_feed/data/feed_category_table.csv")) %>% ## this table was created manually. It matches our ingredient names from Aas et al. 2022 to mapspam names. Must also update product_to_fao_spam.csv. 
  select(-notes) 

# make sure all feed is categorized...if not update the feed_category_table.csv
setdiff(demand$source_ingredient, feed_cats$source_feedname)

# make sure no duplicates, if there are: correct them:
feed_cats[duplicated(feed_cats$source_feedname),]

feedstuff_cats <- demand %>%
  left_join(feed_cats, by= c("source_ingredient" = "source_feedname")) 
filter(feedstuff_cats, is.na(included_source)) # should be no NA values

crop_feed <- feedstuff_cats %>%
  filter(included_source == "mapspam")

# see whats there, should be no blank data!
crop_feed %>%
  filter(ingredient_demand > 0) %>%
  select(source_ingredient, product) %>%
  unique() %>%
  data.frame()

```


Determine processing loss. This gives us the true amount of raw material. 

```{r}

feed_loss <- read_csv(here("prep/02_feed/data/feed_extraction_rates.csv"))  %>%
  dplyr::select(-processing, -source, -...7) %>%
  unique()

setdiff(crop_feed$product, feed_loss$product) # if anything pops up, edit feed_extraction_rates.csv to include loss data

# missing "guar protein" 

crop_feed_extract <- crop_feed %>%
  left_join(feed_loss, by = "product") %>%
  mutate(tonnes_product = ingredient_demand * 100/(100 - crop_loss)) 

write.csv(crop_feed_extract, here("prep/02_feed/data/demand/crop_demand_extraction_corrected.csv"), row.names = FALSE)


```

Convert to mapspam crops.

```{r}


## SPAM_super categories that we have combined:
spam_super <- vroom::vroom(here("prep/02_feed/data/MapSPAM_to_FAO_v2.csv")) %>%
  select(SPAM_short_name, SPAM_super) %>%
  unique() %>%
  data.frame()

## feed items and corresponding spam categories
spam <- read_csv(here("prep/02_feed/data/product_to_fao_spam.csv")) %>%
  select(product, SPAM_short_name) %>%
  unique()
setdiff(spam_super$SPAM_short_name, spam$SPAM_short_name) # these crops are not feed items
setdiff(spam$SPAM_short_name, spam_super$SPAM_short_name) # should be nothing here
## if there are differences: need to edit something to align data
setdiff(crop_feed_extract$product, spam$product)

spam <- left_join(spam, spam_super, by="SPAM_short_name")

crop_feed_spam <- crop_feed_extract %>%
  left_join(spam, by="product") %>%
  group_by(iso3c, animal_system, SPAM_super, product) %>%
  summarize(tonnes_product = sum(tonnes_product)) %>%
  ungroup()

write_csv(crop_feed_spam, here("prep/02_feed/data/demand/system_country_mapspam_tonnes_consumption.csv"))

```


## Calculate tonnes consumption from FOFM categories of feed

```{r}

feed_cats <- read_csv(here("prep/02_feed/data/feed_category_table.csv")) %>%
  select(-notes)

feedstuff_cats <- demand %>%
  left_join(feed_cats, by= c("source_ingredient" ="source_feedname")) 

filter(feedstuff_cats, is.na(included_source)) # should be no NA values

fofm_feed <- feedstuff_cats %>%
  filter(included_source == "fofm") %>%
  mutate(feed_item = "fofm marine catch") %>%
  select(iso3c, system=animal_system, tonnes=ingredient_demand) %>%
  filter(tonnes>0) %>%
  filter(!is.na(system))

unique(fofm_feed$system)

```

account for processing loss

```{r}

feed_loss <- read_csv(here("prep/02_feed/data/feed_extraction_rates.csv"))  %>%
  filter(crop == "forage fish") %>%
  dplyr::select(crop_loss) %>%
  unique() %>%
  pull()

fofm_feed_extract <- fofm_feed %>%
  mutate(feed_loss = feed_loss) %>%
  mutate(tonnes_product = tonnes * 100/(100 - feed_loss)) 

# check to see values generally match with expectation
fofm_feed_extract %>%
  separate(system, c("animal", "system", "product")) %>%
  group_by(animal) %>%
  summarize(tonnes=sum(tonnes_product))


read_csv(here("prep/02_feed/data/demand/fofm_aquaculture_corrected_consumption.csv")) %>%
  select(animal, true_tonnes_fish)

regions <- read_csv(here("data/spatial/output/food_rgns.csv")) %>%
  select(-ID_0)

fofm_feed_final <- left_join(regions, fofm_feed_extract) %>%
  mutate(feed_item = "forage fish") %>%
  select(iso3c, Country, system, feed_item, tonnes = tonnes_product) %>%
  mutate(tonnes = ifelse(is.na(tonnes), 0, tonnes)) %>%
  filter(!is.na(system))

write_csv(fofm_feed_final, here("prep/02_feed/data/demand/FMFO_country_data.csv"))

```



## Calculate tonnes consumption from fodder

## Summary of categories

```{r}
## do we need this?
feed_cats <- read_csv(here("prep/02_feed/data/feed_category_table.csv")) %>%
  select(-notes)

feedstuff_cats <- demand %>%
  left_join(feed_cats, by = c("source_ingredient" = "source_feedname"))
filter(feedstuff_cats, is.na(included_source)) # should be no NA values

feed <- feedstuff_cats %>%
  separate(animal_system, c("animal", "system", "product")) %>%
  group_by(animal, included_source) %>%
  summarize(tonnes_by_category = sum(ingredient_demand)) %>%
  group_by(animal) %>%
  mutate(tonnes_total = sum(tonnes_by_category)) %>%
  ungroup() %>%
  rowwise() %>%
  mutate(proportion = tonnes_by_category/tonnes_total) %>%
  data.frame()

# write_csv(feed, here("feed/data/system_consumption_per_category.csv"))


```

