---
title: "Forage fish for feed"
author: "Gage Clawson (NCEAS, IMAS)"
date: "May 18, 2023"
output: html_document
editor_options: 
  chunk_output_type: console
---


```{r}
#load relevant packages, etc.

library(here)
library(raster)
library(tidyverse)
library(countrycode)
library(readxl)


source(here("src/fxns.R"))
source(here("src/directories.R"))

```


The likely country source of fish meal/oil for each animal system. These data were generated by Jessica based on country level consumption and UNCOMTRADE trade data. 

```{r}

feed_rgn <- read_csv(here("prep/02_feed/data/FMFO_bySource_2021Apr.csv")) %>%
  filter(!is.na(tonnes))

```


Food balance sheets

```{r}
fbs <- read_csv(file.path(rdsi_raw_data_dir, "fao/FAO_FoodBalanceSheets/d2023/FoodBalanceSheets_E_All_Data_(Normalized).csv")) %>%
  filter(Year == 2020) %>% # have to use 2020 here because fbs doesn't have 2021 yet... 
  clean_names() %>%
  dplyr::select(consuming_area_code = area_code, consuming_country = area, element, FAO_Item_Code_NFB = item_code, item, value) %>%
  filter(element %in% c("Domestic supply quantity", "Export Quantity", "Feed", "Import Quantity", "Production", "Stock Variation")) %>% # filter for relevant element 
  filter(item %in% c("Demersal Fish", "Pelagic Fish", "Marine Fish, Other", "Fish, Boy Oil", "Fish, Liver Oil", "Crustaceans", "Cephalopods", "Molluscs, Other")) # filter for potential fmfo items


```

FAO detailed trade 

```{r}

```



UN COMTRADE 

Possible HS codes for fish oil and fish meal  



HS 230120 â€“ Flours, meals and pellets; of fish or of crustaceans, molluscs or other aquatic invertebrates  

```{r}
raw_230120_meals <- read.csv(here("prep/02_feed/data/comtrade/TradeData_230120.csv"))


test <- raw_230120_meals %>% distinct(ReporterISO, Partner2ISO) %>%
  pivot_wider(values_from = Partner2ISO, names_from = ReporterISO)

unique(raw_230120_meals$ReporterISO) # 78 countries.. maybe it didn't download all? 

unique(feed_rgn$iso3c) # 143 in data from jessica...


raw_150420_oils <- read.csv(here("prep/02_feed/data/comtrade/TradeData_150420.csv"))

length(unique(raw_150420_oils$ReporterISO)) # 76 countries.. maybe it didn't download all? 


raw_150410_oils <- read.csv(here("prep/02_feed/data/comtrade/TradeData_150410.csv"))

length(unique(raw_150410_oils$ReporterISO)) # 75 countries.. maybe it didn't download all? 

meals_df <- raw_230120_meals %>%
    filter(ReporterISO != "W00", 
         PartnerISO != "W00") %>%
  filter(Partner2ISO == "W00") %>%
  dplyr::select(ReporterISO, FlowDesc, PartnerISO, CmdCode, CmdDesc, Qty, PrimaryValue) %>%
  mutate(Qty = Qty*0.001, 
         PrimaryValue = PrimaryValue*0.001) 
  
oils_df <- raw_150420_oils %>%
    filter(ReporterISO != "W00", 
         PartnerISO != "W00") %>%
  filter(Partner2ISO == "W00") %>%
  dplyr::select(ReporterISO, FlowDesc, PartnerISO, CmdCode , CmdDesc, Qty, PrimaryValue) %>%
  mutate(Qty = Qty*0.001, 
         PrimaryValue = PrimaryValue*0.001)

test <- oils_df %>%
  filter(ReporterISO == "CHN", 
         PartnerISO == "CHN") ## ok... so we want exports and what they are keeping for themselves 

## we want exports and anything they keep for themselves.. e.g. "landing country". So we want anything they export, or export or import to themselves 

oils_meals_all <- rbind(oils_df, meals_df) %>%
  mutate(type = ifelse(CmdCode == 230120, "fish meal", "fish oil"))

oils_meals_imports <- oils_meals_all %>%
  filter(FlowDesc == "Import") %>%
  filter(ReporterISO == PartnerISO) %>%
    group_by(ReporterISO, type) %>% 
  summarise(tonnes = sum(Qty, na.rm = TRUE)) %>%
  ungroup()

oils_meals_exports_self <- oils_meals_all %>%
    filter(FlowDesc == "Export") %>%
  filter(ReporterISO == PartnerISO) # 0 


oils_meals_exports <- oils_meals_all %>%
    filter(FlowDesc == "Export") %>%
  group_by(ReporterISO, type) %>% 
  summarise(tonnes = sum(Qty, na.rm = TRUE)) %>%
  ungroup()
  
oils_meals_landings_exports <- rbind(oils_meals_imports, oils_meals_exports) %>%
  group_by(ReporterISO, type) %>%
  summarise(tonnes = sum(tonnes,na.rm = TRUE)) %>%
  ungroup()

```

## Possible approach 1 
  - Determine each countries' breakdown of forage fish species catch by flag country (e.g., where the catch is actually landed, rather than caught). Filter for all forage fish species, group by country and species, and determine the within-country proportions of catch from each species. For example, 60% of the forage fish species weight that Norway lands is from Atlantic herring, 32% from Blue whiting, 6% from Atlantic mackerel, etc...
 - Apply these within country percentages to total country domestic fish oil and fish meal. Now we will have X tonnes of fish oil and fish meal exported from or kept within country Y per fish species. 
     - For example, if 60% of the forage catch in Norway is from Atlantic herring, then 60% of the fish meal exported from or kept in Norway will be from Atlantic herring. 
 - Next, we can use the species specific allocation rates that Rich put together to convert the fish oil and fish meal to raw material live weight equivalents. 

After this, I get a bit fuzzy on the best way to move forward. At some point, we need to incorporate the demand for FMFO ingredients for salmon in each country. Doing the above steps would tell us total Fish oil or fish meal in live weight per country, but won't tell us what it is ultimately used for. 

 - Match to watson data by vessel flag (e.g., the landing country) and species
 - Then group by cell after multiplying by the proportion of forage catch to fofm in each landing country per species 

```{r}

forage_spp_biomar <- read_csv("/mnt/rdsi/raw_data/biomar/forage_spp_list.csv") %>% dplyr::select(-3) # grab forage fish species from biomar

forage_spp_nceas <-   read_csv(file.path(watson_dir, "v5.0/watson_2017_fisheries_catch_w_cat.csv")) |> 
  filter(!is.na(foragefish)) %>%
  distinct(CommonName, TaxonName) # grab forage fish spp from halleys paper

setdiff(forage_spp_biomar$scientific_name, forage_spp_nceas$TaxonName)

setdiff(forage_spp_nceas$TaxonName, forage_spp_biomar$scientific_name) # lots of mismatches based on spelling... 

## ill use halleys species list for now 

codes_country <- read.csv(file.path(watson_dir, "v5.0/Codes_country.csv")) # read in country codes 

# calculate forage catch and add iso3c codes
forage_catch <- 
  read_csv(file.path(watson_dir, "v5.0/watson_2017_fisheries_catch_w_cat.csv")) |> 
  left_join(watson_rgn, by = c("CountryName" = "country", "CNumber")) %>%
  mutate(catch = ReportedIND + IUUIND + ReportedNIND + IUUNIND) %>%
  mutate(FOFM_catch = catch*foragefish) %>%
  mutate(FOFM_catch = ifelse(is.na(FOFM_catch), 0, FOFM_catch))  %>%
  filter(FOFM_catch > 0) %>%
  left_join(codes_country, by = c("CNumber" = "Cnumber")) %>%
  rename(country = FAO.name) %>%
    mutate(iso3c = countrycode(sourcevar = country, origin = "country.name", destination = "iso3c")) %>%
  mutate(iso3c = 
           case_when(
             country == "Amer Samoa" ~ "ASM", 
             country == "Br Ind Oc Tr" ~ "IOT", 
             country == "Br Virgin Is" ~ "VGB", 
             country == "Dominican Rp" ~ "DOM",
             country == "Fr Polynesia" ~ "PYF", 
             country == "Fr Guiana" ~ "GUF", 
             country == "Micronesia" ~ "FSM", 
             country == "St Pier Mq" ~ "SPM", 
             country == "Untd Arab Em" ~ "UAE", 
             country == "US Virgin Is" ~ "VIR", 
             TRUE ~ iso3c
           ))

## get an estimate of proportion of forage fish catch coming from different species in different landing countries. 
forage_catch_iso <- forage_catch %>%
  group_by(iso3c, CommonName, TaxonName) %>%
  summarise(catch = sum(FOFM_catch, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(iso3c) %>%
  mutate(total_fofm_catch = sum(catch, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(prop_of_iso_total = catch/total_fofm_catch)


## 
```


Now join landings+exports comtrade data with watson data 

```{r}
forage_fofm <- forage_catch_iso %>%
  left_join(oils_meals_landings_exports, by = c("iso3c" = "ReporterISO")) %>%
  mutate(tonnes_fofm_spp = tonnes*prop_of_iso_total) %>%
  dplyr::select(iso3c, CommonName, TaxonName, type, tonnes_fofm_spp) %>%
  filter(!is.na(tonnes_fofm_spp))

```

Now we can read in allocation data that rich created

```{r}
fish_allocations_raw <- read_xlsx(here("data/tidy_data/allocation/embodied_fish_allocation.xlsx"))

ga_mass_FO <- fish_allocations_raw %>%
  filter(ecosystem == "GA", ingredient == "Fish oil") %>%
  pull(mass_value)

ga_mass_FM <- fish_allocations_raw %>%
  filter(ecosystem == "GA", ingredient == "Fishmeal") %>%
  pull(mass_value)

  
ga_ge_FO <- fish_allocations_raw %>%
  filter(ecosystem == "GA", ingredient == "Fish oil") %>%
  pull(ge_value)


ga_ge_FM <- fish_allocations_raw %>%
  filter(ecosystem == "GA", ingredient == "Fishmeal") %>%
  pull(ge_value)


fish_allocations_df <- fish_allocations_raw %>%
  filter(!is.na(fishmeal_yield)) %>%
  filter(ecosystem != "GA") %>%
  mutate(CommonName = trimws(str_extract(species, ".*?(?=\\()"))) %>%
  mutate(CommonName = ifelse(CommonName == "Peruvian bnchovy", "Peruvian anchovy", CommonName)) %>%
  group_by(CommonName, ingredient) %>% # lets just do global averages per species for now 
  summarise(ge_value = mean(ge_value, na.rm = TRUE), 
            mass_value = mean(mass_value, na.rm = TRUE)) %>%
  ungroup() 

```

Match allocation data to the fish oil and fish meal per species from comtrade

```{r}
forage_fofm_allocation <- forage_fofm %>%
  left_join(fish_allocations_df, by = c("type" = "ingredient", "CommonName")) %>%
  mutate(ge_value = case_when(
    is.na(ge_value) & type == "Fishmeal" ~ ga_ge_FM,
    is.na(ge_value) & type == "Fish oil" ~ ga_ge_FO, 
    TRUE ~ ge_value),
    mass_value = case_when(
      is.na(mass_value) & type == "Fishmeal" ~ ga_mass_FM,
      is.na(mass_value) & type == "Fish oil" ~ ga_mass_FO, 
      TRUE ~ mass_value
    )
  ) %>%
  pivot_longer(cols = c("ge_value", "mass_value"), 
               names_to = "allocation_type", 
               values_to = "allocation_value"
               ) %>%
  mutate(allocation_type = ifelse(allocation_type == "ge_value", "ge", "mass")) %>%
  mutate(tonnes_fofm_spp_live_weight = tonnes_fofm_spp*allocation_value)


## compare to demand 

test <- forage_fofm_allocation %>%
  group_by(iso3c, type) %>%
  summarise(tonnes_fofm = sum(tonnes_fofm_spp, na.rm =TRUE),
            tonnes_fofm_live_weight = sum(tonnes_fofm_spp_live_weight, na.rm = TRUE))


system_consumption_ingredient <- read_csv(here("prep/02_feed/data/demand/total_aquaculture_ingredient_demand.csv")) %>%
  filter(ingredient %in% c("fish meal, forage fish", "fish oil, forage fish")) 
```




## Possible approach 2

 1. Start with demand per country 
    - EX: NOR requires X tonnes of FO
 2. Get trade data for FO and FM and match to demand data. Figure out how much countries import FO or FM from other countries. 
    - EX: NOR imports Y% of FO from USA, Z% from Peru, etc.
 3. Multiply the import %s by the demand tonnes to get ingredient tonnes imported per country
    - EX: NOR requires 100 tonnes of FO, they import 60% from the USA, then 60 tonnes of FO ingredients in NOR comes from the USA for salmon. 
 4. Group by exporter country to get total amount of FO or FM ingredients they export under each diet demand scenario
    - EX: USA exports 60 tonnes to NOR, 40 tonnes to CHL, then they export 100 tonnes of FO total for salmon feed. 
 5. Determine each countries' breakdown of forage fish species catch by flag country (e.g., where the catch is actually landed, rather than caught). Filter for all forage fish species, group by country and species, and determine the within-country proportions of catch from each species. For example, 55% of the forage fish species weight that USA lands is from Gulf Menhaden, 24% from Atlantic Menhaden, 8% from Atka mackerel, etc...
 6. Apply these within country percentages to total country exported fish oil and fish meal (calculated in step 4). Now we will have X tonnes of fish oil and Y tonnes of fish meal exported from or kept within country Z per fish species per diet scenario. 
     - For example, if 55% of the forage catch in USA is from Gulf Menhaden, then 55% of the fish meal (and 55% of the fish oil) exported from or kept in USA will be attributed to Gulf Menhaden. 
 7. Next, we can use the species specific allocation rates that Rich put together to convert the fish oil and fish meal to raw material live weight equivalents. Now we have total tonnes of fish oil and fish meal live weight equivalents per landing country per species. 

Now I'm a bit fuzzy on the next part...

 8. Divide the tonnes of fish oil and fish meal live weight equivalents by the total amount of forage catch in each country. This gives us a proportion of forage fish catch in each country that goes to FMFO. 
 9. Join with Watson data, group by cell, and rasterize? Now we will have rasters describing the amount of forage fish catch that goes to fish oil or fish meal for salmon feed under each diet scenario under each allocation approach (mass or energetic). 
 
 
```{r}
## step 1
country_demand <- read_csv(here("prep/02_feed/data/demand/total_aquaculture_ingredient_demand.csv")) %>%
  filter(ingredient %in% c("fish meal, forage fish", "fish oil, forage fish")) %>%
  mutate(ingredient = ifelse(ingredient == "fish meal, forage fish", "fish meal", "fish oil"))

## step 2

oils_meals_import_props <- oils_meals_all %>% 
  dplyr::select(ReporterISO, PartnerISO, type, Qty) %>% 
  group_by(ReporterISO, type) %>%
  mutate(total_import = sum(Qty, na.rm = TRUE)) %>% 
  ungroup() %>%
  mutate(prop_import = Qty/total_import)
  

## step 3

demand_trade <- country_demand %>%
  left_join(oils_meals_import_props, by = c("iso3c" = "ReporterISO", "ingredient" = "type")) %>% ## the comtrade data is missing a lot of countries... 
  mutate(tonnes_ingredient_demand_traded = prop_import*ingredient_demand) # small problem here: missing RUS, PRK, FRO, and ARE. According to comtrade they don't import any fish oil or fish meal... 

## step 4
demand_trade_origin <- demand_trade %>%
  group_by(PartnerISO, ingredient, diet) %>%
  summarise(total_ingredient_tonnes_traded = sum(tonnes_ingredient_demand_traded, na.rm = TRUE)) %>% # missing about 1 million tonnes due to missing countries in trade data 
  ungroup()

## step 5 
codes_country <- read.csv(file.path(watson_dir, "v5.0/Codes_country.csv")) # read in country codes 

# calculate forage catch and add iso3c codes
forage_catch <- 
  read_csv(file.path(watson_dir, "v5.0/watson_2017_fisheries_catch_w_cat.csv")) |> 
  left_join(watson_rgn, by = c("CountryName" = "country", "CNumber")) %>%
  mutate(catch = ReportedIND + IUUIND + ReportedNIND + IUUNIND) %>%
  mutate(FOFM_catch = catch*foragefish) %>%
  mutate(FOFM_catch = ifelse(is.na(FOFM_catch), 0, FOFM_catch))  %>%
  filter(FOFM_catch > 0) %>%
  left_join(codes_country, by = c("CNumber" = "Cnumber")) %>%
  rename(country = FAO.name) %>%
    mutate(iso3c = countrycode(sourcevar = country, origin = "country.name", destination = "iso3c")) %>%
  mutate(iso3c = 
           case_when(
             country == "Amer Samoa" ~ "ASM", 
             country == "Br Ind Oc Tr" ~ "IOT", 
             country == "Br Virgin Is" ~ "VGB", 
             country == "Dominican Rp" ~ "DOM",
             country == "Fr Polynesia" ~ "PYF", 
             country == "Fr Guiana" ~ "GUF", 
             country == "Micronesia" ~ "FSM", 
             country == "St Pier Mq" ~ "SPM", 
             country == "Untd Arab Em" ~ "UAE", 
             country == "US Virgin Is" ~ "VIR", 
             TRUE ~ iso3c
           ))


foragefish <- 
  read_csv(file.path(watson_dir, "v5.0/watson_2017_fisheries_catch_w_cat.csv")) |> 
  left_join(watson_rgn, by = c("CountryName" = "country", "CNumber")) %>%
  mutate(catch = ReportedIND + IUUIND + ReportedNIND + IUUNIND) %>%
  mutate(FOFM_catch = catch*foragefish) %>%
  mutate(FOFM_catch = ifelse(is.na(FOFM_catch), 0, FOFM_catch))

## get an estimate of proportion of forage fish catch coming from different species in different landing countries. 
forage_catch_iso <- forage_catch %>%
  group_by(iso3c, CommonName, TaxonName) %>%
  summarise(catch = sum(FOFM_catch, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(iso3c) %>%
  mutate(total_fofm_catch = sum(catch, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(prop_of_iso_total = catch/total_fofm_catch)

## step 6 

forage_fofm_origins <- forage_catch_iso %>%
  dplyr::select(iso3c, CommonName, TaxonName, prop_of_iso_total) %>%
  left_join(demand_trade_origin, by = c("iso3c" = "PartnerISO")) %>%
  mutate(tonnes_fofm_spp = total_ingredient_tonnes_traded*prop_of_iso_total) %>%
  dplyr::select(iso3c, CommonName, TaxonName, ingredient, diet, tonnes_fofm_spp) %>%
  filter(!is.na(tonnes_fofm_spp))

## step 7

## read in allocation data 
fish_allocations_raw <- read_xlsx(here("data/tidy_data/allocation/embodied_fish_allocation.xlsx"))

ga_mass_FO <- fish_allocations_raw %>%
  filter(ecosystem == "GA", ingredient == "Fish oil") %>%
  pull(mass_value)

ga_mass_FM <- fish_allocations_raw %>%
  filter(ecosystem == "GA", ingredient == "Fishmeal") %>%
  pull(mass_value)

  
ga_ge_FO <- fish_allocations_raw %>%
  filter(ecosystem == "GA", ingredient == "Fish oil") %>%
  pull(ge_value)


ga_ge_FM <- fish_allocations_raw %>%
  filter(ecosystem == "GA", ingredient == "Fishmeal") %>%
  pull(ge_value)


fish_allocations_df <- fish_allocations_raw %>%
  filter(!is.na(fishmeal_yield)) %>%
  filter(ecosystem != "GA") %>%
  mutate(CommonName = trimws(str_extract(species, ".*?(?=\\()"))) %>%
  mutate(CommonName = ifelse(CommonName == "Peruvian bnchovy", "Peruvian anchovy", CommonName)) %>%
  group_by(CommonName, ingredient) %>% # lets just do global averages per species for now 
  summarise(ge_value = mean(ge_value, na.rm = TRUE), 
            mass_value = mean(mass_value, na.rm = TRUE)) %>%
  ungroup() 

## Match allocation data to the fish oil and fish meal per species from comtrade


forage_fofm_allocation <- forage_fofm_origins %>%
  left_join(fish_allocations_df, by = c("ingredient", "CommonName")) %>%
  mutate(ge_value = case_when(
    is.na(ge_value) & ingredient == "fish meal" ~ ga_ge_FM,
    is.na(ge_value) & ingredient == "fish oil" ~ ga_ge_FO, 
    TRUE ~ ge_value),
    mass_value = case_when(
      is.na(mass_value) & ingredient == "fish meal" ~ ga_mass_FM,
      is.na(mass_value) & ingredient == "fish oil" ~ ga_mass_FO, 
      TRUE ~ mass_value
    )
  ) %>%
  pivot_longer(cols = c("ge_value", "mass_value"), 
               names_to = "allocation_type", 
               values_to = "allocation_value"
               ) %>%
  mutate(allocation_type = ifelse(allocation_type == "ge_value", "ge", "mass")) %>%
  mutate(tonnes_fofm_spp_live_weight = tonnes_fofm_spp*allocation_value)


## step 8

# Divide the tonnes of fish oil and fish meal live weight equivalents by the total amount of forage catch in each country. This gives us a proportion of forage fish catch in each country that goes to FMFO.

foragefish_rgn_totals <- forage_catch_iso %>%
  group_by(iso3c) %>%
  summarise(FOFM_catch = sum(catch)) %>%
  ungroup()

forage_fofm_allocation_totals <- forage_fofm_allocation %>%
  group_by(iso3c, ingredient, diet, allocation_type) %>%
  summarise(total_tonnes_fofm_lw = sum(tonnes_fofm_spp_live_weight, na.rm = TRUE)) %>%
              ungroup()

FOFM_props <- left_join(foragefish_rgn_totals, forage_fofm_allocation_totals) %>%
  filter(!is.na(diet)) %>% # filter out NAs for now.. will fix later
  mutate(prop = ifelse(FOFM_catch == 0, 0, total_tonnes_fofm_lw/FOFM_catch)) %>%
  dplyr::select(iso3c, ingredient, diet, allocation_type, prop)


diets <- unique(FOFM_props$diet)
allocations <- unique(FOFM_props$allocation_type)
ingredients <- unique(FOFM_props$ingredient)

for(diet_type in diets){
  for(allocation in allocations){
    for(ingredient_type in ingredients){
    
    # diet_type = "plant-dominant"
    # allocation = "ge"    
    # ingredient_type = "fish oil"
    
  watson_raster_template <- raster::raster(ncol=720, nrow=360, vals=c(1:259200))
  
  system_prop <- FOFM_props %>%
    dplyr::filter(diet == diet_type,
                  allocation_type == allocation,
                  ingredient == ingredient_type) %>%
    dplyr::select(iso3c, diet, ingredient, prop)
  
  foragefish_system <- left_join(foragefish, system_prop, by = c("iso3c")) %>%
    mutate(prop = ifelse(is.na(prop), 0, prop)) %>%
    mutate(FOFM_catch_foodsystem = prop*FOFM_catch) %>%
    group_by(Cell) %>%
    summarise(tonnes = sum(FOFM_catch_foodsystem, na.rm = TRUE)) %>%
    ungroup()
    
  forage_fish_system <- raster::subs(watson_raster_template, foragefish_system, by = "Cell", which = "tonnes", subsWithNA=TRUE)

# plot(log(forage_fish_system + 1))

# the following should be about equal
print(sprintf("the following should be about equal"))
print(sprintf("raster calc: %s", cellStats(forage_fish_system, "sum", na.rm=TRUE))) 
print(sprintf("observed: %s", forage_fofm_allocation_totals %>% filter(diet == diet_type, allocation_type == allocation, ingredient == ingredient_type) %>% group_by(ingredient) %>% summarise(total = sum(total_tonnes_fofm_lw, na.rm = TRUE)) %>% ungroup() %>% pull(total)))


    writeRaster(forage_fish_system, sprintf(here("prep/02_feed/output/%s/forage fish_%s_%s.tif"), diet_type, ingredient_type, allocation), overwrite = TRUE)
  
   }
  }
}


test <- rast(list.files(here("prep/02_feed/output/fish-dominant/"), full.names = TRUE, pattern = "fish oil|fish meal"))
test_names <- list.files(here("prep/02_feed/output/fish-dominant/"), pattern = "fish oil|fish meal")

names(test) <- test_names


plot(log(test+1))

plot(test)
```
 
