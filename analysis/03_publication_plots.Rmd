---
title: "Publication plots: non maps"
output: html_document
editor_options: 
  chunk_output_type: console
---

## Summary

This code produces figures 2 and 3, as well as some supplementary plots:

Figure 2: 
> Figure 2. Distribution of proportion of global habitat area impacted for species. Each point represents an individual species. Only impacted species are shown in the plot (i.e., species are exposed to and vulnerable to harvest pressure). To see distributions including species with zero impact, refer to Supplementary Fig. 3. Light blue points indicate mean across all species in marine taxon and dark green points indicate mean across species in terrestrial taxon. Orange points indicate mean across all species within the taxon and scenario and orange lines indicate the median. Boxes represent the interquartile range (IQR, quartile Q1 to Q3); whiskers indicate observations 1.5x IQR below (above) Q1 (Q3) the box. The panel on the right shows points >95th percentile, and total number of assessed species per taxon. 

SI Figure 3:
> Supplementary Figure 3. Distribution of the proportion of global habitat area impacted for each assessed species. Each point represents an individual species within the taxon. Orange points indicate mean across all species in taxon and orange lines indicate median. Boxes represent the interquartile range (IQR, quartile Q1 to Q3); whiskers indicate observations 1.5x IQR below (above) Q1 (Q3) the box. Panel on the right shows points >95th quantile, and total number of observations per taxon. 

Figure 3: 
> Proportion of each taxon’s global habitat area which is impacted by raw material for each aquafeed scenario. To see proportions including species with zero impact, refer to Supplementary Fig. 4. 

SI Figure 4:
> Supplementary Fig 4. Proportion of each taxon’s global habitat area impacted of all assessed species by raw material for each aquafeed scenario. 


SI Figure 2: 
> Supplementary Figure 2. Top 25 average proportion of habitat area impacted in cells within country and EEZ boundaries, by raw materials, ranked by country (iso3c code). 


## Setup

Load libraries

```{r setup, include=FALSE}

library(tidyverse)
library(here)
library(data.table)
library(terra)
library(strex)
library(patchwork)
library(cowplot)
library(glue)
library(RColorBrewer)
library(ggpubr)
library(qs)
library(parallel)
library(doParallel)

source(here("src/directories.R"))

source(here("src/spatial.R"))

biodiv_dir <- file.path(rdsi_dir, "biodiversity_impacts")

impact_maps_dir <- file.path(biodiv_dir, "output")

this_dir <- here("analysis/")

```

```{r}
# Create a named vector with colors for each spp_type
color_scale <- readRDS(here("prep/03_prep_spp_habitats/int/color_scale.RDS"))

pal_mats <- c("Soybean" = "#328C41",
              "Trimmings fish" = "#8FBAED",
              "Sunflower" = "#4277A9",
              "Wheat" = "#FFE96D",
              "Rapeseed" = "#AC9900",
              "Pulses" = "#79E0DA",
              "Forage fish" = "#3DB1AB",
              "Maize" = "#0A6B66",
              "Other crops" = "#BC94C6")

theme_ohara <- function(base_size = 9) {
  theme(axis.ticks = element_blank(),
        text             = element_text(family = 'Helvetica',
                                        color = 'gray30', size = base_size),
        plot.title       = element_text(size = rel(1.25), hjust = 0, face = 'bold'),
        panel.background = element_blank(),
        legend.position  = 'right',
        panel.border     = element_blank(),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_line(colour = 'grey90', size = .25),
        legend.key       = element_rect(colour = NA, fill = NA),
        axis.line        = element_blank())
}

```

Read in marine and terrestrial dfs and combine

```{r}
marine_overlap <- readRDS(here("prep/03_prep_spp_habitats/output/aoh_marine_impact.rds")) %>%
    dplyr::select(sciname, spp_type, diet, fcr_type, allocation, ingredient, vulnerability, impact_total, total_hab_area)

length(unique(marine_overlap$sciname)) # 23029

terrestrial_overlap <- readRDS(here("prep/03_prep_spp_habitats/output/aoh_terrestrial_impact.rds")) %>% 
  dplyr::select(-suitability) %>%
      dplyr::select(sciname, spp_type, diet, fcr_type, allocation, ingredient, vulnerability, impact_total, total_hab_area)

length(unique(terrestrial_overlap$sciname)) # 31596

23029 + 31596 # 54625 - perfect


all_overlap <- rbind(marine_overlap, terrestrial_overlap) %>%
    mutate(taxon = str_to_sentence(spp_type)) %>%
  mutate(taxon = case_when(
    taxon == "Terrestrial mammal" ~ "Terrestrial mammals",
    taxon == "Bird" ~ "Birds",
    taxon == "Fish" ~ "Finfish", 
    taxon == "Marine mammal" ~ "Marine mammals",
    taxon == "Marine plant" ~ "Marine plants",
    TRUE ~ taxon)) %>%
  mutate(ingredient = str_replace(ingredient, "CropsNES", "Other crops"))

length(unique(all_overlap$sciname)) # 54625
unique(all_overlap$ingredient)

```

Some stats for paper:

 - 54628 species assessed
 - 466 more spp impacted under plant-dominant
 - ~78% spp that are assessed are impacted
 - ~85% are vulnerable

```{r}
taxon_names <- all_overlap %>%
  distinct(spp_type, taxon)

spp_impacted <- all_overlap %>%
  filter(impact_total > 0) %>%
  group_by(taxon, diet, allocation, fcr_type) %>%
  summarise(spp_count_impacted = n_distinct(sciname)) %>%
  ungroup()

aquamaps_spp <- readRDS(file.path(rdsi_dir, "biodiversity_impacts/int/spp_vuln_depth_info.rds")) %>%
  distinct(spp_type = taxon, sciname = species)
  
eyres_spp <- readRDS(here("prep/03_prep_spp_habitats/data/iucn/eyres_iucn_spp.rds")) %>%
  dplyr::select(spp_type, sciname = scientific_name) %>%
  mutate(sciname = tolower(sciname)) %>%
  mutate(spp_type = case_when(
    spp_type == "mammals" ~ "Terrestrial mammal",
    spp_type == "amphibians" ~ "Amphibians", 
    spp_type == "reptiles" ~ "Reptiles", 
    spp_type == "birds" ~ "Bird"
  ))

spp_assessed <- rbind(aquamaps_spp, eyres_spp) %>%
  left_join(taxon_names) %>%
  group_by(taxon) %>%
  summarise(spp_count_assessed = n_distinct(sciname)) %>%
  ungroup() %>%
  filter(!is.na(taxon))

sum(spp_assessed$spp_count_assessed) # 54628

spp_assessed_impacted <- spp_impacted %>%
  left_join(spp_assessed) 

spp_impact_test <- spp_assessed_impacted %>%
  group_by(diet, allocation, fcr_type) %>%
  summarise(total_impact = sum(spp_count_impacted, na.rm = TRUE),
            total_assessed = sum(spp_count_assessed, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(prop = total_impact/total_assessed)

spp_total_hab <- all_overlap %>%
  distinct(sciname, spp_type, total_hab_area) %>%
  mutate(id = row_number())

test <- data.frame(dups = duplicated(spp_total_hab$sciname)) %>%
  mutate(id = row_number()) %>%
  filter(dups == TRUE)
  
test2 <- spp_total_hab %>%
  filter(id %in% c(test$id)) ## good no dupes

```

**Figure 2: Mean proportion impacted**

 > Figure 2. Distribution of proportion of global habitat area impacted for species. Each point represents an individual species. Only impacted species are shown in the plot (i.e., species are exposed to and vulnerable to harvest pressure). To see distributions including species with zero impact, refer to Supplementary Fig. 3. Light blue points indicate mean across all species in marine taxon and dark green points indicate mean across species in terrestrial taxon. Orange points indicate mean across all species within the taxon and scenario and orange lines indicate the median. Boxes represent the interquartile range (IQR, quartile Q1 to Q3); whiskers indicate observations 1.5x IQR below (above) Q1 (Q3) the box. The panel on the right shows points >95th percentile, and total number of assessed species per taxon. 

 - Look at ranges of values
 - Split into two plots, like in global food paper; 1 is <95th quantile, 1 is >95th quantile 
 - One point for each species with box and whisker chart overlaid
 - Add colored (orange) points for average within taxa
 
```{r}
spp_assessed_plot_df <- spp_assessed %>%
  mutate(spp_count_str = glue("n = {spp_count_assessed}"))

all_overlap_df <- all_overlap %>%
  rename(fcr = fcr_type) %>%
        separate_wider_delim(ingredient, delim = "_", names = c("raw_material", "ingredient")) %>% 
  mutate(raw_material = str_to_sentence(raw_material), 
         ingredient = str_to_sentence(ingredient),
         allocation = str_to_sentence(allocation),
         diet = str_to_sentence(diet),
         fcr = str_to_sentence(fcr)) %>%
    filter(allocation == "Economic",
           fcr == "Regular")

length(unique(all_overlap_df$sciname)) # 54625

summary_df_spp <- all_overlap_df %>%
  group_by(sciname, diet, fcr, allocation, taxon) %>%
  summarise(impact_total = sum(impact_total, na.rm = TRUE)) %>%
  ungroup() %>%
  filter(impact_total > 0) %>%
  left_join(spp_assessed_plot_df) %>%
  left_join(spp_total_hab %>% dplyr::select(-spp_type, -id)) %>%
  mutate(prop_impact = impact_total/total_hab_area)  %>%
  group_by(taxon, diet, fcr) %>%
  mutate(mean_prop = mean(prop_impact,na.rm=TRUE),
         median_prop = median(prop_impact,na.rm=TRUE)) %>%
  ungroup() %>%
  mutate(terr_marine = ifelse(taxon %in% c("Terrestrial mammals", "Birds", "Reptiles", "Amphibians"), "Terrestrial", "Marine"))


taxon_hab_area <- spp_total_hab %>%
  dplyr::select(-sciname, -id) %>%
  group_by(spp_type) %>%
  summarise(total_hab_area = sum(total_hab_area, na.rm = TRUE)) %>%
  ungroup() %>%
  left_join(taxon_names) %>%
  dplyr::select(-spp_type)
  

summary_df_all <- all_overlap_df %>%
  group_by(diet, fcr, allocation, taxon) %>%
  summarise(impact_total = sum(impact_total, na.rm = TRUE)) %>%
  ungroup() %>%
  left_join(taxon_hab_area) %>%
  mutate(prop_impact = impact_total/total_hab_area)

quant_95 <- quantile(summary_df_spp$prop_impact, 0.95)


summary_df_spp_out <- summary_df_spp %>%
  filter(prop_impact >= quant_95) %>%
  group_by(diet, fcr, allocation, taxon) %>%
  mutate(spp_outliers = n_distinct(sciname)) %>%
  ungroup() 

join_df <- summary_df_spp_out %>%
  distinct(taxon, diet, fcr, allocation, spp_outliers)

summary_df_spp_reg <- summary_df_spp %>%
  filter(prop_impact > quant_95) %>%
  left_join(join_df) %>%
  mutate(spp_impacted = spp_count_assessed - spp_outliers) %>%
  mutate(prop_outlier = spp_outliers/spp_count_assessed)

spp_assessed_reg_outlier <- distinct(summary_df_spp_reg, taxon, diet, spp_impacted, spp_outliers, prop_outlier) %>%
    add_row(taxon = "Corals", diet = "Plant-dominant", spp_impacted = 249, spp_outliers = 0, prop_outlier = 0) %>%
      add_row(taxon = "Marine plants", diet = "Plant-dominant", spp_impacted = 280, spp_outliers = 0, prop_outlier = 0) %>%
  arrange(taxon, diet) %>% 
  mutate(perc_outlier = round(prop_outlier, 3)*100) %>% 
  distinct(taxon, perc_outlier) %>%
group_by(taxon) %>%
  summarize(perc_outlier = paste0("(", paste(perc_outlier, collapse = "%, "), "%)"))


spp_assessed_reg <- distinct(summary_df_spp_reg, taxon, spp_impacted, spp_outliers) %>%
  group_by(taxon) %>%
  slice(1) %>%
  mutate(total_spp = spp_outliers + spp_impacted) %>%
  mutate(total_spp = format(total_spp, big.mark = ",")) %>%
  left_join(spp_assessed_reg_outlier) %>%
    mutate(spp_impacted_str = glue("n = {spp_impacted}"),
           spp_outliers_str = glue("n = {spp_outliers}"),
           spp_count_assessed = glue("n = {total_spp}")) %>%
      mutate(spp_count_assessed_perc = paste0(spp_count_assessed, ", ", perc_outlier))

# Set the levels of the taxon variable in summary_df_test
summary_df_spp$taxon <- with(summary_df_spp, reorder(taxon, prop_impact, FUN = function(x) mean(x)))

diet_cols = c("Fish-dominant" = "#0D6EB5", "Plant-dominant" = "#7BD67F")

## make boxplot of prop impacted

plot1 <- ggplot(summary_df_spp %>% filter(prop_impact > 0), aes(x = prop_impact)) +
  geom_point(aes(y = taxon, color = diet), alpha = 0.2, position = position_jitterdodge(dodge.width = -0.9)) + 
  geom_vline(xintercept = 0, color = "black") +
  geom_point(data = summary_df_spp, aes(x = mean_prop, y = taxon, group = diet),
             position = position_dodge(width = -0.9),
             shape = 21, color = "black", fill = "orange", size = 4) +
     geom_boxplot(aes(y = taxon, fill = diet), outlier.fill = NA, outlier.color = NA, position = position_dodge(width = -0.9), alpha = 0, colour = "orange") +
   geom_boxplot(aes(y = taxon, fill = diet), outlier.fill = NA, outlier.color = NA, position = position_dodge(width = -0.9), alpha = 0, fatten = NULL) +
  theme_ohara() +
      labs(x = "Proportion of global habitat area impacted", fill = 'Diet', color = 'Diet') +
  scale_x_continuous(expand = c(0,0), limits = c(0, quant_95)) +
  scale_color_manual(values = diet_cols, breaks = names(diet_cols), guide = guide_legend(reverse = FALSE)) +
  theme(panel.background = element_blank(),
            axis.title.y = element_blank(),
            axis.text.x = element_text(size = 16, angle = 45, hjust = 1),
         axis.text.y = element_text(size = 16),
        strip.text = element_text(size = 16),
        axis.title = element_text(size = 16),
        legend.position = "none", 
        text = element_text(family = "Arial"))

ggsave(plot = plot1, here(this_dir, "MS_plots/test.png"), width = 16, height = 9, units = "in", bg = "white")


# get legend

quant_95_round <- round(quant_95, 6)

plot2 <- ggplot(summary_df_spp %>% filter(prop_impact > quant_95), aes(x = prop_impact)) +
  geom_point(aes(y = taxon, color = diet), alpha = 0.4, position = position_jitterdodge(dodge.width = -0.9)) + 
  geom_vline(xintercept = quant_95, color = "black") +
  theme_ohara() +
      labs(x = "", y = "") +
  scale_x_continuous(expand = c(0,0), limits = c(quant_95, 0.018), breaks = c(quant_95, seq(0.003, 0.012, by = 0.003)), labels = c("0.000058", "0.003", "0.006", "0.009", "0.012")) +
  scale_color_manual(values = diet_cols, breaks = names(diet_cols), guide = guide_legend(reverse = FALSE)) +
  theme(panel.background = element_blank(),
            axis.title.y = element_blank(),
            axis.text.x = element_text(size = 16, angle = 45, hjust = 1),
         axis.text.y = element_blank(),
        strip.text = element_text(size = 16),
        axis.title = element_text(size = 16),
        legend.position = "none", 
        text = element_text(family = "arial")) +
      geom_text(data = spp_assessed_reg, aes(label = spp_count_assessed, y = taxon),
                x = 0.011, hjust = 0, color = 'black',
                family = 'arial',
                size = 6) 


plot1_legend <- get_legend(ggplot(summary_df_spp, aes(x = mean_prop)) +
  geom_boxplot(aes(y = taxon, fill = diet, color = diet), 
               width = 0.3, position = position_dodge(width = -0.7),
               size = 0.3, outlier.size = 0.3) + 
  theme_ohara() + 
    theme(panel.background = element_blank(),
            legend.text = element_text(size = 16),
            legend.title = element_text(size = 16),
            legend.key.size = unit(.20, 'cm'),
            legend.background = element_blank()) + 
    scale_fill_manual(values = diet_cols, breaks = names(diet_cols), guide = guide_legend(reverse = FALSE)) + 
  scale_color_manual(values = diet_cols, breaks = names(diet_cols), guide = guide_legend(reverse = FALSE)) + 
    labs(x = "Proportion of habitat area impacted", fill = 'Diet', color = 'Diet'))


# draw plots together 
p <- ggdraw() + draw_plot((plot1 + plot2 +  plot_layout(widths = c(3, 1)))) + draw_plot(plot1_legend,  x = .63, y = 0.15, height = .10, width = .15) 

ggsave(plot = p, here(this_dir, "MS_plots/fig2_economic_boxplot_prop_orange.png"), width = 16, height = 9, units = "in", bg = "white") # technically for nature food the max width is 180 mm, however, I'm saving like this and adjusting save in post production because doing it here messing things up...

```
 
Now make the same plot, but keep 0 impact species, for SI:

```{r}

summary_df_spp <- all_overlap_df %>%
  group_by(sciname, diet, fcr, allocation, taxon) %>%
  summarise(impact_total = sum(impact_total, na.rm = TRUE)) %>%
  ungroup() %>%
  left_join(spp_assessed_plot_df) %>%
  left_join(spp_total_hab %>% dplyr::select(-spp_type, -id)) %>%
  mutate(prop_impact = impact_total/total_hab_area)  %>%
  group_by(taxon, diet, fcr) %>%
  mutate(mean_prop = mean(prop_impact,na.rm=TRUE),
         median_prop = median(prop_impact,na.rm=TRUE)) %>%
  ungroup()

quant_95 <- quantile(summary_df_spp$prop_impact, 0.95)

summary_df_spp_out <- summary_df_spp %>%
  filter(prop_impact >= quant_95) %>%
  group_by(diet, fcr, allocation, taxon) %>%
  mutate(spp_outliers = n_distinct(sciname)) %>%
  ungroup() 

join_df <- summary_df_spp_out %>%
  distinct(taxon, diet, fcr, allocation, spp_outliers)

summary_df_spp_reg <- summary_df_spp %>%
  filter(prop_impact > quant_95) %>%
  left_join(join_df) %>%
  mutate(spp_impacted = spp_count_assessed - spp_outliers) 

spp_assessed_reg_outlier <- distinct(summary_df_spp_reg, taxon, spp_outliers, spp_impacted) %>%
  group_by(taxon) %>%
  slice(1) %>%
  mutate(total_spp = format(spp_outliers + spp_impacted, big.mark = ",")) %>%
    mutate(spp_impacted_str = glue("n = {spp_impacted}"),
           spp_outliers_str = glue("n = {spp_outliers}"),
           spp_count_assessed = glue("n = {total_spp}"))

# Set the levels of the taxon variable in summary_df_test
summary_df_spp$taxon <- with(summary_df_spp, reorder(taxon, prop_impact, FUN = function(x) mean(x)))

diet_cols = c("Fish-dominant" = "#0D6EB5", "Plant-dominant" = "#7BD67F")

## make boxplot of prop impacted

plot1 <- ggplot(summary_df_spp, aes(x = prop_impact)) +
  geom_point(aes(y = taxon, color = diet), alpha = 0.2, position = position_jitterdodge(dodge.width = -0.9)) + 
  geom_vline(xintercept = 0, color = "black") +
  geom_point(data = summary_df_spp, aes(x = mean_prop, y = taxon, group = diet),
             position = position_dodge(width = -0.9),
             shape = 21, color = "black", fill = "orange", size = 4) +
     geom_boxplot(aes(y = taxon, fill = diet), outlier.fill = NA, outlier.color = NA, position = position_dodge(width = -0.9), alpha = 0, colour = "orange") +
   geom_boxplot(aes(y = taxon, fill = diet), outlier.fill = NA, outlier.color = NA, position = position_dodge(width = -0.9), alpha = 0, fatten = NULL) +
  theme_ohara() +
      labs(x = "Proportion of global habitat area impacted", fill = 'Diet', color = 'Diet') +
  scale_x_continuous(expand = c(0,0), limits = c(0, quant_95)) +
  scale_color_manual(values = diet_cols, breaks = names(diet_cols), guide = guide_legend(reverse = FALSE)) +
  theme(panel.background = element_blank(),
            axis.title.y = element_blank(),
            axis.text.x = element_text(size = 16, angle = 45, hjust = 1),
         axis.text.y = element_text(size = 16),
        strip.text = element_text(size = 16),
        axis.title = element_text(size = 16),
        legend.position = "none", 
        text = element_text(family = "Arial"))

# get legend

plot2 <- ggplot(summary_df_spp %>% filter(prop_impact > quant_95), aes(x = prop_impact)) +
  geom_point(aes(y = taxon, color = diet), alpha = 0.4, position = position_jitterdodge(dodge.width = -0.9)) + 
  geom_vline(xintercept = quant_95, color = "black") +
  theme_ohara() +
      labs(x = "", y = "") +
  scale_x_continuous(expand = c(0,0), limits = c(quant_95, 0.018), breaks = c(quant_95, seq(0.003, 0.012, by = 0.003)), labels = c("0.000041", "0.003", "0.006", "0.009", "0.012")) +
  scale_color_manual(values = diet_cols, breaks = names(diet_cols), guide = guide_legend(reverse = FALSE)) +
  theme(panel.background = element_blank(),
            axis.title.y = element_blank(),
            axis.text.x = element_text(size = 16, angle = 45, hjust = 1),
         axis.text.y = element_blank(),
        strip.text = element_text(size = 16),
        axis.title = element_text(size = 16),
        legend.position = "none", 
        text = element_text(family = "arial")) +
      geom_text(data = spp_assessed_reg_outlier, aes(label = spp_count_assessed, y = taxon),
                x = 0.008, hjust = 0, color = 'black',
                family = 'arial',
                size = 6)

plot1_legend <- get_legend(ggplot(summary_df_spp, aes(x = mean_prop)) +
  geom_boxplot(aes(y = taxon, fill = diet, color = diet), 
               width = 0.3, position = position_dodge(width = -0.7),
               size = 0.3, outlier.size = 0.3) + 
  theme_ohara() + 
    theme(panel.background = element_blank(),
            legend.text = element_text(size = 16),
            legend.title = element_text(size = 16),
            legend.key.size = unit(.20, 'cm'),
            legend.background = element_blank()) + 
    scale_fill_manual(values = diet_cols, breaks = names(diet_cols), guide = guide_legend(reverse = FALSE)) + 
  scale_color_manual(values = diet_cols, breaks = names(diet_cols), guide = guide_legend(reverse = FALSE)) + 
    labs(x = "Proportion of habitat area impacted", fill = 'Diet', color = 'Diet'))


# draw plots together 
p <- ggdraw() + draw_plot((plot1 + plot2 +  plot_layout(widths = c(3, 1)))) + draw_plot(plot1_legend,  x = .63, y = 0.15, height = .10, width = .15) 

ggsave(here(this_dir, "SI_plots/SIfig_economic_boxplot_prop.png"), width = 16, height = 9, units = "in", bg = "white", plot = p, dpi = 300) # technically for nature food the max width is 180 mm, however, I'm saving like this and adjusting save in post production because doing it here messing things up...
```

**Figure 3: Proportion of taxa global habitat area impacted**
> Figure 3. Proportion of each taxon’s global habitat area which is impacted by raw material for each aquafeed scenario. To see proportions including species with zero impact, refer to Supplementary Fig. 4. 

SI Figure 4:
> Supplementary Fig 4. Proportion of each taxon’s global habitat area impacted of all assessed species by raw material for each aquafeed scenario. 

```{r}

impacted_spp <- all_overlap_df %>%
  filter(impact_total > 0) %>%
  pull(sciname) %>%
  unique()

taxon_hab_area <- spp_total_hab %>%
  filter(sciname %in% impacted_spp) %>%
  dplyr::select(-sciname, -id) %>%
  group_by(spp_type) %>%
  summarise(total_hab_area = sum(total_hab_area, na.rm = TRUE)) %>%
  ungroup() %>%
  left_join(taxon_names) %>%
  dplyr::select(-spp_type)

summary_df_barcharts <- all_overlap_df %>%
  group_by(diet, fcr, raw_material, allocation, taxon) %>%
  summarise(impact_total = sum(impact_total, na.rm = TRUE)) %>%
  ungroup() %>%
  filter(impact_total > 0) %>%
  left_join(taxon_hab_area) %>%
  mutate(prop_impact = impact_total/total_hab_area)

test <- summary_df_barcharts %>%
  group_by(diet, fcr, raw_material, allocation) %>%
  summarise(impact_total = sum(impact_total, na.rm = TRUE),
            total_hab_area = sum(total_hab_area, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(prop_impact = impact_total/total_hab_area)


## switch the raw materials and species in that plot

summary_df_barcharts$taxon <- with(summary_df_barcharts, reorder(taxon, prop_impact, FUN = function(x) sum(x)))

ggplot(summary_df_barcharts, aes(x = taxon, y = prop_impact, fill = raw_material)) +
    geom_bar(stat = "identity") +
  facet_wrap(~diet) +
  labs(x = "Taxon", y = "Proportion of global habitat area impacted", fill = NULL) +
  theme_minimal() + 
  scale_fill_manual(values = pal_mats) + 
  coord_flip()  + 
  theme(panel.background = element_blank(),
            axis.title.y = element_blank(),
            axis.text.x = element_text(size = 7, angle = 45, hjust = 1),
         axis.text.y = element_text(size = 7),
        strip.text = element_text(size = 7),
        axis.title = element_text(size = 7),
        legend.text = element_text(size = 7),
        text = element_text(family = "arial")) + 
    scale_y_continuous(expand = c(0,0))


ggsave(here(this_dir, "/MS_plots/fig3_economic_barchart.png"), width = 178.9, height =100.92 , units = "mm", bg = "white")

## now save same but with 0 impact species

taxon_hab_area <- spp_total_hab %>%
#  filter(sciname %in% impacted_spp) %>%
  dplyr::select(-sciname, -id) %>%
  group_by(spp_type) %>%
  summarise(total_hab_area = sum(total_hab_area, na.rm = TRUE)) %>%
  ungroup() %>%
  left_join(taxon_names) %>%
  dplyr::select(-spp_type)

summary_df_barcharts <- all_overlap_df %>%
  group_by(diet, fcr, raw_material, allocation, taxon) %>%
  summarise(impact_total = sum(impact_total, na.rm = TRUE)) %>%
  ungroup() %>%
 # filter(impact_total > 0) %>%
  left_join(taxon_hab_area) %>%
  mutate(prop_impact = impact_total/total_hab_area)

## switch the raw materials and species in that plot

summary_df_barcharts$taxon <- with(summary_df_barcharts, reorder(taxon, prop_impact, FUN = function(x) sum(x)))

ggplot(summary_df_barcharts, aes(x = taxon, y = prop_impact, fill = raw_material)) +
    geom_bar(stat = "identity") +
  facet_wrap(~diet) +
  labs(x = "Taxon", y = "Proportion of global habitat area impacted", fill = NULL) +
  theme_minimal() + 
  scale_fill_manual(values = pal_mats) + 
  coord_flip()  + 
  theme(panel.background = element_blank(),
            axis.title.y = element_blank(),
            axis.text.x = element_text(size = 7, angle = 45, hjust = 1),
         axis.text.y = element_text(size = 7),
        strip.text = element_text(size = 7),
        axis.title = element_text(size = 7),
        legend.text = element_text(size = 7),
        text = element_text(family = "arial")) + 
    scale_y_continuous(expand = c(0,0))


ggsave(here(this_dir, "/SI_plots/SI_fig3_economic_barchart.png"), width = 178.9, height =100.92 , units = "mm", bg = "white")

summary_df_barcharts$raw_material <- with(summary_df_barcharts, reorder(raw_material, prop_impact, FUN = function(x) mean(x)))


ggplot(summary_df_barcharts, aes(x = raw_material, y = prop_impact, fill = taxon)) +
    geom_bar(stat = "identity") +
  facet_grid(fcr ~ diet, scales = "free_y") +
  labs(x = "Raw material", y = "Proportion of habitat impacted", fill = NULL) +
  scale_fill_manual(values = color_scale) + 
  theme_minimal() + 
  coord_flip()  + 
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) # Adjust the 'angle' value as needed

ggsave(here(this_dir, "SI_plots/SI_fig_barchart_by_raw_mat.png"), width = 178.9, height =100.92 , units = "mm", bg = "white")

```


**Look at per country land/eez impacts**
 - grab by raw material rasters 
 - currently we are taking the average of an average... is there a way to fix this without great computational cost? I think taking a weighted average by number of impacted species is ok, thanks ChatGPT: 
 'Weighting by the number of species impacted helps mitigate any distortion from taking an average of an average. It ensures that cells with more species (and thus potentially higher impact) contribute more to the overall country-level impact.
If the weights are used appropriately in the second step, this avoids the common issue of diluting the information when averaging an average. The weighted average ensures that the relative importance of each cell is preserved in the final country-level estimate."
 
SI Figure 2: 
> Supplementary Figure 2. Top 25 average proportion of habitat area impacted in cells within country and EEZ boundaries, by raw materials, ranked by country (iso3c code). 

```{r}
allocations <- c("economic")
fcr_types <- c("regular")
diet_types <- c("plant-dominant", "fish-dominant")
spp_types <- all_overlap %>% 
  filter(spp_type != "polychaetes") %>% 
  pull(spp_type) %>% unique()

ingredient_types <- all_overlap %>% 
  pull(ingredient) %>% unique()

raw_materials <- c("Soybean", "Wheat", "Sunflower", "CropsNES", "Rapeseed", "Maize", "forage fish", "trimmings fish", "Pulses")

land_eez_rgns <- read.csv(file.path(biodiv_dir, "spatial/rgns_xy_all.csv")) %>% 
  dplyr::select(x, y, rgn_id)

land_eez_rgns_ids <- read.csv(here("data/spatial/output/region_ids.csv"))
setdiff(land_eez_rgns_ids$rgn_id, land_eez_rgns$rgn_id) # 0 good

num_cores <- 9
cl <- makeCluster(num_cores)
registerDoParallel(cl)


foreach(raw_mat = raw_materials,
        .packages = c("qs", "terra", "tidyverse", "dplyr", "glue")) %dopar% {
for(allocation_type in c("economic", "mass", "ge")){
  for(fcr_type in fcr_types){
    for(diet_type in diet_types){
          
# diet_type = "plant-dominant"
# fcr_type = "regular"
# allocation_type = "economic"
# raw_mat = "Rapeseed"

          if(length(list.files(file.path(glue(impact_maps_dir, "/impact_maps_across_taxon_by_material/{diet_type}/{fcr_type}")), pattern = glue("{allocation_type}_{raw_mat}_mean_prop.tif"), full.names = TRUE)) > 0 ){
        
            files <- c(list.files(file.path(glue(impact_maps_dir, "/impact_maps_across_taxon_by_material/{diet_type}/{fcr_type}")), pattern = glue("{allocation_type}_{raw_mat}_mean_prop.tif"), full.names = TRUE), list.files(file.path(glue(impact_maps_dir, "/impact_maps_across_taxon_by_material/{diet_type}/{fcr_type}")), pattern = glue("{allocation_type}_{raw_mat}_nspp.tif"), full.names = TRUE))
            
        
        map_df <- rast(files) %>%
          as.data.frame(., xy = TRUE) %>%
          left_join(land_eez_rgns) %>%
          group_by(rgn_id) %>%
          summarise(mean_prop_weighted = weighted.mean(mean_prop, nspp, na.rm = TRUE),
                    mean_prop = mean(mean_prop, na.rm = TRUE),
                    sum_prop = sum(mean_prop, na.rm = TRUE)) %>%
          mutate(allocation = allocation_type, 
                 diet = diet_type, 
                 fcr = fcr_type, 
                 raw_material = raw_mat) %>%
          ungroup()
        
        
        qsave(map_df, file.path(glue(impact_maps_dir, "/csvs/by_material_country_summary/mean_impacts_{allocation_type}_{diet_type}_{fcr_type}_{raw_mat}.qs")))
        
          }else{
            next()
          }
        
        }
      }
    }
  }

stopCluster(cl)


rgn_ids <- read.csv(here("data/spatial/output/region_ids.csv"))

# now lets join all of those together into one dataframe and save 

csv_files <- list.files(file.path(impact_maps_dir, "csvs/by_material_country_summary"), pattern = ".qs", full.names = TRUE)

list_of_dfs <- lapply(csv_files, qread) 

combined_impact_df <- do.call(rbind, list_of_dfs) %>%
  left_join(rgn_ids) %>%
  mutate(raw_material = str_to_sentence(raw_material), 
         allocation = str_to_sentence(allocation),
         diet = str_to_sentence(diet),
         fcr = str_to_sentence(fcr))  %>%
 mutate(raw_material = ifelse(raw_material == "Cropsnes", "Other crops", raw_material))

## do the same thing but make a plot with raw material as the fill value

summary_df <- combined_impact_df %>%
  dplyr::select(diet, iso3c, rgn_id, fcr, allocation, raw_material, mean_prop, mean_prop_weighted) %>%
  filter(allocation == "Economic", fcr == "Regular") 
  
  top_25_impacts <- summary_df %>% 
   group_by(iso3c, diet, fcr) %>%
  summarise(total_impact = sum(mean_prop_weighted, na.rm = TRUE)) %>%
    ungroup() %>%
    group_by(diet, fcr) %>% 
    arrange(-total_impact) %>%
    mutate(rank = row_number()) %>%
    filter(rank <= 25) %>%
    ungroup() %>%
    dplyr::select(-total_impact) 
  
  plot_df <- summary_df %>%
    group_by(iso3c, diet, fcr) %>%
    filter(iso3c %in% c(top_25_impacts$iso3c)) %>%
  group_by(iso3c, diet, fcr) %>%
  mutate(total_impact = sum(mean_prop_weighted, na.rm = TRUE)) %>%
    left_join(top_25_impacts) %>%
    filter(!is.na(rank))
  
legend_plot <-  get_legend(ggplot(summary_df, aes(x = iso3c, y = mean_prop_weighted, fill = raw_material)) +
    geom_bar(stat = "identity") +
  facet_wrap(~diet,  as.table = TRUE, drop = TRUE, shrink = TRUE) +
 scale_fill_manual(values = pal_mats) + 
  theme_minimal() + 
  coord_flip()  + 
facet_grid(fcr~diet, scales = "free") +
    theme(axis.text.x = element_text(angle = -90, hjust = 1),
          axis.text.y = element_text( size = 5), 
          legend.title = element_blank()))

  

panel_1_df <- plot_df %>% 
  filter(diet == "Fish-dominant")

panel_1_df$iso3c <- with(panel_1_df, reorder(iso3c, total_impact, FUN = function(x) mean(x)))


panel_1 <- ggplot(panel_1_df, aes(x = iso3c, y = mean_prop_weighted, fill = raw_material)) +
    geom_bar(stat = "identity") +
 scale_fill_manual(values = pal_mats) + 
  theme_minimal() + 
  coord_flip()  + 
facet_grid(fcr~diet, scales = "free") +
    theme(axis.text.x = element_text(angle = -90, hjust = 1, size = 8),
          axis.text.y = element_text( size = 8), 
          legend.position = "none", 
          axis.title.x = element_blank(), 
          strip.text.y = element_blank()) + # Adjust the 'angle' value as needed
  labs(x = "")

panel_2_df <- plot_df %>% 
  filter(diet == "Plant-dominant")

panel_2_df$iso3c <- with(panel_2_df, reorder(iso3c, total_impact, FUN = function(x) mean(x)))


panel_2 <- ggplot(panel_2_df, aes(x = iso3c, y = mean_prop_weighted, fill = raw_material)) +
    geom_bar(stat = "identity") +
 scale_fill_manual(values = pal_mats) + 
  theme_minimal() + 
  coord_flip()  + 
facet_wrap(~diet) +
    theme(axis.text.x = element_text(angle = -90, hjust = 1),
          axis.text.y = element_text( size = 8), 
          legend.position = "none", 
          axis.title.x = element_blank(), 
          axis.title.y = element_blank()) 


total_panel <- panel_1 + panel_2

ggdraw() + 
  draw_plot(total_panel) +
  draw_label('Average proportion of habitat area impacted', x = 0.35, y = .034, hjust = 0, vjust = 1, 
             size = 11, fontfamily = 'Helvetica') +
    theme(plot.margin = margin(0, 3, 0, 0, "cm")) + # Adjust the right margin as needed
    draw_plot(legend_plot,  x = 1.02, y = 0.5, height = .10, width = .15)

ggsave(here(this_dir, "SI_plots/economic_country_props.png"), bg = "white", width = 178.9, height =100.92 , units = "mm")

country_stats_1 <- combined_impact_df %>%
  filter(allocation == "Economic") %>%
  group_by(diet, fcr, iso3c) %>%
  summarise(sum_prop_mean = sum(mean_prop_weighted, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(diet, fcr) %>%
  mutate(total_prop_mean = sum(sum_prop_mean, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(prop_impacts = sum_prop_mean/total_prop_mean)
```


Let's look at average cell impacts across materials, globally

```{r}

num_cores <- 9
cl <- makeCluster(num_cores)
registerDoParallel(cl)


foreach(raw_mat = raw_materials,
        .packages = c("qs", "terra", "tidyverse", "dplyr", "glue")) %dopar% {
for(allocation_type in c("economic", "mass", "ge")){
  for(fcr_type in fcr_types){
    for(diet_type in diet_types){
          
# diet_type = "plant-dominant"
# fcr_type = "regular"
# allocation_type = "economic"
# raw_mat = "Rapeseed"

          if(length(list.files(file.path(glue(impact_maps_dir, "/impact_maps_across_taxon_by_material/{diet_type}/{fcr_type}")), pattern = glue("{allocation_type}_{raw_mat}_mean_prop.tif"), full.names = TRUE)) > 0 ){
        
            files <- c(list.files(file.path(glue(impact_maps_dir, "/impact_maps_across_taxon_by_material/{diet_type}/{fcr_type}")), pattern = glue("{allocation_type}_{raw_mat}_mean_prop.tif"), full.names = TRUE), list.files(file.path(glue(impact_maps_dir, "/impact_maps_across_taxon_by_material/{diet_type}/{fcr_type}")), pattern = glue("{allocation_type}_{raw_mat}_nspp.tif"), full.names = TRUE))
            
        
        map_df <- rast(files) %>%
          as.data.frame(., xy = TRUE) %>%
          mutate(raw_material = raw_mat) %>%
          group_by(raw_material) %>%
          summarise(mean_prop_weighted = weighted.mean(mean_prop, nspp, na.rm = TRUE),
                    mean_prop = mean(mean_prop, na.rm = TRUE),
                    sum_prop = sum(mean_prop, na.rm = TRUE)) %>%
          mutate(allocation = allocation_type, 
                 diet = diet_type, 
                 fcr = fcr_type, 
                 raw_material = raw_mat) %>%
          ungroup()
        
        
        qsave(map_df, file.path(glue(impact_maps_dir, "/csvs/by_material_global_summary/mean_impacts_{allocation_type}_{diet_type}_{fcr_type}_{raw_mat}.qs")))
        
          }else{
            next()
          }
        
        }
      }
    }
  }

stopCluster(cl)

# now lets join all of those together into one dataframe and save 

csv_files <- list.files(file.path(impact_maps_dir, "csvs/by_material_global_summary"), pattern = ".qs", full.names = TRUE)

list_of_dfs <- lapply(csv_files, qread) 

combined_impact_df <- do.call(rbind, list_of_dfs) %>%
  mutate(raw_material = str_to_sentence(raw_material), 
         allocation = str_to_sentence(allocation),
         diet = str_to_sentence(diet),
         fcr = str_to_sentence(fcr))  %>%
 mutate(raw_material = ifelse(raw_material == "Cropsnes", "Other crops", raw_material))

material_stats_1 <- combined_impact_df %>%
    filter(allocation == "Economic") %>%
  filter(fcr == "Regular")

material_stats_1$raw_material <- with(material_stats_1, reorder(raw_material, mean_prop_weighted, FUN = function(x) sum(x)))

ggplot(material_stats_1, aes(x = raw_material, y = mean_prop_weighted, fill = raw_material)) +
    geom_bar(stat = "identity") +
  facet_wrap(~diet) +
  theme_minimal() + 
  scale_fill_manual(values = pal_mats) + 
  coord_flip()  + 
  theme(panel.background = element_blank(),
            axis.title.y = element_blank(),
            axis.text.x = element_text(size = 7, angle = 45, hjust = 1),
         axis.text.y = element_text(size = 7),
        strip.text = element_text(size = 7),
        axis.title = element_text(size = 7),
        legend.text = element_text(size = 7),
        text = element_text(family = "arial"),
        legend.position = "none") + 
    scale_y_continuous(expand = c(0,0)) + 
    labs(x = "Raw material", y = "Average proportion of habitat area impacted", fill = NULL)


ggsave(here(this_dir, "SI_plots/average_raw_mat_impact.png"), bg = "white", width = 178.9, height = 100.92 , units = "mm")

```

**Plot showing diet percentages**
 - We didn't end up using this. 
 
```{r}
diet_comps <- read.csv(here("prep/02_feed/data/aquaculture_diet_composition.csv")) %>%
  distinct(raw_name, prop_diet, diet) %>%
  filter(prop_diet > 0)

# check sums 
diet_comps %>% filter(diet == "fish-dominant") %>% pull(prop_diet) %>% sum()
diet_comps %>% filter(diet == "plant-dominant") %>% pull(prop_diet) %>% sum()


ingredient_levels <- c( "Fish meal, forage fish",  "Fish oil, forage fish", "Fish meal, trimmings", "Fish oil, trimmings", "Soybean meal", "Corn gluten meal" , "Faba beans" , "Wheat gluten" ,"Wheat" , "Soy protein concentrate",  "Guar meal",  "Pea protein concentrate", "Sunflower meal", "Canola oil", "Linseed oil", "Soy oil", "Pea flour", "Coconut oil", "Micro ingredients")


both_diets <- diet_comps %>% 
  mutate(raw_name = str_replace_all(raw_name, "cut offs", "trimmings")) %>%
      mutate(hjust = if_else(condition = diet == "fish-dominant", true = 1, false = 0)) |> 
    mutate(label_x_pos = if_else(diet =="fish-dominant", true =0.5, false = 2.5)) |> 
  mutate(diet = if_else(condition = diet == "fish-dominant", true = "Fish-\ndominant", false = "Plant-\ndominant")) %>% 
   mutate(diet = factor(diet, levels = rev(c("Plant-\ndominant", "Fish-\ndominant")))) %>%
  filter(raw_name != "other") %>%
  mutate(ingredients = str_to_sentence(raw_name)) %>% 
  mutate(ingredients = factor(ingredients, levels = rev(ingredient_levels))) 


ggplot(data = both_diets,
       aes(x = diet , y = prop_diet, fill = ingredients))+
  geom_col()+
  scale_fill_manual(values =  c("darkgoldenrod4", rev(colorRampPalette(brewer.pal(n=9, name = "Greens"))(14)),  brewer.pal(n=5, name = "Blues")[c(2:5)]))+
  theme_pubr()+
  theme(legend.title = element_blank(),
        legend.text = element_text(size=7),
        text = element_text(size=8),
        legend.position = "right",
        #legend.box.spacing = unit(-0.1, "cm"),
        panel.grid = element_blank(),
        legend.key.size = unit(0.25, "cm")
        )+
  labs(x = "Feed scenario", y = "Proportion")+
  guides(fill = guide_legend(byrow=TRUE, reverse = FALSE, ncol = 1))

ggsave(filename = here(this_dir, "SI_plots/feed_composition.jpg"), dpi = 600, width = 10, height = 9, units = "cm")


```
