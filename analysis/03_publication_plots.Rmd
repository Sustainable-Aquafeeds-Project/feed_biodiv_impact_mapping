---
title: "Summary plots: non maps"
output: html_document
editor_options: 
  chunk_output_type: console
---

## Setup

Load libraries

```{r setup, include=FALSE}

library(tidyverse)
library(here)
library(data.table)
library(terra)
library(strex)
library(patchwork)
library(cowplot)
library(glue)
library(RColorBrewer)
library(ggpubr)
library(qs)

source(here("src/directories.R"))

source(here("src/spatial.R"))

biodiv_dir <- file.path(rdsi_dir, "biodiversity_impacts")

impact_maps_dir <- file.path(biodiv_dir, "output")

```

```{r}
# Create a named vector with colors for each spp_type
color_scale <- readRDS(here("prep/03_prep_spp_habitats/int/color_scale.RDS"))

pal_mats <- c("Soybean" = "#328C41",
              "Trimmings fish" = "#8FBAED",
              "Sunflower" = "#4277A9",
              "Wheat" = "#FFE96D",
              "Rapeseed" = "#AC9900",
              "Pulses" = "#79E0DA",
              "Forage fish" = "#3DB1AB",
              "Maize" = "#0A6B66",
              "Cropsnes" = "#BC94C6")

theme_ohara <- function(base_size = 9) {
  theme(axis.ticks = element_blank(),
        text             = element_text(family = 'Helvetica',
                                        color = 'gray30', size = base_size),
        plot.title       = element_text(size = rel(1.25), hjust = 0, face = 'bold'),
        panel.background = element_blank(),
        legend.position  = 'right',
        panel.border     = element_blank(),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_line(colour = 'grey90', size = .25),
        legend.key       = element_rect(colour = NA, fill = NA),
        axis.line        = element_blank())
}

```

Read in marine and terrestrial dfs and combine

```{r}
marine_overlap <- readRDS(here("prep/03_prep_spp_habitats/output/aoh_marine_impact.rds")) %>%
    dplyr::select(sciname, spp_type, diet, fcr_type, allocation, ingredient, vulnerability, impact_total, total_hab_area)

terrestrial_overlap <- readRDS(here("prep/03_prep_spp_habitats/output/aoh_terrestrial_impact.rds")) %>% 
  dplyr::select(-suitability) %>%
      dplyr::select(sciname, spp_type, diet, fcr_type, allocation, ingredient, vulnerability, impact_total, total_hab_area)

all_overlap <- rbind(marine_overlap, terrestrial_overlap) %>%
    mutate(taxon = str_to_sentence(spp_type)) %>%
  mutate(taxon = case_when(
    taxon == "Terrestrial mammal" ~ "Terrestrial mammals",
    taxon == "Bird" ~ "Birds",
    taxon == "Fish" ~ "Finfish", 
    taxon == "Marine mammal" ~ "Marine mammals",
    taxon == "Marine plant" ~ "Marine plants",
    TRUE ~ taxon))

```

Some stats for paper:

 - 54628 species assessed
 - 466 more spp impacted under plant-dominant
 - ~78% spp that are assessed are impacted

```{r}
taxon_names <- all_overlap %>%
  distinct(spp_type, taxon)

spp_impacted <- all_overlap %>%
  filter(impact_total > 0) %>%
  group_by(taxon, diet, allocation, fcr_type) %>%
  summarise(spp_count_impacted = n_distinct(sciname)) %>%
  ungroup()

aquamaps_spp <- readRDS(file.path(rdsi_dir, "biodiversity_impacts/int/spp_vuln_depth_info.rds")) %>%
  distinct(spp_type = taxon, sciname = species)
  
eyres_spp <- readRDS(here("prep/03_prep_spp_habitats/data/iucn/eyres_iucn_spp.rds")) %>%
  dplyr::select(spp_type, sciname = scientific_name) %>%
  mutate(sciname = tolower(sciname)) %>%
  mutate(spp_type = case_when(
    spp_type == "mammals" ~ "Terrestrial mammal",
    spp_type == "amphibians" ~ "Amphibians", 
    spp_type == "reptiles" ~ "Reptiles", 
    spp_type == "birds" ~ "Bird"
  ))

spp_assessed <- rbind(aquamaps_spp, eyres_spp) %>%
  left_join(taxon_names) %>%
  group_by(taxon) %>%
  summarise(spp_count_assessed = n_distinct(sciname)) %>%
  ungroup() %>%
  filter(!is.na(taxon))

sum(spp_assessed$spp_count_assessed) # 54628

spp_assessed_impacted <- spp_impacted %>%
  left_join(spp_assessed) 

spp_impact_test <- spp_assessed_impacted %>%
  group_by(diet, allocation, fcr_type) %>%
  summarise(total_impact = sum(spp_count_impacted, na.rm = TRUE),
            total_assessed = sum(spp_count_assessed, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(prop = total_impact/total_assessed)

spp_total_hab <- all_overlap %>%
  distinct(sciname, spp_type, total_hab_area) %>%
  mutate(id = row_number())

test <- data.frame(dups = duplicated(spp_total_hab$sciname)) %>%
  mutate(id = row_number()) %>%
  filter(dups == TRUE)
  
test2 <- spp_total_hab %>%
  filter(id %in% c(test$id)) ## good no dupes

```

**Mean proportion impacted**

 - Look at ranges of values
 - Split into two plots, like in global food paper; 1 is <95th quantile, 1 is >95th quantile 
 - One point for each species with box and whisker chart overlaid
 
```{r}
spp_assessed_plot_df <- spp_assessed %>%
  mutate(spp_count_str = glue("n = {spp_count_assessed}"))

all_overlap_df <- all_overlap %>%
  rename(fcr = fcr_type) %>%
        separate_wider_delim(ingredient, delim = "_", names = c("raw_material", "ingredient")) %>% 
  mutate(raw_material = str_to_sentence(raw_material), 
         ingredient = str_to_sentence(ingredient),
         allocation = str_to_sentence(allocation),
         diet = str_to_sentence(diet),
         fcr = str_to_sentence(fcr)) %>%
    filter(allocation == "Economic",
           fcr == "Regular")

summary_df_spp <- all_overlap_df %>%
  group_by(sciname, diet, fcr, allocation, taxon) %>%
  summarise(impact_total = sum(impact_total, na.rm = TRUE)) %>%
  ungroup() %>%
  left_join(spp_assessed_plot_df) %>%
  left_join(spp_total_hab %>% dplyr::select(-spp_type, -id)) %>%
  mutate(prop_impact = impact_total/total_hab_area)  %>%
  group_by(taxon, diet, fcr) %>%
  mutate(mean_prop = mean(prop_impact,na.rm=TRUE),
         median_prop = median(prop_impact,na.rm=TRUE)) %>%
  ungroup()

taxon_hab_area <- spp_total_hab %>%
  dplyr::select(-sciname, -id) %>%
  group_by(spp_type) %>%
  summarise(total_hab_area = sum(total_hab_area, na.rm = TRUE)) %>%
  ungroup() %>%
  left_join(taxon_names) %>%
  dplyr::select(-spp_type)
  

summary_df_all <- all_overlap_df %>%
  group_by(diet, fcr, allocation, taxon) %>%
  summarise(impact_total = sum(impact_total, na.rm = TRUE)) %>%
  ungroup() %>%
  left_join(taxon_hab_area) %>%
  mutate(prop_impact = impact_total/total_hab_area)

quant_95 <- quantile(summary_df_spp$prop_impact, 0.95)


summary_df_spp_out <- summary_df_spp %>%
  filter(prop_impact >= quant_95) %>%
  group_by(diet, fcr, allocation, taxon) %>%
  mutate(spp_outliers = n_distinct(sciname)) %>%
  ungroup() 

join_df <- summary_df_spp_out %>%
  distinct(taxon, diet, fcr, allocation, spp_outliers)

summary_df_spp_reg <- summary_df_spp %>%
  filter(prop_impact > quant_95) %>%
  left_join(join_df) %>%
  mutate(spp_impacted = spp_count_assessed - spp_outliers) 

spp_assesed_reg_outlier <- distinct(summary_df_spp_reg, taxon, spp_outliers, spp_impacted) %>%
  group_by(taxon) %>%
  slice(1) %>%
  mutate(total_spp = spp_outliers + spp_impacted) %>%
    mutate(spp_impacted_str = glue("n = {spp_impacted}"),
           spp_outliers_str = glue("n = {spp_outliers}"),
           spp_count_assessed = glue("n = {total_spp}"))

# Set the levels of the taxon variable in summary_df_test
summary_df_spp$taxon <- with(summary_df_spp, reorder(taxon, prop_impact, FUN = function(x) mean(x)))

diet_cols = c("Fish-dominant" = "#0D6EB5", "Plant-dominant" = "#7BD67F")

## make boxplot of prop impacted

plot1 <- ggplot(summary_df_spp %>% filter(prop_impact > 0), aes(x = prop_impact)) +
  geom_point(aes(y = taxon, color = diet), alpha = 0.2, position = position_jitterdodge(dodge.width = -0.9)) + 
  geom_vline(xintercept = 0, color = "black") +
  geom_point(data = summary_df_spp, aes(x = mean_prop, y = taxon, group = diet),
             position = position_dodge(width = -0.9),
             shape = 21, color = "black", fill = "orange", size = 4) +
     geom_boxplot(aes(y = taxon, fill = diet), outlier.fill = NA, outlier.color = NA, position = position_dodge(width = -0.9), alpha = 0, colour = "orange") +
   geom_boxplot(aes(y = taxon, fill = diet), outlier.fill = NA, outlier.color = NA, position = position_dodge(width = -0.9), alpha = 0, fatten = NULL) +
  theme_ohara() +
      labs(x = "Proportion of habitat area impacted", fill = 'Diet', color = 'Diet') +
  scale_x_continuous(expand = c(0,0), limits = c(0, quant_95)) +
  scale_color_manual(values = diet_cols, breaks = names(diet_cols), guide = guide_legend(reverse = FALSE)) +
  theme(panel.background = element_blank(),
            axis.title.y = element_blank(),
            axis.text.x = element_text(size = 16, angle = 45, hjust = 1),
         axis.text.y = element_text(size = 16),
        strip.text = element_text(size = 16),
        axis.title = element_text(size = 16),
        legend.position = "none", 
        text = element_text(family = "Arial"))

# get legend

plot2 <- ggplot(summary_df_spp %>% filter(prop_impact > quant_95), aes(x = prop_impact)) +
  geom_point(aes(y = taxon, color = diet), alpha = 0.4, position = position_jitterdodge(dodge.width = -0.9)) + 
  geom_vline(xintercept = quant_95, color = "black") +
  theme_ohara() +
      labs(x = "", y = "") +
  scale_x_continuous(expand = c(0,0), limits = c(quant_95, 0.012)) +
  scale_color_manual(values = diet_cols, breaks = names(diet_cols), guide = guide_legend(reverse = FALSE)) +
  theme(panel.background = element_blank(),
            axis.title.y = element_blank(),
            axis.text.x = element_text(size = 16, angle = 45, hjust = 1),
         axis.text.y = element_blank(),
        strip.text = element_text(size = 16),
        axis.title = element_text(size = 16),
        legend.position = "none", 
        text = element_text(family = "arial")) +
      geom_text(data = spp_assesed_reg_outlier, aes(label = spp_count_assessed, y = taxon),
                x = 0.008, hjust = 0, color = 'black',
                family = 'arial',
                size = 6)

plot1_legend <- get_legend(ggplot(summary_df_spp, aes(x = mean_prop)) +
  geom_boxplot(aes(y = taxon, fill = diet, color = diet), 
               width = 0.3, position = position_dodge(width = -0.7),
               size = 0.3, outlier.size = 0.3) + 
  theme_ohara() + 
    theme(panel.background = element_blank(),
            legend.text = element_text(size = 16),
            legend.title = element_text(size = 16),
            legend.key.size = unit(.20, 'cm'),
            legend.background = element_blank()) + 
    scale_fill_manual(values = diet_cols, breaks = names(diet_cols), guide = guide_legend(reverse = FALSE)) + 
  scale_color_manual(values = diet_cols, breaks = names(diet_cols), guide = guide_legend(reverse = FALSE)) + 
    labs(x = "Proportion of habitat area impacted", fill = 'Diet', color = 'Diet'))


# draw plots together 
ggdraw() + draw_plot((plot1 + plot2 +  plot_layout(widths = c(3, 1)))) + draw_plot(plot1_legend,  x = .78, y = 0.15, height = .10, width = .15) 

ggsave(here(this_dir, "MS_plots/fig2_economic_boxplot_prop.png"), width = 16, height = 9, units = "in", bg = "white") # technically for nature food the max width is 180 mm, however, I'm saving like this and adjusting save in post production because doing it here messing things up...

```
 

```{r}

summary_df_barcharts <- all_overlap_df %>%
  group_by(diet, fcr, raw_material, allocation, taxon) %>%
  summarise(impact_total = sum(impact_total, na.rm = TRUE)) %>%
  ungroup() %>%
  left_join(taxon_hab_area) %>%
  mutate(prop_impact = impact_total/total_hab_area)

## switch the raw materials and species in that plot

summary_df_barcharts$taxon <- with(summary_df_barcharts, reorder(taxon, prop_impact, FUN = function(x) sum(x)))

ggplot(summary_df_barcharts, aes(x = taxon, y = prop_impact, fill = raw_material)) +
    geom_bar(stat = "identity") +
  facet_wrap(~diet) +
  labs(x = "Taxon", y = "Proportion of total habitat impacted", fill = NULL) +
  theme_minimal() + 
  scale_fill_manual(values = pal_mats) + 
  coord_flip()  + 
  theme(panel.background = element_blank(),
            axis.title.y = element_blank(),
            axis.text.x = element_text(size = 7, angle = 45, hjust = 1),
         axis.text.y = element_text(size = 7),
        strip.text = element_text(size = 7),
        axis.title = element_text(size = 7),
        legend.text = element_text(size = 7),
        text = element_text(family = "arial")) + 
    scale_y_continuous(expand = c(0,0))


ggsave(here(this_dir, "/MS_plots/fig3_economic_barchart.png"), width = 178.9, height =100.92 , units = "mm", bg = "white")

summary_df_barcharts$raw_material <- with(summary_df_barcharts, reorder(raw_material, prop_impact, FUN = function(x) mean(x)))


ggplot(summary_df_barcharts, aes(x = raw_material, y = prop_impact, fill = taxon)) +
    geom_bar(stat = "identity") +
  facet_grid(fcr ~ diet, scales = "free_y") +
  labs(x = "Raw material", y = "Proportion of habitat impacted", fill = NULL) +
  scale_fill_manual(values = color_scale) + 
  theme_minimal() + 
  coord_flip()  + 
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) # Adjust the 'angle' value as needed

ggsave(here(this_dir, "SI_plots/barchart_by_raw_mat.png"), width = 178.9, height =100.92 , units = "mm", bg = "white")

```

**Plot showing diet percentages**

```{r}
diet_comps <- read.csv(here("prep/02_feed/data/aquaculture_diet_composition.csv")) %>%
  distinct(raw_name, prop_diet, diet) %>%
  filter(prop_diet > 0)

# check sums 
diet_comps %>% filter(diet == "fish-dominant") %>% pull(prop_diet) %>% sum()
diet_comps %>% filter(diet == "plant-dominant") %>% pull(prop_diet) %>% sum()


ingredient_levels <- c( "Fish meal, forage fish",  "Fish oil, forage fish", "Fish meal, trimmings", "Fish oil, trimmings", "Soybean meal", "Corn gluten meal" , "Faba beans" , "Wheat gluten" ,"Wheat" , "Soy protein concentrate",  "Guar meal",  "Pea protein concentrate", "Sunflower meal", "Canola oil", "Linseed oil", "Soy oil", "Pea flour", "Coconut oil", "Micro ingredients")


both_diets <- diet_comps %>% 
  mutate(raw_name = str_replace_all(raw_name, "cut offs", "trimmings")) %>%
      mutate(hjust = if_else(condition = diet == "fish-dominant", true = 1, false = 0)) |> 
    mutate(label_x_pos = if_else(diet =="fish-dominant", true =0.5, false = 2.5)) |> 
  mutate(diet = if_else(condition = diet == "fish-dominant", true = "Fish-\ndominant", false = "Plant-\ndominant")) %>% 
   mutate(diet = factor(diet, levels = rev(c("Plant-\ndominant", "Fish-\ndominant")))) %>%
  filter(raw_name != "other") %>%
  mutate(ingredients = str_to_sentence(raw_name)) %>% 
  mutate(ingredients = factor(ingredients, levels = rev(ingredient_levels))) 


ggplot(data = both_diets,
       aes(x = diet , y = prop_diet, fill = ingredients))+
  geom_col()+
  scale_fill_manual(values =  c("darkgoldenrod4", rev(colorRampPalette(brewer.pal(n=9, name = "Greens"))(14)),  brewer.pal(n=5, name = "Blues")[c(2:5)]))+
  theme_pubr()+
  theme(legend.title = element_blank(),
        legend.text = element_text(size=7),
        text = element_text(size=8),
        legend.position = "right",
        #legend.box.spacing = unit(-0.1, "cm"),
        panel.grid = element_blank(),
        legend.key.size = unit(0.25, "cm")
        )+
  labs(x = "Feed scenario", y = "Proportion")+
  guides(fill = guide_legend(byrow=TRUE, reverse = FALSE, ncol = 1))

ggsave(filename = here(this_dir, "SI_plots/feed_composition.jpg"), dpi = 600, width = 10, height = 9, units = "cm")


```

**Look at per country land/eez impacts**
 - grab by raw material rasters 

```{r}
allocations <- c("economic", "mass", "ge")
fcr_types <- c("regular", "efficient")
diet_types <- c("plant-dominant", "fish-dominant")
spp_types <- all_overlap %>% 
  filter(spp_type != "polychaetes") %>% 
  pull(spp_type) %>% unique()

ingredient_types <- all_overlap %>% 
  pull(ingredient) %>% unique()

raw_materials <- c("Soybean", "Wheat", "Sunflower", "CropsNES", "Rapeseed", "Maize", "forage fish", "trimmings fish", "Pulses")

land_eez_rgns <- read.csv(file.path(biodiv_dir, "spatial/rgns_xy_all.csv")) %>% 
  dplyr::select(x, y, rgn_id)

land_eez_rgns_ids <- read.csv(here("data/spatial/output/region_ids.csv"))

num_cores <- 9
cl <- makeCluster(num_cores)
registerDoParallel(cl)


foreach(raw_mat = raw_materials,
        .packages = c("qs", "terra", "tidyverse", "dplyr", "glue")) %dopar% {
for(allocation_type in allocations){
  for(fcr_type in fcr_types){
    for(diet_type in diet_types){
          
# diet_type = "fish-dominant"
# fcr_type = "regular"
# allocation_type = "economic"
# raw_mat = "Soybean"

          if(length(list.files(file.path(glue(impact_maps_dir, "/impact_maps_across_taxon_by_material/{diet_type}/{fcr_type}")), pattern = glue("{allocation_type}_{raw_mat}_mean_prop.tif"), full.names = TRUE)) > 0 ){
        
            files <- c(list.files(file.path(glue(impact_maps_dir, "/impact_maps_across_taxon_by_material/{diet_type}/{fcr_type}")), pattern = glue("{allocation_type}_{raw_mat}_mean_prop.tif"), full.names = TRUE), list.files(file.path(glue(impact_maps_dir, "/impact_maps_across_taxon_by_material/{diet_type}/{fcr_type}")), pattern = glue("{allocation_type}_{raw_mat}_nspp.tif"), full.names = TRUE))
            
        
        map_df <- rast(files) %>%
          as.data.frame(., xy = TRUE) %>%
          left_join(land_eez_rgns) %>%
          group_by(rgn_id) %>%
          summarise(mean_prop_weighted = weighted.mean(mean_prop, nspp, na.rm = TRUE),
                    mean_prop = mean(mean_prop, na.rm = TRUE)) %>%
          mutate(allocation = allocation_type, 
                 diet = diet_type, 
                 fcr = fcr_type, 
                 raw_material = raw_mat) %>%
          ungroup()
        
        
        qsave(map_df, file.path(glue(impact_maps_dir, "/csvs/by_material_country_summary/mean_impacts_{allocation_type}_{diet_type}_{fcr_type}_{raw_mat}.qs")))
        
          }else{
            next()
          }
        
        }
      }
    }
  }

stopCluster(cl)


rgn_ids <- read.csv(here("data/spatial/output/region_ids.csv"))

# now lets join all of those together into one dataframe and save 

csv_files <- list.files(file.path(impact_maps_dir, "csvs/by_material_country_summary"), pattern = ".qs", full.names = TRUE)

list_of_dfs <- lapply(csv_files, qread)

combined_impact_df <- do.call(rbind, list_of_dfs) %>%
  left_join(rgn_ids) %>%
  mutate(raw_material = str_to_sentence(raw_material), 
         allocation = str_to_sentence(allocation),
         diet = str_to_sentence(diet),
         fcr = str_to_sentence(fcr)) %>%
  mutate(raw_material = ifelse(raw_material == "Cropsnes", "CropsNES", raw_material)) 

## do the same thing but make a plot with raw material as the fill value

summary_df <- combined_impact_df %>%
  dplyr::select(diet, iso3c, rgn_id, fcr, allocation, raw_material, mean_prop, mean_prop_weighted) %>%
  filter(allocation == "Economic", fcr == "Regular") 
  
  top_25_impacts <- summary_df %>% 
   group_by(iso3c, diet, fcr) %>%
  summarise(total_impact = sum(mean_prop_weighted, na.rm = TRUE)) %>%
    ungroup() %>%
    group_by(diet, fcr) %>% 
    arrange(-total_impact) %>%
    mutate(rank = row_number()) %>%
    filter(rank <= 25) %>%
    ungroup() %>%
    dplyr::select(-total_impact) 
  
  plot_df <- summary_df %>%
    group_by(iso3c, diet, fcr) %>%
    filter(iso3c %in% c(top_25_impacts$iso3c)) %>%
  group_by(iso3c, diet, fcr) %>%
  mutate(total_impact = sum(mean_prop_weighted, na.rm = TRUE)) %>%
    left_join(top_25_impacts) %>%
    filter(!is.na(rank))
  
legend_plot <-  get_legend(ggplot(summary_df, aes(x = iso3c, y = mean_prop_weighted, fill = raw_material)) +
    geom_bar(stat = "identity") +
  facet_wrap(~diet,  as.table = TRUE, drop = TRUE, shrink = TRUE) +
 scale_fill_manual(values = pal_mats) + 
  theme_minimal() + 
  coord_flip()  + 
facet_grid(fcr~diet, scales = "free") +
    theme(axis.text.x = element_text(angle = -90, hjust = 1),
          axis.text.y = element_text( size = 5), 
          legend.title = element_blank()))

  

panel_1_df <- plot_df %>% 
  filter(diet == "Fish-dominant")

panel_1_df$iso3c <- with(panel_1_df, reorder(iso3c, total_impact, FUN = function(x) mean(x)))


panel_1 <- ggplot(panel_1_df, aes(x = iso3c, y = mean_prop_weighted, fill = raw_material)) +
    geom_bar(stat = "identity") +
 scale_fill_manual(values = pal_mats) + 
  theme_minimal() + 
  coord_flip()  + 
facet_grid(fcr~diet, scales = "free") +
    theme(axis.text.x = element_text(angle = -90, hjust = 1, size = 8),
          axis.text.y = element_text( size = 8), 
          legend.position = "none", 
          axis.title.x = element_blank(), 
          strip.text.y = element_blank()) + # Adjust the 'angle' value as needed
  labs(x = "")

panel_2_df <- plot_df %>% 
  filter(diet == "Plant-dominant")

panel_2_df$iso3c <- with(panel_2_df, reorder(iso3c, total_impact, FUN = function(x) mean(x)))


panel_2 <- ggplot(panel_2_df, aes(x = iso3c, y = mean_prop_weighted, fill = raw_material)) +
    geom_bar(stat = "identity") +
 scale_fill_manual(values = pal_mats) + 
  theme_minimal() + 
  coord_flip()  + 
facet_wrap(~diet) +
    theme(axis.text.x = element_text(angle = -90, hjust = 1),
          axis.text.y = element_text( size = 8), 
          legend.position = "none", 
          axis.title.x = element_blank(), 
          axis.title.y = element_blank()) 


total_panel <- panel_1 + panel_2

ggdraw() + 
  draw_plot(total_panel) +
  draw_label('Nspp weighted average proportion of habitat impacted', x = 0.35, y = .034, hjust = 0, vjust = 1, 
             size = 11, fontfamily = 'Helvetica') +
    theme(plot.margin = margin(0, 3, 0, 0, "cm")) + # Adjust the right margin as needed
    draw_plot(legend_plot,  x = 1.02, y = 0.5, height = .10, width = .15)

ggsave(here(this_dir, "SI_plots/economic_country_props.png"), bg = "white", width = 178.9, height =100.92 , units = "mm")

country_stats_1 <- combined_impact_df %>%
  filter(allocation == "Economic") %>%
  group_by(diet, fcr, iso3c) %>%
  summarise(sum_prop_mean = sum(mean_prop_weighted, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(diet, fcr) %>%
  mutate(total_prop_mean = sum(sum_prop_mean, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(prop_impacts = sum_prop_mean/total_prop_mean)


material_stats_1 <- combined_impact_df %>%
    filter(allocation == "Economic") %>%
    group_by(diet, fcr, raw_material) %>%
  summarise(
            mean_prop_weighted = mean(mean_prop_weighted, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(diet, fcr) %>%
  mutate(total_prop_mean = sum(mean_prop_weighted, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(prop_impacts = mean_prop_weighted/total_prop_mean) %>%
  filter(fcr == "Regular")

material_stats_1$raw_material <- with(material_stats_1, reorder(raw_material, mean_prop_weighted, FUN = function(x) sum(x)))

ggplot(material_stats_1, aes(x = raw_material, y = mean_prop_weighted, fill = raw_material)) +
    geom_bar(stat = "identity") +
  facet_wrap(~diet) +
  labs(x = "Raw material", y = "Average proportion of habitat impacted", fill = NULL) +
  theme_minimal() + 
  scale_fill_manual(values = pal_mats) + 
  coord_flip()  + 
  theme(panel.background = element_blank(),
            axis.title.y = element_blank(),
            axis.text.x = element_text(size = 7, angle = 45, hjust = 1),
         axis.text.y = element_text(size = 7),
        strip.text = element_text(size = 7),
        axis.title = element_text(size = 7),
        legend.text = element_text(size = 7),
        text = element_text(family = "arial")) + 
    scale_y_continuous(expand = c(0,0))

ggsave(here(this_dir, "SI_plots/average_raw_mat_impact.png"), bg = "white", width = 178.9, height =100.92 , units = "mm")

```

