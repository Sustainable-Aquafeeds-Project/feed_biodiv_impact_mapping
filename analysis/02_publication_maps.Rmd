---
title: "Summary plots: maps"
output: html_document
editor_options: 
  chunk_output_type: console
---

## Setup

Load libraries

```{r setup, include=FALSE}

library(tidyverse)
library(here)
library(rnaturalearth)
library(strex)
library(sf)
library(patchwork)
library(cowplot)
library(glue)
library(RColorBrewer)
library(ggpubr)
library(smoothr)
library(ggtext)
library(ggnewscale)
library(qs)

source(here("src/directories.R"))

source(here("src/spatial.R"))

setwd(dirname(rstudioapi::getSourceEditorContext()$path)) # set working directory to where this script is located
this_dir <- getwd()

biodiv_dir <- file.path(rdsi_dir, "biodiversity_impacts")

impact_maps_dir <- file.path(biodiv_dir, "output")

globe_bbox <- rbind(c(-180, -90), c(-180, 90), 
                      c(180, 90), c(180, -90), c(-180, -90)) 

globe_border <- st_polygon(list(globe_bbox)) %>%
  st_sfc(crs = 4326) %>%
  st_sf(data.frame(rgn = 'globe', geom = .)) %>%
  smoothr::densify(max_distance = 0.5) %>%
  st_transform(crs = crs(moll_template))


```

```{r establish color palettes and themes}

## establish color palette from food footprint project
d_brown <- "#515256"
m_brown <- "#B27B54"
l_brown <- "#BC995F"
green <- "#A8B072"
yellow<- "#EFCE71"
l_yellow <- "#F7F6C1"

jv_pal <- c(l_yellow, yellow, green, l_brown, m_brown, d_brown)

continuous_pal <-  colorRampPalette(jv_pal, space="Lab", bias = 3.5)(10000)
image(volcano, asp=1, col=continuous_pal)

light_gray <- "#F8F9FA"
final_palette <- c(light_gray, continuous_pal)
image(volcano, asp=1, col=final_palette)

palette_red <- c(final_palette, "#B90000")
image(volcano, asp=1, col=palette_red)


countries_shp <- ne_countries(scale = 110, returnclass = "sf") |> 
  st_transform(crs(moll_template)) # read in countries shapefile

theme_ohara <- function(base_size = 9) {
  theme(axis.ticks = element_blank(),
        text             = element_text(family = 'Helvetica',
                                        color = 'gray30', size = base_size),
        plot.title       = element_text(size = rel(1.25), hjust = 0, face = 'bold'),
        panel.background = element_blank(),
        legend.position  = 'right',
        panel.border     = element_blank(),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_line(colour = 'grey90', size = .25),
        legend.key       = element_rect(colour = NA, fill = NA),
        axis.line        = element_blank())
}


```

Make map split by quantiles in each cell
 - regular quantiles up to 95th 
 - Then 95-99th
 - then >= 99th
 
Additionally, make a delta map, and color either fish dominant or plant dominant. Have the legend colors be the same as the green and blue we use for the boxplot, but split by quantile of delta (same as regular impact quantiles above).
 
 - For main text
 
```{r}
# make publication ready mean extinction risk plots with all feed scenarios, economic allocation
 filepath <- glue(file.path(impact_maps_dir, "csvs/impact_maps_across_taxon_ingredient/economic_mean_prop.qs"))

quantile_pal <- c(
    "0-24" = "#D4F7F0", 
    "25-49" = "#538AC6", 
    "50-74" = "#1E438F", 
    "75-94" = "#F8D422", 
    "95-99" = "#E95D08", 
    "≥99" = "#781211"
)

all_df <-  qread(filepath) %>%
  filter(fcr_type == "regular") %>%
    filter(!is.na(value)) %>%
    mutate(diet_cap = str_to_sentence(diet))

quantiles <- all_df %>%
  group_by(diet) %>%
  summarise(q25 = quantile(value, 0.25),
            q50 = quantile(value, 0.50),
            q75 = quantile(value, 0.75),
            q95 = quantile(value, 0.95),
            q99 = quantile(value, 0.99)) %>%
  ungroup()

all_df_quant <- all_df %>%
  left_join(quantiles, by = "diet") %>%
    mutate(category = case_when(
    value < q25 ~ "0-24",
    value >= q25 & value < q50 ~ "25-49",
    value >= q50 & value < q75 ~ "50-74",
    value >= q75 & value < q95 ~ "75-94",
    value >= q95 & value < q99 ~ "95-99",
    value >= q99 ~ "≥99"
  ))

all_df_quant$category <- factor(all_df_quant$category, levels = c("0-24", "25-49", "50-74", "75-94", "95-99", "≥99"))

  quantile_plot <-  ggplot() + 
      geom_tile(data = all_df_quant, aes(x = long, y = lat, fill = category, color = category)) +
                 geom_sf(data = countries_shp, fill = NA, colour = "grey", alpha = 0.2)  +
                 geom_sf(data = globe_border, fill = NA, colour = "grey") + 
    scale_x_continuous(expand = c(0, 0)) +
    scale_y_continuous(expand = c(0, 0)) +
    theme_minimal() + 
      theme(plot.title = element_text(hjust = 0.5), 
          axis.title = element_blank(),
          axis.text = element_blank(),
          axis.ticks = element_blank(),
          legend.margin = margin(r = 10), # add a margin to legend text so it isn't cut off when saving 
          legend.position = "bottom",
          text = element_text(family = "Arial", colour = "black"),
          legend.title = element_text(size = 8),
          strip.text.x = element_text(size = 8, family = "Arial", colour = "black"),
          legend.key.size = unit(4, "mm")) + # change legend box sizes
  labs(fill = "Impact by Quantile") + 
     guides(color = "none",
             fill = guide_legend(title.position = "top", title.hjust = 0.5, nrow = 1)) + 
    facet_wrap(~diet_cap) + 
    scale_fill_manual(values = quantile_pal) +
    scale_colour_manual(values = quantile_pal) 
  
    ggsave(glue(here(this_dir, "SI_plots/economic_mean_prop_quantiles.png")), plot = quantile_plot, width = 8, height = 8, bg = "white")
    
    
## Delta plot 
    
 filepath <- glue(file.path(impact_maps_dir, "csvs/impact_maps_across_taxon_ingredient/delta/economic_mean_prop.qs"))

delta_df <-  qread(filepath) %>%
  filter(fcr_type == "regular", 
         delta_cat != "No difference") # there are only a few pixels where there is no difference... so just filter out.

quantiles_delta_fish <- delta_df %>%
  filter(delta_cat == "Fish-dominant") %>%
  group_by(delta_cat) %>%
  summarise(q25 = quantile(delta, 0.25),
            q50 = quantile(delta, 0.50),
            q75 = quantile(delta, 0.75),
            q95 = quantile(delta, 0.95),
            q99 = quantile(delta, 0.99)) %>%
  ungroup()

quantiles_delta_plant <- delta_df %>%
  filter(delta_cat == "Plant-dominant") %>%
  group_by(delta_cat) %>%
  summarise(q25 = quantile(-1*delta, 0.25),
            q50 = quantile(-1*delta, 0.50),
            q75 = quantile(-1*delta, 0.75),
            q95 = quantile(-1*delta, 0.95),
            q99 = quantile(-1*delta, 0.99)) %>%
  ungroup() %>%
  mutate(across(2:6, ~.x*-1))

quantiles_delta <- rbind(quantiles_delta_plant, quantiles_delta_fish) # bind back together

delta_df_quant <- delta_df %>%
  left_join(quantiles_delta, by = "delta_cat") %>%
    mutate(category = case_when(
    abs(delta) < abs(q25) ~ "0-24",
    abs(delta) >= abs(q25) & abs(delta) < abs(q50) ~ "25-49",
    abs(delta) >= abs(q50) & abs(delta) < abs(q75) ~ "50-74",
    abs(delta) >= abs(q75) & abs(delta) < abs(q95) ~ "75-94",
    abs(delta) >= abs(q95) & abs(delta) < abs(q99) ~ "95-99",
    abs(delta) >= abs(q999) ~ "≥99"
  ))

# establish palettes for delta map 
plant_pal <- c(
      "0-24" = "#DBF1D5", 
    "25-49" = "#ADDEA7", 
    "50-74" = "#74C476", 
    "75-94" = "#37A055", 
    "95-99" = "#0B7734", 
    "≥99" = "#00441B"
)

fish_pal <- c(
      "0-24" = "#D6E5F4", 
    "25-49" = "#ABCFE5", 
    "50-74" = "#6BAED6", 
    "75-94" = "#3787C0", 
    "95-99" = "#105BA4", 
    "≥99" = "#08306B"
)

delta_df_quant_fis <- delta_df_quant %>% filter(delta_cat == "Fish-dominant")
delta_df_quant_fis$category <- factor(delta_df_quant_fis$category, levels = c("0-24", "25-49", "50-74", "75-94", "95-99", "≥99"))


delta_df_quant_plant <- delta_df_quant %>% filter(delta_cat == "Plant-dominant")
delta_df_quant_plant$category <- factor(delta_df_quant_plant$category, levels = c("0-24", "25-49", "50-74", "75-94", "95-99", "≥99"))


   delta_plot <-  ggplot() + 
      geom_tile(data = delta_df_quant_plant, aes(x = long, y = lat, fill = category, color = category)) +
        scale_fill_manual(values = plant_pal) +
    scale_colour_manual(values = plant_pal) +
    scale_x_continuous(expand = c(0, 0)) +
    scale_y_continuous(expand = c(0, 0)) +
     theme_ohara() + 
  labs() +
  guides(color = "none") +
          theme(legend.position = "none", 
                text = element_text(family = "Arial")) + 
     new_scale_color() +
     new_scale_fill() + 
           geom_tile(data = delta_df_quant_fis, aes(x = long, y = lat, fill = category, color = category)) +
             scale_fill_manual(values = fish_pal) +
                 geom_sf(data = countries_shp, fill = NA, colour = "grey", alpha = 0.2)  +
                 geom_sf(data = globe_border, fill = NA, colour = "grey") + 
    scale_colour_manual(values = fish_pal) +
       labs(fill = "Fish-dominant", x = "Difference of Impact by Quantile", y = "") +
  guides(color = "none") + 
     theme(legend.position = "none", 
           axis.text.y = element_blank(), 
           axis.text.x = element_blank(),
           axis.title.x = element_text(size = 8, family = "Arial"),
           plot.margin = margin(t = 10, r = 10, b = 50, l = 10, unit = "pt"),
           text = element_text(family = "Arial", colour = "black"))
   
   fish_legend <- get_legend(ggplot() + 
      geom_tile(data = delta_df_quant_fis, aes(x = long, y = lat, fill = category, color = category)) +
             scale_fill_manual(values = fish_pal) +
              scale_colour_manual(values = fish_pal) +
                  labs(fill = "Fish-dominant") +
          guides(color = "none",
            fill = guide_legend(title.position = "bottom", title.hjust = 0.5, nrow = 1)) +
          theme(legend.position = "bottom", 
                  legend.title = element_text(size = 8),
                legend.text = element_text(size = 8), 
      text = element_text(family = "Arial", colour = "black"),
      legend.margin = margin(r = 10),
      legend.key.size = unit(4, "mm")))
   
   plant_legend <- get_legend(ggplot() + 
      geom_tile(data = delta_df_quant_plant, aes(x = long, y = lat, fill = category, color = category)) +
             scale_fill_manual(values = plant_pal) +
              scale_colour_manual(values = plant_pal) +
                  labs(fill = "Plant-dominant") +
          guides(color = "none",
            fill = guide_legend(title.position = "bottom", title.hjust = 0.5, nrow = 1)) +
          theme(legend.position = "bottom",
                legend.title = element_text(size = 8),
                legend.text = element_text(size = 8), 
                text = element_text(family = "Arial", colour = "black"), 
      legend.margin = margin(r = 10),
      legend.key.size = unit(4, "mm")))
     
   full_plot <- ggdraw() +
                draw_plot(delta_plot) +
                draw_plot(fish_legend, height = 0.25, width = 0.52) +
                draw_plot(plant_legend, height = 0.25, width = 1.54)
     
   ## saving two separetely because I can
   
        ggsave(glue(here(this_dir, "MS_plots/fig1_economic_mean_prop_quantiles_delta.png")),
                plot = plot_grid(quantile_plot, full_plot, nrow = 2, labels = c("A", "B"), label_fontfamily = "Arial", label_fontface = "bold", label_size = 8), 
                width = 180, height = 180, bg = "white", units = "mm")
      
         ggsave(glue(here(this_dir, "SI_plots/economic_mean_prop_delta_plot.png")),
                plot = full_plot, 
                width = 180, height = 180, bg = "white", units = "mm")
   
    
```

Histogram of impact values by quantile group 
 - SI

```{r}
hist_plot_fish <- ggplot(data = all_df_quant %>% filter(diet == "fish-dominant")) + 
    geom_histogram(aes(value, fill = category)) +
    facet_wrap(~category, scales = "free", ncol = 2) +
    theme_ohara() +
    labs(x = "Average proportion of habitat impacted", y = "Number of cells", title = "Fish-dominant") +
    scale_fill_manual(values = quantile_pal) +
  theme(legend.position = "none")

hist_plot_plant <- ggplot(data = all_df_quant %>% filter(diet == "plant-dominant")) + 
    geom_histogram(aes(value, fill = category)) +
    facet_wrap(~category, scales = "free", ncol = 2) +
    theme_ohara() +
    labs(x = "Average proportion of habitat impacted", y = "Number of cells", title = "Plant-dominant") +
    scale_fill_manual(values = quantile_pal) + 
    theme(legend.position = "none")

  
  ggsave(glue(here(this_dir, "SI_plots/economic_mean_prop_quantiles_hist_plant.png")), plot = plot_grid(hist_plot_plant , nrow = 1), width = 8, height = 8, bg = "white") 
  
    ggsave(glue(here(this_dir, "SI_plots/economic_mean_prop_quantiles_hist_fish.png")), plot = plot_grid(hist_plot_fish, nrow = 1), width = 8, height = 8, bg = "white") 
    
```


Make map showing actual values
 - SI
 
```{r}
# make publication ready mean extinction risk plots with all feed scenarios, economic allocation
 filepath <- glue(file.path(impact_maps_dir, "csvs/impact_maps_across_taxon_ingredient/economic_mean_prop.qs"))

all_df <-  qread(filepath) %>%
  filter(fcr_type == "regular")

 plot_list <- list()
  
 diets <- unique(all_df$diet)
 
 for(diet_type in diets){

      # diet_type = "plant-dominant"
      
  loop_loop_df <- all_df %>%
    filter(diet == diet_type)
  
quantile_value <- quantile(loop_loop_df$value, probs = 0.99, na.rm = TRUE)
  
  loop_loop_df <- loop_loop_df %>% 
    mutate(value_new = ifelse(value > quantile_value, quantile_value, value))
  
  loop_plot <-  ggplot() + 
      geom_tile(data = loop_loop_df, aes(x = long, y = lat, fill = value_new, color = value_new)) +
     geom_tile(fill = ifelse(loop_loop_df$value_new < quantile_value, "#B90000", NA)) + 
            geom_sf(data = countries_shp, fill = NA, colour = "grey") + 
       scale_fill_gradientn(colors = palette_red, na.value = "white") +
            scale_color_gradientn(colors = palette_red, na.value = "white") +
            geom_sf(data = globe_border,
            fill = NA, color = 'grey70', 
            size = .1) +
    scale_x_continuous(expand = c(0, 0)) +
    scale_y_continuous(expand = c(0, 0)) +
    theme_void() +
      theme(plot.title = element_text(hjust = 0.5), 
          axis.title = element_blank(),
          axis.text = element_blank(),
          axis.ticks = element_blank(),
          legend.margin = margin(r = 10)) + # add a margin to legend text so it isn't cut off when saving 
  labs(fill = "Proportion\nhabitat\nimpacted") + 
     guides(color = "none") + 
    facet_wrap(~diet)
  
        
      plot_list[[length(plot_list) + 1]] <- loop_plot

  } 

ggsave(glue(here(this_dir, "SI_plots/economic_mean_prop.png")), plot = plot_grid(plotlist = plot_list, nrow = 1), width = 10, height = 4, bg = "white")
```


Map stats!
 
 
 - Look specifically at cell with highest value
 
```{r}

land_eez_rgns <- read.csv(file.path(biodiv_dir, "spatial/rgns_xy_all.csv")) %>% 
  dplyr::select(x, y, rgn_id)

## read in plant-dominant, economic, regulat
 filepath <- glue(file.path(impact_maps_dir, "csvs/impact_maps_across_taxon_ingredient/economic_mean_prop.qs"))

all_df <-  qread(filepath)  %>%
  filter(value > 0) %>%
  filter(!is.na(value))

max(all_df$value) # 0.2235324 - plant-dominant regular

moll_template_land <- readRDS(here("prep/03_prep_spp_habitats/data/spatial/moll_template_land_xy.rds"))
moll_template_ocean <- readRDS(here("prep/03_prep_spp_habitats/data/spatial/moll_template_ocean_xy.rds"))


maximum_location <- all_df %>%
  filter(value > 0.22) %>%
  left_join(land_eez_rgns, by = c("long" = "x", "lat" = "y")) %>%
  left_join(moll_template_land, by = c("long" = "x", "lat" = "y")) # max value is 0.2235324 on land in Norway

## how many spp impacted in that cell? 
 filepath <- glue(file.path(impact_maps_dir, "csvs/impact_maps_across_taxon_ingredient/economic_nspp.qs"))

nspp_df <-  qread(filepath) %>%
  left_join(moll_template_xy, by = c("long" = "x", "lat" = "y")) %>%
  filter(cell_id == 786772) # 39 spp impacted

## how many spp are in that cell total that aren't impacted? Do I have this info saved somewhere??
# since this is a terrestrial cell, we only need to look at terrestrial species

spp_fp <- data.frame(filepath = list.files(file.path("/mnt/rdsi/raw_data/AOH_eyres/reprojected_mol_csv_fin"), full.names = TRUE)) %>%
  mutate(species_full = str_after_last(filepath, "\\/")) %>%
  mutate(species_id = as.numeric(str_remove_all(species_full, ".csv"))) %>%
  left_join(iucn_ids_names, by = c("species_id" = "iucn_id")) %>%
  dplyr::select(filepath, species_full = scientific_name, spp_type, species_id) %>%
  mutate(spp_type = case_when(
    spp_type == "mammals" ~ "Terrestrial mammal", 
    spp_type == "birds" ~ "Bird",
    spp_type == "reptiles" ~ "Reptiles",
    spp_type == "amphibians" ~ "Amphibians"
  ))

spp_info_df <- readRDS(file.path(this_dir, "int/terrestrial_spp_habitat_suitability.rds")) %>%
  inner_join(spp_fp, by = c("species" = "species_full", "spp_type")) %>% # change this to left join ? 
  rename(species_full = species)


source(here("src/fxns.R"))
library(data.table)

tx_maps <- collect_spp_rangemaps_terrestrial(spp_info_df$species_full, spp_info_df$filepath)

max_cell <- tx_maps %>%
  as.data.table() %>%
   .[cell_id == 786772] # ok there are 97 spp total in this cell, meaning 97-39 = 58 are not impacted

 all_spp_map <- tx_maps %>%
   as.data.table() %>%
                                                  .[ , .(
                                                         n_spp       = length(unique(species_full))),
                                                     by = 'cell_id'] %>%
   as.data.frame() %>%
   left_join(moll_template_xy) %>%
            left_join(moll_template_xy) %>%
            dplyr::select(x, y, n_spp) %>%
            rast(., type = "xyz", crs = moll_template)
 
 writeRaster(all_spp_map, here("data/spatial/output/terrestrial_spp_richness.tif"), overwrite = TRUE)

rgn_id <- read.csv(here("data/spatial/output/region_ids.csv"))


```

Compare diet types and ncells impacted

```{r}
test <- all_df %>%
  group_by(diet, fcr_type) %>%
  summarise(prop_mean = mean(value, na.rm = TRUE)) %>%
  ungroup()

scenario_summary <- all_df %>% 
  filter(value > 0) %>%
  group_by(diet, fcr_type) %>%
  summarise(cells_impacted = n()) %>%
  ungroup()

moll_land <- readRDS(here("prep/03_prep_spp_habitats/data/spatial/moll_template_land_xy.rds"))

all_df_land <- all_df %>%
  left_join(moll_land, by = c("long" = "x", "lat" = "y")) %>%
  filter(!is.na(cell_id)) %>%
  filter(value > 0) %>%
    group_by(diet, fcr_type) %>%
  summarise(cells_impacted = n()) %>%
  ungroup() %>%
   mutate(land_cells_total = 2876998) %>%
  mutate(prop = cells_impacted/land_cells_total)

moll_ocean <- readRDS(here("prep/03_prep_spp_habitats/data/spatial/moll_template_ocean_xy.rds"))

all_df_ocean <- all_df %>%
  left_join(moll_ocean, by = c("long" = "x", "lat" = "y")) %>%
  filter(!is.na(cell_id)) %>%
    filter(value > 0) %>%
    group_by(diet, fcr_type) %>%
  summarise(cells_impacted = n()) %>%
  ungroup() %>%
  mutate(ocean_cells_total = 3684240) %>%
  mutate(prop = cells_impacted/ocean_cells_total)

# Comparing the fish-dominant and plant-dominant feed scenarios, under the regular FCR scenario, we see that the plant-dominant diet has 81,352 more pixels impacted (there are ~6.5 million pixels on a 10km by 10 km Mollweide grid). This difference is almost exclusively due to the difference in terrestrial crop impacts, with the plant-dominant diet having 80,789 more terrestrial pixels impacted than that of the fish-dominant diet. Overall, ocean pixels are impacted over a larger area: ~42% of ocean pixels are impacted, regardless of feed scenario. In comparison, 23%-26% of land pixels are impacted, depending on the scenario. 

```




