---
title: "Summary stats for manuscript"
output: html_document
editor_options: 
  chunk_output_type: console
---

## Setup

Load libraries

```{r setup, include=FALSE}

library(tidyverse)
library(here)
library(strex)
library(sf)
library(glue)
library(qs)
library(mapview)

source(here("src/directories.R"))

source(here("src/spatial.R"))

setwd(dirname(rstudioapi::getSourceEditorContext()$path)) # set working directory to where this script is located
this_dir <- getwd()

biodiv_dir <- file.path(rdsi_dir, "biodiversity_impacts")

impact_maps_dir <- file.path(biodiv_dir, "output")

```

```{r}
marine_overlap <- readRDS(here("prep/03_prep_spp_habitats/output/aoh_marine_impact.rds")) %>%
    dplyr::select(sciname, spp_type, diet, fcr_type, allocation, ingredient, vulnerability, impact_total, total_hab_area)

terrestrial_overlap <- readRDS(here("prep/03_prep_spp_habitats/output/aoh_terrestrial_impact.rds")) %>% 
  dplyr::select(-suitability) %>%
      dplyr::select(sciname, spp_type, diet, fcr_type, allocation, ingredient, vulnerability, impact_total, total_hab_area)

all_overlap <- rbind(marine_overlap, terrestrial_overlap) %>%
    mutate(taxon = str_to_sentence(spp_type)) %>%
  mutate(taxon = case_when(
    taxon == "Terrestrial mammal" ~ "Terrestrial mammals",
    taxon == "Bird" ~ "Birds",
    taxon == "Fish" ~ "Finfish", 
    taxon == "Marine mammal" ~ "Marine mammals",
    taxon == "Marine plant" ~ "Marine plants",
    TRUE ~ taxon))

spp_total_hab <- all_overlap %>%
  distinct(sciname, spp_type, total_hab_area) %>%
  mutate(id = row_number())


ocean_impacts <- marine_overlap %>% 
  group_by(diet, fcr_type, allocation) %>%
  summarise(total_km2_impact = sum(impact_total, na.rm = TRUE)) %>%
  ungroup() %>%
  filter(fcr_type == "regular", allocation == "economic") %>%
  mutate(type = "ocean")

terrestrial_impacts <- terrestrial_overlap %>%
  filter(!str_detect(ingredient, "fish meal|fish oil")) %>%
  group_by(diet, fcr_type, allocation) %>%
  summarise(total_km2_impact = sum(impact_total, na.rm = TRUE)) %>%
  ungroup() %>%
  filter(fcr_type == "regular", allocation == "economic") %>%
  mutate(type = "terrestrial")


322308.2 + 123897.6
304212.8+174105.1


all_impacts <- rbind(ocean_impacts, terrestrial_impacts)
```

Get some stats about differences between formulations and average impacts.

```{r}
## read in plant-dominant, economic, regular
 filepath <- glue(file.path(impact_maps_dir, "csvs/impact_maps_across_taxon_ingredient/economic_mean_prop.qs"))

all_df <-  qread(filepath)  %>%
  filter(value > 0) %>%
  filter(!is.na(value))

test <- all_df %>% 
  group_by(diet, fcr_type) %>%
  summarise(avg = mean(value, na.rm = TRUE),
            min = min(value, na.rm = TRUE),
            max = max(value, na.rm = TRUE), 
            median = median(value, na.rm = TRUE),
            q_95 = quantile(value, c(0.05, 0.95))) %>%
  ungroup()

options(scipen=0)

quantile(all_df %>% filter(fcr_type == "regular") %>% pull(value), c(0.05,0.95))
## both scenarios
#                    5%                   95% 
# 0.0000000000007917118 0.0000538178921487997 

quantiles_by_diet <- all_df %>%
  filter(fcr_type == "regular") %>%
  group_by(diet) %>%
  summarise(
    lower_quantile = quantile(value, 0.05),
    upper_quantile = quantile(value, 0.95)
  )

# Display the results
quantiles_by_diet

# # A tibble: 2 × 3
#   diet           lower_quantile upper_quantile
#   <chr>                   <dbl>          <dbl>
# 1 fish-dominant        7.96e-13      0.0000456
# 2 plant-dominant       7.88e-13      0.0000636


max(all_df$value) # 0.2235324 # can dive into prep/03_prep_spp_habitats/08_process_mean_sd_summary.Rmd to find out more of whats happening in this cell. 

moll_template_land <- readRDS(here("prep/03_prep_spp_habitats/data/spatial/moll_template_land_xy.rds"))
moll_template_ocean <- readRDS(here("prep/03_prep_spp_habitats/data/spatial/moll_template_ocean_xy.rds"))

land_eez_rgns <- read.csv(file.path(biodiv_dir, "spatial/rgns_xy_all.csv")) %>% 
  dplyr::select(x, y, rgn_id)

maximum_location <- all_df %>%
  filter(value > 0.22) %>%
  left_join(land_eez_rgns, by = c("long" = "x", "lat" = "y")) %>%
 left_join(moll_template_land, by = c("long" = "x", "lat" = "y")) %>% # max value is ~0.22 on land in Norway
st_as_sf(coords = c("long", "lat"), crs = crs(moll_template)) # in Akershus county
mapview(maximum_location)
  

test <- all_df %>%
  group_by(diet, fcr_type) %>%
  summarise(prop_mean = mean(value, na.rm = TRUE)) %>%
  ungroup()

scenario_summary <- all_df %>% 
  filter(value > 0) %>%
  group_by(diet, fcr_type) %>%
  summarise(cells_impacted = n()) %>%
  ungroup()

moll_land <- readRDS(here("prep/03_prep_spp_habitats/data/spatial/moll_template_land_xy.rds"))

all_df_land <- all_df %>%
  left_join(moll_land, by = c("long" = "x", "lat" = "y")) %>%
  filter(!is.na(cell_id)) %>%
  filter(value > 0) %>%
    group_by(diet, fcr_type) %>%
  summarise(cells_impacted = n()) %>%
  ungroup() %>%
   mutate(land_cells_total = 2876998) %>%
  mutate(prop = cells_impacted/land_cells_total)

moll_ocean <- readRDS(here("prep/03_prep_spp_habitats/data/spatial/moll_template_ocean_xy.rds"))

all_df_ocean <- all_df %>%
  left_join(moll_ocean, by = c("long" = "x", "lat" = "y")) %>%
  filter(!is.na(cell_id)) %>%
    filter(value > 0) %>%
    group_by(diet, fcr_type) %>%
  summarise(cells_impacted = n()) %>%
  ungroup() %>%
  mutate(ocean_cells_total = 3684240) %>%
  mutate(prop = cells_impacted/ocean_cells_total)

# Comparing the fish-dominant and plant-dominant feed scenarios, under the BAU FCR scenario, we see that the plant-dominant diet has 81,352 more pixels impacted (there are ~6.5 million pixels on a 10km Mollweide grid) (Fig. 1). This difference is almost exclusively due to the difference in terrestrial crop impacts, with the plant-dominant diet having 80789 more terrestrial pixels impacted than that of the fish-dominant diet. 

# Overall, ocean pixels are impacted over a larger area: approximately 42% of ocean pixels, regardless of feed scenario. In comparison, around a quarter of land pixels are impacted. The global average proportion of habitat impacted ranges from 0.00001769810 to 0.00003439829, with the fish-dominant, regular FCR scenario having the largest global average impact (0.00000507).

# Pixels in which there are impacts under both scenarios, the plant-dominant diet has, on average, larger impacts on land, particularly in Sub-Saharan Africa, Canada, the Middle East, and Western Europe. In contrast, the fish-dominant diet has larger impacts in most ocean pixels, the United States, parts of South America, and China (Fig. 1b). 


```

Compare how vulnerable species types are

```{r}
vuln_values <- all_overlap %>%
  distinct(sciname, ingredient, vulnerability) %>%
  mutate(type = ifelse(str_detect(ingredient, "fish"), "marine", "terrestrial")) %>%
  group_by(type) %>%
  summarise(mean_vuln = mean(vulnerability)) %>%
  ungroup()

ag_suitability <- readRDS(here("prep/03_prep_spp_habitats/int/terrestrial_spp_habitat_suitability.rds"))

test <- ag_suitability %>% 
  mutate(sensitivity = 1 - cropland_suitability) %>%
  group_by(sensitivity) %>%
  summarise(count_sens = n())

5487/sum(test$count_sens) # ~81% of terrestrial species are fully sensitive

1 - mean(ag_suitability$cropland_suitability) # 0.8213065

vuln_taxa <- readRDS(file.path(rdsi_dir, "biodiversity_impacts/int/spp_vuln_depth_info.rds")) %>%
  unite("ingredient", c(fish_type, ingredient), sep = "_") %>%
  mutate(ingredient = case_when(
    ingredient == "trimmings fish_fish meal" ~ "trimmings fish_fish meal, cut offs",
    ingredient == "trimmings fish_fish oil" ~ "trimmings fish_fish oil, cut offs",
    TRUE ~ ingredient
  )) %>%
  distinct(species,ingredient, vuln_quartile) %>%
  filter(species %in% unique(marine_overlap$sciname))

test2 <- vuln_taxa %>%
  group_by(species) %>% 
  summarise(sensitivity = mean(vuln_quartile)) %>%
  ungroup() %>%
  group_by(sensitivity) %>% 
  summarise(count_sens = n())

412/sum(test2$count_sens) # 0.01789049 ==> ~2% of marine species are full sensitive.. vast majority (~88% are marginal)

mean(vuln_taxa$vuln_quartile) # 0.4579552

# Additionally, of all species (impacted or not), marine species, on average, have a vulnerability value of 0.45, while terrestrial species have a vulnerability value of 0.82. This means that within our methods, marine species are, on average, more resilient to fishing pressures than terrestrial species are to cropland used for aquafeeds.

length(unique(vuln_taxa$species)) # 23029
length(unique(ag_suitability$species)) # 31596


terr_vuln_spp <- ag_suitability %>% 
  filter(cropland_suitability != 1)
length(terr_vuln_spp$species) # 26413 terrestrial species are sensitive to cropland


marine_vuln_spp <- vuln_taxa %>%
  group_by(species) %>%
  summarise(total_vuln = sum(vuln_quartile, na.rm = TRUE)) %>%
  ungroup() %>%
  filter(total_vuln != 0)

length(marine_vuln_spp$species) # 20682 marine species are sensitive to harvest

(20682 + 26413)/(23029 + 31596) # 0.8526659 are vulnerable in some capacity

```

How many species assessed and impacted? 

```{r}
taxon_names <- all_overlap %>%
  distinct(spp_type, taxon)

spp_impacted <- all_overlap %>%
  filter(impact_total > 0) %>%
  group_by(taxon, diet, allocation, fcr_type) %>%
  summarise(spp_count_impacted = n_distinct(sciname)) %>%
  ungroup()

spp_impacted_economic <- spp_impacted %>% 
  filter(allocation == "economic", 
         fcr_type == "regular") %>%
  group_by(diet) %>%
  summarise(total_spp_impacted = sum(spp_count_impacted))

## so 42939 out of 54268 spp are impacted. 47097 species are actually sensitive to harvest. 

aquamaps_spp <- readRDS(file.path(rdsi_dir, "biodiversity_impacts/int/spp_vuln_depth_info.rds")) %>%
  distinct(spp_type = taxon, sciname = species) %>%
  filter(spp_type != "polychaetes")

setdiff(aquamaps_spp$sciname, marine_overlap$sciname) # [1] "artedidraco mirus"      "careproctus georgianus"

setdiff(marine_overlap$sciname, aquamaps_spp$sciname) # 0
  
eyres_spp <- readRDS(here("prep/03_prep_spp_habitats/data/iucn/eyres_iucn_spp.rds")) %>%
  dplyr::select(spp_type, sciname = scientific_name) %>%
  mutate(sciname = tolower(sciname)) %>%
  mutate(spp_type = case_when(
    spp_type == "mammals" ~ "Terrestrial mammal",
    spp_type == "amphibians" ~ "Amphibians", 
    spp_type == "reptiles" ~ "Reptiles", 
    spp_type == "birds" ~ "Bird"
  ))

spp_assessed <- rbind(aquamaps_spp, eyres_spp) %>%
  left_join(taxon_names) %>%
  group_by(taxon) %>%
  summarise(spp_count_assessed = n_distinct(sciname)) %>%
  ungroup() %>%
  filter(!is.na(taxon))

spp_assessed_impacted <- spp_impacted %>%
  left_join(spp_assessed)

summary_info <- spp_assessed_impacted %>%
  group_by(diet, allocation, fcr_type) %>%
  summarise(total_assessed = sum(spp_count_assessed, na.rm = TRUE),
            total_impacted = sum(spp_count_impacted, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(prop_impacted = total_impacted/total_assessed)


marine_vs_terr <- spp_assessed_impacted %>%
  filter(diet == "plant-dominant", allocation == "economic", fcr_type == "regular") %>%
  mutate(type = ifelse(taxon %in% c("Amphibians", "Birds", "Terrestrial mammals", "Reptiles"), "terrestrial", "marine")) %>%
  group_by(type) %>%
    summarise(total_assessed = sum(spp_count_assessed, na.rm = TRUE),
            total_impacted = sum(spp_count_impacted, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(prop_impacted = total_impacted/total_assessed)

#  A tibble: 2 × 4
#   type        total_assessed total_impacted prop_impacted
#   <chr>                <int>          <int>         <dbl>
# 1 marine               22985          20538         0.894
# 2 terrestrial          31643          22401         0.708

spp_assessed %>% filter(taxon %in% c("Amphibians", "Reptiles", "Terrestrial mammals", "Birds")) %>% pull(spp_count_assessed) %>% sum() # 31643 assessed terrestial spp

```

What % of species fall into >95th quantile of global prop of habitat impacted:

```{r}
spp_assessed_plot_df <- spp_assessed %>%
  mutate(spp_count_str = glue("n = {spp_count_assessed}"))

all_overlap_df <- all_overlap %>%
  rename(fcr = fcr_type) %>%
        separate_wider_delim(ingredient, delim = "_", names = c("raw_material", "ingredient")) %>% 
  mutate(raw_material = str_to_sentence(raw_material), 
         ingredient = str_to_sentence(ingredient),
         allocation = str_to_sentence(allocation),
         diet = str_to_sentence(diet),
         fcr = str_to_sentence(fcr)) %>%
    filter(allocation == "Economic",
           fcr == "Regular")

summary_df_spp <- all_overlap_df %>%
  group_by(sciname, diet, fcr, allocation, taxon) %>%
  summarise(impact_total = sum(impact_total, na.rm = TRUE)) %>%
  ungroup() %>%
  left_join(spp_assessed_plot_df) %>%
  left_join(spp_total_hab %>% dplyr::select(-spp_type, -id)) %>%
  mutate(prop_impact = impact_total/total_hab_area)  %>%
  group_by(taxon, diet, fcr) %>%
  mutate(mean_prop = mean(prop_impact,na.rm=TRUE),
         median_prop = median(prop_impact,na.rm=TRUE)) %>%
  ungroup()

taxon_hab_area <- spp_total_hab %>%
  dplyr::select(-sciname, -id) %>%
  group_by(spp_type) %>%
  summarise(total_hab_area = sum(total_hab_area, na.rm = TRUE)) %>%
  ungroup() %>%
  left_join(taxon_names) %>%
  dplyr::select(-spp_type)
  

summary_df_all <- all_overlap_df %>%
  group_by(diet, fcr, allocation, taxon) %>%
  summarise(impact_total = sum(impact_total, na.rm = TRUE)) %>%
  ungroup() %>%
  left_join(taxon_hab_area) %>%
  mutate(prop_impact = impact_total/total_hab_area)

quant_95 <- quantile(summary_df_spp$prop_impact, 0.95)


summary_df_spp_out <- summary_df_spp %>%
  filter(prop_impact >= quant_95) %>%
  group_by(diet, fcr, allocation, taxon) %>%
  mutate(spp_outliers = n_distinct(sciname)) %>%
  ungroup() 

summary_spp_outliers <- summary_df_spp %>%
  filter(prop_impact >= quant_95) %>%
  group_by(diet, fcr, allocation, taxon) %>%
  summarise(spp_outliers = n_distinct(sciname)) %>%
  ungroup() 

# Overall, our analysis reveals that terrestrial mammal species exhibit the highest impacts on average across all taxon, in the plant-dominant scenario. Of terrestrial mammal species assessed, 10% are above the 95th percentile proportion of total habitat impacted (Fig. 2). While birds, reptiles, and amphibians are exposed to both marine and terrestrial disturbance pressures, most of their impacts are derived from terrestrial based feed ingredients, with only a small proportion of their impacts coming from forage and trimmings fish raw materials, as these species are unlikely to be bycatch or have exposure to areas of harvest of marine ingredients (Fig. 3). Among marine taxonomic groupings, marine plants see the highest proportion of their global habitat area impacted (Fig. 3), and finfish have the widest range of proportion of habitat impacted, with around 5% of species falling above the 95 percentile of proportion of habitat impacted in the fish-dominant formulation (Fig. 2).

```


Look at efficiency of raw materials; how does proportional contribution of impact differ from proportional contribution of feed formulation?

1. Look at proportional contribution of total overall impacts per raw material
2. Look at proportional contribution of average impacts per raw material?

 -  When observing the proportional contributions of raw material impacts to total species habitats globally, we find that soybeans are inefficient when compared to their proportional contribution to feed formulation. That is, soybeans represent 17% and 22% of the feed formulation, but 36% and 47% of the species area of total habitat impacted under the fish-dominant and plant-dominant scenarios, respectively. Compared to all of the other raw materials, we observe either nearly equal, or efficient percentages (Fig. 3). When observing proportional contribution to average global impacts across species, we find that soybeans are again the most inefficient, but within the fish-dominant formulation, representing 27% of the average impacts but only 10% of the feed. The most efficient ingredient, a result of our allocation approach, is trimmings fish, representing only 0.1% of the average impacts, but 13% 

```{r}

codes <- read.csv(here("prep/02_feed/data/ingredient_spam_fao_codes.csv")) %>%
  dplyr::select(raw_name = source_ingredient, raw_material = raw.material)

diets_raw_mat <- read.csv(here("prep/02_feed/data/aquaculture_diet_composition.csv")) %>%
  distinct(raw_name, prop_diet, diet) %>%
  left_join(codes) %>%
  mutate(raw_material = case_when(
    str_detect(raw_name, "cut offs") ~ "Trimmings fish", 
    str_detect(raw_name, "pea flour|guar|pea pro|faba") ~ "Pulses",
    str_detect(raw_name, "forage fish") ~ "Forage fish",
    str_detect(raw_name, "coconut|linseed") ~ "Cropsnes",
    TRUE ~ str_to_title(raw_material)
    
  )) %>%
  group_by(raw_material, diet) %>%
  summarise(total_diet_contribution = sum(prop_diet, na.rm = TRUE)) %>%
  ungroup() %>%
  filter(!is.na(raw_material)) %>%
  mutate(diet = str_to_sentence(diet))

summary_df_barcharts <- all_overlap_df %>%
  group_by(diet, fcr, raw_material, allocation, taxon) %>%
  summarise(impact_total = sum(impact_total, na.rm = TRUE)) %>%
  ungroup() %>%
  left_join(taxon_hab_area) %>%
  mutate(prop_impact = impact_total/total_hab_area)

summary_df_stats <- summary_df_barcharts %>%
   group_by(diet, fcr, raw_material, allocation) %>%
  summarise(prop_total_impact = sum(prop_impact),
            total_km2 = sum(impact_total, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(diet, fcr, allocation) %>% 
  mutate(total_impact = sum(prop_total_impact)) %>%
  mutate(prop_attributed = prop_total_impact/total_impact) %>%
  left_join(diets_raw_mat) %>%
  mutate(delta = prop_attributed - total_diet_contribution)
  
## wow ok some interesting results! Soybean is highly inefficient! Rapeseed doesn't appear to be that bad...
# In the fish-dominant diet: 
#  - soybean accounts for 17% of the feed, however, it accounts for ~36% of the impacts. 
#  - forage fish ingredients account for 42% of the fish dominant feed and only ~41% of the impacts. 
#  - wheat is similarly efficient in the fish dominant diet; 20% of the feed and 18% of the impacts. 
# 
# For the plant-dominant diet:
#  - Soybeans are 22% of the feeds but account for ~47% of the impacts.
#  - Forage fish are 17% of the feed and 17% of the impacts. 
#  - Wheat is 16% of the feed and 11% of the impacts
#  - Pulses are 12% of the feed and 11% of the impacts
#  - Rapeseed is 18% of the feed and 10% of the impact


## lets look at average impacts contributions

rgn_ids <- read.csv(here("data/spatial/output/region_ids.csv"))

# read in average raw material impacts - country level... unfortunately will have to take a mean here 
csv_files <- list.files(file.path(impact_maps_dir, "csvs/by_material_country_summary"), pattern = ".qs", full.names = TRUE)

list_of_dfs <- lapply(csv_files, qread)

combined_impact_df <- do.call(rbind, list_of_dfs) %>%
  left_join(rgn_ids) %>%
  mutate(raw_material = str_to_sentence(raw_material), 
         allocation = str_to_sentence(allocation),
         diet = str_to_sentence(diet),
         fcr = str_to_sentence(fcr)) %>%
  mutate(raw_material = ifelse(raw_material == "Cropsnes", "CropsNES", raw_material)) 

material_stats_1 <- combined_impact_df %>%
    filter(allocation == "Economic") %>%
    group_by(diet, fcr, raw_material) %>%
  summarise(
            mean_prop_weighted = mean(mean_prop_weighted, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(diet, fcr) %>%
  mutate(total_prop_mean = sum(mean_prop_weighted, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(prop_impacts = mean_prop_weighted/total_prop_mean) 

  
summary_df_stats_diet <- material_stats_1 %>%
  mutate(raw_material = ifelse(raw_material == "CropsNES", "Cropsnes", raw_material)) %>% 
  left_join(diets_raw_mat) %>%
  mutate(delta = prop_impacts - total_diet_contribution) %>%
  mutate(delta_abs = abs(delta))
```


How much of impact does Norway account for? 

 - While Norway contributes the highest share of the world’s impacts from aquafeed production (30%-32%), it produces 51% of the world's salmon, and produces and utilises 19%-27% of their terrestrial aquafeed ingredients in the country, depending on the feed scenario. 

```{r}
rgn_ids <- read.csv(here("data/spatial/output/region_ids.csv"))

# now lets join all of those together into one dataframe and save 

csv_files <- list.files(file.path(impact_maps_dir, "csvs/by_material_country_summary"), pattern = ".qs", full.names = TRUE)

list_of_dfs <- lapply(csv_files, qread)

combined_impact_df <- do.call(rbind, list_of_dfs) %>%
  left_join(rgn_ids) %>%
  mutate(raw_material = str_to_sentence(raw_material), 
         allocation = str_to_sentence(allocation),
         diet = str_to_sentence(diet),
         fcr = str_to_sentence(fcr)) %>%
  mutate(raw_material = ifelse(raw_material == "Cropsnes", "CropsNES", raw_material))


summary_iso3c_impacts <- combined_impact_df %>%
  group_by(iso3c, rgn_id, Country, allocation, diet, fcr) %>%
  summarise(sum_mean_impact = sum(mean_prop_weighted, na.rm = TRUE)) %>%
  ungroup() %>%
  filter(allocation == "Economic", diet == "Plant-dominant", fcr == "Regular") %>%
  group_by(allocation, diet, fcr) %>%
  mutate(total_impact = sum(sum_mean_impact)) %>%
  ungroup() %>%
  mutate(prop_contribute = sum_mean_impact/total_impact) %>%
  filter(!is.na(iso3c)) %>%
  filter(iso3c != "XD")


test <- summary_iso3c_impacts %>% 
  filter(!iso3c %in% c("HSX", "ATA"))
  
test <- rgn_ids %>% 
  filter(!iso3c %in% c("HSX", "ATA"))

test2 <- rgn_ids %>%
  filter(!iso3c %in% c(unique(summary_iso3c_impacts$iso3c)))
  
  
```


How much raw material does Norway produce and use in country for salmon aquafeeds? 

```{r}
ingredient_production_location <- read.csv(here("prep/02_feed/data/demand/ingredient_demand_production_locations.csv"))

norway_incountry <- ingredient_production_location %>%
  filter(
         iso3c_consuming == "NOR") %>%
  group_by(iso3c_consuming, iso3c_producing, diet, fcr_type, GAEZ_category) %>%
  summarise(total_tonnes_traded = sum(producing_ingredient_consumed_tonnes, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(diet, fcr_type) %>%
  mutate(total_tonnes_consumed = sum(total_tonnes_traded, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(prop_consumed = total_tonnes_traded/total_tonnes_consumed)

```

How much salmon aquaculture production does NOR produce? 

```{r}

production <- readRDS(here("data/tidy_data/production-data/aquaculture_production_tidy.rds")) 


salmon_production <- production %>%
  filter(species == "Atlantic salmon" & year == 2020,
         value > 0) %>%
  mutate(species = "salmon")

1388433.84/sum(salmon_production$value) # 51%

```

Check to see how efficient FCR impacts compare to regular. 
 - Does a 10% decrease in FCR = 10% decrease in impacts? 
 
 YES - because we assume trade relationships stay the same regardless of scenario.

   
```{r}

fcr_comparison_df <- all_overlap %>% 
  filter(allocation == "economic") %>%
  pivot_wider(names_from = fcr_type, values_from = impact_total) %>%
  mutate(difference = regular - efficient) %>%
  mutate(percent_difference = ((difference)/regular)*100) %>%
  mutate(percent_difference = ifelse(is.nan(percent_difference), 0, percent_difference)) %>%
  filter(vulnerability != 0, 
         percent_difference != 0) # perfect... all 10 or very close to it

test <- fcr_comparison_df %>% 
  filter(percent_difference < 0)


test2 <- fcr_comparison_df %>%
  filter(percent_difference != 0) %>%
  group_by(diet) %>% 
  summarise(mean_diff = mean(percent_difference, na.rm = TRUE)) %>%
  ungroup()

# A tibble: 2 × 2
#   diet           mean_diff
#   <chr>              <dbl>
# 1 fish-dominant       10.0
# 2 plant-dominant      10.0

## Check the global rasters:

 filepath <- glue(file.path(impact_maps_dir, "csvs/impact_maps_across_taxon_ingredient/economic_mean_prop.qs"))

all_df <-  qread(filepath)  %>%
  filter(value > 0) %>%
  filter(!is.na(value)) %>%
   pivot_wider(names_from = fcr_type, values_from = value) %>%
  mutate(difference = regular - efficient) %>%
  mutate(percent_difference = ((difference)/regular)*100) %>%
  mutate(percent_difference = ifelse(is.nan(percent_difference), 0, percent_difference))

test2 <- all_df %>%
  filter(percent_difference != 0) %>%
  group_by(diet) %>% 
  summarise(mean_diff = mean(percent_difference, na.rm = TRUE)) %>%
  ungroup()

## ok we see the same thing here... all 10% decrease... good

```


How many species have both marine and terrestrial impacts? 

```{r}

test <- all_overlap %>%
  filter(spp_type %in% c("Bird", "Amphibians", "Reptiles")) %>%
  filter(impact_total > 0) %>%
  filter(allocation == "economic", fcr_type == "regular") %>%
  mutate(ingredient_type = ifelse(str_detect(ingredient, "forage fish|trimmings fish"), "marine", "terrestrial")) %>%
  pivot_wider(names_from = ingredient_type, values_from = impact_total)

unique(test$sciname) # 46 amphibians, reptiles, or birds which have marine impacts

## do any of them have both??
test2 <- test %>%
  group_by(sciname, spp_type, diet) %>%
  summarise(marine = sum(marine, na.rm = TRUE),
            terrestrial = sum(terrestrial, na.rm = TRUE)) %>%
  ungroup() %>% 
  filter(marine > 0, terrestrial > 0) ## nope, none of them have both

```

Why do we see higher impacts for macrophytes and benthic creates nave high prop impacted? 

1. Lower total AOH, so higher props. 
2. Destructive gear types like trawling and dregding

```{r}


test <- readRDS(file.path(rdsi_dir, "biodiversity_impacts/int/spp_vuln_depth_info.rds")) %>% 
  filter(taxon %in% c("arthropods", "molluscs", "echinoderms", "cnidaria", "sponges", "corals", "Marine plant"))

test2 <- test %>% group_by(depth_position) %>% summarise(n())

test3 <- test %>% group_by(depth_position, taxon, catch_type) %>% summarise(n())

# arrange(taxon_hab_area, total_hab_area)
# # A tibble: 15 × 2
#    total_hab_area taxon              
#             <dbl> <chr>              
#  2      836560700 Corals             
#  3      847877200 Marine plants      
#  4     1228453400 Sponges            
#  5     1570267500 Echinoderms        
#  6     2405192600 Cnidaria           
#  9     4047208500 Cephalopods        
# 10     4522806100 Marine mammals     
# 12     5708949800 Elasmobranchs      
# 13    17981181900 Molluscs           
# 14    18339709000 Arthropods         
# 15    77370257100 Finfish   

# lets look at gears used for forage fish catch


source(here("src/directories.R"))
catch <- readRDS(file.path(watson_dir, "v5.0/int/all_catch_foragefish.rds"))

test_catch <- catch %>% 
  filter(FOFM_catch > 0) %>%
  group_by(water_col_position, VBDesc) %>%
  summarise(forage_catch = sum(FOFM_catch,na.rm = TRUE)) %>%
  ungroup()

sum(catch$FOFM_catch) # 24765797

unique(test_catch$VBDesc)

test_catch %>%
  filter(VBDesc %in% c("bottom trawls", "conical and drum-like traps", "trapping gear", "traps", "by diving", "explosives")) %>%
  pull(forage_catch) %>%
  sum()

# 3339241/24765797

trimmingsfish <- readRDS(file.path(watson_dir, "v5.0/int/all_catch_trimmingsfish.rds")) %>%
  filter(trimmings_catch > 0) %>%
  group_by(water_col_position, VBDesc) %>%
  summarise(trimmings_catch = sum(trimmings_catch,na.rm = TRUE)) %>%
  ungroup()

sum(trimmingsfish$trimmings_catch) # 18282816

unique(trimmingsfish$VBDesc)

trimmingsfish %>%
  filter(VBDesc %in% c("bottom trawls", "conical and drum-like traps", "trapping gear", "traps", "by diving", "explosives")) %>%
  pull(trimmings_catch) %>%
  sum()

(1129209 + 3339241)/(18282816 +24765797) # 10% of catch comes from destructive benthic gears

```

How much bigger are marine habitats than terrestrial habitats?

```{r}

marine_hab_areas <-  marine_overlap %>%
  filter(impact_total > 0) %>%
  distinct(sciname, total_hab_area)

mean(marine_hab_areas$total_hab_area) # 6577977

terr_hab_areas <- terrestrial_overlap %>%
  filter(impact_total > 0) %>%
  distinct(sciname, total_hab_area)

mean(terr_hab_areas$total_hab_area) # 523836.1


6577977/523836.1 # 12.55732 marine habitat areas are ~12.5x larger than terrestrial on average


## what about impacts 
test <- marine_overlap %>%
  filter(
          impact_total > 0,
         allocation == "economic") %>%
  group_by(sciname, diet, fcr_type, allocation) %>%
  summarise(impact_total = sum(impact_total, na.rm = TRUE)) %>%
  ungroup() %>%
  left_join(marine_hab_areas) %>%
  mutate(prop_impact = impact_total/total_hab_area) %>% 
  group_by(diet, fcr_type) %>%
  summarise(mean_prop = mean(prop_impact, na.rm = TRUE)) %>% 
  ungroup()

## mean plant-dominant marine spp prop impact is 
## filter 0s: 0.000003810617

test2 <- terrestrial_overlap %>%
  filter(
          impact_total > 0,
         allocation == "economic") %>%
  group_by(sciname, diet, fcr_type, allocation) %>%
  summarise(impact_total = sum(impact_total, na.rm = TRUE)) %>%
  ungroup() %>%
  left_join(terr_hab_areas) %>%
  mutate(prop_impact = impact_total/total_hab_area) %>% 
  group_by(diet, fcr_type) %>%
  summarise(mean_prop = mean(prop_impact, na.rm = TRUE)) %>% 
  ungroup()

# mean plant-dominant terrestrial spp prop impact is 
# 0.00002844402

## terrestrial plant-dominant impacts are on average 7.5x more than marine plant-dominant impacts
0.00002844402/0.000003810617

## terrestrial fish-domiannt impacts are on average 1.4x more than marine fish-dominant impacts
0.000009356426 # marine fd
0.00001272571 # terr fd

0.00001272571/0.000009356426 # 1.360104

## look at average habitat areas for terrestrial taxa 

terr_taxa_avg <- terrestrial_overlap %>% 
  filter(impact_total > 0) %>%
  distinct(sciname, spp_type, total_hab_area) %>%
  group_by(spp_type) %>%
  summarise(avg_hab = mean(total_hab_area, na.rm = TRUE),
            total_hab = sum(total_hab_area, na.rm = TRUE)) %>%
  ungroup()

```

