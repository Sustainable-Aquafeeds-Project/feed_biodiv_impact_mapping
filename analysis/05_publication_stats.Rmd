---
title: "Summary stats for manuscript"
output: html_document
editor_options: 
  chunk_output_type: console
---

## Setup

Load libraries

```{r setup, include=FALSE}

library(tidyverse)
library(here)
library(strex)
library(sf)
library(glue)
library(qs)
library(mapview)

source(here("src/directories.R"))

source(here("src/spatial.R"))

setwd(dirname(rstudioapi::getSourceEditorContext()$path)) # set working directory to where this script is located
this_dir <- getwd()

biodiv_dir <- file.path(rdsi_dir, "biodiversity_impacts")

impact_maps_dir <- file.path(biodiv_dir, "output")

```

```{r}
marine_overlap <- readRDS(here("prep/03_prep_spp_habitats/output/aoh_marine_impact.rds")) %>%
    dplyr::select(sciname, spp_type, diet, fcr_type, allocation, ingredient, vulnerability, impact_total, total_hab_area)

terrestrial_overlap <- readRDS(here("prep/03_prep_spp_habitats/output/aoh_terrestrial_impact.rds")) %>% 
  dplyr::select(-suitability) %>%
      dplyr::select(sciname, spp_type, diet, fcr_type, allocation, ingredient, vulnerability, impact_total, total_hab_area)

all_overlap <- rbind(marine_overlap, terrestrial_overlap) %>%
    mutate(taxon = str_to_sentence(spp_type)) %>%
  mutate(taxon = case_when(
    taxon == "Terrestrial mammal" ~ "Terrestrial mammals",
    taxon == "Bird" ~ "Birds",
    taxon == "Fish" ~ "Finfish", 
    taxon == "Marine mammal" ~ "Marine mammals",
    taxon == "Marine plant" ~ "Marine plants",
    TRUE ~ taxon))

spp_total_hab <- all_overlap %>%
  distinct(sciname, spp_type, total_hab_area) %>%
  mutate(id = row_number())
```

Get some stats about differences between formulations and average impacts.

```{r}
## read in plant-dominant, economic, regular
 filepath <- glue(file.path(impact_maps_dir, "csvs/impact_maps_across_taxon_ingredient/economic_mean_prop.qs"))

all_df <-  qread(filepath)  %>%
  filter(value > 0) %>%
  filter(!is.na(value))

max(all_df$value) # 0.2235324 # can dive into prep/03_prep_spp_habitats/08_process_mean_sd_summary.Rmd to find out more of whats happening in this cell. 

moll_template_land <- readRDS(here("prep/03_prep_spp_habitats/data/spatial/moll_template_land_xy.rds"))
moll_template_ocean <- readRDS(here("prep/03_prep_spp_habitats/data/spatial/moll_template_ocean_xy.rds"))

land_eez_rgns <- read.csv(file.path(biodiv_dir, "spatial/rgns_xy_all.csv")) %>% 
  dplyr::select(x, y, rgn_id)

maximum_location <- all_df %>%
  filter(value > 0.22) %>%
  left_join(land_eez_rgns, by = c("long" = "x", "lat" = "y")) %>%
 left_join(moll_template_land, by = c("long" = "x", "lat" = "y")) %>% # max value is ~0.22 on land in Norway
st_as_sf(coords = c("long", "lat"), crs = crs(moll_template)) # in Akershus county
mapview(maximum_location)
  

test <- all_df %>%
  group_by(diet, fcr_type) %>%
  summarise(prop_mean = mean(value, na.rm = TRUE)) %>%
  ungroup()

scenario_summary <- all_df %>% 
  filter(value > 0) %>%
  group_by(diet, fcr_type) %>%
  summarise(cells_impacted = n()) %>%
  ungroup()

moll_land <- readRDS(here("prep/03_prep_spp_habitats/data/spatial/moll_template_land_xy.rds"))

all_df_land <- all_df %>%
  left_join(moll_land, by = c("long" = "x", "lat" = "y")) %>%
  filter(!is.na(cell_id)) %>%
  filter(value > 0) %>%
    group_by(diet, fcr_type) %>%
  summarise(cells_impacted = n()) %>%
  ungroup() %>%
   mutate(land_cells_total = 2876998) %>%
  mutate(prop = cells_impacted/land_cells_total)

moll_ocean <- readRDS(here("prep/03_prep_spp_habitats/data/spatial/moll_template_ocean_xy.rds"))

all_df_ocean <- all_df %>%
  left_join(moll_ocean, by = c("long" = "x", "lat" = "y")) %>%
  filter(!is.na(cell_id)) %>%
    filter(value > 0) %>%
    group_by(diet, fcr_type) %>%
  summarise(cells_impacted = n()) %>%
  ungroup() %>%
  mutate(ocean_cells_total = 3684240) %>%
  mutate(prop = cells_impacted/ocean_cells_total)

# Comparing the fish-dominant and plant-dominant feed scenarios, under the BAU FCR scenario, we see that the plant-dominant diet has 81,352 more pixels impacted (there are ~6.5 million pixels on a 10km Mollweide grid) (Fig. 1). This difference is almost exclusively due to the difference in terrestrial crop impacts, with the plant-dominant diet having 80789 more terrestrial pixels impacted than that of the fish-dominant diet. 

# Overall, ocean pixels are impacted over a larger area: approximately 42% of ocean pixels, regardless of feed scenario. In comparison, around a quarter of land pixels are impacted. The global average proportion of habitat impacted ranges from 0.00001769810 to 0.00003439829, with the fish-dominant, regular FCR scenario having the largest global average impact (0.00000507).

# Pixels in which there are impacts under both scenarios, the plant-dominant diet has, on average, larger impacts on land, particularly in Sub-Saharan Africa, Canada, the Middle East, and Western Europe. In contrast, the fish-dominant diet has larger impacts in most ocean pixels, the United States, parts of South America, and China (Fig. 1b). 


```

Compare how vulnerable species types are

```{r}
vuln_values <- all_overlap %>%
  distinct(sciname, ingredient, vulnerability) %>%
  mutate(type = ifelse(str_detect(ingredient, "fish"), "marine", "terrestrial")) %>%
  group_by(type) %>%
  summarise(mean_vuln = mean(vulnerability)) %>%
  ungroup()

ag_suitability <- readRDS(here("prep/03_prep_spp_habitats/int/terrestrial_spp_habitat_suitability.rds"))

1 - mean(ag_suitability$cropland_suitability) # 0.8213065

vuln_taxa <- readRDS(file.path(rdsi_dir, "biodiversity_impacts/int/spp_vuln_depth_info.rds")) %>%
  unite("ingredient", c(fish_type, ingredient), sep = "_") %>%
  mutate(ingredient = case_when(
    ingredient == "trimmings fish_fish meal" ~ "trimmings fish_fish meal, cut offs",
    ingredient == "trimmings fish_fish oil" ~ "trimmings fish_fish oil, cut offs",
    TRUE ~ ingredient
  )) %>%
  distinct(species,ingredient, vuln_quartile)

mean(vuln_taxa$vuln_quartile) # 0.44618

# Additionally, of all species (impacted or not), marine species, on average, have a vulnerability value of 0.45, while terrestrial species have a vulnerability value of 0.82. This means that within our methods, marine species are, on average, more resilient to fishing pressures than terrestrial species are to cropland used for aquafeeds.

length(unique(vuln_taxa$species)) # 23639
length(unique(ag_suitability$species)) # 31596


terr_vuln_spp <- ag_suitability %>% 
  filter(cropland_suitability != 1)
length(terr_vuln_spp$species) # 26413 terrestrial vuln


marine_vuln_spp <- vuln_taxa %>%
  group_by(species) %>%
  summarise(total_vuln = sum(vuln_quartile, na.rm = TRUE)) %>%
  ungroup() %>%
  filter(total_vuln != 0)

length(marine_vuln_spp$species) # 20684 terrestrial vuln

(20684 + 26413)/(23639 + 31596) # 0.8526659 are vulnerable in some capacity

```

How many species assessed and impacted? 

```{r}
taxon_names <- all_overlap %>%
  distinct(spp_type, taxon)

spp_impacted <- all_overlap %>%
  filter(impact_total > 0) %>%
  group_by(taxon, diet, allocation, fcr_type) %>%
  summarise(spp_count_impacted = n_distinct(sciname)) %>%
  ungroup()

aquamaps_spp <- readRDS(file.path(rdsi_dir, "biodiversity_impacts/int/spp_vuln_depth_info.rds")) %>%
  distinct(spp_type = taxon, sciname = species)
  
eyres_spp <- readRDS(here("prep/03_prep_spp_habitats/data/iucn/eyres_iucn_spp.rds")) %>%
  dplyr::select(spp_type, sciname = scientific_name) %>%
  mutate(sciname = tolower(sciname)) %>%
  mutate(spp_type = case_when(
    spp_type == "mammals" ~ "Terrestrial mammal",
    spp_type == "amphibians" ~ "Amphibians", 
    spp_type == "reptiles" ~ "Reptiles", 
    spp_type == "birds" ~ "Bird"
  ))

spp_assessed <- rbind(aquamaps_spp, eyres_spp) %>%
  left_join(taxon_names) %>%
  group_by(taxon) %>%
  summarise(spp_count_assessed = n_distinct(sciname)) %>%
  ungroup() %>%
  filter(!is.na(taxon))

spp_assessed_impacted <- spp_impacted %>%
  left_join(spp_assessed)

summary_info <- spp_assessed_impacted %>%
  group_by(diet, allocation, fcr_type) %>%
  summarise(total_assessed = sum(spp_count_assessed, na.rm = TRUE),
            total_impacted = sum(spp_count_impacted, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(prop_impacted = total_impacted/total_assessed)

```

What % of species fall into >95th quantile of global prop of habitat impacted:

```{r}
spp_assessed_plot_df <- spp_assessed %>%
  mutate(spp_count_str = glue("n = {spp_count_assessed}"))

all_overlap_df <- all_overlap %>%
  rename(fcr = fcr_type) %>%
        separate_wider_delim(ingredient, delim = "_", names = c("raw_material", "ingredient")) %>% 
  mutate(raw_material = str_to_sentence(raw_material), 
         ingredient = str_to_sentence(ingredient),
         allocation = str_to_sentence(allocation),
         diet = str_to_sentence(diet),
         fcr = str_to_sentence(fcr)) %>%
    filter(allocation == "Economic",
           fcr == "Regular")

summary_df_spp <- all_overlap_df %>%
  group_by(sciname, diet, fcr, allocation, taxon) %>%
  summarise(impact_total = sum(impact_total, na.rm = TRUE)) %>%
  ungroup() %>%
  left_join(spp_assessed_plot_df) %>%
  left_join(spp_total_hab %>% dplyr::select(-spp_type, -id)) %>%
  mutate(prop_impact = impact_total/total_hab_area)  %>%
  group_by(taxon, diet, fcr) %>%
  mutate(mean_prop = mean(prop_impact,na.rm=TRUE),
         median_prop = median(prop_impact,na.rm=TRUE)) %>%
  ungroup()

taxon_hab_area <- spp_total_hab %>%
  dplyr::select(-sciname, -id) %>%
  group_by(spp_type) %>%
  summarise(total_hab_area = sum(total_hab_area, na.rm = TRUE)) %>%
  ungroup() %>%
  left_join(taxon_names) %>%
  dplyr::select(-spp_type)
  

summary_df_all <- all_overlap_df %>%
  group_by(diet, fcr, allocation, taxon) %>%
  summarise(impact_total = sum(impact_total, na.rm = TRUE)) %>%
  ungroup() %>%
  left_join(taxon_hab_area) %>%
  mutate(prop_impact = impact_total/total_hab_area)

quant_95 <- quantile(summary_df_spp$prop_impact, 0.95)


summary_df_spp_out <- summary_df_spp %>%
  filter(prop_impact >= quant_95) %>%
  group_by(diet, fcr, allocation, taxon) %>%
  mutate(spp_outliers = n_distinct(sciname)) %>%
  ungroup() 

summary_spp_outliers <- summary_df_spp %>%
  filter(prop_impact >= quant_95) %>%
  group_by(diet, fcr, allocation, taxon) %>%
  summarise(spp_outliers = n_distinct(sciname)) %>%
  ungroup() 

# Overall, our analysis reveals that terrestrial mammal species exhibit the highest impacts on average across all taxon, in the plant-dominant scenario. Of terrestrial mammal species assessed, 10% are above the 95th percentile proportion of total habitat impacted (Fig. 2). While birds, reptiles, and amphibians are exposed to both marine and terrestrial disturbance pressures, most of their impacts are derived from terrestrial based feed ingredients, with only a small proportion of their impacts coming from forage and trimmings fish raw materials, as these species are unlikely to be bycatch or have exposure to areas of harvest of marine ingredients (Fig. 3). Among marine taxonomic groupings, marine plants see the highest proportion of their global habitat area impacted (Fig. 3), and finfish have the widest range of proportion of habitat impacted, with around 5% of species falling above the 95 percentile of proportion of habitat impacted in the fish-dominant formulation (Fig. 2).

```


Look at efficiency of raw materials; how does proportional contribution of impact differ from proportional contribution of feed forumation?

1. Look at proportional contribution of total overall impacts per raw material
2. Look at proportional contribution of average impacts per raw material?

 -  When observing the proportional contributions of raw material impacts to total species habitats globally, we find that soybeans are inefficient when compared to their proportional contribution to feed formulation. That is, soybeans represent 17% and 22% of the feed formulation, but 36% and 47% of the species area of total habitat impacted under the fish-dominant and plant-dominant scenarios, respectively. Compared to all of the other raw materials, we observe either nearly equal, or efficient percentages (Fig. 3). When observing proportional contribution to average global impacts across species, we find that soybeans are again the most inefficient, but within the fish-dominant formulation, representing 27% of the average impacts but only 10% of the feed. The most efficient ingredient, a result of our allocation approach, is trimmings fish, representing only 0.1% of the average impacts, but 13% 

```{r}

codes <- read.csv(here("prep/02_feed/data/ingredient_spam_fao_codes.csv")) %>%
  dplyr::select(raw_name = source_ingredient, raw_material = raw.material)

diets_raw_mat <- read.csv(here("prep/02_feed/data/aquaculture_diet_composition.csv")) %>%
  distinct(raw_name, prop_diet, diet) %>%
  left_join(codes) %>%
  mutate(raw_material = case_when(
    str_detect(raw_name, "cut offs") ~ "Trimmings fish", 
    str_detect(raw_name, "pea flour|guar|pea pro|faba") ~ "Pulses",
    str_detect(raw_name, "forage fish") ~ "Forage fish",
    str_detect(raw_name, "coconut|linseed") ~ "Cropsnes",
    TRUE ~ str_to_title(raw_material)
    
  )) %>%
  group_by(raw_material, diet) %>%
  summarise(total_diet_contribution = sum(prop_diet, na.rm = TRUE)) %>%
  ungroup() %>%
  filter(!is.na(raw_material)) %>%
  mutate(diet = str_to_sentence(diet))

summary_df_barcharts <- all_overlap_df %>%
  group_by(diet, fcr, raw_material, allocation, taxon) %>%
  summarise(impact_total = sum(impact_total, na.rm = TRUE)) %>%
  ungroup() %>%
  left_join(taxon_hab_area) %>%
  mutate(prop_impact = impact_total/total_hab_area)

summary_df_stats <- summary_df_barcharts %>%
   group_by(diet, fcr, raw_material, allocation) %>%
  summarise(prop_total_impact = sum(prop_impact),
            total_km2 = sum(impact_total, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(diet, fcr, allocation) %>% 
  mutate(total_impact = sum(prop_total_impact)) %>%
  mutate(prop_attributed = prop_total_impact/total_impact) %>%
  left_join(diets_raw_mat) %>%
  mutate(delta = prop_attributed - total_diet_contribution)
  
## wow ok some interesting results! Soybean is highly inefficient! Rapeseed doesn't appear to be that bad...
# In the fish-dominant diet: 
#  - soybean accounts for 17% of the feed, however, it accounts for ~36% of the impacts. 
#  - forage fish ingredients account for 42% of the fish dominant feed and only ~41% of the impacts. 
#  - wheat is similarly efficient in the fish dominant diet; 20% of the feed and 18% of the impacts. 
# 
# For the plant-dominant diet:
#  - Soybeans are 22% of the feeds but account for ~47% of the impacts.
#  - Forage fish are 17% of the feed and 17% of the impacts. 
#  - Wheat is 16% of the feed and 11% of the impacts
#  - Pulses are 12% of the feed and 11% of the impacts
#  - Rapeseed is 18% of the feed and 10% of the impact


## lets look at average impacts contributions

rgn_ids <- read.csv(here("data/spatial/output/region_ids.csv"))

# read in average raw material impacts - country level... unfortunately will have to take a mean here 
csv_files <- list.files(file.path(impact_maps_dir, "csvs/by_material_country_summary"), pattern = ".qs", full.names = TRUE)

list_of_dfs <- lapply(csv_files, qread)

combined_impact_df <- do.call(rbind, list_of_dfs) %>%
  left_join(rgn_ids) %>%
  mutate(raw_material = str_to_sentence(raw_material), 
         allocation = str_to_sentence(allocation),
         diet = str_to_sentence(diet),
         fcr = str_to_sentence(fcr)) %>%
  mutate(raw_material = ifelse(raw_material == "Cropsnes", "CropsNES", raw_material)) 

material_stats_1 <- combined_impact_df %>%
    filter(allocation == "Economic") %>%
    group_by(diet, fcr, raw_material) %>%
  summarise(
            mean_prop_weighted = mean(mean_prop_weighted, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(diet, fcr) %>%
  mutate(total_prop_mean = sum(mean_prop_weighted, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(prop_impacts = mean_prop_weighted/total_prop_mean) 

  
summary_df_stats_diet <- material_stats_1 %>%
  mutate(raw_material = ifelse(raw_material == "CropsNES", "Cropsnes", raw_material)) %>% 
  left_join(diets_raw_mat) %>%
  mutate(delta = prop_impacts - total_diet_contribution) %>%
  mutate(delta_abs = abs(delta))
```


How much of impact does Norway account for? 

 - Norway has the highest impact among all countries, representing a share of 30% - 32% of global average impacts from aquafeed, depending on the feed scenario. While Norway contributes a considerable share of the world’s impacts, it produces 51% of the world's salmon, and produces and utilises 19%-27% of their terrestrial aquafeed ingredients in the country depending on the feed scenario, a large portion of the worlds’ raw materials which are used for aquafeed. 

```{r}
rgn_ids <- read.csv(here("data/spatial/output/region_ids.csv"))

# now lets join all of those together into one dataframe and save 

csv_files <- list.files(file.path(impact_maps_dir, "csvs/by_material_country_summary"), pattern = ".qs", full.names = TRUE)

list_of_dfs <- lapply(csv_files, qread)

combined_impact_df <- do.call(rbind, list_of_dfs) %>%
  left_join(rgn_ids) %>%
  mutate(raw_material = str_to_sentence(raw_material), 
         allocation = str_to_sentence(allocation),
         diet = str_to_sentence(diet),
         fcr = str_to_sentence(fcr)) %>%
  mutate(raw_material = ifelse(raw_material == "Cropsnes", "CropsNES", raw_material))


summary_iso3c_impacts <- combined_impact_df %>%
  group_by(iso3c, allocation, diet, fcr) %>%
  summarise(sum_mean_impact = sum(mean_prop_weighted, na.rm = TRUE)) %>%
  ungroup() %>%
  filter(allocation == "Economic") %>%
  group_by(allocation, diet, fcr) %>%
  mutate(total_impact = sum(sum_mean_impact)) %>%
  ungroup() %>%
  mutate(prop_contribute = sum_mean_impact/total_impact)
```


How much raw material does Norway produce and use in country for salmon aquafeeds? 

```{r}
ingredient_production_location <- read.csv(here("prep/02_feed/data/demand/ingredient_demand_production_locations.csv"))

norway_incountry <- ingredient_production_location %>%
  filter(
         iso3c_consuming == "NOR") %>%
  group_by(iso3c_consuming, iso3c_producing, diet, fcr_type, GAEZ_category) %>%
  summarise(total_tonnes_traded = sum(producing_ingredient_consumed_tonnes, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(diet, fcr_type) %>%
  mutate(total_tonnes_consumed = sum(total_tonnes_traded, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(prop_consumed = total_tonnes_traded/total_tonnes_consumed)

```

How much salmon aquaculture production does NOR produce? 

```{r}

production <- readRDS(here("data/tidy_data/production-data/aquaculture_production_tidy.rds")) 


salmon_production <- production %>%
  filter(species == "Atlantic salmon" & year == 2020,
         value > 0) %>%
  mutate(species = "salmon")

1388433.84/sum(salmon_production$value) # 51%

```

Check to see how efficient FCR impacts compare to regular. 
 - Does a 10% decrease in FCR = 10% decrease in impacts? YES - because we assume trade relationships stay the same.
   - Look at a species level, average impact level, etc
   
```{r}

fcr_comparison_df <- all_overlap %>% 
  filter(allocation == "economic") %>%
  pivot_wider(names_from = fcr_type, values_from = impact_total) %>%
  mutate(difference = regular - efficient) %>%
  mutate(percent_difference = ((difference)/regular)*100) %>%
  mutate(percent_difference = ifelse(is.nan(percent_difference), 0, percent_difference)) %>%
  filter(vulnerability != 0, 
         percent_difference != 0) # perfect... all 10 or very close to it

test <- fcr_comparison_df %>% 
  filter(percent_difference < 0)


test2 <- fcr_comparison_df %>%
  filter(percent_difference != 0) %>%
  group_by(diet) %>% 
  summarise(mean_diff = mean(percent_difference, na.rm = TRUE)) %>%
  ungroup()

# A tibble: 2 × 2
#   diet           mean_diff
#   <chr>              <dbl>
# 1 fish-dominant       10.0
# 2 plant-dominant      10.0




## Check the global rasters:

 filepath <- glue(file.path(impact_maps_dir, "csvs/impact_maps_across_taxon_ingredient/economic_mean_prop.qs"))

all_df <-  qread(filepath)  %>%
  filter(value > 0) %>%
  filter(!is.na(value)) %>%
   pivot_wider(names_from = fcr_type, values_from = value) %>%
  mutate(difference = regular - efficient) %>%
  mutate(percent_difference = ((difference)/regular)*100) %>%
  mutate(percent_difference = ifelse(is.nan(percent_difference), 0, percent_difference))

test2 <- all_df %>%
  filter(percent_difference != 0) %>%
  group_by(diet) %>% 
  summarise(mean_diff = mean(percent_difference, na.rm = TRUE)) %>%
  ungroup()

## ok we see the same thing here... all 10% decrease... good

```

