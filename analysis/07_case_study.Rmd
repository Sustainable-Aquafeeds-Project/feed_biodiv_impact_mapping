---
title: "Publication plots: non maps"
output: html_document
editor_options: 
  chunk_output_type: console
---

## Setup

Load libraries

```{r setup, include=FALSE}

library(tidyverse)
library(here)
library(data.table)
library(terra)
library(strex)
library(patchwork)
library(cowplot)
library(glue)
library(RColorBrewer)
library(ggpubr)
library(qs)
library(parallel)
library(doParallel)

source(here("src/directories.R"))

source(here("src/spatial.R"))

biodiv_dir <- file.path(rdsi_dir, "biodiversity_impacts")

impact_maps_dir <- file.path(biodiv_dir, "output")

this_dir <- here("analysis/")

```

Let's explore the cell with the highest impacts:
 - in Norway, plant-dominant 22% average habitat area impacted
 - in Norway, fish-dominant XX% average habitat area impacted
 
 
```{r}
land_eez_rgns <- read.csv(file.path(biodiv_dir, "spatial/rgns_xy_all.csv")) %>% 
  dplyr::select(x, y, rgn_id)

## read in plant-dominant, economic, regulat
 filepath <- glue(file.path(impact_maps_dir, "csvs/impact_maps_across_taxon_ingredient/economic_mean_prop.qs"))

all_df <-  qread(filepath)  %>%
  filter(value > 0) %>%
  filter(!is.na(value))

max_scen <- all_df %>%
  group_by(diet, fcr_type) %>%
  summarise(max_val = max(value, na.rm = TRUE)) %>%
  ungroup()

# A tibble: 4 Ã— 3
#   diet           fcr_type  max_val
#   <chr>          <chr>       <dbl>
# 1 fish-dominant  efficient  0.0958
# 2 fish-dominant  regular    0.106 
# 3 plant-dominant efficient  0.201 
# 4 plant-dominant regular    0.224 

max_cell <- all_df %>%
  filter(value > 0.09) # 786772 cell_id

## lets find the exact cell of these impacts
moll_template_land <- readRDS(here("prep/03_prep_spp_habitats/data/spatial/moll_template_land_xy.rds")) %>%
  mutate(type = "land")
moll_template_ocean <- readRDS(here("prep/03_prep_spp_habitats/data/spatial/moll_template_ocean_xy.rds")) %>%
  mutate(type = "ocean")

moll_template_all <- rbind(moll_template_land, moll_template_ocean)
land_eez_rgns <- read.csv(file.path(biodiv_dir, "spatial/rgns_xy_all.csv")) %>% 
  dplyr::select(x, y, rgn_id)

maximum_location <- all_df %>%
  filter(value >  0.0958) %>%
  left_join(land_eez_rgns, by = c("long" = "x", "lat" = "y")) %>%
  left_join(moll_template_all, by = c("long" = "x", "lat" = "y"))

# All max values in each scenario are in the same cell, on land, in Norway: cell_id = 786772
# side note - the maximum ocean cells are also in Norway

## how many spp impacted in that cell? 
 filepath <- glue(file.path(impact_maps_dir, "csvs/impact_maps_across_taxon_ingredient/economic_nspp.qs"))

nspp_df <-  qread(filepath) %>%
  left_join(moll_template_xy, by = c("long" = "x", "lat" = "y")) %>%
  dplyr::select(cell_id, diet, fcr_type, nspp_impacted = value) %>%
  filter(cell_id == 786772) # 39 spp impacted in all scenarios

## how many species are actually in that cell? 

all_richness <- rast(list.files(here("data/spatial/output"), pattern = "richness", full.names = TRUE)) %>% 
    app(., "sum", na.rm = TRUE) %>%
  as.data.frame(., xy = TRUE) %>%
  left_join(moll_template_xy) %>%
  dplyr::select(cell_id, sum_spp = sum)

max_impacts <- maximum_location %>% 
  left_join(all_richness) %>%
  left_join(nspp_df) %>%
 filter(cell_id == 786772)

## ok so, 39 spp impacted, 97 spp present

```


What species are impacted in largest impact cells:
 - grab any cells that fall into the 95-99 or >= 99 quantile categories; cell list saved in 02_publication_maps.Rmd

```{r}
# take code from aggregation script

large_impact_cells <- readRDS(here("analysis/int/large_impact_cells.rds")) # ok... might need to filter for cells in specific countries... e.g., NOR, CHL, BRA, UK, CAN to cut down on computational load needed to save this information if this doesnt work, then will need to save country by country.. or only >99 impacts

diet_types <- c("fish-dominant", "plant-dominant")
fcr_types <- c("regular")
allocation_types <- c("economic")


max_impact_df <- data.frame(species_full = NA, cell_id = NA, cropland_suitability = NA, spp_type = NA, filepath = NA,
                            species_id = NA, harvest = NA, hab_area = NA, impact_km2 = NA, source_file = NA,
                            raw_material = NA, diet = NA, allocation = NA, fcr = NA)

for(diet in diet_types){
  for(fcr in fcr_types){
    for(allocation in allocation_types){

# allocation = "economic"
# diet = "plant-dominant"
# fcr = "regular"

all_files <- list.files(file.path(biodiv_dir, "output/impact_maps_by_spp_ingredient_lists"), pattern = glue(".*_{diet}_{fcr}_.*_{allocation}"), full.names = TRUE)

to_remove <- grep("fish oil|fish meal", all_files)
all_files <- all_files[-to_remove]


all_files_list <- lapply(all_files, qread)

## now filter for specific cell_id and see what is impacted...

max_cell_impacts <- all_files_list %>% 
  map(~ .x %>%
        map(~ filter(.x, cell_id %in% c(large_impact_cells))))  # filter for any cells that are in the cells that have an average impact in the 95-99 or >=99th quantiles


for (i in seq_along(max_cell_impacts)) {
  for (j in seq_along(max_cell_impacts[[i]])) {
    max_cell_impacts[[i]][[j]]$source_file <- all_files[i]
  }
}

max_cell_impacts_fin <- max_cell_impacts %>%
  bind_rows() %>%
  mutate(raw_material = str_before_first(str_after_nth(str_after_last(source_file, "/"), "_", 3), "_")) %>%
  mutate(diet = diet, 
         allocation = allocation, 
         fcr = fcr)

qsave(max_cell_impacts_fin, glue(here("analysis/int/large_cell_impacts_terrestrial_{diet}_{fcr}_{allocation}.qs")))


    }
  }
}



## consider for marine species? Maybe... if i did it would take ~8 hours I'm guessing, and might be quite a lot more data

```

Need to do the same thing for marine impacts...

```{r}
diet_types <- c("fish-dominant", "plant-dominant")
fcr_types <- c("efficient", "regular")
allocation_types <- c("mass", "ge", "economic")


for(diet in diet_types){
  for(fcr in fcr_types){
    for(allocation in allocation_types){
      
        all_impact_df <- data.frame(cell_id = NA, prop_mean = NA, prop_sd = NA, prop_nspp = NA, prop_ext_risk = NA)
      
      for(chunk_id in 1:13){
        
       # chunk_id = 1
        
        files <- list.files(file.path(biodiv_dir, "int/marine_aggregation/sub_chunk_dfs/"), pattern = glue(".*_{diet}_{fcr}_.*_{allocation}_chunk_{chunk_id}.qs"), full.names = TRUE)
        
        impacts_chunk <- lapply(files, qread) %>%
          bind_rows() %>%
          filter(!is.na(cell_id)) %>%
          filter(cell_id %in% large_impact_cells) %>%
  as.data.frame()

        
    all_impact_df <- rbind(all_impact_df, impacts_chunk)
        
      }
                 

            
    }
  }
}  
```


What IUCN category are these heavily impacted species? 

```{r}
max_impact_df <- qread( here(this_dir, "int/terrestrial_spp_1%_impacted.qs"))
iucn_cats <- read.csv(here("prep/03_prep_spp_habitats/int/spp_iucn_cats.csv"))

iucn_big_impacts <- max_impact_df %>% 
  mutate(species_full = tolower(species_full)) %>%
  left_join(iucn_cats, by = c("species_full" = "sciname")) %>%
  filter(!(category %in% c("NE", "LC", "DD"))) %>%
  group_by(species_full, cell_id) %>%
  mutate(total_impacts = sum(impact_km2)) %>%
  ungroup() %>%
  filter(total_impacts >= 1) 

## ok wheat and rapeseed really bad! 

max_impact_cell_spp <- max_impact_df %>% 
  filter(cell_id == 786772) %>%
  mutate(species_full = tolower(species_full)) %>% 
  left_join(iucn_cats, by = c("species_full" = "sciname")) ## ok they are all LC lol
```

Ok, let's pull the "hotspot" areas for 4 examples:

 - Norway
 - Argentina
 - Chile (coastal)
 - Canada


```{r}
max_impact_df <- qread( here(this_dir, "int/terrestrial_spp_1%_impacted.qs"))
land_eez_rgns <- read.csv(file.path(biodiv_dir, "spatial/rgns_xy_all.csv")) %>%
  dplyr::select(x, y, iso3c) %>% 
  left_join(moll_template_xy)


max_impact_iso3c <- max_impact_df %>%
  left_join(land_eez_rgns) 

max_impact_rast <- max_impact_iso3c %>%
  group_by(x, y, diet, allocation, fcr) %>%
  summarise(impact_km2 = sum(impact_km2, na.rm = TRUE)) %>%
  ungroup() %>%
  filter(diet == "plant-dominant", fcr == "regular") %>%
  dplyr::select(x, y, impact_km2) %>%
  rast(., crs = moll_template)

plot(max_impact_rast, col = "red")

unique(max_impact_iso3c$iso3c) # [1] "NOR" "SWE" "CAN" "NLD" "CHL" "CHN" "ARG" ... ok.... this isn't right


max_impact_nor <- max_impact_iso3c %>%
  filter(iso3c == "NOR")


max_impact_can <- max_impact_iso3c %>%
  filter(iso3c == "CAN")


max_impact_chl <- max_impact_iso3c %>%
  filter(iso3c == "CHL")

max_impact_arg <- max_impact_iso3c %>%
  filter(iso3c == "ARG")


max_impact_bra <- max_impact_iso3c %>%
  filter(iso3c == "BRA")

```

